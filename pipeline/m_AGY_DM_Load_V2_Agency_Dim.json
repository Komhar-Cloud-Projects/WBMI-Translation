{
    "name": "s_m_AGY_DM_Load_V2_Agency_Dim",
    "properties": {
        "activities": [
            {
                "name": "m_AGY_DM_Load_V2_Agency_Dim",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nSQ_agency AS (\n\n------------ PRE SQL ----------\ntruncate table dbo.work_v2_agency\r\n\r\ninsert dbo.work_v2_agency (agency_ak_id ,\r\n                    EFF_FROM_DATE)\r\nSELECT AGENCY_AK_ID, EFF_FROM_DATE FROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.AGENCY WHERE CREATED_DATE >= '@{pipeline().parameters.SELECTION_START_TS}'\r\nUNION\r\nSELECT AGENCY_AK_ID, EFF_FROM_DATE FROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.AGENCY_ADDRESS WHERE CREATED_DATE >= '@{pipeline().parameters.SELECTION_START_TS}'\r\nUNION\r\nSELECT AGENCY_AK_ID, EFF_FROM_DATE FROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.AGENCY_UNDERWRITER WHERE CREATED_DATE >= '@{pipeline().parameters.SELECTION_START_TS}'\r\nUNION\r\nSELECT B.AGENCY_AK_ID,A.EFF_FROM_DATE FROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.UNDERWRITER A, @{pipeline().parameters.SOURCE_TABLE_OWNER}.AGENCY_UNDERWRITER B\r\nWHERE A.UW_AK_ID = B.UW_AK_ID AND A.CREATED_DATE >= '@{pipeline().parameters.SELECTION_START_TS}'\r\nUNION\r\nSELECT C.AGENCY_AK_ID, A.EFF_FROM_DATE FROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.UNDERWRITER_TERRITORY A, @{pipeline().parameters.SOURCE_TABLE_OWNER}.UNDERWRITER B,@{pipeline().parameters.SOURCE_TABLE_OWNER}.AGENCY_UNDERWRITER C\r\nWHERE A.UW_AK_ID = B.UW_AK_ID AND B.UW_AK_ID = C.UW_AK_ID AND A.CREATED_DATE >= '@{pipeline().parameters.SELECTION_START_TS}'\r\nUNION\r\nSELECT C.AGENCY_AK_ID, A.EFF_FROM_DATE FROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.UNDERWRITER_MANAGER A,@{pipeline().parameters.SOURCE_TABLE_OWNER}.UNDERWRITER_TERRITORY B, @{pipeline().parameters.SOURCE_TABLE_OWNER}.AGENCY_UNDERWRITER C\r\nWHERE A.UW_MGR_AK_ID = B.UW_MGR_AK_ID AND C.UW_AK_ID = B.UW_AK_ID\r\nAND A.CREATED_DATE >= '@{pipeline().parameters.SELECTION_START_TS}'\n----------------------\n\n\n\tSELECT\r\n\t\r\n\tAGENCY.AGENCY_ID,\r\n\tAGENCY.AGENCY_AK_ID,\r\n\tAGENCY.RSM_TERR_SYM,\r\n\tISNULL(AGENCY.RSM_TERR_CODE,0) RSM_TERR_CODE,\r\n\tAGENCY.RSM_TERR_NAME,\r\n\tAGENCY.RSM_FULL_NAME,\r\n\tAGENCY.PRIM_AGENCY_STATE_CODE,\r\n\tAGENCY.PRIM_AGENCY_STATE_ABBREV,\r\n\tAGENCY.PRIM_AGENCY_STATE_DESCRIPT,\r\n\tAGENCY.PRIM_AGENCY_NUM,\r\n\tAGENCY.PRIM_AGENCY_KEY,\r\n\tAGENCY.PRIM_AGENCY_NAME,\r\n\tAGENCY.AGENCY_STATE_CODE,\r\n\tAGENCY.AGENCY_STATE_ABBREV,\r\n\tAGENCY.AGENCY_STATE_DESCRIPT,\r\n\tAGENCY.AGENCY_NUM,\r\n\tAGENCY.AGENCY_KEY,\r\n\tAGENCY.AGENCY_NAME,\r\n\tAGENCY.AGENCY_PAY_CODE,\r\n\tAGENCY.AGENCY_PAY_CODE_EFF_FROM_DATE,\r\n\tAGENCY.AGENCY_PAY_CODE_EFF_TO_DATE,\r\n\tAGENCY.DIRCONN_PER_DATE,\r\n\tAGENCY.DIRCONN_COMM_DATE,\r\n\tDISTINCT_EFF_DATES.EFF_FROM_DATE,\r\n\t\r\n\tCASE WHEN AGENCY_UNDERWRITER.AGENCY_UW_ID IS NULL THEN -1 ELSE AGENCY_UNDERWRITER.AGENCY_UW_ID END AS AGENCY_UW_ID,\r\n\t\r\n\tCASE WHEN UNDERWRITER.UW_ID IS NULL THEN -1 ELSE UNDERWRITER.UW_ID END AS UW_ID,\r\n\t\r\n\tCASE WHEN UNDERWRITER_TERRITORY.UW_TERR_ID IS NULL THEN -1 ELSE UNDERWRITER_TERRITORY.UW_TERR_ID END AS UW_TERR_ID,\r\n\t\r\n\tCASE WHEN UNDERWRITER_MANAGER.UW_MGR_ID IS NULL THEN -1 ELSE UNDERWRITER_MANAGER.UW_MGR_ID END AS UW_MGR_ID,\r\n\t\r\n\tCASE WHEN AGENCY_ADDRESS.AGENCY_ADDRESS_ID IS NULL THEN -1 ELSE AGENCY_ADDRESS.AGENCY_ADDRESS_ID END AS AGENCY_ADDRESS_ID,\r\n\t\r\n\tCASE WHEN UNDERWRITER_TERRITORY.TERR_CODE IS NULL THEN 'N/A' ELSE RTRIM(UNDERWRITER_TERRITORY.TERR_CODE) END AS TERR_CODE,\r\n\t\r\n\tCASE WHEN UNDERWRITER.UW_CODE IS NULL THEN 'N/A' ELSE UW_CODE END AS UW_CODE,\r\n\t\r\n\tCASE WHEN RTRIM(UNDERWRITER.UW_FIRST_NAME) IS NULL THEN 'N/A' ELSE RTRIM(UNDERWRITER.UW_FIRST_NAME) END AS UW_FIRST_NAME,\r\n\t\r\n\tCASE WHEN RTRIM(UNDERWRITER.UW_LAST_NAME) IS NULL THEN 'N/A' ELSE RTRIM(UNDERWRITER.UW_LAST_NAME) END AS UW_LAST_NAME,\r\n\t\r\n\tCASE WHEN UNDERWRITER_MANAGER.SOURCE_UW_MGR_ID IS NULL THEN -1 ELSE UNDERWRITER_MANAGER.SOURCE_UW_MGR_ID END AS SOURCE_UW_MGR_ID,\r\n\t\r\n\tCASE WHEN RTRIM(UNDERWRITER_MANAGER.UW_MGR_FIRST_NAME) IS NULL THEN 'N/A' ELSE RTRIM(UNDERWRITER_MANAGER.UW_MGR_FIRST_NAME) END AS UW_MGR_FIRST_NAME,\r\n\t\r\n\tCASE WHEN RTRIM(UNDERWRITER_MANAGER.UW_MGR_LAST_NAME) IS NULL THEN 'N/A' ELSE RTRIM(UNDERWRITER_MANAGER.UW_MGR_LAST_NAME) END AS UW_MGR_LAST_NAME,\r\n\t\r\n\tCASE WHEN RTRIM(AGENCY_ADDRESS.AGENCY_ADDRESS) IS NULL THEN 'N/A' ELSE RTRIM(AGENCY_ADDRESS.AGENCY_ADDRESS) END AS AGENCY_ADDRESS,\r\n\t\r\n\tCASE WHEN RTRIM(AGENCY_ADDRESS.CITY) IS NULL THEN 'N/A' ELSE RTRIM(AGENCY_ADDRESS.CITY) END AS CITY,\r\n\t\r\n\tCASE WHEN RTRIM(AGENCY_ADDRESS.POSTAL_CODE) IS NULL THEN 'N/A' ELSE RTRIM(AGENCY_ADDRESS.POSTAL_CODE) END AS POSTAL_CODE\r\n\t\r\n\tFROM\r\n\t\r\n\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.work_v2_agency DISTINCT_EFF_DATES\r\n\t\r\n\tLEFT OUTER JOIN @{pipeline().parameters.SOURCE_TABLE_OWNER}.AGENCY AGENCY ON DISTINCT_EFF_DATES.AGENCY_AK_ID = AGENCY.AGENCY_AK_ID\r\n\tAND DISTINCT_EFF_DATES.EFF_FROM_DATE BETWEEN AGENCY.EFF_FROM_DATE AND AGENCY.EFF_TO_DATE\r\n\t\r\n\tLEFT OUTER JOIN @{pipeline().parameters.SOURCE_TABLE_OWNER}.AGENCY_UNDERWRITER AGENCY_UNDERWRITER\r\n\tON AGENCY.AGENCY_AK_ID = AGENCY_UNDERWRITER.AGENCY_AK_ID\r\n\tAND DISTINCT_EFF_DATES.EFF_FROM_DATE BETWEEN AGENCY_UNDERWRITER.EFF_FROM_DATE AND AGENCY_UNDERWRITER.EFF_TO_DATE\r\n\t\r\n\tLEFT OUTER JOIN @{pipeline().parameters.SOURCE_TABLE_OWNER}.UNDERWRITER UNDERWRITER\r\n\tON AGENCY_UNDERWRITER.UW_AK_ID = UNDERWRITER.UW_AK_ID\r\n\tAND DISTINCT_EFF_DATES.EFF_FROM_DATE BETWEEN UNDERWRITER.EFF_FROM_DATE AND UNDERWRITER.EFF_TO_DATE\r\n\t\r\n\tLEFT OUTER JOIN @{pipeline().parameters.SOURCE_TABLE_OWNER}.UNDERWRITER_TERRITORY UNDERWRITER_TERRITORY\r\n\tON UNDERWRITER.UW_AK_ID = UNDERWRITER_TERRITORY.UW_AK_ID\r\n\tAND DISTINCT_EFF_DATES.EFF_FROM_DATE BETWEEN UNDERWRITER_TERRITORY.EFF_FROM_DATE AND UNDERWRITER_TERRITORY.EFF_TO_DATE\r\n\t\r\n\t--LEFT OUTER JOIN @{pipeline().parameters.SOURCE_TABLE_OWNER}.UNDERWRITER_MANAGER UNDERWRITER_MANAGER\r\n\t---ON UNDERWRITER_TERRITORY.UW_MGR_AK_ID = UNDERWRITER_MANAGER.UW_MGR_AK_ID\r\n\t---AND DISTINCT_EFF_DATES.EFF_FROM_DATE BETWEEN -------UNDERWRITER_MANAGER.EFF_FROM_DATE AND UNDERWRITER_MANAGER.EFF_TO_DATE\r\n\t\r\n\tLEFT OUTER JOIN @{pipeline().parameters.SOURCE_TABLE_OWNER}.UNDERWRITER_MANAGER UNDERWRITER_MANAGER\r\n\tON UNDERWRITER_TERRITORY.UW_MGR_AK_ID = UNDERWRITER_MANAGER.UW_MGR_AK_ID\r\n\tAND UNDERWRITER_TERRITORY.UW_AK_ID = AGENCY_UNDERWRITER.UW_AK_ID   --\r\n\tAND AGENCY_UNDERWRITER.insurance_line IN ('C','D')\r\n\tAND DISTINCT_EFF_DATES.EFF_FROM_DATE BETWEEN UNDERWRITER_MANAGER.EFF_FROM_DATE \r\n\tAND UNDERWRITER_MANAGER.EFF_TO_DATE\r\n\t\r\n\tLEFT OUTER JOIN @{pipeline().parameters.SOURCE_TABLE_OWNER}.AGENCY_ADDRESS AGENCY_ADDRESS\r\n\tON AGENCY.AGENCY_AK_ID = AGENCY_ADDRESS.AGENCY_AK_ID\r\n\tAND DISTINCT_EFF_DATES.EFF_FROM_DATE BETWEEN AGENCY_ADDRESS.EFF_FROM_DATE AND AGENCY_ADDRESS.EFF_TO_DATE\r\n\t \r\n\t \r\n\tORDER BY 1,2\n),\nEXPTRANS AS (\n\tSELECT\n\tagency_id,\n\tagency_uw_id,\n\t-1 AS producer_code_id,\n\tuw_id,\n\tuw_terr_id,\n\tuw_mgr_id,\n\tagency_address_id,\n\trsm_terr_code,\n\trsm_terr_name,\n\trsm_full_name,\n\tprim_agency_state_code,\n\tprim_agency_state_abbrev,\n\tprim_agency_state_descript,\n\tprim_agency_num,\n\tprim_agency_key,\n\tprim_agency_name,\n\tagency_state_code,\n\tagency_state_abbrev,\n\tagency_state_descript,\n\tagency_num,\n\tagency_key,\n\tagency_name,\n\tagency_pay_code,\n\tagency_pay_code_eff_from_date,\n\tagency_pay_code_eff_to_date,\n\t'N/A' AS prdcr_code,\n\tterr_code,\n\tuw_code,\n\tuw_first_name,\n\tuw_last_name,\n\tuw_first_name || ' ' || uw_last_name AS uw_full_name,\n\tsource_uw_mgr_id,\n\tuw_mgr_first_name,\n\tuw_mgr_last_name,\n\tuw_mgr_first_name || ' ' || uw_mgr_last_name AS uw_mgr_full_name,\n\trsm_terr_sym,\n\tdirconn_per_date,\n\tdirconn_comm_date,\n\tagency_address,\n\tcity,\n\tpostal_code,\n\t1 AS crrnt_snpsht_flag,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS audit_id,\n\teff_from_date AS eff_from_dt,\n\t-- *INF*: TO_DATE('12/31/2100 23:59:59', 'MM/DD/YYYY HH24:MI:SS')\n\tTO_DATE('12/31/2100 23:59:59', 'MM/DD/YYYY HH24:MI:SS') AS eff_to_dt,\n\tsysdate AS cr_mod_dt,\n\tagency_ak_id,\n\t'N/A' AS DEFAULT_STR,\n\t-- *INF*: TO_DATE('1/1/1800','MM/DD/YYYY')\n\tTO_DATE('1/1/1800', 'MM/DD/YYYY') AS DEFAULT_DATE\n\tFROM SQ_agency\n),\nLKP_agency_underwriter AS (\n\tSELECT\n\tagency_uw_id,\n\tinsurance_line,\n\tuw_code,\n\tagency_ak_id\n\tFROM (\n\t\tSELECT      \r\n\t\t    aa.agency_uw_id as agency_uw_id\r\n\t\t, RTRIM(LTRIM(aa.insurance_line)) as insurance_line \r\n\t\t  ,aa.agency_ak_id as agency_ak_id\r\n\t\t    ,a.uw_code as uw_code    \r\n\t\t  FROM      @{pipeline().parameters.SOURCE_TABLE_OWNER}.underwriter a,\r\n\t\t     @{pipeline().parameters.SOURCE_TABLE_OWNER}.agency_underwriter aa\r\n\t\t  where a.uw_ak_id = aa.uw_ak_id\r\n\t\t   and  RTRIM(LTRIM(aa.insurance_line)) IN ( 'C','D')  --- Commercial Lines/NSI\r\n\t\t   and  a.crrnt_snpsht_flag = 1\r\n\t\t   and  aa.crrnt_snpsht_flag = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY uw_code,agency_ak_id ORDER BY agency_uw_id DESC) = 1\n),\nLKP_sup_underwriter_manager_region AS (\n\tSELECT\n\tagency_num,\n\tagency_state,\n\tbus_unit_ind,\n\tuw_mgr_region,\n\tuw_mgr\n\tFROM (\n\t\tSELECT b.agency_num as agency_num\r\n\t\t                 ,b.agency_state as agency_state\r\n\t\t                  ,b.bus_unit_ind as bus_unit_ind \r\n\t\t                 ,b.uw_mgr_region    as uw_mgr_region    \r\n\t\t                  ,b.uw_mgr    as uw_mgr    \r\n\t\tFROM (\r\n\t\tSELECT   \r\n\t\t    a.agency_num as agency_num\r\n\t\t   ,a.agency_state as agency_state\r\n\t\t   ,a.bus_unit_ind as bus_unit_ind \r\n\t\t   ,CASE WHEN RTRIM(a.uw_mgr_region) IS NULL THEN 'N/A' ELSE RTRIM(a.uw_mgr_region) END as uw_mgr_region  \r\n\t\t   ,CASE WHEN RTRIM(a.uw_mgr) IS NULL THEN 'N/A' ELSE RTRIM(a.uw_mgr) END as uw_mgr\r\n\t\t  FROM  @{pipeline().parameters.SOURCE_TABLE_OWNER}.sup_underwriter_manager_region a\r\n\t\t  where a.crrnt_snpsht_flag = 1) b\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY agency_num,agency_state ORDER BY agency_num DESC) = 1\n),\nEXP_DET_MRG_REGION AS (\n\tSELECT\n\tLKP_sup_underwriter_manager_region.bus_unit_ind AS LKP_bus_unit_ind,\n\tLKP_sup_underwriter_manager_region.uw_mgr_region AS LKP_uw_mgr_region,\n\tLKP_sup_underwriter_manager_region.uw_mgr AS LKP_uw_mgr,\n\tEXPTRANS.uw_mgr_full_name AS in_uw_mgr_full_name,\n\tLKP_agency_underwriter.agency_uw_id AS LKP_agency_uw_id,\n\tLKP_agency_underwriter.insurance_line AS LKP_insurance_line,\n\t-- *INF*: IIF(ISNULL(LKP_agency_uw_id),'N/A',IIF(  LKP_insurance_line = 'D',in_uw_mgr_full_name,LKP_uw_mgr))\r\n\t-- \r\n\t--  \r\n\t--  \n\tIFF(LKP_agency_uw_id IS NULL, 'N/A', IFF(LKP_insurance_line = 'D', in_uw_mgr_full_name, LKP_uw_mgr)) AS v_uw_mgr_full_name,\n\t-- *INF*: IIF(ISNULL(LKP_agency_uw_id) OR LKP_insurance_line = 'D'  ,'N/A',LKP_uw_mgr_region)\n\tIFF(LKP_agency_uw_id IS NULL OR LKP_insurance_line = 'D', 'N/A', LKP_uw_mgr_region) AS v_uw_mgr_region,\n\t-- *INF*: IIF(ISNULL(LKP_agency_uw_id) OR LKP_insurance_line = 'D' ,'N/A',LKP_bus_unit_ind)\n\tIFF(LKP_agency_uw_id IS NULL OR LKP_insurance_line = 'D', 'N/A', LKP_bus_unit_ind) AS v_bus_unit_ind,\n\tv_uw_mgr_full_name AS o_uw_mgr,\n\tv_uw_mgr_region AS o_uw_mgr_region,\n\tv_bus_unit_ind AS o_bus_unit_ind\n\tFROM EXPTRANS\n\tLEFT JOIN LKP_agency_underwriter\n\tON LKP_agency_underwriter.uw_code = EXPTRANS.uw_code AND LKP_agency_underwriter.agency_ak_id = EXPTRANS.agency_ak_id\n\tLEFT JOIN LKP_sup_underwriter_manager_region\n\tON LKP_sup_underwriter_manager_region.agency_num = EXPTRANS.agency_num AND LKP_sup_underwriter_manager_region.agency_state = EXPTRANS.agency_state_code\n),\nLKP_AGENCY_DIM AS (\n\tSELECT\n\tagency_dim_id,\n\tedw_agency_pk_id,\n\tedw_agency_uw_pk_id,\n\tedw_prdcr_code_pk_id,\n\tedw_uw_pk_id,\n\tedw_uw_mgr_pk_id,\n\tedw_agency_addr_pk_id,\n\tterr_code,\n\tin_agency_id,\n\tin_agency_uw_id,\n\tin_producer_code_id,\n\tin_uw_id1,\n\tin_uw_terr_id,\n\tin_uw_mgr_id1,\n\tin_agency_address_id,\n\tin_rsm_terr_code1,\n\tin_rsm_terr_name,\n\tin_rsm_full_name1,\n\tin_prim_agency_state_code1,\n\tin_prim_agency_state_abbrev1,\n\tin_prim_agency_state_descript1,\n\tin_prim_agency_num1,\n\tin_prim_agency_key1,\n\tin_prim_agency_name1,\n\tin_agency_state_code1,\n\tin_agency_state_abbrev1,\n\tin_agency_state_descript1,\n\tin_agency_num1,\n\tin_agency_key1,\n\tin_agency_name1,\n\tin_prdcr_code1,\n\tin_terr_code1,\n\tin_uw_code1,\n\tin_uw_full_name1,\n\tin_source_uw_mgr_id1,\n\tin_uw_mgr_full_name1,\n\tin_rsm_terr_sym1,\n\tin_dirconn_per_date,\n\tin_dirconn_comm_date1,\n\tin_agency_address,\n\tin_city,\n\tin_postal_code,\n\tcrrnt_snpsht_flag,\n\taudit_id,\n\teff_from_dt,\n\teff_to_dt,\n\tcr_mod_dt,\n\tagency_ak_id,\n\tin_agency_pay_code,\n\tin_agency_pay_code_eff_from_date,\n\tin_agency_pay_code_eff_to_date\n\tFROM (\n\t\tSELECT \r\n\t\tagency_dim.agency_dim_id as agency_dim_id, \r\n\t\tagency_dim.edw_agency_pk_id as edw_agency_pk_id, \r\n\t\tagency_dim.edw_agency_uw_pk_id as edw_agency_uw_pk_id, \r\n\t\tagency_dim.edw_prdcr_code_pk_id as edw_prdcr_code_pk_id, \r\n\t\tagency_dim.edw_uw_pk_id as edw_uw_pk_id, \r\n\t\tagency_dim.edw_uw_mgr_pk_id as edw_uw_mgr_pk_id, \r\n\t\tagency_dim.edw_agency_addr_pk_id as edw_agency_addr_pk_id, \r\n\t\trtrim(agency_dim.terr_code) as terr_code \r\n\t\tFROM \r\n\t\tV2.agency_dim agency_dim\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY edw_agency_pk_id,edw_agency_uw_pk_id,edw_prdcr_code_pk_id,edw_uw_pk_id,edw_uw_mgr_pk_id,edw_agency_addr_pk_id,terr_code ORDER BY agency_dim_id) = 1\n),\nFIL_EXISTING_ROWS AS (\n\tSELECT\n\tLKP_AGENCY_DIM.agency_dim_id AS in_agency_dim_id, \n\tLKP_AGENCY_DIM.in_agency_id, \n\tLKP_AGENCY_DIM.in_agency_uw_id, \n\tLKP_AGENCY_DIM.in_producer_code_id, \n\tLKP_AGENCY_DIM.in_uw_id1, \n\tLKP_AGENCY_DIM.in_uw_terr_id, \n\tLKP_AGENCY_DIM.in_uw_mgr_id1, \n\tLKP_AGENCY_DIM.in_agency_address_id, \n\tLKP_AGENCY_DIM.in_rsm_terr_code1, \n\tLKP_AGENCY_DIM.in_rsm_terr_name, \n\tLKP_AGENCY_DIM.in_rsm_full_name1, \n\tLKP_AGENCY_DIM.in_prim_agency_state_code1, \n\tLKP_AGENCY_DIM.in_prim_agency_state_abbrev1, \n\tLKP_AGENCY_DIM.in_prim_agency_state_descript1, \n\tLKP_AGENCY_DIM.in_prim_agency_num1, \n\tLKP_AGENCY_DIM.in_prim_agency_key1, \n\tLKP_AGENCY_DIM.in_prim_agency_name1, \n\tLKP_AGENCY_DIM.in_agency_state_code1, \n\tLKP_AGENCY_DIM.in_agency_state_abbrev1, \n\tLKP_AGENCY_DIM.in_agency_state_descript1, \n\tLKP_AGENCY_DIM.in_agency_num1, \n\tLKP_AGENCY_DIM.in_agency_key1, \n\tLKP_AGENCY_DIM.in_agency_name1, \n\tLKP_AGENCY_DIM.in_prdcr_code1, \n\tLKP_AGENCY_DIM.in_terr_code1, \n\tLKP_AGENCY_DIM.in_uw_code1, \n\tLKP_AGENCY_DIM.in_uw_full_name1, \n\tLKP_AGENCY_DIM.in_source_uw_mgr_id1, \n\tEXP_DET_MRG_REGION.o_uw_mgr AS in_uw_mgr_full_name1, \n\tLKP_AGENCY_DIM.in_rsm_terr_sym1, \n\tLKP_AGENCY_DIM.in_dirconn_per_date, \n\tLKP_AGENCY_DIM.in_dirconn_comm_date1, \n\tLKP_AGENCY_DIM.in_agency_address, \n\tLKP_AGENCY_DIM.in_city, \n\tLKP_AGENCY_DIM.in_postal_code, \n\tLKP_AGENCY_DIM.crrnt_snpsht_flag, \n\tLKP_AGENCY_DIM.audit_id, \n\tLKP_AGENCY_DIM.eff_from_dt, \n\tLKP_AGENCY_DIM.eff_to_dt, \n\tLKP_AGENCY_DIM.cr_mod_dt, \n\tLKP_AGENCY_DIM.agency_ak_id, \n\tEXP_DET_MRG_REGION.o_bus_unit_ind AS bus_unit_ind, \n\tEXP_DET_MRG_REGION.o_uw_mgr_region AS uw_mgr_region, \n\tLKP_sup_underwriter_manager_region.uw_mgr AS LKP_uw_mgr, \n\tLKP_AGENCY_DIM.in_agency_pay_code, \n\tLKP_AGENCY_DIM.in_agency_pay_code_eff_from_date, \n\tLKP_AGENCY_DIM.in_agency_pay_code_eff_to_date, \n\tEXPTRANS.DEFAULT_STR, \n\tEXPTRANS.DEFAULT_DATE\n\tFROM EXPTRANS\n\t -- Manually join with EXP_DET_MRG_REGION\n\tLEFT JOIN LKP_AGENCY_DIM\n\tON LKP_AGENCY_DIM.edw_agency_pk_id = EXPTRANS.agency_id AND LKP_AGENCY_DIM.edw_agency_uw_pk_id = EXPTRANS.agency_uw_id AND LKP_AGENCY_DIM.edw_prdcr_code_pk_id = EXPTRANS.producer_code_id AND LKP_AGENCY_DIM.edw_uw_pk_id = EXPTRANS.uw_id AND LKP_AGENCY_DIM.edw_uw_mgr_pk_id = EXPTRANS.uw_mgr_id AND LKP_AGENCY_DIM.edw_agency_addr_pk_id = EXPTRANS.agency_address_id AND LKP_AGENCY_DIM.terr_code = EXPTRANS.terr_code\n\tLEFT JOIN LKP_sup_underwriter_manager_region\n\tON LKP_sup_underwriter_manager_region.agency_num = EXPTRANS.agency_num AND LKP_sup_underwriter_manager_region.agency_state = EXPTRANS.agency_state_code\n\tWHERE ISNULL(in_agency_dim_id)\n),\nagency_dim_insert AS (\n\tINSERT INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.agency_dim\n\t(edw_agency_pk_id, edw_agency_uw_pk_id, edw_prdcr_code_pk_id, edw_uw_pk_id, edw_uw_terr_pk_id, edw_uw_mgr_pk_id, edw_agency_addr_pk_id, edw_agency_ak_id, rsm_terr_code, rsm_terr_descript, rsm_full_name, prim_agency_state_code, prim_agency_state_abbrev, prim_agency_state_descript, prim_agency_num, prim_agency_key, prim_agency_name, agency_state_code, agency_state_abbrev, agency_state_descript, agency_num, agency_key, agency_name, prdcr_code, terr_code, uw_code, uw_full_name, source_uw_mgr_id, uw_mgr_full_name, rsm_terr_sym, dirconnect_per_date, dirconn_comm_date, agency_addr, agency_city, agency_postal_code, crrnt_snpsht_flag, audit_id, eff_from_date, eff_to_date, created_date, modified_date, agency_pay_code, agency_pay_code_eff_from_date, agency_pay_code_eff_to_date, bus_unit_ind, uw_mgr_region)\n\tSELECT \n\tin_agency_id AS EDW_AGENCY_PK_ID, \n\tin_agency_uw_id AS EDW_AGENCY_UW_PK_ID, \n\tin_producer_code_id AS EDW_PRDCR_CODE_PK_ID, \n\tin_uw_id1 AS EDW_UW_PK_ID, \n\tin_uw_terr_id AS EDW_UW_TERR_PK_ID, \n\tin_uw_mgr_id1 AS EDW_UW_MGR_PK_ID, \n\tin_agency_address_id AS EDW_AGENCY_ADDR_PK_ID, \n\tagency_ak_id AS EDW_AGENCY_AK_ID, \n\tin_rsm_terr_code1 AS RSM_TERR_CODE, \n\tin_rsm_terr_name AS RSM_TERR_DESCRIPT, \n\tin_rsm_full_name1 AS RSM_FULL_NAME, \n\tin_prim_agency_state_code1 AS PRIM_AGENCY_STATE_CODE, \n\tin_prim_agency_state_abbrev1 AS PRIM_AGENCY_STATE_ABBREV, \n\tin_prim_agency_state_descript1 AS PRIM_AGENCY_STATE_DESCRIPT, \n\tin_prim_agency_num1 AS PRIM_AGENCY_NUM, \n\tin_prim_agency_key1 AS PRIM_AGENCY_KEY, \n\tin_prim_agency_name1 AS PRIM_AGENCY_NAME, \n\tin_agency_state_code1 AS AGENCY_STATE_CODE, \n\tin_agency_state_abbrev1 AS AGENCY_STATE_ABBREV, \n\tin_agency_state_descript1 AS AGENCY_STATE_DESCRIPT, \n\tin_agency_num1 AS AGENCY_NUM, \n\tin_agency_key1 AS AGENCY_KEY, \n\tin_agency_name1 AS AGENCY_NAME, \n\tin_prdcr_code1 AS PRDCR_CODE, \n\tin_terr_code1 AS TERR_CODE, \n\tin_uw_code1 AS UW_CODE, \n\tin_uw_full_name1 AS UW_FULL_NAME, \n\tin_source_uw_mgr_id1 AS SOURCE_UW_MGR_ID, \n\tin_uw_mgr_full_name1 AS UW_MGR_FULL_NAME, \n\tin_rsm_terr_sym1 AS RSM_TERR_SYM, \n\tin_dirconn_per_date AS DIRCONNECT_PER_DATE, \n\tin_dirconn_comm_date1 AS DIRCONN_COMM_DATE, \n\tin_agency_address AS AGENCY_ADDR, \n\tin_city AS AGENCY_CITY, \n\tin_postal_code AS AGENCY_POSTAL_CODE, \n\tCRRNT_SNPSHT_FLAG, \n\tAUDIT_ID, \n\teff_from_dt AS EFF_FROM_DATE, \n\teff_to_dt AS EFF_TO_DATE, \n\tcr_mod_dt AS CREATED_DATE, \n\tcr_mod_dt AS MODIFIED_DATE, \n\tin_agency_pay_code AS AGENCY_PAY_CODE, \n\tin_agency_pay_code_eff_from_date AS AGENCY_PAY_CODE_EFF_FROM_DATE, \n\tin_agency_pay_code_eff_to_date AS AGENCY_PAY_CODE_EFF_TO_DATE, \n\tBUS_UNIT_IND, \n\tUW_MGR_REGION\n\tFROM FIL_EXISTING_ROWS\n),\nSQ_agency_dim AS (\n\tSELECT\r\n\tagency_dim.agency_dim_id,\r\n\tagency_dim.edw_agency_ak_id,\r\n\tagency_dim.eff_from_date\r\n\tFROM\r\n\tV2.agency_dim agency_dim\r\n\tWHERE EXISTS\r\n\t(\r\n\tSELECT 1 FROM V2.agency_dim agency_dim2\r\n\twhere agency_dim.edw_agency_ak_id = agency_dim2.edw_agency_ak_id\r\n\tand agency_dim2.crrnt_snpsht_flag = 1\r\n\tgroup by agency_dim2.edw_agency_ak_id having count(distinct eff_from_date) > 1\r\n\t)\r\n\tand agency_dim.crrnt_snpsht_flag = 1\r\n\t\r\n\tOrder by 2,3\n),\nLKP_AGENCY_DIM_GET_TO_DATE AS (\n\tSELECT\n\teff_from_date,\n\teff_from_date1,\n\teff_to_date,\n\tedw_agency_ak_id,\n\tedw_agency_ak_id1\n\tFROM (\n\t\tSELECT\r\n\t\tmin(B.EFF_FROM_DATE) as eff_to_date,\r\n\t\tA.EFF_FROM_DATE as eff_from_date,\r\n\t\tA.edw_agency_ak_id as edw_agency_ak_id\r\n\t\t\r\n\t\tFROM\r\n\t\t(\r\n\t\tSELECT\r\n\t\tedw_agency_ak_id,\r\n\t\tEFF_FROM_DATE\r\n\t\tFROM\r\n\t\tv2.agency_dim\r\n\t\twhere crrnt_snpsht_flag=1\r\n\t\t) AS A,\r\n\t\t(\r\n\t\tSELECT\r\n\t\tedw_agency_ak_id,\r\n\t\tEFF_FROM_DATE\r\n\t\tFROM\r\n\t\tv2.agency_dim\r\n\t\twhere crrnt_snpsht_flag =1\r\n\t\t) AS B\r\n\t\tWHERE A.edw_agency_ak_id = B.edw_agency_ak_id\r\n\t\tAND B.EFF_FROM_DATE > A.EFF_FROM_DATE\r\n\t\t\r\n\t\tgroup by\r\n\t\tA.edw_agency_ak_id,\r\n\t\tA.EFF_FROM_DATE\r\n\t\t--\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY eff_from_date,edw_agency_ak_id ORDER BY eff_from_date) = 1\n),\nEXP_EFF_TO_DATE AS (\n\tSELECT\n\tSQ_agency_dim.agency_dim_id,\n\tLKP_AGENCY_DIM_GET_TO_DATE.eff_to_date,\n\t-- *INF*: iif(not isnull(eff_to_date),add_to_date(eff_to_date,'SS',-1))\n\tIFF(NOT eff_to_date IS NULL, add_to_date(eff_to_date, 'SS', - 1)) AS out_eff_to_date,\n\t0 AS crrnt_snpsht_flag,\n\tsysdate AS modified_date,\n\tLKP_AGENCY_DIM_GET_TO_DATE.edw_agency_ak_id AS exists_edw_agency_ak_id\n\tFROM SQ_agency_dim\n\tLEFT JOIN LKP_AGENCY_DIM_GET_TO_DATE\n\tON LKP_AGENCY_DIM_GET_TO_DATE.eff_from_date = SQ_agency_dim.eff_from_date AND LKP_AGENCY_DIM_GET_TO_DATE.edw_agency_ak_id = SQ_agency_dim.edw_agency_ak_id\n),\nFIL_NULL_EFF_TO_DATE AS (\n\tSELECT\n\tagency_dim_id, \n\texists_edw_agency_ak_id, \n\tout_eff_to_date, \n\tcrrnt_snpsht_flag, \n\tmodified_date\n\tFROM EXP_EFF_TO_DATE\n\tWHERE not isnull(exists_edw_agency_ak_id)\n),\nUPD_AGENCY_DIM_EXPIRE AS (\n\tSELECT\n\tagency_dim_id, \n\tout_eff_to_date, \n\tcrrnt_snpsht_flag, \n\tmodified_date\n\tFROM FIL_NULL_EFF_TO_DATE\n),\nagency_dim_expire AS (\n\tMERGE INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.agency_dim AS T\n\tUSING UPD_AGENCY_DIM_EXPIRE AS S\n\tON T.agency_dim_id = S.agency_dim_id\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.crrnt_snpsht_flag = S.crrnt_snpsht_flag, T.eff_to_date = S.out_eff_to_date, T.modified_date = S.modified_date\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "246509"
            },
            "WBMI_BATCH_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "905529"
            },
            "WBMI_SESSION_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "7604493"
            },
            "SELECTION_START_TS": {
                "type": "string",
                "defaultValue": "08/30/2023 02:30:45"
            },
            "SELECTION_END_TS": {
                "type": "string",
                "defaultValue": "08/31/2023 02:35:48"
            },
            "DBCONNECTION_SOURCE": {
                "type": "string",
                "defaultValue": "SQLServer_RPT_EDM_Claim"
            },
            "DBCONNECTION_TARGET": {
                "type": "string",
                "defaultValue": "SQLServer_WC_Data_Mart_Claim"
            },
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "DBO"
            },
            "TARGET_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "V2"
            },
            "SOURCE_SYSTEM_ID": {
                "type": "string",
                "defaultValue": "EXCEED AND PMS"
            }
        },
        "folder": {
            "name": "Claims DataMart/"
        },
        "annotations": []
    }
}