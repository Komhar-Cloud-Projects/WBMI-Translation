{
    "name": "s_m_POL_FEED_WorkCatastropheExposureLimit_DCT",
    "properties": {
        "activities": [
            {
                "name": "m_POL_FEED_WorkCatastropheExposureLimit_DCT",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nSQ_WorkCatastropheExposureTransaction AS (\n\tSELECT DISTINCT WCET.SourceSystemId,\r\n\t\tPOL.pol_key,\r\n\t\tRL.LocationUnitNumber,\r\n\t\tRC.SubLocationUnitNumber,\r\n\t\tNULL as VehicleNumber,\r\n\t\tWCET.BusinessType,\r\n\t\tLMT.CoverageLimitType,\r\n\t      FIRST_VALUE(LMT.CoverageLimitValue) OVER (PARTITION BY WCET.SourceSystemId, POL.pol_key, RL.LocationUnitNumber, RC.CoverageType, RC.SubLocationUnitNumber, WCET.BusinessType, LMT.CoverageLimitType ORDER BY pt.PremiumTransactionEffectiveDate desc, pt.PremiumTransactionEnteredDate desc,PT.Effectivedate desc, CLB.CreatedDate desc,lmt.coveragelimitvalue desc) AS CoverageLimitValue,\r\n\t\t0.0 as CostNew,\r\n\t      RC.CoverageType\r\n\tFROM @{pipeline().parameters.TARGET_DATABASE_NAME}.@{pipeline().parameters.TARGET_TABLE_OWNER}.WorkCatastropheExposureTransaction WCET\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PremiumTransaction PT ON WCET.PremiumTransactionAKId = PT.PremiumTransactionAKID\r\n\t\tAND PT.CurrentSnapshotFlag = 1\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.RatingCoverage RC ON PT.RatingCoverageAKID = RC.RatingCoverageAKID\r\n\t\tAND RC.EffectiveDate = PT.EffectiveDate\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PolicyCoverage PC ON PC.PolicyCoverageAKID = RC.PolicyCoverageAKID\r\n\t\tAND PC.CurrentSnapshotFlag = 1\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.RiskLocation RL ON PC.RiskLocationAKID = RL.RiskLocationAKID\r\n\t\tAND RL.CurrentSnapshotFlag = 1\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER_V2}.policy POL ON POL.pol_ak_id = RL.PolicyAKID\r\n\t\tAND POL.crrnt_snpsht_flag = 1\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.CoverageLimitBridge CLB ON CLB.PremiumTransactionAKId = PT.PremiumTransactionAKID\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.CoverageLimit LMT ON CLB.CoverageLimitId = LMT.CoverageLimitId\r\n\tWHERE WCET.BusinessType <> 'Commercial Auto'\r\n\tand LMT.CoverageLimitType Not In (@{pipeline().parameters.SUM_UP_LIMIT_TYPES}) \r\n\t\r\n\tUNION ALL\r\n\t\r\n\tSELECT DISTINCT WCET.SourceSystemId,\r\n\t\tPOL.pol_key,\r\n\t\tNULL as LocationUnitNumber,\r\n\t\tNULL as SubLocationUnitNumber,\r\n\t\tCDCA.VehicleNumber,\r\n\t\tWCET.BusinessType,\r\n\t\tNULL as CoverageLimitType,\r\n\t\tNULL as CoverageLimitValue,\r\n\t      FIRST_VALUE(CDCA.CostNew) OVER (PARTITION BY WCET.SourceSystemId, POL.pol_key, CDCA.VehicleNumber, WCET.BusinessType ORDER BY PT.PremiumTransactionEffectiveDate desc, PT.PremiumTransactionEnteredDate desc, PT.Effectivedate desc, CDCA.CreatedDate desc) AS CostNew,\r\n\t      RC.CoverageType\r\n\tFROM @{pipeline().parameters.TARGET_DATABASE_NAME}.@{pipeline().parameters.TARGET_TABLE_OWNER}.WorkCatastropheExposureTransaction WCET\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PremiumTransaction PT ON WCET.PremiumTransactionAKId = PT.PremiumTransactionAKID\r\n\t\tAND PT.CurrentSnapshotFlag = 1\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.RatingCoverage RC ON PT.RatingCoverageAKID = RC.RatingCoverageAKID\r\n\t\tAND RC.EffectiveDate = PT.EffectiveDate\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PolicyCoverage PC ON PC.PolicyCoverageAKID = RC.PolicyCoverageAKID\r\n\t\tAND PC.CurrentSnapshotFlag = 1\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.RiskLocation RL ON PC.RiskLocationAKID = RL.RiskLocationAKID\r\n\t\tAND RL.CurrentSnapshotFlag = 1\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER_V2}.policy POL ON POL.pol_ak_id = RL.PolicyAKID\r\n\t\tAND POL.crrnt_snpsht_flag = 1\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.CoverageDetailCommercialAuto CDCA ON CDCA.PremiumTransactionId = PT.PremiumTransactionId\r\n\tWHERE WCET.BusinessType = 'Commercial Auto'\r\n\t\r\n\t@{pipeline().parameters.WHERE_CLAUSE}\r\n\t\r\n\tUNION ALL\r\n\t\r\n\tselect distinct SourceSystemId,\r\n\t\t\t\t\tpol_key,\r\n\t\t\t\t\tLocationUnitNumber,\r\n\t\t\t\t\tSubLocationUnitNumber,\r\n\t\t\t\t\tVehicleNumber,\r\n\t\t\t\t\tBusinessType,\r\n\t\t\t\t\tCoverageLimitType,\r\n\t\t\t\t\tFIRST_VALUE(cast(CoverageLimitValue as varchar)) OVER (PARTITION BY SourceSystemId, pol_key, LocationUnitNumber, SubLocationUnitNumber, BusinessType,CoverageType, CoverageLimitType ORDER BY PremiumTransactionEffectiveDate desc, PremiumTransactionEnteredDate desc,Effectivedate desc, CreatedDate desc),\r\n\t\t\t\t\tCostNew,\r\n\t\t\t\t\tCoverageType\r\n\t\t\t\t\tfrom (\r\n\tSELECT DISTINCT WCET.SourceSystemId,\r\n\t\t\t\t\tPOL.pol_key,\r\n\t\t\t\t\tRL.LocationUnitNumber,\r\n\t\t\t\t\tRC.SubLocationUnitNumber,\r\n\t\t\t\t\tNULL as VehicleNumber,\r\n\t\t\t\t\tWCET.BusinessType,\r\n\t\t\t\t\tLMT.CoverageLimitType,\r\n\t\t\t\t\tRC.CoverageType,\r\n\t (Case When LMT.CoverageLimitType in ('Scheduled Property','Equipment Scheduled') then\r\n\t\t\t        Sum(cast(LMT.CoverageLimitValue as bigint)*CLB.CoverageLimitIDCount) OVER (PARTITION BY WCET.SourceSystemId, POL.pol_key, RL.LocationUnitNumber, RC.SubLocationUnitNumber, WCET.BusinessType, RC.CoverageType,LMT.CoverageLimitType ,pt.PremiumTransactionEffectiveDate , pt.PremiumTransactionEnteredDate ,PT.Effectivedate , CLB.CreatedDate ) \r\n\t              when LMT.CoverageLimitType in ('GKLL') then\r\n\t\t               max(cast(LMT.CoverageLimitValue as bigint)) OVER (PARTITION BY WCET.SourceSystemId, POL.pol_key, RL.LocationUnitNumber, RC.SubLocationUnitNumber, WCET.BusinessType, RC.CoverageType,LMT.CoverageLimitType ,pt.PremiumTransactionEffectiveDate , pt.PremiumTransactionEnteredDate ,PT.Effectivedate , CLB.CreatedDate ) \r\n\t\t\t\t     else\r\n\t\t\t\t\tSum(cast(LMT.CoverageLimitValue as bigint)) OVER (PARTITION BY WCET.SourceSystemId, POL.pol_key, RL.LocationUnitNumber, RC.SubLocationUnitNumber, WCET.BusinessType, RC.CoverageType,LMT.CoverageLimitType ,pt.PremiumTransactionEffectiveDate , pt.PremiumTransactionEnteredDate ,PT.Effectivedate , CLB.CreatedDate ) \r\n\t\t\t\t    end) AS CoverageLimitValue,\t\t\t  \r\n\t\t  pt.PremiumTransactionEffectiveDate , pt.PremiumTransactionEnteredDate ,PT.Effectivedate , CLB.CreatedDate,\r\n\t\t0.0 as CostNew\r\n\tFROM @{pipeline().parameters.TARGET_DATABASE_NAME}.@{pipeline().parameters.TARGET_TABLE_OWNER}.WorkCatastropheExposureTransaction WCET\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PremiumTransaction PT ON WCET.PremiumTransactionAKId = PT.PremiumTransactionAKID\r\n\t\tAND PT.CurrentSnapshotFlag = 1\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.RatingCoverage RC ON PT.RatingCoverageAKID = RC.RatingCoverageAKID\r\n\t\tAND RC.EffectiveDate = PT.EffectiveDate\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PolicyCoverage PC ON PC.PolicyCoverageAKID = RC.PolicyCoverageAKID\r\n\t\tAND PC.CurrentSnapshotFlag = 1\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.RiskLocation RL ON PC.RiskLocationAKID = RL.RiskLocationAKID\r\n\t\tAND RL.CurrentSnapshotFlag = 1\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER_V2}.policy POL ON POL.pol_ak_id = RL.PolicyAKID\r\n\t\tAND POL.crrnt_snpsht_flag = 1\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.CoverageLimitBridge CLB ON CLB.PremiumTransactionAKId = PT.PremiumTransactionAKID\r\n\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.CoverageLimit LMT ON CLB.CoverageLimitId = LMT.CoverageLimitId\r\n\tWHERE WCET.BusinessType <> 'Commercial Auto'\r\n\tand LMT.CoverageLimitType In (@{pipeline().parameters.SUM_UP_LIMIT_TYPES})  \r\n\t@{pipeline().parameters.WHERE_CLAUSE}\r\n\t) A\n),\nEXP_MetaData AS (\n\tSELECT\n\tSourceSystemId AS i_SourceSystemId,\n\tpol_key AS i_pol_key,\n\tLocationUnitNumber AS i_LocationUnitNumber,\n\tSubLocationUnitNumber AS i_SubLocationUnitNumber,\n\tVehicleNumber AS i_VehicleNumber,\n\tBusinessType AS i_BusinessType,\n\tCoverageLimitType AS i_CoverageLimitType,\n\tCoverageLimitValue AS i_CoverageLimitValue,\n\tCostNew AS i_CostNew,\n\tCoverageType AS i_CoverageType,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- i_BusinessType =  'Commercial Auto',\r\n\t-- 'TotalVehicleCost', \r\n\t-- i_BusinessType = 'SMARTbusiness' and IN(i_CoverageType, 'Earthquake', 'Building') and i_CoverageLimitType = 'Building', \r\n\t-- i_CoverageLimitType||i_CoverageType,\r\n\t-- i_CoverageLimitType)\r\n\t-- \r\n\t-- \r\n\t-- --IIF(i_BusinessType= 'Commercial Auto',\r\n\t-- --'TotalVehicleCost', \r\n\t-- --i_CoverageLimitType)\r\n\t-- \r\n\t-- --IIF(i_BusinessType= 'Commercial Auto', IIF(i_StatedAmount='1', 'StatedAmount', NULL), i_CoverageLimitType)\n\tDECODE(\n\t    TRUE,\n\t    i_BusinessType = 'Commercial Auto', 'TotalVehicleCost',\n\t    i_BusinessType = 'SMARTbusiness' and i_CoverageType IN ('Earthquake','Building') and i_CoverageLimitType = 'Building', i_CoverageLimitType || i_CoverageType,\n\t    i_CoverageLimitType\n\t) AS v_LimitType,\n\t-- *INF*: IIF(i_BusinessType= 'Commercial Auto', \r\n\t-- TO_CHAR(i_CostNew), \r\n\t-- i_CoverageLimitValue)\r\n\t-- \r\n\t-- --IIF(i_BusinessType= 'Commercial Auto', IIF(i_StatedAmount='1', TO_CHAR(i_CostNew), NULL), i_CoverageLimitValue)\n\tIFF(i_BusinessType = 'Commercial Auto', TO_CHAR(i_CostNew), i_CoverageLimitValue) AS v_LimitValue,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS o_AuditId,\n\tSYSDATE AS o_CreatedDate,\n\tSYSDATE AS o_ModifiedDate,\n\ti_SourceSystemId AS o_SourceSystemId,\n\ti_pol_key AS o_PolicyKey,\n\t-- *INF*: IIF(IN(i_BusinessType, 'Commercial Property','SBOP','SMARTbusiness','Dealers Physical Damage','Garagekeepers Liability','Commercial Inland Marine'), i_LocationUnitNumber,NULL)\n\tIFF(\n\t    i_BusinessType IN ('Commercial Property','SBOP','SMARTbusiness','Dealers Physical Damage','Garagekeepers Liability','Commercial Inland Marine'),\n\t    i_LocationUnitNumber,\n\t    NULL\n\t) AS o_LocationNumber,\n\t-- *INF*: IIF(IN(i_BusinessType, 'Commercial Property','SBOP','SMARTbusiness'),  i_SubLocationUnitNumber,NULL)\n\tIFF(\n\t    i_BusinessType IN ('Commercial Property','SBOP','SMARTbusiness'), i_SubLocationUnitNumber,\n\t    NULL\n\t) AS o_BuildingNumber,\n\t-- *INF*: IIF(i_BusinessType= 'Commercial Auto', i_VehicleNumber, NULL)\n\tIFF(i_BusinessType = 'Commercial Auto', i_VehicleNumber, NULL) AS o_VehicleNumber,\n\ti_BusinessType AS o_BusinessType,\n\t-- *INF*: SUBSTR(v_LimitType, INSTR(REG_REPLACE(v_LimitType,'[a-zA-Z]','#'),'#',1), LENGTH(v_LimitType))\r\n\t-- \r\n\t-- \r\n\t-- --RTRIM(LTRIM(REG_REPLACE(v_LimitType, '[^0-9]', '')))\n\tSUBSTR(v_LimitType, REGEXP_INSTR(REGEXP_REPLACE(v_LimitType, '[a-zA-Z]', '#'), '#', 1), LENGTH(v_LimitType)) AS o_LimitType,\n\tv_LimitValue AS o_LimitValue\n\tFROM SQ_WorkCatastropheExposureTransaction\n),\nFIL_NULL AS (\n\tSELECT\n\to_AuditId AS AuditId, \n\to_CreatedDate AS CreatedDate, \n\to_ModifiedDate AS ModifiedDate, \n\to_SourceSystemId AS SourceSystemId, \n\to_PolicyKey AS PolicyKey, \n\to_LocationNumber AS LocationNumber, \n\to_BuildingNumber AS BuildingNumber, \n\to_VehicleNumber AS VehicleNumber, \n\to_BusinessType AS BusinessType, \n\to_LimitType AS LimitType, \n\to_LimitValue AS LimitValue\n\tFROM EXP_MetaData\n\tWHERE NOT ISNULL(LimitType)\n),\nWorkCatastropheExposureLimit AS (\n\tTRUNCATE TABLE @{pipeline().parameters.TARGET_TABLE_OWNER}.WorkCatastropheExposureLimit;\n\tINSERT INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.WorkCatastropheExposureLimit\n\t(AuditId, CreatedDate, ModifiedDate, SourceSystemId, PolicyKey, LocationNumber, BuildingNumber, VehicleNumber, BusinessType, LimitType, LimitValue)\n\tSELECT \n\tAUDITID, \n\tCREATEDDATE, \n\tMODIFIEDDATE, \n\tSOURCESYSTEMID, \n\tPOLICYKEY, \n\tLOCATIONNUMBER, \n\tBUILDINGNUMBER, \n\tVEHICLENUMBER, \n\tBUSINESSTYPE, \n\tLIMITTYPE, \n\tLIMITVALUE\n\tFROM FIL_NULL\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "TARGET_DATABASE_NAME": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "TARGET_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "SOURCE_DATABASE_NAME": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "SOURCE_TABLE_OWNER_V2": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "SUM_UP_LIMIT_TYPES": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WHERE_CLAUSE": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            }
        },
        "folder": {
            "name": "PolicyDataServices/"
        },
        "annotations": []
    }
}