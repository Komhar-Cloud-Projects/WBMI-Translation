{
    "name": "s_m_CLM_DW_LOAD_Claim_Transaction_EXD_OFFSET_ONSET",
    "properties": {
        "activities": [
            {
                "name": "m_CLM_DW_LOAD_Claim_Transaction_EXD_OFFSET_ONSET",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nLKP_sup_convert_s3p_claim_transaction_code AS (\n\tSELECT\n\tedw_trans_code,\n\ts3p_financial_type_code,\n\ts3p_trans_code,\n\ts3p_trans_ctgry_code\n\tFROM (\n\t\tSELECT sup_convert_s3p_claim_transaction_code.edw_financial_type_code as edw_financial_type_code, sup_convert_s3p_claim_transaction_code.edw_trans_code as edw_trans_code, sup_convert_s3p_claim_transaction_code.edw_trans_ctgry_code as edw_trans_ctgry_code, sup_convert_s3p_claim_transaction_code.s3p_financial_type_code as s3p_financial_type_code, sup_convert_s3p_claim_transaction_code.s3p_trans_code as s3p_trans_code, sup_convert_s3p_claim_transaction_code.s3p_trans_ctgry_code as s3p_trans_ctgry_code \r\n\t\tFROM @{pipeline().parameters.TARGET_TABLE_OWNER}.sup_convert_s3p_claim_transaction_code\r\n\t\tWHERE crrnt_snpsht_flag = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY s3p_financial_type_code,s3p_trans_code,s3p_trans_ctgry_code ORDER BY edw_trans_code) = 1\n),\nLKP_sup_convert_pms_claim_transaction_code AS (\n\tSELECT\n\tedw_trans_code,\n\tpms_trans_code\n\tFROM (\n\t\tSELECT \n\t\t\tedw_trans_code,\n\t\t\tpms_trans_code\n\t\tFROM sup_convert_pms_claim_transaction_code\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY pms_trans_code ORDER BY edw_trans_code) = 1\n),\nLKP_Sup_Claim_Transaction_Code AS (\n\tSELECT\n\tsup_claim_trans_code_id,\n\ttrans_code\n\tFROM (\n\t\tSELECT \n\t\t\tsup_claim_trans_code_id,\n\t\t\ttrans_code\n\t\tFROM @{pipeline().parameters.TARGET_TABLE_OWNER}.sup_claim_transaction_code\n\t\tWHERE crrnt_snpsht_flag = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY trans_code ORDER BY sup_claim_trans_code_id) = 1\n),\nSEQ_Claim_Transaction AS (\n\tCREATE SEQUENCE SEQ_Claim_Transaction\n\tSTART = 0\n\tINCREMENT = 1;\n),\nSQ_Stage_Tables AS (\n\tSELECT\r\n\t tch_claim_nbr,\r\n\t MAX(off_onset_ts) as off_onset_ts,\r\n\t off_client_id \r\n\tFROM (\r\n\tSELECT \r\n\t A.tch_claim_nbr,\r\n\t A.off_onset_ts as off_onset_ts,\r\n\t B.off_client_id \r\n\t FROM \r\n\t        clm_offset_onset_stage A,\r\n\t        offset_onset_cov_stage B,\r\n\t        offset_onset_unit_stage C\r\n\t WHERE A.tch_claim_nbr = B.tch_claim_nbr\r\n\t        AND B.tch_claim_nbr = C.tch_claim_nbr\r\n\t        AND A.off_onset_ts = B.off_onset_ts\r\n\t        AND B.off_onset_ts = C.off_onset_ts\r\n\t         AND A.off_onset_ts > = '@{pipeline().parameters.SELECTION_START_TS}'\r\n\t        AND B.off_onset_ts > =  '@{pipeline().parameters.SELECTION_START_TS}'\r\n\t\r\n\tunion all\r\n\t\r\n\tSELECT \r\n\tA.ClaimOccurrenceKey as tch_claim_nbr,\r\n\tA.ClaimUpdateDate as off_onset_ts,\r\n\tA.ClaimantPartyKey as off_client_id \r\n\tFROM @{pipeline().parameters.EDW_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.WorkClaimCatastropheCodeOnsetOffset A\r\n\tjoin @{pipeline().parameters.EDW_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.claim_occurrence CO\r\n\ton A.ClaimOccurrenceAKID=CO.claim_occurrence_ak_id and CO.crrnt_snpsht_flag=1\r\n\twhere A.ClaimUpdateDate>='@{pipeline().parameters.SELECTION_START_TS}'\r\n\t) Src\r\n\tgroup by tch_claim_nbr, off_client_id\n),\nEXP_Default AS (\n\tSELECT\n\ttch_claim_nbr,\n\toff_onset_ts,\n\toff_client_id\n\tFROM SQ_Stage_Tables\n),\nLKP_Claim_Party_Occurrence_AK_ID AS (\n\tSELECT\n\tclaim_party_occurrence_ak_id,\n\tclaim_occurrence_ak_id,\n\tclaim_occurrence_type_code,\n\ts3p_claim_num,\n\tclaimant_num,\n\tclaim_party_role_code\n\tFROM (\n\t\tSELECT CPO.claim_party_occurrence_ak_id      AS claim_party_occurrence_ak_id,\r\n\t\t              CO.claim_occurrence_ak_id                         AS claim_occurrence_ak_id, \r\n\t\t       CO.claim_occurrence_type_code         AS claim_occurrence_type_code,\r\n\t\t       CO.s3p_claim_num                                     AS s3p_claim_num,\r\n\t\t       LTRIM(RTRIM(CO.claim_occurrence_key)) AS claimant_num,\r\n\t\t       LTRIM(RTRIM(CP.claim_party_key))      AS claim_party_role_code\r\n\t\tFROM   @{pipeline().parameters.TARGET_TABLE_OWNER}.claim_party_occurrence CPO,\r\n\t\t       @{pipeline().parameters.TARGET_TABLE_OWNER}.claim_party CP,\r\n\t\t       @{pipeline().parameters.TARGET_TABLE_OWNER}.claim_occurrence CO\r\n\t\tWHERE  CO.claim_occurrence_ak_id = CPO.claim_occurrence_ak_id\r\n\t\t       AND CP.claim_party_ak_id = CPO.claim_party_ak_id\r\n\t\t       AND CO.source_sys_id = '@{pipeline().parameters.SOURCE_SYSTEM_ID}'\r\n\t\t       AND CP.source_sys_id = '@{pipeline().parameters.SOURCE_SYSTEM_ID}'\r\n\t\t       AND CPO.source_sys_id = '@{pipeline().parameters.SOURCE_SYSTEM_ID}'\r\n\t\t       AND CPO.claim_party_role_code = 'CLMT'\r\n\t\t       AND CO.crrnt_snpsht_flag = 1\r\n\t\t       AND CP.crrnt_snpsht_flag = 1\r\n\t\t       AND CPO.crrnt_snpsht_flag = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY claimant_num,claim_party_role_code ORDER BY claim_party_occurrence_ak_id DESC) = 1\n),\nEXP_Lkp_Values AS (\n\tSELECT\n\tLKP_Claim_Party_Occurrence_AK_ID.claim_party_occurrence_ak_id,\n\tEXP_Default.tch_claim_nbr,\n\tEXP_Default.off_onset_ts,\n\tEXP_Default.off_client_id,\n\tLKP_Claim_Party_Occurrence_AK_ID.claim_occurrence_ak_id,\n\tLKP_Claim_Party_Occurrence_AK_ID.claim_occurrence_type_code,\n\tLKP_Claim_Party_Occurrence_AK_ID.s3p_claim_num\n\tFROM EXP_Default\n\tLEFT JOIN LKP_Claim_Party_Occurrence_AK_ID\n\tON LKP_Claim_Party_Occurrence_AK_ID.claimant_num = EXP_Default.tch_claim_nbr AND LKP_Claim_Party_Occurrence_AK_ID.claim_party_role_code = EXP_Default.off_client_id\n),\nSQL_Claim_Transaction AS (-- SQL_Claim_Transaction\n\n\t##############################################\n\n\t# TODO: Place holder for Custom transformation\n\n\t##############################################\n),\nEXP_Pass_Through AS (\n\tSELECT\n\tclaim_trans_id,\n\tclaim_trans_ak_id,\n\tclaimant_cov_det_ak_id,\n\tclaim_pay_ak_id,\n\tcause_of_loss,\n\treserve_ctgry,\n\ttype_disability,\n\tsar_id,\n\toffset_onset_ind,\n\tfinancial_type_code,\n\ts3p_trans_code,\n\tpms_trans_code,\n\ttrans_code,\n\toff_onset_ts_output,\n\ttrans_date,\n\ts3p_updated_date,\n\ts3p_to_pms_trans_date,\n\tpms_acct_entered_date,\n\ttrans_base_type_code,\n\ttrans_ctgry_code,\n\ttrans_amt,\n\ttrans_hist_amt,\n\ttrans_rsn,\n\tdraft_num,\n\tsingle_check_ind,\n\toffset_reissue_ind,\n\treprocess_date,\n\ttrans_entry_oper_id,\n\twc_stage_pk_id,\n\terr_flag,\n\tcrrnt_snpsht_flag,\n\taudit_id,\n\teff_from_date,\n\teff_to_date,\n\tsource_sys_id,\n\tcreated_date,\n\tmodified_date,\n\ttax_id,\n\tclaim_master_1099_list_ak_id,\n\ts3p_created_date,\n\ttch_claim_nbr_output AS tch_claim_nbr,\n\toff_client_id_output AS off_client_id,\n\tCauseOfLossID,\n\tSupReserveCategoryCodeID,\n\tFinancialTypeCodeID,\n\tS3PTransactionCodeID,\n\tPMSTransactionCodeID,\n\tTransactionCodeID,\n\tSupTransactionCategoryCodeID\n\tFROM SQL_Claim_Transaction\n),\nRTR_Offset_Onset AS (\n\tSELECT\n\tclaim_trans_id,\n\tclaim_trans_ak_id,\n\tclaimant_cov_det_ak_id,\n\tclaim_pay_ak_id,\n\tcause_of_loss,\n\treserve_ctgry,\n\ttype_disability,\n\tsar_id,\n\toffset_onset_ind,\n\tfinancial_type_code,\n\ts3p_trans_code,\n\tpms_trans_code,\n\ttrans_code,\n\toff_onset_ts_output,\n\ttrans_date,\n\ts3p_updated_date,\n\ts3p_to_pms_trans_date,\n\tpms_acct_entered_date,\n\ttrans_base_type_code,\n\ttrans_ctgry_code,\n\ttrans_amt,\n\ttrans_hist_amt,\n\ttrans_rsn,\n\tdraft_num,\n\tsingle_check_ind,\n\toffset_reissue_ind,\n\treprocess_date,\n\ttrans_entry_oper_id,\n\twc_stage_pk_id,\n\terr_flag,\n\tcrrnt_snpsht_flag,\n\taudit_id,\n\teff_from_date,\n\teff_to_date,\n\tsource_sys_id,\n\tcreated_date,\n\tmodified_date,\n\ttax_id,\n\tclaim_master_1099_list_ak_id,\n\ts3p_created_date,\n\tCauseOfLossID,\n\tSupReserveCategoryCodeID,\n\tFinancialTypeCodeID,\n\tS3PTransactionCodeID,\n\tPMSTransactionCodeID,\n\tTransactionCodeID,\n\tSupTransactionCategoryCodeID\n\tFROM EXP_Pass_Through\n),\nRTR_Offset_Onset_OFFSET_UPDATE AS (SELECT * FROM RTR_Offset_Onset WHERE IN(pms_trans_code,'90','92','40','41','42','43', '65', '66','91','21','22','23','24','26','27','28','29','37','71','72','73','75','76','77','78','79','81','82','83','84','86','87','88','89')\r\n\r\n\r\n---Add trans_code 77,78,79,'87' after defect was found.),\nRTR_Offset_Onset_ONSET_INSERT AS (SELECT * FROM RTR_Offset_Onset WHERE IN(pms_trans_code,'21','22','23','24','26','27','28','29','37','40','41','42','43','65','66','71','72','73','75','76','77','78'\r\n,'79','81','82','83','84', '86','87','88','89','90','91','92','95','97','98','99')),\nRTR_Offset_Onset_OFFSET_INSERT AS (SELECT * FROM RTR_Offset_Onset WHERE IN(pms_trans_code,'90','92','21','22','23','24','26','27','28','29','37','71','72','73','75','76','81','82','83','84','86','88','89','77')\r\n\r\n\r\n\r\n--- IN ('90','92',) and not in ('95','97','98','99') and not in ('43','65','66','40','41','42')\r\n----IN(pms_trans_code,'21','22','23','24','26','27','28','29','37','40','41','42','43','65','66','71','72','73','75','76',\r\n----'77','78','79','81','82','83','84','86','87','88','89','90','91','92','95','97','98','99')\r\n---- '87' is only code missing from above logic and Onset Offset PMS program doesnt talk about this code.),\nRTR_Offset_Onset_OFFSET_UPDATE_NONREG_RES AS (SELECT * FROM RTR_Offset_Onset WHERE IN(pms_trans_code,'95','97','98','99')\r\n\r\n\r\n---('21','22','23','24','26','27','28','29','37','40','41','42','43','65','66','71','72','73','75','76','77','78','79',\r\n----'81','82','83','84','86','87','88','89','90','91','92','95','97','98','99')),\nEXP_Offset_Insert AS (\n\tSELECT\n\tclaim_trans_id,\n\tclaim_trans_ak_id,\n\tclaimant_cov_det_ak_id,\n\tclaim_pay_ak_id,\n\tcause_of_loss,\n\treserve_ctgry,\n\ttype_disability,\n\tsar_id,\n\toffset_onset_ind,\n\t'O' AS trans_offset_onset_ind,\n\tfinancial_type_code,\n\ts3p_trans_code,\n\t'N/A' AS s3p_trans_code_out,\n\tpms_trans_code,\n\t-- *INF*: DECODE(TRUE,IN(pms_trans_code,'90','92'),'41',\r\n\t--                                     IN(pms_trans_code,'21','22','23','24','25','28','29'),'29',\r\n\t--                                     IN(pms_trans_code,'26','27','37'),'26',\r\n\t--                                     IN(pms_trans_code,'81','83','88'),'88',\r\n\t--                                     IN(pms_trans_code,'82','84','89'),'89',\r\n\t--                                     IN(pms_trans_code,'74','75','76'),'76',\r\n\t--                                     pms_trans_code='86','87',\r\n\t--                                     pms_trans_code='71','78',\r\n\t--                                     pms_trans_code='72','79',\r\n\t--                                     pms_trans_code='73','77',\r\n\t--                                     pms_trans_code)\r\n\t-- \r\n\t-- \r\n\t-- \n\tDECODE(\n\t    TRUE,\n\t    pms_trans_code IN ('90','92'), '41',\n\t    pms_trans_code IN ('21','22','23','24','25','28','29'), '29',\n\t    pms_trans_code IN ('26','27','37'), '26',\n\t    pms_trans_code IN ('81','83','88'), '88',\n\t    pms_trans_code IN ('82','84','89'), '89',\n\t    pms_trans_code IN ('74','75','76'), '76',\n\t    pms_trans_code = '86', '87',\n\t    pms_trans_code = '71', '78',\n\t    pms_trans_code = '72', '79',\n\t    pms_trans_code = '73', '77',\n\t    pms_trans_code\n\t) AS v_pms_trans_code,\n\tv_pms_trans_code AS pms_trans_code_out,\n\tv_pms_trans_code AS lkp_PMSTransactionCodeID,\n\ttrans_code,\n\t-- *INF*: :LKP.LKP_SUP_CONVERT_PMS_CLAIM_TRANSACTION_CODE(v_pms_trans_code)\n\tLKP_SUP_CONVERT_PMS_CLAIM_TRANSACTION_CODE_v_pms_trans_code.edw_trans_code AS v_trans_code,\n\t-- *INF*: IIF(RTRIM(v_trans_code) <> '0', v_trans_code, \r\n\t-- \tDECODE(TRUE, \tIN (v_pms_trans_code,'76','26','88','89'),IIF(trans_hist_amt = 0.0,'39','38'), \r\n\t-- \t\t\t\t\t\tIN (v_pms_trans_code,'27','83','84'),IIF(trans_amt = 0.0,'40','30')\r\n\t--  \t\t\t\t\t)\r\n\t-- )\r\n\t-- \r\n\t-- ---- Above rules are for Claim_Transaction_PMS mapping. Used these rules as logic is based on pms_trans_code.\n\tIFF(\n\t    RTRIM(v_trans_code) <> '0', v_trans_code,\n\t    DECODE(\n\t        TRUE,\n\t        v_pms_trans_code IN ('76','26','88','89'), IFF(\n\t            trans_hist_amt = 0.0, '39', '38'\n\t        ),\n\t        v_pms_trans_code IN ('27','83','84'), IFF(\n\t            trans_amt = 0.0, '40', '30'\n\t        )\n\t    )\n\t) AS trans_code_out,\n\toff_onset_ts_output,\n\ttrans_date,\n\t-- *INF*: IIF(v_pms_trans_code = '41',off_onset_ts_output,trans_date)\n\tIFF(v_pms_trans_code = '41', off_onset_ts_output, trans_date) AS trans_date_Out,\n\ts3p_updated_date,\n\ts3p_to_pms_trans_date,\n\tpms_acct_entered_date,\n\toff_onset_ts_output AS pms_acct_entered_date_Out,\n\ttrans_base_type_code,\n\ttrans_ctgry_code,\n\ttrans_amt,\n\t-- *INF*: IIF(v_pms_trans_code= '41', 0.0, -1* trans_amt)\n\tIFF(v_pms_trans_code = '41', 0.0, - 1 * trans_amt) AS trans_amt_Out,\n\ttrans_hist_amt,\n\t-- *INF*: IIF(v_pms_trans_code= '41', -1* trans_amt,-1 * trans_hist_amt )\n\tIFF(v_pms_trans_code = '41', - 1 * trans_amt, - 1 * trans_hist_amt) AS trans_hist_amt_Out,\n\ttrans_rsn,\n\tdraft_num,\n\tsingle_check_ind,\n\toffset_reissue_ind,\n\treprocess_date,\n\ttrans_entry_oper_id,\n\twc_stage_pk_id,\n\t-1 * wc_stage_pk_id AS wc_stage_pk_id_Out,\n\terr_flag,\n\tcrrnt_snpsht_flag,\n\taudit_id,\n\teff_from_date,\n\teff_to_date,\n\tsource_sys_id,\n\tcreated_date,\n\tmodified_date,\n\ttax_id,\n\tclaim_master_1099_list_ak_id,\n\ts3p_created_date,\n\tCauseOfLossID AS CauseOfLossID4,\n\tSupReserveCategoryCodeID AS SupReserveCategoryCodeID4,\n\tFinancialTypeCodeID AS FinancialTypeCodeID4,\n\tS3PTransactionCodeID AS S3PTransactionCodeID4,\n\tPMSTransactionCodeID AS PMSTransactionCodeID4,\n\tTransactionCodeID AS TransactionCodeID4,\n\tSupTransactionCategoryCodeID AS SupTransactionCategoryCodeID4\n\tFROM RTR_Offset_Onset_OFFSET_INSERT\n\tLEFT JOIN LKP_SUP_CONVERT_PMS_CLAIM_TRANSACTION_CODE LKP_SUP_CONVERT_PMS_CLAIM_TRANSACTION_CODE_v_pms_trans_code\n\tON LKP_SUP_CONVERT_PMS_CLAIM_TRANSACTION_CODE_v_pms_trans_code.pms_trans_code = v_pms_trans_code\n\n),\nEXP_Onset_Insert AS (\n\tSELECT\n\tclaim_trans_id,\n\tclaim_trans_ak_id,\n\tclaimant_cov_det_ak_id,\n\tclaim_pay_ak_id,\n\tcause_of_loss,\n\treserve_ctgry,\n\ttype_disability,\n\tsar_id,\n\toffset_onset_ind,\n\tfinancial_type_code,\n\ts3p_trans_code,\n\tpms_trans_code,\n\ttrans_code,\n\t'N' AS trans_offset_onset_ind,\n\toff_onset_ts_output,\n\ttrans_date,\n\ts3p_updated_date,\n\ts3p_to_pms_trans_date,\n\tpms_acct_entered_date,\n\t-- *INF*: IIF(IN(pms_trans_code,'90','92','95','97','98','99','43','65','66','91'),pms_acct_entered_date,off_onset_ts_output)\n\tIFF(\n\t    pms_trans_code IN ('90','92','95','97','98','99','43','65','66','91'), pms_acct_entered_date,\n\t    off_onset_ts_output\n\t) AS pms_acct_entered_date_Out,\n\ttrans_base_type_code,\n\ttrans_ctgry_code,\n\ttrans_amt,\n\ttrans_hist_amt,\n\ttrans_rsn,\n\tdraft_num,\n\tsingle_check_ind,\n\toffset_reissue_ind,\n\treprocess_date,\n\ttrans_entry_oper_id,\n\twc_stage_pk_id,\n\terr_flag,\n\tcrrnt_snpsht_flag,\n\teff_from_date,\n\teff_to_date,\n\tsource_sys_id,\n\tcreated_date,\n\tmodified_date,\n\ttax_id,\n\tclaim_master_1099_list_ak_id,\n\ts3p_created_date,\n\tCauseOfLossID AS CauseOfLossID3,\n\tSupReserveCategoryCodeID AS SupReserveCategoryCodeID3,\n\tFinancialTypeCodeID AS FinancialTypeCodeID3,\n\tS3PTransactionCodeID AS S3PTransactionCodeID3,\n\tPMSTransactionCodeID AS PMSTransactionCodeID3,\n\tTransactionCodeID AS TransactionCodeID3,\n\tSupTransactionCategoryCodeID AS SupTransactionCategoryCodeID3\n\tFROM RTR_Offset_Onset_ONSET_INSERT\n),\nUnion_Offset_Onset AS (\n\tSELECT claim_trans_id, claim_trans_ak_id, claimant_cov_det_ak_id, claim_pay_ak_id, cause_of_loss, reserve_ctgry, type_disability, sar_id, offset_onset_ind, financial_type_code, s3p_trans_code, pms_trans_code, trans_code, trans_date, s3p_updated_date, s3p_to_pms_trans_date, pms_acct_entered_date_Out AS pms_acct_entered_date, trans_base_type_code, trans_ctgry_code, trans_amt, trans_hist_amt, trans_rsn, draft_num, single_check_ind, offset_reissue_ind, reprocess_date, trans_entry_oper_id, wc_stage_pk_id, err_flag, crrnt_snpsht_flag, eff_from_date, eff_to_date, source_sys_id, created_date, modified_date, tax_id, claim_master_1099_list_ak_id, trans_offset_onset_ind, s3p_created_date, CauseOfLossID3 AS CauseOfLossID, SupReserveCategoryCodeID3 AS SupReserveCategoryCodeID, FinancialTypeCodeID3 AS FinancialTypeCodeID, S3PTransactionCodeID3 AS S3PTransactionCodeID, PMSTransactionCodeID3 AS PMSTransactionCodeID, TransactionCodeID3 AS TransactionCodeID, SupTransactionCategoryCodeID3 AS SupTransactionCategoryCodeID\n\tFROM EXP_Onset_Insert\n\tUNION\n\tSELECT claim_trans_id, claim_trans_ak_id, claimant_cov_det_ak_id, claim_pay_ak_id, cause_of_loss, reserve_ctgry, type_disability, sar_id, offset_onset_ind, financial_type_code, s3p_trans_code_out AS s3p_trans_code, pms_trans_code_out AS pms_trans_code, trans_code_out AS trans_code, trans_date_Out AS trans_date, s3p_updated_date, s3p_to_pms_trans_date, pms_acct_entered_date_Out AS pms_acct_entered_date, trans_base_type_code, trans_ctgry_code, trans_amt_Out AS trans_amt, trans_hist_amt_Out AS trans_hist_amt, trans_rsn, draft_num, single_check_ind, offset_reissue_ind, reprocess_date, trans_entry_oper_id, wc_stage_pk_id_Out AS wc_stage_pk_id, err_flag, crrnt_snpsht_flag, audit_id, eff_from_date, eff_to_date, source_sys_id, created_date, modified_date, tax_id, claim_master_1099_list_ak_id, trans_offset_onset_ind, s3p_created_date, CauseOfLossID4 AS CauseOfLossID, SupReserveCategoryCodeID4 AS SupReserveCategoryCodeID, FinancialTypeCodeID4 AS FinancialTypeCodeID, S3PTransactionCodeID4 AS S3PTransactionCodeID, PMSTransactionCodeID4 AS PMSTransactionCodeID, TransactionCodeID4 AS TransactionCodeID, SupTransactionCategoryCodeID4 AS SupTransactionCategoryCodeID\n\tFROM EXP_Offset_Insert\n),\nEXP_Claim_Trans_AK_ID AS (\n\tSELECT\n\tSEQ_Claim_Transaction.NEXTVAL,\n\tNEXTVAL AS Claim_trans_ak_id,\n\tclaimant_cov_det_ak_id,\n\tclaim_pay_ak_id,\n\tcause_of_loss,\n\treserve_ctgry,\n\ttype_disability,\n\tsar_id,\n\toffset_onset_ind AS offset_onset_ind_Out,\n\tfinancial_type_code,\n\ts3p_trans_code,\n\tpms_trans_code,\n\ttrans_code,\n\ttrans_date,\n\ts3p_updated_date,\n\ts3p_to_pms_trans_date,\n\tpms_acct_entered_date,\n\ttrans_base_type_code,\n\ttrans_ctgry_code,\n\ttrans_amt,\n\ttrans_hist_amt,\n\ttrans_rsn,\n\tdraft_num,\n\tsingle_check_ind,\n\toffset_reissue_ind,\n\treprocess_date,\n\ttrans_entry_oper_id,\n\twc_stage_pk_id,\n\terr_flag,\n\tcrrnt_snpsht_flag,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS audit_id,\n\t-- *INF*: TO_DATE('01/01/1800 01:00:00','MM/DD/YYYY HH24:MI:SS')\n\tTO_TIMESTAMP('01/01/1800 01:00:00', 'MM/DD/YYYY HH24:MI:SS') AS eff_from_date,\n\t-- *INF*: TO_DATE('12/31/2100 23:59:59','MM/DD/YYYY HH24:MI:SS')\n\tTO_TIMESTAMP('12/31/2100 23:59:59', 'MM/DD/YYYY HH24:MI:SS') AS eff_to_date,\n\t@{pipeline().parameters.SOURCE_SYSTEM_ID} AS source_sys_id,\n\ttax_id,\n\tclaim_master_1099_list_ak_id,\n\tSYSDATE AS Created_Date,\n\ttrans_offset_onset_ind,\n\ts3p_created_date,\n\tCauseOfLossID,\n\tSupReserveCategoryCodeID,\n\tFinancialTypeCodeID,\n\tS3PTransactionCodeID,\n\tPMSTransactionCodeID,\n\tTransactionCodeID,\n\tSupTransactionCategoryCodeID\n\tFROM Union_Offset_Onset\n),\nclaim_transaction_Insert AS (\n\tINSERT INTO claim_transaction\n\t(claim_trans_ak_id, claimant_cov_det_ak_id, claim_pay_ak_id, cause_of_loss, reserve_ctgry, type_disability, sar_id, offset_onset_ind, financial_type_code, s3p_trans_code, pms_trans_code, trans_code, trans_date, s3p_updated_date, s3p_to_pms_trans_date, pms_acct_entered_date, trans_base_type_code, trans_ctgry_code, trans_amt, trans_hist_amt, trans_rsn, draft_num, single_check_ind, offset_reissue_ind, reprocess_date, trans_entry_oper_id, wc_stage_pk_id, err_flag, crrnt_snpsht_flag, audit_id, eff_from_date, eff_to_date, source_sys_id, created_date, modified_date, tax_id, claim_master_1099_list_ak_id, trans_offset_onset_ind, s3p_created_date, CauseOfLossID, SupReserveCategoryCodeID, FinancialTypeCodeID, S3PTransactionCodeID, PMSTransactionCodeID, TransactionCodeID, SupTransactionCategoryCodeID)\n\tSELECT \n\tClaim_trans_ak_id AS CLAIM_TRANS_AK_ID, \n\tCLAIMANT_COV_DET_AK_ID, \n\tCLAIM_PAY_AK_ID, \n\tCAUSE_OF_LOSS, \n\tRESERVE_CTGRY, \n\tTYPE_DISABILITY, \n\tSAR_ID, \n\toffset_onset_ind_Out AS OFFSET_ONSET_IND, \n\tFINANCIAL_TYPE_CODE, \n\tS3P_TRANS_CODE, \n\tPMS_TRANS_CODE, \n\tTRANS_CODE, \n\tTRANS_DATE, \n\tS3P_UPDATED_DATE, \n\tS3P_TO_PMS_TRANS_DATE, \n\tPMS_ACCT_ENTERED_DATE, \n\tTRANS_BASE_TYPE_CODE, \n\tTRANS_CTGRY_CODE, \n\tTRANS_AMT, \n\tTRANS_HIST_AMT, \n\tTRANS_RSN, \n\tDRAFT_NUM, \n\tSINGLE_CHECK_IND, \n\tOFFSET_REISSUE_IND, \n\tREPROCESS_DATE, \n\tTRANS_ENTRY_OPER_ID, \n\tWC_STAGE_PK_ID, \n\tERR_FLAG, \n\tCRRNT_SNPSHT_FLAG, \n\tAUDIT_ID, \n\tEFF_FROM_DATE, \n\tEFF_TO_DATE, \n\tSOURCE_SYS_ID, \n\tCreated_Date AS CREATED_DATE, \n\tCreated_Date AS MODIFIED_DATE, \n\tTAX_ID, \n\tCLAIM_MASTER_1099_LIST_AK_ID, \n\tTRANS_OFFSET_ONSET_IND, \n\tS3P_CREATED_DATE, \n\tCAUSEOFLOSSID, \n\tSUPRESERVECATEGORYCODEID, \n\tFINANCIALTYPECODEID, \n\tS3PTRANSACTIONCODEID, \n\tPMSTRANSACTIONCODEID, \n\tTRANSACTIONCODEID, \n\tSUPTRANSACTIONCATEGORYCODEID\n\tFROM EXP_Claim_Trans_AK_ID\n),\nEXP_Offset_Update AS (\n\tSELECT\n\tclaim_trans_id,\n\tclaim_trans_ak_id,\n\tclaimant_cov_det_ak_id,\n\tclaim_pay_ak_id,\n\tcause_of_loss,\n\treserve_ctgry,\n\ttype_disability,\n\tsar_id,\n\toffset_onset_ind,\n\t'O' AS trans_offset_onset_ind,\n\tfinancial_type_code,\n\ts3p_trans_code,\n\t-- *INF*: IIF(IN(s3p_trans_code,'90','92'),'91',s3p_trans_code)\n\tIFF(s3p_trans_code IN ('90','92'), '91', s3p_trans_code) AS v_s3p_trans_code,\n\tv_s3p_trans_code AS o_s3p_trans_code,\n\t-- *INF*: :LKP.LKP_SUP_CLAIM_TRANSACTION_CODE(v_s3p_trans_code)\n\tLKP_SUP_CLAIM_TRANSACTION_CODE_v_s3p_trans_code.sup_claim_trans_code_id AS lkp_S3PTransactionCodeID,\n\tpms_trans_code,\n\t-- *INF*: IIF(IN(pms_trans_code,'90','92'),'91',pms_trans_code)\n\tIFF(pms_trans_code IN ('90','92'), '91', pms_trans_code) AS v_pms_trans_code,\n\tv_pms_trans_code AS o_pms_trans_code,\n\t-- *INF*: :LKP.LKP_SUP_CLAIM_TRANSACTION_CODE(v_pms_trans_code)\n\tLKP_SUP_CLAIM_TRANSACTION_CODE_v_pms_trans_code.sup_claim_trans_code_id AS lkp_PMSTransactionCodeID,\n\ttrans_code,\n\toff_onset_ts_output,\n\t-- *INF*: IIF(IN(trans_code,'90','92'),'91',trans_code)\n\tIFF(trans_code IN ('90','92'), '91', trans_code) AS v_Claim_trans_code,\n\tv_Claim_trans_code AS o_trans_code,\n\t-- *INF*: :LKP.LKP_SUP_CLAIM_TRANSACTION_CODE(v_Claim_trans_code)\n\tLKP_SUP_CLAIM_TRANSACTION_CODE_v_Claim_trans_code.sup_claim_trans_code_id AS lkp_TransactionCodeID,\n\ttrans_date,\n\ts3p_updated_date,\n\ts3p_to_pms_trans_date,\n\tpms_acct_entered_date,\n\t-- *INF*: GREATEST(trans_date, pms_acct_entered_date)\n\tGREATEST(trans_date, pms_acct_entered_date) AS v_Greatest_trans_date_pms_acct_entered_date,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- IN(pms_trans_code,'90','92','95','97','98','99','43','65','66','91'),\r\n\t-- pms_acct_entered_date,\r\n\t-- TRUNC(v_Greatest_trans_date_pms_acct_entered_date,'MM')=TRUNC(off_onset_ts_output, 'MM'),\r\n\t-- off_onset_ts_output,\r\n\t-- SET_DATE_PART(SET_DATE_PART(SET_DATE_PART(LAST_DAY(v_Greatest_trans_date_pms_acct_entered_date), 'HH24', 23), 'MI', 59), 'SS',59)\r\n\t-- )\n\tDECODE(\n\t    TRUE,\n\t    pms_trans_code IN ('90','92','95','97','98','99','43','65','66','91'), pms_acct_entered_date,\n\t    CAST(TRUNC(v_Greatest_trans_date_pms_acct_entered_date, 'MONTH') AS TIMESTAMP_NTZ(0)) = CAST(TRUNC(off_onset_ts_output, 'MONTH') AS TIMESTAMP_NTZ(0)), off_onset_ts_output,\n\t    DATEADD(SECOND,59-DATE_PART(SECOND,DATEADD(MINUTE,59-DATE_PART(MINUTE,DATEADD(HOUR,23-DATE_PART(HOUR,LAST_DAY(v_Greatest_trans_date_pms_acct_entered_date)),LAST_DAY(v_Greatest_trans_date_pms_acct_entered_date))),DATEADD(HOUR,23-DATE_PART(HOUR,LAST_DAY(v_Greatest_trans_date_pms_acct_entered_date)),LAST_DAY(v_Greatest_trans_date_pms_acct_entered_date)))),DATEADD(MINUTE,59-DATE_PART(MINUTE,DATEADD(HOUR,23-DATE_PART(HOUR,LAST_DAY(v_Greatest_trans_date_pms_acct_entered_date)),LAST_DAY(v_Greatest_trans_date_pms_acct_entered_date))),DATEADD(HOUR,23-DATE_PART(HOUR,LAST_DAY(v_Greatest_trans_date_pms_acct_entered_date)),LAST_DAY(v_Greatest_trans_date_pms_acct_entered_date))))\n\t) AS o_pms_acct_entered_date,\n\ttrans_base_type_code,\n\ttrans_ctgry_code,\n\ttrans_amt,\n\t-- *INF*: IIF(IN(pms_trans_code,'90','92'),0.0,trans_amt)\n\tIFF(pms_trans_code IN ('90','92'), 0.0, trans_amt) AS trans_amt_Out,\n\ttrans_hist_amt,\n\ttrans_rsn,\n\tdraft_num,\n\tsingle_check_ind,\n\toffset_reissue_ind,\n\treprocess_date,\n\ttrans_entry_oper_id,\n\twc_stage_pk_id,\n\t-- *INF*: -1 * wc_stage_pk_id\r\n\t-- \r\n\t-- \r\n\t-- ----- For Offset record, when we update we want to make that record  have -ve stage pk id \n\t- 1 * wc_stage_pk_id AS wc_stage_pk_id_Out,\n\terr_flag,\n\tcrrnt_snpsht_flag,\n\taudit_id,\n\teff_from_date,\n\teff_to_date,\n\tsource_sys_id,\n\tcreated_date,\n\ttax_id,\n\tclaim_master_1099_list_ak_id,\n\tSYSDATE AS Modified_date,\n\tFinancialTypeCodeID,\n\t-- *INF*: IIF(ISNULL(lkp_S3PTransactionCodeID),-1,lkp_S3PTransactionCodeID)\n\tIFF(lkp_S3PTransactionCodeID IS NULL, - 1, lkp_S3PTransactionCodeID) AS o_S3PTransactionCodeID,\n\t-- *INF*: IIF(ISNULL(lkp_PMSTransactionCodeID),-1,lkp_PMSTransactionCodeID)\n\tIFF(lkp_PMSTransactionCodeID IS NULL, - 1, lkp_PMSTransactionCodeID) AS o_PMSTransactionCodeID,\n\t-- *INF*: IIF(ISNULL(lkp_TransactionCodeID),-1,lkp_TransactionCodeID)\n\tIFF(lkp_TransactionCodeID IS NULL, - 1, lkp_TransactionCodeID) AS o_TransactionCodeID\n\tFROM RTR_Offset_Onset_OFFSET_UPDATE\n\tLEFT JOIN LKP_SUP_CLAIM_TRANSACTION_CODE LKP_SUP_CLAIM_TRANSACTION_CODE_v_s3p_trans_code\n\tON LKP_SUP_CLAIM_TRANSACTION_CODE_v_s3p_trans_code.trans_code = v_s3p_trans_code\n\n\tLEFT JOIN LKP_SUP_CLAIM_TRANSACTION_CODE LKP_SUP_CLAIM_TRANSACTION_CODE_v_pms_trans_code\n\tON LKP_SUP_CLAIM_TRANSACTION_CODE_v_pms_trans_code.trans_code = v_pms_trans_code\n\n\tLEFT JOIN LKP_SUP_CLAIM_TRANSACTION_CODE LKP_SUP_CLAIM_TRANSACTION_CODE_v_Claim_trans_code\n\tON LKP_SUP_CLAIM_TRANSACTION_CODE_v_Claim_trans_code.trans_code = v_Claim_trans_code\n\n),\nUPD_Offset_Update AS (\n\tSELECT\n\tclaim_trans_id, \n\ttrans_offset_onset_ind, \n\to_s3p_trans_code, \n\to_pms_trans_code, \n\to_trans_code, \n\to_pms_acct_entered_date, \n\ttrans_amt_Out, \n\tModified_date, \n\twc_stage_pk_id_Out, \n\tFinancialTypeCodeID, \n\to_S3PTransactionCodeID, \n\to_PMSTransactionCodeID, \n\to_TransactionCodeID\n\tFROM EXP_Offset_Update\n),\nclaim_transaction_Update AS (\n\tMERGE INTO claim_transaction AS T\n\tUSING UPD_Offset_Update AS S\n\tON T.claim_trans_id = S.claim_trans_id\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.s3p_trans_code = S.o_s3p_trans_code, T.pms_trans_code = S.o_pms_trans_code, T.trans_code = S.o_trans_code, T.pms_acct_entered_date = S.o_pms_acct_entered_date, T.trans_amt = S.trans_amt_Out, T.wc_stage_pk_id = S.wc_stage_pk_id_Out, T.modified_date = S.Modified_date, T.trans_offset_onset_ind = S.trans_offset_onset_ind, T.FinancialTypeCodeID = S.FinancialTypeCodeID, T.S3PTransactionCodeID = S.o_S3PTransactionCodeID, T.PMSTransactionCodeID = S.o_PMSTransactionCodeID, T.TransactionCodeID = S.o_TransactionCodeID\n),\nEXP_Offset_Update_NonReg_Res AS (\n\tSELECT\n\tclaim_trans_id,\n\tclaim_trans_ak_id,\n\tclaimant_cov_det_ak_id,\n\tclaim_pay_ak_id,\n\tcause_of_loss,\n\treserve_ctgry,\n\ttype_disability,\n\tsar_id,\n\toffset_onset_ind,\n\t'O' AS trans_offset_onset_ind,\n\tfinancial_type_code,\n\ts3p_trans_code,\n\tpms_trans_code,\n\t-- *INF*: DECODE(TRUE,pms_trans_code='95','40'\r\n\t--                                    ,pms_trans_code='97','27'\r\n\t--                                    ,pms_trans_code='98','83'\r\n\t--                                    ,pms_trans_code='99','84')\r\n\t-- \n\tDECODE(\n\t    TRUE,\n\t    pms_trans_code = '95', '40',\n\t    pms_trans_code = '97', '27',\n\t    pms_trans_code = '98', '83',\n\t    pms_trans_code = '99', '84'\n\t) AS v_pms_trans_code,\n\tv_pms_trans_code AS o_pms_trans_code,\n\t-- *INF*: :LKP.LKP_SUP_CLAIM_TRANSACTION_CODE(v_pms_trans_code)\n\tLKP_SUP_CLAIM_TRANSACTION_CODE_v_pms_trans_code.sup_claim_trans_code_id AS lkp_PMSTransactionCodeID,\n\ttrans_code,\n\t-- *INF*: :LKP.LKP_SUP_CONVERT_PMS_CLAIM_TRANSACTION_CODE(v_pms_trans_code)\n\tLKP_SUP_CONVERT_PMS_CLAIM_TRANSACTION_CODE_v_pms_trans_code.edw_trans_code AS v_trans_code,\n\t-- *INF*: IIF(RTRIM(v_trans_code) <> '0', v_trans_code, \r\n\t-- \tDECODE(TRUE, \tIN (v_pms_trans_code,'76','26','88','89'),IIF(trans_hist_amt = 0.0,'39','38'), \r\n\t-- \t\t\t\t\t\tIN (v_pms_trans_code,'27','83','84'),IIF(trans_amt = 0.0,'40','30')\r\n\t--  \t\t\t\t\t)\r\n\t-- )\r\n\t-- \r\n\t-- --- Above rules are from Claim_Transaction_PMS mapping, as we are using PMS_trans_code, and since we are updating the pms_trans_code in this pipeline from one value to other. Updating the edw_trans_code as well.\n\tIFF(\n\t    RTRIM(v_trans_code) <> '0', v_trans_code,\n\t    DECODE(\n\t        TRUE,\n\t        v_pms_trans_code IN ('76','26','88','89'), IFF(\n\t            trans_hist_amt = 0.0, '39', '38'\n\t        ),\n\t        v_pms_trans_code IN ('27','83','84'), IFF(\n\t            trans_amt = 0.0, '40', '30'\n\t        )\n\t    )\n\t) AS trans_code_out,\n\ttrans_code_out AS o_claim_trans_code,\n\t-- *INF*: :LKP.LKP_SUP_CLAIM_TRANSACTION_CODE(v_trans_code)\n\tLKP_SUP_CLAIM_TRANSACTION_CODE_v_trans_code.sup_claim_trans_code_id AS lkp_claim_trans_code_id,\n\toff_onset_ts_output,\n\ttrans_date,\n\t-- *INF*: off_onset_ts_output\r\n\t-- \r\n\t-- \r\n\t-- ------ For NonReg Reserve transactions (95,97,98,99), existing transaction data gets updated with the sysdate the transaction gets processed.\n\toff_onset_ts_output AS trans_date_Out,\n\ts3p_updated_date,\n\ts3p_to_pms_trans_date,\n\tpms_acct_entered_date,\n\toff_onset_ts_output AS pms_acct_entered_date_Out,\n\ttrans_base_type_code,\n\ttrans_ctgry_code,\n\ttrans_amt,\n\t0.0 AS trans_amt_Out,\n\ttrans_hist_amt,\n\ttrans_rsn,\n\tdraft_num,\n\tsingle_check_ind,\n\toffset_reissue_ind,\n\treprocess_date,\n\ttrans_entry_oper_id,\n\twc_stage_pk_id,\n\t-1 * wc_stage_pk_id AS wc_stage_pk_id_Out,\n\terr_flag,\n\tcrrnt_snpsht_flag,\n\taudit_id,\n\teff_from_date,\n\teff_to_date,\n\tsource_sys_id,\n\tcreated_date,\n\ttax_id,\n\tclaim_master_1099_list_ak_id,\n\tSYSDATE AS Modified_date,\n\t-- *INF*: IIF(ISNULL(lkp_PMSTransactionCodeID),-1,lkp_PMSTransactionCodeID)\n\tIFF(lkp_PMSTransactionCodeID IS NULL, - 1, lkp_PMSTransactionCodeID) AS o_PMSTransactionCodeID,\n\t-- *INF*: IIF(ISNULL(lkp_claim_trans_code_id),-1,lkp_claim_trans_code_id)\n\tIFF(lkp_claim_trans_code_id IS NULL, - 1, lkp_claim_trans_code_id) AS o_TransactionCodeID\n\tFROM RTR_Offset_Onset_OFFSET_UPDATE_NONREG_RES\n\tLEFT JOIN LKP_SUP_CLAIM_TRANSACTION_CODE LKP_SUP_CLAIM_TRANSACTION_CODE_v_pms_trans_code\n\tON LKP_SUP_CLAIM_TRANSACTION_CODE_v_pms_trans_code.trans_code = v_pms_trans_code\n\n\tLEFT JOIN LKP_SUP_CONVERT_PMS_CLAIM_TRANSACTION_CODE LKP_SUP_CONVERT_PMS_CLAIM_TRANSACTION_CODE_v_pms_trans_code\n\tON LKP_SUP_CONVERT_PMS_CLAIM_TRANSACTION_CODE_v_pms_trans_code.pms_trans_code = v_pms_trans_code\n\n\tLEFT JOIN LKP_SUP_CLAIM_TRANSACTION_CODE LKP_SUP_CLAIM_TRANSACTION_CODE_v_trans_code\n\tON LKP_SUP_CLAIM_TRANSACTION_CODE_v_trans_code.trans_code = v_trans_code\n\n),\nUPD_Offset_Non_Reg_Update AS (\n\tSELECT\n\tclaim_trans_id, \n\ttrans_offset_onset_ind, \n\to_pms_trans_code AS pms_trans_code_Out, \n\to_claim_trans_code AS trans_code_out, \n\ttrans_amt_Out, \n\tModified_date, \n\ttrans_date_Out, \n\tpms_acct_entered_date_Out, \n\twc_stage_pk_id_Out, \n\to_PMSTransactionCodeID, \n\to_TransactionCodeID\n\tFROM EXP_Offset_Update_NonReg_Res\n),\nclaim_transaction_Update_Non_Reg_Res AS (\n\tMERGE INTO claim_transaction AS T\n\tUSING UPD_Offset_Non_Reg_Update AS S\n\tON T.claim_trans_id = S.claim_trans_id\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.pms_trans_code = S.pms_trans_code_Out, T.trans_code = S.trans_code_out, T.trans_date = S.trans_date_Out, T.pms_acct_entered_date = S.pms_acct_entered_date_Out, T.trans_amt = S.trans_amt_Out, T.wc_stage_pk_id = S.wc_stage_pk_id_Out, T.modified_date = S.Modified_date, T.trans_offset_onset_ind = S.trans_offset_onset_ind, T.PMSTransactionCodeID = S.o_PMSTransactionCodeID, T.TransactionCodeID = S.o_TransactionCodeID\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "TARGET_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "SELECTION_START_TS": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "EDW_DATABASE_NAME": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "SOURCE_SYSTEM_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            }
        },
        "folder": {
            "name": "ClaimsDataWarehouse/"
        },
        "annotations": []
    }
}