WITH
SQ_ISSCommercialAutoExtract AS (
	SELECT
		ISSCommercialAutoExtractId,
		AuditId,
		CreatedDate,
		EDWPremiumMasterCalculationPKId,
		EDWLossMasterCalculationPKId,
		TypeBureauCode,
		BureauLineOfInsurance,
		BureauCompanyNumber,
		StateProvinceCode,
		PremiumMasterRunDate,
		LossMasterRunDate,
		PolicyKey,
		PremiumMasterClassCode,
		LossMasterClassCode,
		ClaimNumber,
		ClaimantNumber,
		RiskTerritoryCode,
		PolicyEffectiveDate,
		CauseOfLoss,
		DeductibleAmount,
		CoverageCode,
		SublineCode,
		PackageModificationAdjustmentGroupDescription,
		PremiumMasterDirectWrittenPremiumAmount,
		PaidLossAmount,
		OutstandingLossAmount,
		PolicyExpirationDate,
		InceptionToDatePaidLossAmount,
		ClaimantCoverageDetailId,
		AnnualStatementLineNumber,
		ZipPostalCode,
		DeductibleIndicatorCode,
		PolicyLowerLimit,
		PolicyUpperLimit,
		TerminalZoneCode,
		WrittenExposure,
		PaidAllocatedLossAdjustmentExpenseAmount,
		OutstandingAllocatedLossAdjustmentExpenseAmount,
		ClaimLossDate,
		TransactionEffectiveDate,
		CoverageGroupCode
	FROM ISSCommercialAutoExtract
	WHERE @{pipeline().parameters.WHERE_CLAUSE}
),
EXP_Get_Values AS (
	SELECT
	ISSCommercialAutoExtractId AS WorkISSExtractId,
	AuditId,
	CreatedDate,
	EDWPremiumMasterCalculationPKId,
	EDWLossMasterCalculationPKId,
	TypeBureauCode,
	BureauLineOfInsurance,
	BureauCompanyNumber,
	StateProvinceCode,
	PremiumMasterRunDate,
	LossMasterRunDate,
	PolicyKey,
	PremiumMasterClassCode,
	LossMasterClassCode,
	ClaimNumber,
	ClaimantNumber,
	RiskTerritoryCode,
	PolicyEffectiveDate,
	CauseOfLoss,
	DeductibleAmount,
	CoverageCode,
	SublineCode,
	PackageModificationAdjustmentGroupDescription,
	PremiumMasterDirectWrittenPremiumAmount,
	PaidLossAmount,
	OutstandingLossAmount,
	PolicyExpirationDate,
	InceptionToDatePaidLossAmount,
	ClaimantCoverageDetailId,
	AnnualStatementLineNumber,
	ZipPostalCode,
	DeductibleIndicatorCode,
	PolicyLowerLimit,
	PolicyUpperLimit,
	TerminalZoneCode,
	WrittenExposure,
	PaidAllocatedLossAdjustmentExpenseAmount,
	OutstandingAllocatedLossAdjustmentExpenseAmount,
	ClaimLossDate,
	TransactionEffectiveDate,
	CoverageGroupCode
	FROM SQ_ISSCommercialAutoExtract
),
RTR_CL_PL AS (
	SELECT
	WorkISSExtractId,
	AuditId,
	CreatedDate,
	EDWPremiumMasterCalculationPKId,
	EDWLossMasterCalculationPKId,
	TypeBureauCode,
	BureauLineOfInsurance,
	BureauCompanyNumber,
	StateProvinceCode,
	PremiumMasterRunDate,
	LossMasterRunDate,
	PolicyKey,
	PremiumMasterClassCode,
	LossMasterClassCode,
	ClaimNumber,
	ClaimantNumber,
	RiskTerritoryCode,
	PolicyEffectiveDate,
	CauseOfLoss,
	DeductibleAmount,
	CoverageCode,
	ConstructionCode,
	ISOFireProtectionCode,
	SublineCode,
	PackageModificationAdjustmentGroupDescription,
	PolicyForm,
	PremiumMasterDirectWrittenPremiumAmount,
	PaidLossAmount,
	OutstandingLossAmount,
	PolicyExpirationDate,
	InceptionToDatePaidLossAmount,
	ClaimantCoverageDetailId,
	AnnualStatementLineNumber,
	ZipPostalCode,
	DeductibleIndicatorCode,
	VehicleModelYear,
	DefensiveDriverCode,
	PolicyLowerLimit,
	PolicyUpperLimit,
	TerminalZoneCode,
	WrittenExposure,
	PaidAllocatedLossAdjustmentExpenseAmount,
	OutstandingAllocatedLossAdjustmentExpenseAmount,
	ClaimLossDate,
	TransactionEffectiveDate,
	CoverageGroupCode
	FROM EXP_Get_Values
),
RTR_CL_PL_CL AS (SELECT * FROM RTR_CL_PL WHERE IN(TypeBureauCode,'AL','AN','AP','N/A','CommercialAuto')),
RTR_CL_PL_PL AS (SELECT * FROM RTR_CL_PL WHERE IN(TypeBureauCode,'RL','RN','RP')),
EXP_Target_CL AS (
	SELECT
	-- *INF*: TRUNC(SYSDATE,'DD')
	CAST(TRUNC(CURRENT_TIMESTAMP, 'DAY') AS TIMESTAMP_NTZ(0)) AS v_RunDate,
	-- *INF*: 'ISS_Auto_CL_'||TO_CHAR(v_RunDate,'YYYYMMDD')||'.CSV'
	'ISS_Auto_CL_' || TO_CHAR(v_RunDate, 'YYYYMMDD') || '.CSV' AS FileName,
	WorkISSExtractId,
	AuditId,
	CreatedDate,
	EDWPremiumMasterCalculationPKId,
	EDWLossMasterCalculationPKId,
	TypeBureauCode,
	BureauLineOfInsurance,
	BureauCompanyNumber,
	StateProvinceCode,
	PremiumMasterRunDate,
	LossMasterRunDate,
	PolicyKey,
	PremiumMasterClassCode,
	LossMasterClassCode,
	ClaimNumber,
	ClaimantNumber,
	RiskTerritoryCode,
	PolicyEffectiveDate,
	CauseOfLoss,
	DeductibleAmount,
	CoverageCode,
	ConstructionCode,
	ISOFireProtectionCode,
	SublineCode,
	PackageModificationAdjustmentGroupDescription,
	PolicyForm,
	PremiumMasterDirectWrittenPremiumAmount,
	PaidLossAmount,
	OutstandingLossAmount,
	PolicyExpirationDate,
	InceptionToDatePaidLossAmount,
	ClaimantCoverageDetailId,
	AnnualStatementLineNumber,
	ZipPostalCode,
	DeductibleIndicatorCode,
	VehicleModelYear,
	DefensiveDriverCode,
	PolicyLowerLimit,
	PolicyUpperLimit,
	TerminalZoneCode,
	WrittenExposure,
	PaidAllocatedLossAdjustmentExpenseAmount,
	OutstandingAllocatedLossAdjustmentExpenseAmount,
	ClaimLossDate,
	TransactionEffectiveDate,
	CoverageGroupCode
	FROM RTR_CL_PL_CL
),
SRT_ISSFlatFile_Auto_CL AS (
	SELECT
	FileName, 
	WorkISSExtractId, 
	AuditId, 
	CreatedDate, 
	EDWPremiumMasterCalculationPKId, 
	EDWLossMasterCalculationPKId, 
	TypeBureauCode, 
	BureauLineOfInsurance, 
	BureauCompanyNumber, 
	StateProvinceCode, 
	PremiumMasterRunDate, 
	LossMasterRunDate, 
	PolicyKey, 
	PremiumMasterClassCode, 
	LossMasterClassCode, 
	ClaimNumber, 
	ClaimantNumber, 
	RiskTerritoryCode, 
	PolicyEffectiveDate, 
	CauseOfLoss, 
	DeductibleAmount, 
	CoverageCode, 
	SublineCode, 
	PackageModificationAdjustmentGroupDescription, 
	PremiumMasterDirectWrittenPremiumAmount, 
	PaidLossAmount, 
	OutstandingLossAmount, 
	PolicyExpirationDate, 
	InceptionToDatePaidLossAmount, 
	ClaimantCoverageDetailId, 
	AnnualStatementLineNumber, 
	ZipPostalCode, 
	DeductibleIndicatorCode, 
	PolicyLowerLimit, 
	PolicyUpperLimit, 
	TerminalZoneCode, 
	WrittenExposure, 
	PaidAllocatedLossAdjustmentExpenseAmount, 
	OutstandingAllocatedLossAdjustmentExpenseAmount, 
	ClaimLossDate, 
	TransactionEffectiveDate, 
	CoverageGroupCode
	FROM EXP_Target_CL
	ORDER BY PolicyKey ASC, PremiumMasterClassCode ASC, CoverageCode ASC, AnnualStatementLineNumber ASC, ZipPostalCode ASC
),
ISSFlatFile_Auto_CL AS (
	INSERT INTO ISSFlatFile_Auto
	(FileName, WorkISSExtractId, AuditId, CreatedDate, EDWPremiumMasterCalculationPKId, EDWLossMasterCalculationPKId, TypeBureauCode, BureauLineOfInsurance, BureauCompanyNumber, StateProvinceCode, PremiumMasterRunDate, LossMasterRunDate, PolicyKey, PremiumMasterClassCode, LossMasterClassCode, ClaimNumber, ClaimantNumber, RiskTerritoryCode, PolicyEffectiveDate, CauseOfLoss, DeductibleAmount, CoverageCode, SublineCode, PackageModificationAdjustmentGroupDescription, PremiumMasterDirectWrittenPremiumAmount, PaidLossAmount, OutstandingLossAmount, PolicyExpirationDate, InceptionToDatePaidLossAmount, ClaimantCoverageDetailId, AnnualStatementLineNumber, ZipPostalCode, DeductibleIndicatorCode, PolicyLowerLimit, PolicyUpperLimit, TerminalZoneCode, WrittenExposure, PaidAllocatedLossAdjustmentExpenseAmount, OutstandingAllocatedLossAdjustmentExpenseAmount, ClaimLossDate, TransactionEffectiveDate, CoverageGroupCode)
	SELECT 
	FILENAME, 
	WORKISSEXTRACTID, 
	AUDITID, 
	CREATEDDATE, 
	EDWPREMIUMMASTERCALCULATIONPKID, 
	EDWLOSSMASTERCALCULATIONPKID, 
	TYPEBUREAUCODE, 
	BUREAULINEOFINSURANCE, 
	BUREAUCOMPANYNUMBER, 
	STATEPROVINCECODE, 
	PREMIUMMASTERRUNDATE, 
	LOSSMASTERRUNDATE, 
	POLICYKEY, 
	PREMIUMMASTERCLASSCODE, 
	LOSSMASTERCLASSCODE, 
	CLAIMNUMBER, 
	CLAIMANTNUMBER, 
	RISKTERRITORYCODE, 
	POLICYEFFECTIVEDATE, 
	CAUSEOFLOSS, 
	DEDUCTIBLEAMOUNT, 
	COVERAGECODE, 
	SUBLINECODE, 
	PACKAGEMODIFICATIONADJUSTMENTGROUPDESCRIPTION, 
	PREMIUMMASTERDIRECTWRITTENPREMIUMAMOUNT, 
	PAIDLOSSAMOUNT, 
	OUTSTANDINGLOSSAMOUNT, 
	POLICYEXPIRATIONDATE, 
	INCEPTIONTODATEPAIDLOSSAMOUNT, 
	CLAIMANTCOVERAGEDETAILID, 
	ANNUALSTATEMENTLINENUMBER, 
	ZIPPOSTALCODE, 
	DEDUCTIBLEINDICATORCODE, 
	POLICYLOWERLIMIT, 
	POLICYUPPERLIMIT, 
	TERMINALZONECODE, 
	WRITTENEXPOSURE, 
	PAIDALLOCATEDLOSSADJUSTMENTEXPENSEAMOUNT, 
	OUTSTANDINGALLOCATEDLOSSADJUSTMENTEXPENSEAMOUNT, 
	CLAIMLOSSDATE, 
	TRANSACTIONEFFECTIVEDATE, 
	COVERAGEGROUPCODE
	FROM SRT_ISSFlatFile_Auto_CL
),
EXP_Target_PL AS (
	SELECT
	-- *INF*: TRUNC(SYSDATE,'DD')
	CAST(TRUNC(CURRENT_TIMESTAMP, 'DAY') AS TIMESTAMP_NTZ(0)) AS v_RunDate,
	-- *INF*: 'ISS_Auto_PL_'||TO_CHAR(v_RunDate,'YYYYMMDD')||'.CSV'
	'ISS_Auto_PL_' || TO_CHAR(v_RunDate, 'YYYYMMDD') || '.CSV' AS FileName,
	WorkISSExtractId,
	AuditId,
	CreatedDate,
	EDWPremiumMasterCalculationPKId,
	EDWLossMasterCalculationPKId,
	TypeBureauCode,
	BureauLineOfInsurance,
	BureauCompanyNumber,
	StateProvinceCode,
	PremiumMasterRunDate,
	LossMasterRunDate,
	PolicyKey,
	PremiumMasterClassCode,
	LossMasterClassCode,
	ClaimNumber,
	ClaimantNumber,
	RiskTerritoryCode,
	PolicyEffectiveDate,
	CauseOfLoss,
	DeductibleAmount,
	CoverageCode,
	ConstructionCode,
	ISOFireProtectionCode,
	SublineCode,
	PackageModificationAdjustmentGroupDescription,
	PolicyForm,
	PremiumMasterDirectWrittenPremiumAmount,
	PaidLossAmount,
	OutstandingLossAmount,
	PolicyExpirationDate,
	InceptionToDatePaidLossAmount,
	ClaimantCoverageDetailId,
	AnnualStatementLineNumber,
	ZipPostalCode,
	DeductibleIndicatorCode,
	VehicleModelYear,
	DefensiveDriverCode,
	PolicyLowerLimit,
	PolicyUpperLimit,
	TerminalZoneCode,
	WrittenExposure,
	PaidAllocatedLossAdjustmentExpenseAmount,
	OutstandingAllocatedLossAdjustmentExpenseAmount,
	ClaimLossDate,
	TransactionEffectiveDate,
	CoverageGroupCode
	FROM RTR_CL_PL_PL
),
SRT_ISSFlatFILE_Auto_PL AS (
	SELECT
	FileName, 
	WorkISSExtractId, 
	AuditId, 
	CreatedDate, 
	EDWPremiumMasterCalculationPKId, 
	EDWLossMasterCalculationPKId, 
	TypeBureauCode, 
	BureauLineOfInsurance, 
	BureauCompanyNumber, 
	StateProvinceCode, 
	PremiumMasterRunDate, 
	LossMasterRunDate, 
	PolicyKey, 
	PremiumMasterClassCode, 
	LossMasterClassCode, 
	ClaimNumber, 
	ClaimantNumber, 
	RiskTerritoryCode, 
	PolicyEffectiveDate, 
	CauseOfLoss, 
	DeductibleAmount, 
	CoverageCode, 
	SublineCode, 
	PackageModificationAdjustmentGroupDescription, 
	PremiumMasterDirectWrittenPremiumAmount, 
	PaidLossAmount, 
	OutstandingLossAmount, 
	PolicyExpirationDate, 
	InceptionToDatePaidLossAmount, 
	ClaimantCoverageDetailId, 
	AnnualStatementLineNumber, 
	ZipPostalCode, 
	DeductibleIndicatorCode, 
	PolicyLowerLimit, 
	PolicyUpperLimit, 
	TerminalZoneCode, 
	WrittenExposure, 
	PaidAllocatedLossAdjustmentExpenseAmount, 
	OutstandingAllocatedLossAdjustmentExpenseAmount, 
	ClaimLossDate, 
	TransactionEffectiveDate, 
	CoverageGroupCode
	FROM EXP_Target_PL
	ORDER BY PolicyKey ASC, PremiumMasterClassCode ASC, CoverageCode ASC, AnnualStatementLineNumber ASC, ZipPostalCode ASC
),
ISSFlatFile_Auto_PL AS (
	INSERT INTO ISSFlatFile_Auto
	(FileName, WorkISSExtractId, AuditId, CreatedDate, EDWPremiumMasterCalculationPKId, EDWLossMasterCalculationPKId, TypeBureauCode, BureauLineOfInsurance, BureauCompanyNumber, StateProvinceCode, PremiumMasterRunDate, LossMasterRunDate, PolicyKey, PremiumMasterClassCode, LossMasterClassCode, ClaimNumber, ClaimantNumber, RiskTerritoryCode, PolicyEffectiveDate, CauseOfLoss, DeductibleAmount, CoverageCode, SublineCode, PackageModificationAdjustmentGroupDescription, PremiumMasterDirectWrittenPremiumAmount, PaidLossAmount, OutstandingLossAmount, PolicyExpirationDate, InceptionToDatePaidLossAmount, ClaimantCoverageDetailId, AnnualStatementLineNumber, ZipPostalCode, DeductibleIndicatorCode, PolicyLowerLimit, PolicyUpperLimit, TerminalZoneCode, WrittenExposure, PaidAllocatedLossAdjustmentExpenseAmount, OutstandingAllocatedLossAdjustmentExpenseAmount, ClaimLossDate, TransactionEffectiveDate, CoverageGroupCode)
	SELECT 
	FILENAME, 
	WORKISSEXTRACTID, 
	AUDITID, 
	CREATEDDATE, 
	EDWPREMIUMMASTERCALCULATIONPKID, 
	EDWLOSSMASTERCALCULATIONPKID, 
	TYPEBUREAUCODE, 
	BUREAULINEOFINSURANCE, 
	BUREAUCOMPANYNUMBER, 
	STATEPROVINCECODE, 
	PREMIUMMASTERRUNDATE, 
	LOSSMASTERRUNDATE, 
	POLICYKEY, 
	PREMIUMMASTERCLASSCODE, 
	LOSSMASTERCLASSCODE, 
	CLAIMNUMBER, 
	CLAIMANTNUMBER, 
	RISKTERRITORYCODE, 
	POLICYEFFECTIVEDATE, 
	CAUSEOFLOSS, 
	DEDUCTIBLEAMOUNT, 
	COVERAGECODE, 
	SUBLINECODE, 
	PACKAGEMODIFICATIONADJUSTMENTGROUPDESCRIPTION, 
	PREMIUMMASTERDIRECTWRITTENPREMIUMAMOUNT, 
	PAIDLOSSAMOUNT, 
	OUTSTANDINGLOSSAMOUNT, 
	POLICYEXPIRATIONDATE, 
	INCEPTIONTODATEPAIDLOSSAMOUNT, 
	CLAIMANTCOVERAGEDETAILID, 
	ANNUALSTATEMENTLINENUMBER, 
	ZIPPOSTALCODE, 
	DEDUCTIBLEINDICATORCODE, 
	POLICYLOWERLIMIT, 
	POLICYUPPERLIMIT, 
	TERMINALZONECODE, 
	WRITTENEXPOSURE, 
	PAIDALLOCATEDLOSSADJUSTMENTEXPENSEAMOUNT, 
	OUTSTANDINGALLOCATEDLOSSADJUSTMENTEXPENSEAMOUNT, 
	CLAIMLOSSDATE, 
	TRANSACTIONEFFECTIVEDATE, 
	COVERAGEGROUPCODE
	FROM SRT_ISSFlatFILE_Auto_PL
),