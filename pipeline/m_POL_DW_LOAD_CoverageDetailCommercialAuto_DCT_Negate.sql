WITH
SQ_CoverageDetailCommercialAuto AS (
	SELECT CDCA.PremiumTransactionID,
	       CDCA.CoverageGuid,
	       CDCA.VehicleGroupCode,
	       CDCA.RadiusOfOperation,
	       CDCA.SecondaryVehicleType,
	       CDCA.UsedInDumpingIndicator,
	       CDCA.VehicleYear,
	       CDCA.StatedAmount,
	       CDCA.CostNew,
	       CDCA.VehicleDeleteDate,
	       CDCA.VIN,
	       CDCA.VehicleMake,
	       CDCA.VehicleModel,
	       CDCA.VehicleNumber,
	       CDCA.CompositeRatedFlag,
	       CDCA.TerminalZoneCode,
	       CDCA.VehicleType,
	       CDCA.PIPBureauCoverageCode,
	       CDCA.RetroactiveDate,
	       CDCA.VehicleTypeSize,
	       CDCA.BusinessUseClass,
	       CDCA.SecondaryClass,
	       CDCA.FleetType,
	       CDCA.SecondaryClassGroup,
	       CDCA.IncludeUIM,	
	       PT.PremiumTransactionID,
	       CDCA.CoordinationOfBenefits, 
	       CDCA.MedicalExpensesOption, 
	       CDCA.CoveredByWorkersCompensationFlag,
	       CDCA.SubjectToNoFault,
		 CDCA.AdditionalLimitKS,
		 CDCA.AdditionalLimitKY,
		 CDCA.AdditionalLimitMN,
		 CDCA.RatingZoneCode,
		 CDCA.ReplacementCost,
		 CDCA.FullGlassIndicator,
	       CDCA.HistoricVehicleIndicator
	FROM   dbo.CoverageDetailCommercialAuto CDCA
	       INNER JOIN dbo.WorkPremiumTransactionDataRepairNegate WPTDRN
	               ON CDCA.PremiumTransactionID = WPTDRN.OriginalPremiumTransactionID
	       INNER JOIN dbo.PremiumTransaction PT
	               ON PT.PremiumTransactionAKID = WPTDRN.NewNegatePremiumTransactionAKID
	                  AND PT.SourceSystemId = '@{pipeline().parameters.SOURCE_SYSTEM_ID}'
),
Exp_CoverageDetailGeneralLiability AS (
	SELECT
	PremiumTransactionID AS Old_PremiumTransactionID,
	CoverageGuid,
	VehicleGroupCode,
	RadiusOfOperation,
	SecondaryVehicleType,
	UsedInDumpingIndicator,
	VehicleYear,
	StatedAmount,
	CostNew,
	VehicleDeleteDate,
	VIN,
	VehicleMake,
	VehicleModel,
	VehicleNumber,
	CompositeRatedFlag,
	TerminalZoneCode,
	VehicleType,
	PIPBureauCoverageCode,
	RetroactiveDate AS RetroactiveDate1,
	VehicleTypeSize,
	BusinessUseClass,
	SecondaryClass,
	FleetType,
	SecondaryClassGroup,
	IncludeUIM,
	NewNegatePremiumTransactionID,
	CoordinationOfBenefits,
	MedicalExpensesOption,
	CoveredByWorkersCompensationFlag AS CoveredByWorkComp,
	-- *INF*: IIF(CoveredByWorkComp = 'T',1,0)
	IFF(CoveredByWorkComp = 'T', 1, 0) AS o_CoveredByWorkComp,
	SubjectToNoFault,
	AdditionalLimitKS,
	AdditionalLimitKY,
	AdditionalLimitMN,
	RatingZoneCode,
	ReplacementCost,
	-- *INF*: IIF(ReplacementCost = 'T',1,0)
	IFF(ReplacementCost = 'T', 1, 0) AS o_ReplacementCost,
	FullGlassIndicator,
	-- *INF*: IIF(FullGlassIndicator = 'T',1,0)
	IFF(FullGlassIndicator = 'T', 1, 0) AS o_FullGlassIndicator,
	HistoricVehicleIndicator,
	-- *INF*: IIF(HistoricVehicleIndicator= 'T',1,0)
	IFF(HistoricVehicleIndicator = 'T', 1, 0) AS o_HistoricVehicleIndicator
	FROM SQ_CoverageDetailCommercialAuto
),
EXP_CoverageDetailCommercialAuto AS (
	SELECT
	NewNegatePremiumTransactionID,
	NewNegatePremiumTransactionID AS o_PremiumTransactionID,
	CoverageGuid,
	VehicleGroupCode,
	RadiusOfOperation,
	SecondaryVehicleType,
	UsedInDumpingIndicator,
	VehicleYear,
	StatedAmount,
	CostNew,
	VehicleDeleteDate,
	VIN,
	VehicleMake,
	VehicleModel,
	VehicleNumber,
	CompositeRatedFlag,
	TerminalZoneCode,
	VehicleType,
	PIPBureauCoverageCode,
	RetroactiveDate1,
	VehicleTypeSize,
	BusinessUseClass,
	SecondaryClass,
	FleetType,
	SecondaryClassGroup,
	IncludeUIM,
	CoordinationOfBenefits,
	MedicalExpensesOption,
	o_CoveredByWorkComp AS CoveredByWorkComp,
	SubjectToNoFault,
	AdditionalLimitKS,
	AdditionalLimitKY,
	AdditionalLimitMN,
	RatingZoneCode,
	o_ReplacementCost AS ReplacementCost,
	o_FullGlassIndicator AS FullGlassIndicator,
	o_HistoricVehicleIndicator AS HistoricVehicleIndicator
	FROM Exp_CoverageDetailGeneralLiability
),
LKP_CoverageDetailCommercialAuto AS (
	SELECT
	PremiumTransactionID,
	VehicleGroupCode,
	RadiusOfOperation,
	SecondaryVehicleType,
	UsedInDumpingIndicator,
	VehicleYear,
	StatedAmount,
	CostNew,
	VehicleDeleteDate,
	VIN,
	VehicleMake,
	VehicleModel,
	VehicleNumber,
	CompositeRatedFlag,
	TerminalZoneCode,
	VehicleType,
	PIPBureaucoverageCode,
	VehicleTypeSize,
	BusinessUseClass,
	SecondaryClass,
	FleetType,
	SecondaryClassGroup,
	IncludeUIM
	FROM (
		SELECT 
			PremiumTransactionID,
			VehicleGroupCode,
			RadiusOfOperation,
			SecondaryVehicleType,
			UsedInDumpingIndicator,
			VehicleYear,
			StatedAmount,
			CostNew,
			VehicleDeleteDate,
			VIN,
			VehicleMake,
			VehicleModel,
			VehicleNumber,
			CompositeRatedFlag,
			TerminalZoneCode,
			VehicleType,
			PIPBureaucoverageCode,
			VehicleTypeSize,
			BusinessUseClass,
			SecondaryClass,
			FleetType,
			SecondaryClassGroup,
			IncludeUIM
		FROM @{pipeline().parameters.TARGET_TABLE_OWNER}.CoverageDetailCommercialAuto
		WHERE SourceSystemId='@{pipeline().parameters.SOURCE_SYSTEM_ID}'
		AND
		PremiumTransactionID IN (SELECT pt.PremiumTransactionID FROM
		PremiumTransaction pt INNER JOIN dbo.WorkPremiumTransactionDataRepairNegate wpt
		ON pt.PremiumTransactionAKID=wpt.NewNegatePremiumTransactionAKID)
	)
	QUALIFY ROW_NUMBER() OVER (PARTITION BY PremiumTransactionID ORDER BY PremiumTransactionID) = 1
),
EXP_DetectChanges AS (
	SELECT
	LKP_CoverageDetailCommercialAuto.PremiumTransactionID AS lkp_PremiumTransactionID,
	LKP_CoverageDetailCommercialAuto.VehicleGroupCode AS lkp_VehicleGroupCode,
	LKP_CoverageDetailCommercialAuto.RadiusOfOperation AS lkp_RadiusOfOperation,
	LKP_CoverageDetailCommercialAuto.SecondaryVehicleType AS lkp_SecondaryVehicleType,
	LKP_CoverageDetailCommercialAuto.UsedInDumpingIndicator AS lkp_UsedInDumpingIndicator,
	-- *INF*: IIF(lkp_UsedInDumpingIndicator='T',1,0)
	IFF(lkp_UsedInDumpingIndicator = 'T', 1, 0) AS v_UsedInDumpingIndicator,
	LKP_CoverageDetailCommercialAuto.VehicleYear AS lkp_VehicleYear,
	LKP_CoverageDetailCommercialAuto.StatedAmount AS lkp_StatedAmount,
	LKP_CoverageDetailCommercialAuto.CostNew AS lkp_CostNew,
	LKP_CoverageDetailCommercialAuto.VehicleDeleteDate AS lkp_VehicleDeleteDate,
	LKP_CoverageDetailCommercialAuto.VIN AS lkp_VIN,
	LKP_CoverageDetailCommercialAuto.VehicleMake AS lkp_VehicleMake,
	LKP_CoverageDetailCommercialAuto.VehicleModel AS lkp_VehicleModel,
	LKP_CoverageDetailCommercialAuto.VehicleNumber AS lkp_VehicleNumber,
	LKP_CoverageDetailCommercialAuto.CompositeRatedFlag AS lkp_CompositeRatedFlag,
	-- *INF*: IIF(lkp_CompositeRatedFlag='T',1,0)
	IFF(lkp_CompositeRatedFlag = 'T', 1, 0) AS v_CompositeRatedFlag,
	LKP_CoverageDetailCommercialAuto.TerminalZoneCode AS lkp_TerminalZoneCode,
	LKP_CoverageDetailCommercialAuto.VehicleType AS lkp_VehicleType,
	LKP_CoverageDetailCommercialAuto.PIPBureaucoverageCode AS lkp_PIPBureaucoverageCode,
	LKP_CoverageDetailCommercialAuto.VehicleTypeSize AS lkp_VehicleTypeSize,
	LKP_CoverageDetailCommercialAuto.BusinessUseClass AS lkp_BusinessUseClass,
	LKP_CoverageDetailCommercialAuto.SecondaryClass AS lkp_SecondaryClass,
	LKP_CoverageDetailCommercialAuto.FleetType AS lkp_FleetType,
	LKP_CoverageDetailCommercialAuto.SecondaryClassGroup AS lkp_SecondaryClassGroup,
	LKP_CoverageDetailCommercialAuto.IncludeUIM AS lkp_IncludeUIM,
	EXP_CoverageDetailCommercialAuto.o_PremiumTransactionID AS i_PremiumTransactionID,
	i_PremiumTransactionID AS o_PremiumTransactionID,
	'1' AS o_CurrentSnapshotFlag,
	@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS o_AuditID,
	-- *INF*: TO_DATE('1800-01-01 00:00:00.000', 'YYYY-MM-DD HH24:MI:SS.US')
	TO_TIMESTAMP('1800-01-01 00:00:00.000', 'YYYY-MM-DD HH24:MI:SS.US') AS o_EffectiveDate,
	-- *INF*: TO_DATE('2100-12-31 23:59:59.000', 'YYYY-MM-DD HH24:MI:SS.US')
	TO_TIMESTAMP('2100-12-31 23:59:59.000', 'YYYY-MM-DD HH24:MI:SS.US') AS o_ExpirationDate,
	@{pipeline().parameters.SOURCE_SYSTEM_ID} AS o_SourceSystemID,
	SYSDATE AS o_CreatedDate,
	SYSDATE AS o_ModifiedDate,
	EXP_CoverageDetailCommercialAuto.CoverageGuid,
	EXP_CoverageDetailCommercialAuto.VehicleGroupCode,
	EXP_CoverageDetailCommercialAuto.RadiusOfOperation,
	EXP_CoverageDetailCommercialAuto.SecondaryVehicleType,
	EXP_CoverageDetailCommercialAuto.UsedInDumpingIndicator,
	EXP_CoverageDetailCommercialAuto.VehicleYear,
	EXP_CoverageDetailCommercialAuto.StatedAmount,
	EXP_CoverageDetailCommercialAuto.CostNew,
	EXP_CoverageDetailCommercialAuto.VehicleDeleteDate,
	EXP_CoverageDetailCommercialAuto.VIN,
	EXP_CoverageDetailCommercialAuto.VehicleMake,
	EXP_CoverageDetailCommercialAuto.VehicleModel,
	EXP_CoverageDetailCommercialAuto.VehicleNumber,
	EXP_CoverageDetailCommercialAuto.CompositeRatedFlag,
	EXP_CoverageDetailCommercialAuto.TerminalZoneCode,
	EXP_CoverageDetailCommercialAuto.VehicleType,
	EXP_CoverageDetailCommercialAuto.PIPBureauCoverageCode,
	EXP_CoverageDetailCommercialAuto.RetroactiveDate1,
	EXP_CoverageDetailCommercialAuto.VehicleTypeSize,
	EXP_CoverageDetailCommercialAuto.BusinessUseClass,
	EXP_CoverageDetailCommercialAuto.SecondaryClass,
	EXP_CoverageDetailCommercialAuto.FleetType,
	EXP_CoverageDetailCommercialAuto.SecondaryClassGroup,
	EXP_CoverageDetailCommercialAuto.IncludeUIM,
	-- *INF*: IIF(ISNULL(lkp_PremiumTransactionID),'NEW','UPDATE')
	IFF(lkp_PremiumTransactionID IS NULL, 'NEW', 'UPDATE') AS ChangeFlag,
	EXP_CoverageDetailCommercialAuto.CoordinationOfBenefits,
	EXP_CoverageDetailCommercialAuto.MedicalExpensesOption,
	EXP_CoverageDetailCommercialAuto.CoveredByWorkComp,
	EXP_CoverageDetailCommercialAuto.SubjectToNoFault,
	EXP_CoverageDetailCommercialAuto.AdditionalLimitKS,
	EXP_CoverageDetailCommercialAuto.AdditionalLimitKY,
	EXP_CoverageDetailCommercialAuto.AdditionalLimitMN,
	EXP_CoverageDetailCommercialAuto.RatingZoneCode,
	EXP_CoverageDetailCommercialAuto.ReplacementCost,
	EXP_CoverageDetailCommercialAuto.FullGlassIndicator,
	EXP_CoverageDetailCommercialAuto.HistoricVehicleIndicator
	FROM EXP_CoverageDetailCommercialAuto
	LEFT JOIN LKP_CoverageDetailCommercialAuto
	ON LKP_CoverageDetailCommercialAuto.PremiumTransactionID = EXP_CoverageDetailCommercialAuto.o_PremiumTransactionID
),
RTR_INSERT_UPDATE AS (
	SELECT
	o_PremiumTransactionID AS PremiumTransactionID,
	o_CurrentSnapshotFlag AS CurrentSnapshotFlag,
	o_AuditID AS AuditID,
	o_EffectiveDate AS EffectiveDate,
	o_ExpirationDate AS ExpirationDate,
	o_SourceSystemID AS SourceSystemID,
	o_CreatedDate AS CreatedDate,
	o_ModifiedDate AS ModifiedDate,
	CoverageGuid,
	VehicleGroupCode,
	RadiusOfOperation,
	SecondaryVehicleType,
	UsedInDumpingIndicator,
	VehicleYear AS Year,
	StatedAmount,
	CostNew,
	VehicleDeleteDate,
	VIN,
	VehicleMake AS Make,
	VehicleModel AS Model,
	VehicleNumber,
	CompositeRatedFlag AS CompositeRating,
	TerminalZoneCode,
	VehicleType,
	ChangeFlag,
	PIPBureauCoverageCode AS PIPBureaucoverageCode,
	RetroactiveDate1 AS RetroactiveDate,
	VehicleTypeSize AS CommercialAutoVehicleType,
	BusinessUseClass AS CommercialAutoBusinessUseClass,
	SecondaryClass,
	FleetType,
	SecondaryClassGroup,
	IncludeUIM,
	CoordinationOfBenefits,
	MedicalExpensesOption,
	CoveredByWorkComp,
	SubjectToNoFault,
	AdditionalLimitKS,
	AdditionalLimitKY,
	AdditionalLimitMN,
	RatingZoneCode,
	ReplacementCost,
	FullGlassIndicator,
	HistoricVehicleIndicator
	FROM EXP_DetectChanges
),
RTR_INSERT_UPDATE_INSERT AS (SELECT * FROM RTR_INSERT_UPDATE WHERE ChangeFlag = 'NEW'),
RTR_INSERT_UPDATE_UPDATE AS (SELECT * FROM RTR_INSERT_UPDATE WHERE ChangeFlag = 'UPDATE'),
CoverageDetailCommercialAuto_INSERT AS (
	INSERT INTO CoverageDetailCommercialAuto
	(PremiumTransactionID, CurrentSnapshotFlag, AuditID, EffectiveDate, ExpirationDate, SourceSystemID, CreatedDate, ModifiedDate, CoverageGuid, VehicleGroupCode, RadiusOfOperation, SecondaryVehicleType, UsedInDumpingIndicator, VehicleYear, StatedAmount, CostNew, VehicleDeleteDate, VIN, VehicleMake, VehicleModel, VehicleNumber, CompositeRatedFlag, TerminalZoneCode, VehicleType, PIPBureauCoverageCode, RetroactiveDate, VehicleTypeSize, BusinessUseClass, SecondaryClass, FleetType, SecondaryClassGroup, IncludeUIM, CoordinationOfBenefits, MedicalExpensesOption, CoveredByWorkersCompensationFlag, SubjectToNoFault, AdditionalLimitKS, AdditionalLimitKY, AdditionalLimitMN, RatingZoneCode, ReplacementCost, FullGlassIndicator, HistoricVehicleIndicator)
	SELECT 
	PREMIUMTRANSACTIONID, 
	CURRENTSNAPSHOTFLAG, 
	AUDITID, 
	EFFECTIVEDATE, 
	EXPIRATIONDATE, 
	SOURCESYSTEMID, 
	CREATEDDATE, 
	MODIFIEDDATE, 
	COVERAGEGUID, 
	VEHICLEGROUPCODE, 
	RADIUSOFOPERATION, 
	SECONDARYVEHICLETYPE, 
	USEDINDUMPINGINDICATOR, 
	Year AS VEHICLEYEAR, 
	STATEDAMOUNT, 
	COSTNEW, 
	VEHICLEDELETEDATE, 
	VIN, 
	Make AS VEHICLEMAKE, 
	Model AS VEHICLEMODEL, 
	VEHICLENUMBER, 
	CompositeRating AS COMPOSITERATEDFLAG, 
	TERMINALZONECODE, 
	VEHICLETYPE, 
	PIPBureaucoverageCode AS PIPBUREAUCOVERAGECODE, 
	RETROACTIVEDATE, 
	CommercialAutoVehicleType AS VEHICLETYPESIZE, 
	CommercialAutoBusinessUseClass AS BUSINESSUSECLASS, 
	SECONDARYCLASS, 
	FLEETTYPE, 
	SECONDARYCLASSGROUP, 
	INCLUDEUIM, 
	COORDINATIONOFBENEFITS, 
	MEDICALEXPENSESOPTION, 
	CoveredByWorkComp AS COVEREDBYWORKERSCOMPENSATIONFLAG, 
	SUBJECTTONOFAULT, 
	ADDITIONALLIMITKS, 
	ADDITIONALLIMITKY, 
	ADDITIONALLIMITMN, 
	RATINGZONECODE, 
	REPLACEMENTCOST, 
	FULLGLASSINDICATOR, 
	HISTORICVEHICLEINDICATOR
	FROM RTR_INSERT_UPDATE_INSERT
),