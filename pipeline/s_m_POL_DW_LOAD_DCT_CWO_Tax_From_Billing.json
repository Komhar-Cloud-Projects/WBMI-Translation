{
    "name": "s_m_POL_DW_LOAD_DCT_CWO_Tax_From_Billing",
    "properties": {
        "activities": [
            {
                "name": "m_POL_DW_LOAD_DCT_CWO_Tax_From_Billing",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nSQ_PassThroughChargeTransaction AS (\n\tselect \r\n\tpt.EffectiveDate,pt.LogicalIndicator,pt.LogicalDeleteFlag,pt.DuplicateSequence, pt.PassThroughChargeTransactionHashKey,\r\n\tpt.StatisticalCoverageAKID,\r\n\tmax(pt.PassThroughChargeTransactionExpirationDate) over (partition by pol.pol_key) as PassThroughChargeTransactionExpirationDate,\r\n\tpt.PassThroughChargeTransactionAmount, pt.TaxPercentageRate,pt.PassThroughChargeTransactionCodeId, pt.RisklocationAKID,\r\n\tpt.PolicyAKID,pt.SupLGTLineOfInsuranceID,pt.SupSurchargeExemptID, pt.SupPassThroughChargeTypeID,pt.PolicyCoverageAKId,pt.DCTTaxCode,\r\n\tpt.OffsetOnsetCode,DCBIL.WrittenOffAmount, DCBIL.InstallmentDate, DCBIL.PolicyReference,\r\n\tpol.pol_eff_date, pol.pol_exp_date\r\n\tfrom PassThroughChargeTransaction pt\r\n\tinner join @{pipeline().parameters.TARGET_TABLE_OWNER_V2}.policy pol\r\n\ton pol.pol_ak_id = pt.PolicyAKID\r\n\tand pol.crrnt_snpsht_flag = 1\r\n\tinner join @{pipeline().parameters.SOURCE_DATABASE_NAME}..WorkDCBILCommissionCWOTax DCBIL\r\n\ton DCBIL.PolicyReference=pol.pol_num and DCBIL.PolicyTermEffectiveDate=pol.pol_eff_date and DCBIL.PolicyTermExpirationDate=pol.pol_exp_date\r\n\twhere pt.PassThroughChargeTransactionAmount <> 0\r\n\tand DCBIL.WrittenOffAmount<>0\r\n\tAnd pt.SourceSystemID='@{pipeline().parameters.SOURCE_SYSTEM_ID}'\r\n\tand pt.ReasonAmendedCode!='CWO'\r\n\torder by pol.pol_key, pt.PassThroughChargeTransactionID\n),\nLKP_Exist AS (\n\tSELECT\n\tPolicyNumber,\n\tPassThroughChargeTransactionEffectiveDate,\n\tTotalCWO,\n\tpol_eff_date,\n\tpol_exp_date\n\tFROM (\n\t\tselect pol.pol_num as PolicyNumber, pt.PassThroughChargeTransactionEffectiveDate as PassThroughChargeTransactionEffectiveDate, sum(pt.PassThroughChargeTransactionAmount) as TotalCWO,\r\n\t\tpol.pol_eff_date as pol_eff_date, pol.pol_exp_date as pol_exp_date\r\n\t\tfrom PassThroughChargeTransaction pt\t\r\n\t\tinner join @{pipeline().parameters.TARGET_TABLE_OWNER_V2}.policy pol\ton pol.pol_ak_id = pt.PolicyAKID\tand pol.crrnt_snpsht_flag = 1\t\r\n\t\twhere PT.ReasonAmendedCode='CWO'\r\n\t\tgroup by pol.pol_num, pt.PassThroughChargeTransactionEffectiveDate, pol.pol_eff_date, pol.pol_exp_date\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY PolicyNumber,PassThroughChargeTransactionEffectiveDate,TotalCWO,pol_eff_date,pol_exp_date ORDER BY PolicyNumber) = 1\n),\nLKP_TotalPassThroughAmount AS (\n\tSELECT\n\tTotalPassThroughAmount,\n\tpol_num,\n\tpol_eff_date,\n\tpol_exp_date\n\tFROM (\n\t\tselect pol.pol_num as pol_num, sum(pt.PassThroughChargeTransactionAmount) as TotalPassThroughAmount,\r\n\t\tpol.pol_eff_date as pol_eff_date, pol.pol_exp_date as pol_exp_date\r\n\t\tfrom PassThroughChargeTransaction pt\r\n\t\tinner join @{pipeline().parameters.TARGET_TABLE_OWNER_V2}.policy pol\r\n\t\ton pol.pol_ak_id = pt.PolicyAKID\r\n\t\tand pol.crrnt_snpsht_flag = 1\r\n\t\twhere pt.PassThroughChargeTransactionAmount <> 0\r\n\t\tAnd pt.SourceSystemID='@{pipeline().parameters.SOURCE_SYSTEM_ID}'\r\n\t\tand pt.ReasonAmendedCode!='CWO'\r\n\t\tand POL.pol_num in (select distinct PolicyReference from @{pipeline().parameters.SOURCE_DATABASE_NAME}..WorkDCBILCommissionCWOTax DCBIL)\r\n\t\tgroup by pol.pol_num,pol.pol_eff_date, pol.pol_exp_date\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY pol_num,pol_eff_date,pol_exp_date ORDER BY TotalPassThroughAmount) = 1\n),\nFIL_Exist AS (\n\tSELECT\n\tLKP_Exist.PolicyNumber AS lkp_PolicyNumber, \n\tSQ_PassThroughChargeTransaction.EffectiveDate, \n\tSQ_PassThroughChargeTransaction.LogicalIndicator, \n\tSQ_PassThroughChargeTransaction.LogicalDeleteFlag, \n\tSQ_PassThroughChargeTransaction.DuplicateSequence, \n\tSQ_PassThroughChargeTransaction.PassThroughChargeTransactionHashKey, \n\tSQ_PassThroughChargeTransaction.StatisticalCoverageAKID, \n\tSQ_PassThroughChargeTransaction.PassThroughChargeTransactionExpirationDate, \n\tSQ_PassThroughChargeTransaction.PassThroughChargeTransactionAmount, \n\tSQ_PassThroughChargeTransaction.TaxPercentageRate, \n\tSQ_PassThroughChargeTransaction.PassThroughChargeTransactionCodeId, \n\tSQ_PassThroughChargeTransaction.RisklocationAKID, \n\tSQ_PassThroughChargeTransaction.PolicyAKID, \n\tSQ_PassThroughChargeTransaction.SupLGTLineOfInsuranceID, \n\tSQ_PassThroughChargeTransaction.SupSurchargeExemptID, \n\tSQ_PassThroughChargeTransaction.SupPassThroughChargeTypeID, \n\tSQ_PassThroughChargeTransaction.PolicyCoverageAKId, \n\tSQ_PassThroughChargeTransaction.DCTTaxCode, \n\tSQ_PassThroughChargeTransaction.OffsetOnsetCode, \n\tLKP_TotalPassThroughAmount.TotalPassThroughAmount, \n\tSQ_PassThroughChargeTransaction.WrittenOffAmount, \n\tSQ_PassThroughChargeTransaction.InstallmentDate\n\tFROM SQ_PassThroughChargeTransaction\n\tLEFT JOIN LKP_Exist\n\tON LKP_Exist.PolicyNumber = SQ_PassThroughChargeTransaction.PolicyReference AND LKP_Exist.PassThroughChargeTransactionEffectiveDate = SQ_PassThroughChargeTransaction.InstallmentDate AND LKP_Exist.TotalCWO = SQ_PassThroughChargeTransaction.WrittenOffAmount AND LKP_Exist.pol_eff_date = SQ_PassThroughChargeTransaction.pol_eff_date AND LKP_Exist.pol_exp_date = SQ_PassThroughChargeTransaction.pol_exp_date\n\tLEFT JOIN LKP_TotalPassThroughAmount\n\tON LKP_TotalPassThroughAmount.pol_num = SQ_PassThroughChargeTransaction.PolicyReference AND LKP_TotalPassThroughAmount.pol_eff_date = SQ_PassThroughChargeTransaction.pol_eff_date AND LKP_TotalPassThroughAmount.pol_exp_date = SQ_PassThroughChargeTransaction.pol_exp_date\n\tWHERE ISNULL(lkp_PolicyNumber)\n),\nSEQ_PassThroughChargeTransactionAKID AS (\n\tCREATE SEQUENCE SEQ_PassThroughChargeTransactionAKID\n\tSTART = 0\n\tINCREMENT = 1;\n),\nEXP_AmountCalc AS (\n\tSELECT\n\tEffectiveDate AS i_EffectiveDate,\n\tLogicalIndicator AS i_LogicalIndicator,\n\tLogicalDeleteFlag AS i_LogicalDeleteFlag,\n\tDuplicateSequence AS i_DuplicateSequence,\n\tPassThroughChargeTransactionHashKey AS i_PassThroughChargeTransactionHashKey,\n\tStatisticalCoverageAKID AS i_StatisticalCoverageAKID,\n\tPassThroughChargeTransactionExpirationDate AS i_PassThroughChargeTransactionExpirationDate,\n\tPassThroughChargeTransactionAmount AS i_PassThroughChargeTransactionAmount,\n\tTaxPercentageRate AS i_TaxPercentageRate,\n\tPassThroughChargeTransactionCodeId AS i_PassThroughChargeTransactionCodeId,\n\tRisklocationAKID AS i_RisklocationAKID,\n\tPolicyAKID AS i_PolicyAKID,\n\tSupLGTLineOfInsuranceID AS i_SupLGTLineOfInsuranceID,\n\tSupSurchargeExemptID AS i_SupSurchargeExemptID,\n\tSupPassThroughChargeTypeID AS i_SupPassThroughChargeTypeID,\n\tPolicyCoverageAKId AS i_PolicyCoverageAKId,\n\tDCTTaxCode AS i_DCTTaxCode,\n\tOffsetOnsetCode AS i_OffsetOnsetCode,\n\tTotalPassThroughAmount AS i_TotalPassThroughAmount,\n\tWrittenOffAmount AS i_WrittenOffAmount,\n\tInstallmentDate AS i_InstallmentDate,\n\tSEQ_PassThroughChargeTransactionAKID.NEXTVAL AS i_NEXTVAL,\n\t-- *INF*: IIF(i_TotalPassThroughAmount=0,0,i_PassThroughChargeTransactionAmount/i_TotalPassThroughAmount)\n\tIFF(\n\t    i_TotalPassThroughAmount = 0, 0,\n\t    i_PassThroughChargeTransactionAmount / i_TotalPassThroughAmount\n\t) AS v_AllocationFactor,\n\tv_AllocationFactor*i_WrittenOffAmount AS v_CWOAmount,\n\t'1' AS o_CurrentSnapshotFlag,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS o_AuditID,\n\ti_EffectiveDate AS o_EffectiveDate,\n\t-- *INF*: TO_DATE('12/31/2100 23:59:59','MM/DD/YYYY HH24:MI:SS')\n\tTO_TIMESTAMP('12/31/2100 23:59:59', 'MM/DD/YYYY HH24:MI:SS') AS o_ExpirationDate,\n\t@{pipeline().parameters.SOURCE_SYSTEM_ID} AS o_SourceSystemID,\n\tSYSDATE AS o_CreatedDate,\n\tSYSDATE AS o_ModifiedDate,\n\ti_LogicalIndicator AS o_LogicalIndicator,\n\t-- *INF*: DECODE(TRUE,i_LogicalDeleteFlag='T','1',i_LogicalDeleteFlag='F','0','0')\n\tDECODE(\n\t    TRUE,\n\t    i_LogicalDeleteFlag = 'T', '1',\n\t    i_LogicalDeleteFlag = 'F', '0',\n\t    '0'\n\t) AS o_LogicalDeleteFlag,\n\ti_DuplicateSequence AS o_DuplicateSequence,\n\ti_PassThroughChargeTransactionHashKey AS o_PassThroughChargeTransactionHashKey,\n\ti_NEXTVAL AS o_PassThroughChargeTransactionAKID,\n\ti_StatisticalCoverageAKID AS o_StatisticalCoverageAKID,\n\t'Endorse' AS o_PassThroughChargeTransactionCode,\n\ti_InstallmentDate AS o_PassThroughChargeTransactionEnteredDate,\n\ti_InstallmentDate AS o_PassThroughChargeTransactionEffectiveDate,\n\ti_PassThroughChargeTransactionExpirationDate AS o_PassThroughChargeTransactionExpirationDate,\n\ti_InstallmentDate AS o_PassThroughChargeTransactionBookedDate,\n\tv_CWOAmount AS o_PassThroughChargeTransactionAmount,\n\t0.00 AS o_FullTermPremium,\n\t0.00 AS o_FullTaxAmount,\n\ti_TaxPercentageRate AS o_TaxPercentageRate,\n\t'CWO' AS o_ReasonAmendedCode,\n\ti_PassThroughChargeTransactionCodeId AS o_PassThroughChargeTransactionCodeId,\n\ti_RisklocationAKID AS o_RisklocationAKID,\n\ti_PolicyAKID AS o_PolicyAKID,\n\ti_SupLGTLineOfInsuranceID AS o_SupLGTLineOfInsuranceID,\n\ti_SupSurchargeExemptID AS o_SupSurchargeExemptID,\n\ti_SupPassThroughChargeTypeID AS o_SupPassThroughChargeTypeID,\n\t0.00 AS o_TotalAnnualPremiumSubjectToTax,\n\ti_PolicyCoverageAKId AS o_PolicyCoverageAKId,\n\ti_DCTTaxCode AS o_DCTTaxCode,\n\ti_OffsetOnsetCode AS o_OffsetOnsetCode,\n\t1 AS LoadSequence,\n\t'N/A' AS NegateRestateCode\n\tFROM FIL_Exist\n),\nPassThroughChargeTransaction AS (\n\tINSERT INTO PassThroughChargeTransaction\n\t(CurrentSnapshotFlag, AuditID, EffectiveDate, ExpirationDate, SourceSystemID, CreatedDate, ModifiedDate, LogicalIndicator, LogicalDeleteFlag, DuplicateSequence, PassThroughChargeTransactionHashKey, PassThroughChargeTransactionAKID, StatisticalCoverageAKID, PassThroughChargeTransactionCode, PassThroughChargeTransactionEnteredDate, PassThroughChargeTransactionEffectiveDate, PassThroughChargeTransactionExpirationDate, PassThroughChargeTransactionBookedDate, PassThroughChargeTransactionAmount, FullTermPremium, FullTaxAmount, TaxPercentageRate, ReasonAmendedCode, PassThroughChargeTransactionCodeId, RiskLocationAKID, PolicyAKID, SupLGTLineOfInsuranceID, PolicyCoverageAKID, SupSurchargeExemptID, SupPassThroughChargeTypeID, TotalAnnualPremiumSubjectToTax, DCTTaxCode, OffsetOnsetCode, LoadSequence, NegateRestateCode)\n\tSELECT \n\to_CurrentSnapshotFlag AS CURRENTSNAPSHOTFLAG, \n\to_AuditID AS AUDITID, \n\to_EffectiveDate AS EFFECTIVEDATE, \n\to_ExpirationDate AS EXPIRATIONDATE, \n\to_SourceSystemID AS SOURCESYSTEMID, \n\to_CreatedDate AS CREATEDDATE, \n\to_ModifiedDate AS MODIFIEDDATE, \n\to_LogicalIndicator AS LOGICALINDICATOR, \n\to_LogicalDeleteFlag AS LOGICALDELETEFLAG, \n\to_DuplicateSequence AS DUPLICATESEQUENCE, \n\to_PassThroughChargeTransactionHashKey AS PASSTHROUGHCHARGETRANSACTIONHASHKEY, \n\to_PassThroughChargeTransactionAKID AS PASSTHROUGHCHARGETRANSACTIONAKID, \n\to_StatisticalCoverageAKID AS STATISTICALCOVERAGEAKID, \n\to_PassThroughChargeTransactionCode AS PASSTHROUGHCHARGETRANSACTIONCODE, \n\to_PassThroughChargeTransactionEnteredDate AS PASSTHROUGHCHARGETRANSACTIONENTEREDDATE, \n\to_PassThroughChargeTransactionEffectiveDate AS PASSTHROUGHCHARGETRANSACTIONEFFECTIVEDATE, \n\to_PassThroughChargeTransactionExpirationDate AS PASSTHROUGHCHARGETRANSACTIONEXPIRATIONDATE, \n\to_PassThroughChargeTransactionBookedDate AS PASSTHROUGHCHARGETRANSACTIONBOOKEDDATE, \n\to_PassThroughChargeTransactionAmount AS PASSTHROUGHCHARGETRANSACTIONAMOUNT, \n\to_FullTermPremium AS FULLTERMPREMIUM, \n\to_FullTaxAmount AS FULLTAXAMOUNT, \n\to_TaxPercentageRate AS TAXPERCENTAGERATE, \n\to_ReasonAmendedCode AS REASONAMENDEDCODE, \n\to_PassThroughChargeTransactionCodeId AS PASSTHROUGHCHARGETRANSACTIONCODEID, \n\to_RisklocationAKID AS RISKLOCATIONAKID, \n\to_PolicyAKID AS POLICYAKID, \n\to_SupLGTLineOfInsuranceID AS SUPLGTLINEOFINSURANCEID, \n\to_PolicyCoverageAKId AS POLICYCOVERAGEAKID, \n\to_SupSurchargeExemptID AS SUPSURCHARGEEXEMPTID, \n\to_SupPassThroughChargeTypeID AS SUPPASSTHROUGHCHARGETYPEID, \n\to_TotalAnnualPremiumSubjectToTax AS TOTALANNUALPREMIUMSUBJECTTOTAX, \n\to_DCTTaxCode AS DCTTAXCODE, \n\to_OffsetOnsetCode AS OFFSETONSETCODE, \n\tLOADSEQUENCE, \n\tNEGATERESTATECODE\n\tFROM EXP_AmountCalc\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "TARGET_TABLE_OWNER_V2": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "SOURCE_DATABASE_NAME": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "SOURCE_SYSTEM_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            }
        },
        "folder": {
            "name": "RPT_EDM and EDW/Policy DataWarehouse/"
        },
        "annotations": []
    }
}