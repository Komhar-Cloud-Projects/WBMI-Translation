{
    "name": "s_m_POL_DM_LOAD_PremiumTransactionTypeDim",
    "properties": {
        "activities": [
            {
                "name": "m_POL_DM_LOAD_PremiumTransactionTypeDim",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nSQ_PremiumTransaction AS (\n\t(SELECT DISTINCT\r\n\tPT.SourceSystemID,\r\n\tLTRIM(RTRIM(PT.PremiumType)), \r\n\tLTRIM(RTRIM(PT.ReasonAmendedCode)), \r\n\tPT.SupPremiumTransactionCodeId,\r\n\t0 as CustomerCareCommissionRate\r\n\tFROM\r\n\tPremiumTransaction PT\r\n\tWHERE PT.CREATEDDATE>='@{pipeline().parameters.SELECTION_START_TS}' and PT.SourceSystemID='PMS'\r\n\t@{pipeline().parameters.WHERE_CLAUSE_PMS}\r\n\t\r\n\tUNION ALL\r\n\t\r\n\tSELECT DISTINCT\r\n\tPT.SourceSystemID,\r\n\tLTRIM(RTRIM(PT.PremiumType)), \r\n\tLTRIM(RTRIM(PT.ReasonAmendedCode)), \r\n\tPT.SupPremiumTransactionCodeId,\r\n\tPOLCOV.CustomerCareCommissionRate\r\n\tFROM\r\n\tPremiumTransaction PT\r\n\tINNER JOIN RatingCoverage RC\r\n\tON PT.RatingCoverageAKID=RC.RatingCoverageAKID\r\n\tAND PT.EffectiveDate=RC.EffectiveDate\r\n\tINNER JOIN PolicyCoverage POLCOV\r\n\tON RC.PolicyCoverageAKID=POLCOV.PolicyCoverageAKID AND POLCOV.CurrentSnapshotFlag=1\r\n\tWHERE PT.CREATEDDATE>='@{pipeline().parameters.SELECTION_START_TS}' and PT.SourceSystemID='DCT'\r\n\t@{pipeline().parameters.WHERE_CLAUSE_DCT}\r\n\t)\r\n\t\r\n\tUNION\r\n\t\r\n\tSELECT DISTINCT\r\n\tPT.SourceSystemID,\r\n\t'C', \r\n\tLTRIM(RTRIM(PT.ReasonAmendedCode)),\r\n\tPT.SupPremiumTransactionCodeId,\r\n\t0 as CustomerCareCommissionRate\r\n\tFROM\r\n\tPremiumTransaction PT INNER JOIN StatisticalCoverage SC\r\n\tON PT.StatisticalCoverageAKID=SC.StatisticalCoverageAKID\r\n\tWHERE\r\n\tPT.CREATEDDATE>='@{pipeline().parameters.SELECTION_START_TS}' and \r\n\tSC.MajorPerilCode='050'\r\n\t@{pipeline().parameters.WHERE_CLAUSE_PMS}\n),\nexp_Collect_Data_columns AS (\n\tSELECT\n\tSourceSystemID,\n\tPremiumType,\n\tReasonAmendedCode,\n\tSupPremiumTransactionCodeId,\n\tCustomerCareCommissionRate,\n\t1 AS CurrentSnapshotFlag,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS audit_id,\n\tSYSDATE AS createddate,\n\tSYSDATE AS modifieddate,\n\t-- *INF*: TO_DATE('1/1/1800 01:00:00', 'MM/DD/YYYY HH24:MI:SS')\n\tTO_DATE('1/1/1800 01:00:00', 'MM/DD/YYYY HH24:MI:SS') AS EffectiveDate,\n\t-- *INF*: TO_DATE('12/31/2100 23:59:59', 'MM/DD/YYYY HH24:MI:SS')\n\tTO_DATE('12/31/2100 23:59:59', 'MM/DD/YYYY HH24:MI:SS') AS ExpirationDate\n\tFROM SQ_PremiumTransaction\n),\nlkp_sup_premium_transaction_code AS (\n\tSELECT\n\tprem_trans_code_descript,\n\tprem_trans_type_descript,\n\tStandardPremiumTransactionCode,\n\tsup_prem_trans_code_id\n\tFROM (\n\t\tSELECT\r\n\t\tSPTC. sup_prem_trans_code_id as sup_prem_trans_code_id,\r\n\t\tSPTC.prem_trans_code_descript as prem_trans_code_descript, \r\n\t\tSPTC.prem_trans_type_descript as prem_trans_type_descript, \r\n\t\tSPTC.StandardPremiumTransactionCode as StandardPremiumTransactionCode\r\n\t\tFROM sup_premium_transaction_code SPTC\r\n\t\twhere SPTC.crrnt_snpsht_flag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY sup_prem_trans_code_id ORDER BY prem_trans_code_descript DESC) = 1\n),\nlkp_sup_reason_amended_code AS (\n\tSELECT\n\tStandardReasonAmendedDescription,\n\tStandardReasonAmendedCode,\n\trsn_amended_code,\n\tsource_sys_id\n\tFROM (\n\t\tSELECT \n\t\t\tStandardReasonAmendedDescription,\n\t\t\tStandardReasonAmendedCode,\n\t\t\trsn_amended_code,\n\t\t\tsource_sys_id\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.sup_reason_amended_code\n\t\tWHERE crrnt_snpsht_flag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY rsn_amended_code,source_sys_id ORDER BY StandardReasonAmendedDescription) = 1\n),\nExp_Collect_LookupData AS (\n\tSELECT\n\tlkp_sup_premium_transaction_code.prem_trans_code_descript AS lkp_prem_trans_code_descript,\n\t-- *INF*: iif(isnull(lkp_prem_trans_code_descript) or IS_SPACES(lkp_prem_trans_code_descript) or LENGTH(lkp_prem_trans_code_descript)=0,'N/A',LTRIM(RTRIM(lkp_prem_trans_code_descript)))\n\tIFF(lkp_prem_trans_code_descript IS NULL OR IS_SPACES(lkp_prem_trans_code_descript) OR LENGTH(lkp_prem_trans_code_descript) = 0, 'N/A', LTRIM(RTRIM(lkp_prem_trans_code_descript))) AS o_lkp_prem_trans_code_descript,\n\tlkp_sup_premium_transaction_code.prem_trans_type_descript AS lkp_prem_trans_type_descript,\n\t-- *INF*: iif(isnull(lkp_prem_trans_type_descript) or IS_SPACES(lkp_prem_trans_type_descript) or LENGTH(lkp_prem_trans_type_descript)=0,'N/A',LTRIM(RTRIM(lkp_prem_trans_type_descript)))\n\tIFF(lkp_prem_trans_type_descript IS NULL OR IS_SPACES(lkp_prem_trans_type_descript) OR LENGTH(lkp_prem_trans_type_descript) = 0, 'N/A', LTRIM(RTRIM(lkp_prem_trans_type_descript))) AS o_lkp_prem_trans_type_descript,\n\tlkp_sup_reason_amended_code.StandardReasonAmendedDescription AS lkp_rsn_amended_code_descript,\n\t-- *INF*: iif(isnull(lkp_rsn_amended_code_descript) or IS_SPACES(lkp_rsn_amended_code_descript) or LENGTH(lkp_rsn_amended_code_descript)=0,'N/A',LTRIM(RTRIM(lkp_rsn_amended_code_descript)))\n\tIFF(lkp_rsn_amended_code_descript IS NULL OR IS_SPACES(lkp_rsn_amended_code_descript) OR LENGTH(lkp_rsn_amended_code_descript) = 0, 'N/A', LTRIM(RTRIM(lkp_rsn_amended_code_descript))) AS o_lkp_rsn_amended_code_descript,\n\tlkp_sup_premium_transaction_code.StandardPremiumTransactionCode AS lkp_StandardPremiumTransactionCode,\n\t-- *INF*: iif(isnull(lkp_StandardPremiumTransactionCode) or IS_SPACES(lkp_StandardPremiumTransactionCode) or LENGTH(lkp_StandardPremiumTransactionCode)=0,'N/A',LTRIM(RTRIM(lkp_StandardPremiumTransactionCode)))\n\tIFF(lkp_StandardPremiumTransactionCode IS NULL OR IS_SPACES(lkp_StandardPremiumTransactionCode) OR LENGTH(lkp_StandardPremiumTransactionCode) = 0, 'N/A', LTRIM(RTRIM(lkp_StandardPremiumTransactionCode))) AS o_PremiumTransactionCode,\n\tlkp_sup_reason_amended_code.StandardReasonAmendedCode AS lkp_StandardReasonAmendedCode,\n\t-- *INF*: IIF(ISNULL(lkp_StandardReasonAmendedCode) or IS_SPACES(lkp_StandardReasonAmendedCode) or LENGTH(lkp_StandardReasonAmendedCode)=0,'N/A',LTRIM(RTRIM(lkp_StandardReasonAmendedCode)))\n\tIFF(lkp_StandardReasonAmendedCode IS NULL OR IS_SPACES(lkp_StandardReasonAmendedCode) OR LENGTH(lkp_StandardReasonAmendedCode) = 0, 'N/A', LTRIM(RTRIM(lkp_StandardReasonAmendedCode))) AS o_ReasonAmendedCode,\n\texp_Collect_Data_columns.PremiumType,\n\texp_Collect_Data_columns.CurrentSnapshotFlag,\n\texp_Collect_Data_columns.audit_id,\n\texp_Collect_Data_columns.createddate,\n\texp_Collect_Data_columns.modifieddate,\n\texp_Collect_Data_columns.EffectiveDate,\n\texp_Collect_Data_columns.ExpirationDate,\n\texp_Collect_Data_columns.CustomerCareCommissionRate AS i_CustomerCareCommissionRate,\n\ti_CustomerCareCommissionRate AS o_CustomerCareCommissionRate\n\tFROM exp_Collect_Data_columns\n\tLEFT JOIN lkp_sup_premium_transaction_code\n\tON lkp_sup_premium_transaction_code.sup_prem_trans_code_id = exp_Collect_Data_columns.SupPremiumTransactionCodeId\n\tLEFT JOIN lkp_sup_reason_amended_code\n\tON lkp_sup_reason_amended_code.rsn_amended_code = exp_Collect_Data_columns.ReasonAmendedCode AND lkp_sup_reason_amended_code.source_sys_id = exp_Collect_Data_columns.SourceSystemID\n),\nlkp_PremiumTransactionTypeDim AS (\n\tSELECT\n\tPremiumTransactionTypeDimID,\n\tPremiumTransactionCode,\n\tReasonAmendedCode,\n\tPremiumTypeCode,\n\tCustomerCareCommissionRate\n\tFROM (\n\t\tSELECT \r\n\t\tPTTD.PremiumTransactionTypeDimID as PremiumTransactionTypeDimID,\r\n\t\tLTRIM(RTRIM(PTTD.PremiumTransactionCode)) as PremiumTransactionCode, \r\n\t\tLTRIM(RTRIM(PTTD.ReasonAmendedCode)) as ReasonAmendedCode, \r\n\t\tLTRIM(RTRIM(PTTD.PremiumTypeCode)) as PremiumTypeCode ,\r\n\t\tCustomerCareCommissionRate as CustomerCareCommissionRate\r\n\t\tFROM PremiumTransactionTypeDim PTTD\r\n\t\twhere PTTD.CurrentSnapShotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY PremiumTransactionCode,ReasonAmendedCode,PremiumTypeCode,CustomerCareCommissionRate ORDER BY PremiumTransactionTypeDimID DESC) = 1\n),\nfil_PremiumTransactionTypeDim AS (\n\tSELECT\n\tlkp_PremiumTransactionTypeDim.PremiumTransactionTypeDimID AS lkp_PremiumTransactionTypeDimID, \n\tlkp_PremiumTransactionTypeDim.PremiumTransactionCode AS lkp_PremiumTransactionCode, \n\tlkp_PremiumTransactionTypeDim.ReasonAmendedCode AS lkp_ReasonAmendedCode, \n\tlkp_PremiumTransactionTypeDim.PremiumTypeCode AS lkp_PremiumTypeCode, \n\tExp_Collect_LookupData.o_lkp_prem_trans_code_descript, \n\tExp_Collect_LookupData.o_lkp_prem_trans_type_descript, \n\tExp_Collect_LookupData.o_lkp_rsn_amended_code_descript, \n\tExp_Collect_LookupData.o_PremiumTransactionCode AS PremiumTransactionCode, \n\tExp_Collect_LookupData.o_ReasonAmendedCode AS ReasonAmendedCode, \n\tExp_Collect_LookupData.PremiumType, \n\tExp_Collect_LookupData.CurrentSnapshotFlag, \n\tExp_Collect_LookupData.audit_id, \n\tExp_Collect_LookupData.createddate, \n\tExp_Collect_LookupData.modifieddate, \n\tExp_Collect_LookupData.EffectiveDate, \n\tExp_Collect_LookupData.ExpirationDate, \n\tExp_Collect_LookupData.o_CustomerCareCommissionRate AS CustomerCareCommissionRate\n\tFROM Exp_Collect_LookupData\n\tLEFT JOIN lkp_PremiumTransactionTypeDim\n\tON lkp_PremiumTransactionTypeDim.PremiumTransactionCode = Exp_Collect_LookupData.o_PremiumTransactionCode AND lkp_PremiumTransactionTypeDim.ReasonAmendedCode = Exp_Collect_LookupData.o_ReasonAmendedCode AND lkp_PremiumTransactionTypeDim.PremiumTypeCode = Exp_Collect_LookupData.PremiumType AND lkp_PremiumTransactionTypeDim.CustomerCareCommissionRate = Exp_Collect_LookupData.o_CustomerCareCommissionRate\n\tWHERE ISNULL(lkp_PremiumTransactionTypeDimID)\r\nOR\r\n(\r\n(ISNULL(PremiumTransactionCode) AND ISNULL(lkp_ReasonAmendedCode) AND ISNULL(lkp_PremiumTypeCode))\r\nAND\r\n(PremiumTransactionCode='N/A' or ReasonAmendedCode<>'N/A' or lkp_PremiumTypeCode<>'N/A')\r\n)\n),\nAGG_REM_Duplicates AS (\n\tSELECT\n\tlkp_PremiumTransactionCode,\n\tlkp_ReasonAmendedCode,\n\tlkp_PremiumTypeCode,\n\to_lkp_prem_trans_code_descript,\n\to_lkp_prem_trans_type_descript,\n\to_lkp_rsn_amended_code_descript,\n\tPremiumTransactionCode,\n\tReasonAmendedCode,\n\tPremiumType,\n\tCurrentSnapshotFlag,\n\taudit_id,\n\tcreateddate,\n\tmodifieddate,\n\tEffectiveDate,\n\tExpirationDate,\n\tCustomerCareCommissionRate\n\tFROM fil_PremiumTransactionTypeDim\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY PremiumTransactionCode, ReasonAmendedCode, PremiumType, CustomerCareCommissionRate ORDER BY NULL) = 1\n),\nPremiumTransactionTypeDimINS AS (\n\tINSERT INTO Shortcut_to_PremiumTransactionTypeDim\n\t(CurrentSnapshotFlag, AuditID, EffectiveDate, ExpirationDate, CreatedDate, ModifiedDate, PremiumTransactionCode, PremiumTransactionCodeDescription, PremiumTransactionTypeDescription, ReasonAmendedCode, ReasonAmendedCodeDescription, PremiumTypeCode, CustomerCareCommissionRate)\n\tSELECT \n\tCURRENTSNAPSHOTFLAG, \n\taudit_id AS AUDITID, \n\tEFFECTIVEDATE, \n\tEXPIRATIONDATE, \n\tcreateddate AS CREATEDDATE, \n\tmodifieddate AS MODIFIEDDATE, \n\tPREMIUMTRANSACTIONCODE, \n\to_lkp_prem_trans_code_descript AS PREMIUMTRANSACTIONCODEDESCRIPTION, \n\to_lkp_prem_trans_type_descript AS PREMIUMTRANSACTIONTYPEDESCRIPTION, \n\tREASONAMENDEDCODE, \n\to_lkp_rsn_amended_code_descript AS REASONAMENDEDCODEDESCRIPTION, \n\tPremiumType AS PREMIUMTYPECODE, \n\tCUSTOMERCARECOMMISSIONRATE\n\tFROM AGG_REM_Duplicates\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "246511"
            },
            "WBMI_BATCH_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "905531"
            },
            "WBMI_SESSION_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "7604510"
            },
            "SELECTION_START_TS": {
                "type": "string",
                "defaultValue": "08/30/2023 02:57:01"
            },
            "SELECTION_END_TS": {
                "type": "string",
                "defaultValue": "08/31/2023 03:31:13"
            },
            "DBCONNECTION_SOURCE": {
                "type": "string",
                "defaultValue": "SQLServer_RPT_EDM_Policy"
            },
            "DBCONNECTION_TARGET": {
                "type": "string",
                "defaultValue": "SQLServer_WC_DATA_MART_Policy"
            },
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "DBO"
            },
            "TARGET_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "DBO"
            },
            "SOURCE_SYSTEM_ID": {
                "type": "string",
                "defaultValue": "PMS"
            },
            "WHERE_CLAUSE_PMS": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WHERE_CLAUSE_DCT": {
                "type": "string",
                "defaultValue": "Default Value"
            }
        },
        "folder": {
            "name": "Policy DataMart/"
        },
        "annotations": []
    }
}