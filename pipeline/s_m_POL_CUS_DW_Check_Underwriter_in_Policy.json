{
    "name": "s_m_POL_CUS_DW_Check_Underwriter_in_Policy",
    "properties": {
        "activities": [
            {
                "name": "m_POL_CUS_DW_Check_Underwriter_in_Policy",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nLKP_BondProducts AS (\n\tSELECT\n\tProductCode,\n\tpol_id\n\tFROM (\n\t\tselect distinct p.pol_id as pol_id,\r\n\t\tprod.ProductCode as ProductCode\r\n\t\tfrom v2.policy p\r\n\t\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.PolicyCoverage pc on p.pol_ak_id = pc.PolicyAKID\r\n\t\t\t\tand pc.CurrentSnapshotFlag = 1\r\n\t\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.StatisticalCoverage sc on pc.PolicyCoverageAKID = sc.PolicyCoverageAKID\r\n\t\t\t\tand sc.CurrentSnapshotFlag = 1\r\n\t\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Product prod on sc.ProductAKId = prod.ProductAKId\r\n\t\t\t\tand prod.CurrentSnapshotFlag = 1\r\n\t\twhere p.source_sys_id = 'PMS'\r\n\t\t and p.crrnt_snpsht_flag = 1\r\n\t\t and prod.ProductCode in('610','620','630','640','650','660')\r\n\t\tunion\r\n\t\tselect distinct p.pol_id, prod.ProductCode\r\n\t\tfrom v2.policy p\r\n\t\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.PolicyCoverage pc on p.pol_ak_id = pc.PolicyAKID\r\n\t\t\t\tand pc.CurrentSnapshotFlag = 1\r\n\t\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.RatingCoverage rc on pc.PolicyCoverageAKID = rc.PolicyCoverageAKID\r\n\t\t\t\tand rc.CurrentSnapshotFlag = 1\r\n\t\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Product prod on rc.ProductAKId = prod.ProductAKId\r\n\t\t\t\tand prod.CurrentSnapshotFlag = 1\r\n\t\twhere p.source_sys_id = 'DCT'\r\n\t\t and p.crrnt_snpsht_flag = 1\r\n\t\t and prod.ProductCode in('610','620','630','640','650','660')\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY pol_id ORDER BY ProductCode DESC) = 1\n),\nLKP_SBAReinsurance AS (\n\tSELECT\n\tReturnIndicator,\n\tpol_id,\n\treins_co_num\n\tFROM (\n\t\tselect b.pol_id as pol_id,\r\n\t\ta.reins_co_num as reins_co_num,\r\n\t\t'Y' as ReturnIndicator\r\n\t\tfrom @{pipeline().parameters.SOURCE_TABLE_OWNER}.reinsurance_coverage a\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER_V2}.policy b \r\n\t\ton a.pol_ak_id = b.pol_ak_id\r\n\t\twhere a.crrnt_snpsht_flag = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY pol_id,reins_co_num ORDER BY ReturnIndicator DESC) = 1\n),\nSQ_policy AS (\n\tSELECT\n\t\tpol_id,\n\t\tcrrnt_snpsht_flag,\n\t\taudit_id,\n\t\teff_from_date,\n\t\teff_to_date,\n\t\tsource_sys_id,\n\t\tcreated_date,\n\t\tmodified_date,\n\t\tpol_ak_id,\n\t\tcontract_cust_ak_id,\n\t\tagency_ak_id,\n\t\tpol_sym,\n\t\tpol_num,\n\t\tpol_mod,\n\t\tpol_key,\n\t\tmco,\n\t\tpol_co_num,\n\t\tpol_eff_date,\n\t\tpol_exp_date,\n\t\torig_incptn_date,\n\t\tprim_bus_class_code,\n\t\treins_code,\n\t\tpms_pol_lob_code,\n\t\tpol_co_line_code,\n\t\tpol_cancellation_ind,\n\t\tpol_cancellation_date,\n\t\tpol_cancellation_rsn_code,\n\t\tstate_of_domicile_code,\n\t\twbconnect_upload_code,\n\t\tserv_center_support_code,\n\t\tpol_term,\n\t\tterrorism_risk_ind,\n\t\tprior_pol_key,\n\t\tpol_status_code,\n\t\tpol_issue_code,\n\t\tpol_age,\n\t\tindustry_risk_grade_code,\n\t\tuw_review_yr,\n\t\tmvr_request_code,\n\t\trenl_code,\n\t\tamend_num,\n\t\tanniversary_rerate_code,\n\t\tpol_audit_frqncy,\n\t\tfinal_audit_code,\n\t\tzip_ind,\n\t\tguarantee_ind,\n\t\tvariation_code,\n\t\tcounty,\n\t\tnon_smoker_disc_code,\n\t\trenl_disc,\n\t\trenl_safe_driver_disc_count,\n\t\tnonrenewal_flag_date,\n\t\taudit_complt_date,\n\t\torig_acct_date,\n\t\tpol_enter_date,\n\t\texcess_claim_code,\n\t\tpol_status_on_pif,\n\t\ttarget_mrkt_code,\n\t\tpkg_code,\n\t\tpol_kind_code,\n\t\tbus_seg_code,\n\t\tpif_upload_audit_ind,\n\t\terr_flag_bal_txn,\n\t\terr_flag_bal_reins,\n\t\tproducer_code_ak_id,\n\t\tprdcr_code,\n\t\tClassOfBusiness,\n\t\tstrtgc_bus_dvsn_ak_id,\n\t\tErrorFlagBalancePremiumTransaction,\n\t\tRenewalPolicyNumber,\n\t\tRenewalPolicySymbol,\n\t\tRenewalPolicyMod,\n\t\tBillingType,\n\t\tproducer_code_id,\n\t\tsup_bus_class_code_id,\n\t\tsup_pol_term_id,\n\t\tsup_pol_status_code_id,\n\t\tsup_pol_issue_code_id,\n\t\tsup_pol_audit_frqncy_id,\n\t\tsup_industry_risk_grade_code_id,\n\t\tsup_state_id,\n\t\tSurchargeExemptCode,\n\t\tSupSurchargeExemptID,\n\t\tStrategicProfitCenterAKId,\n\t\tInsuranceSegmentAKId,\n\t\tPolicyOfferingAKId,\n\t\tProgramAKId,\n\t\tAgencyAKId,\n\t\tUnderwritingAssociateAKId,\n\t\tObligeeName,\n\t\tAutomatedUnderwritingServicesIndicator,\n\t\tAutomaticRenewalIndicator\n\tFROM policy\n\tWHERE policy.crrnt_snpsht_flag=1 and policy.UnderwritingAssociateAKId=-1\r\n\tand policy.pol_eff_date>='2001-01-01'\r\n\t@{pipeline().parameters.WHERE_CLAUSE}\n),\nEXP_Default AS (\n\tSELECT\n\tpol_id,\n\tpol_key,\n\tStrategicProfitCenterAKId,\n\tAgencyAKId,\n\tPolicyOfferingAKId,\n\tProgramAKId,\n\twbconnect_upload_code\n\tFROM SQ_policy\n),\nLKP_Agency_V2 AS (\n\tSELECT\n\tAgencyCode,\n\tLegalName,\n\tAgencyAKID\n\tFROM (\n\t\tSELECT \n\t\t\tAgencyCode,\n\t\t\tLegalName,\n\t\t\tAgencyAKID\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER_V2}.Agency\n\t\tWHERE CurrentSnapshotFlag=1 and TerminatedDate='2100-12-31 00:00:00.000'\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY AgencyAKID ORDER BY AgencyCode) = 1\n),\nLKP_PolicyOffering AS (\n\tSELECT\n\tPolicyOfferingCode,\n\tPolicyOfferingDescription,\n\ti_PolicyOfferingAKId,\n\tPolicyOfferingAKId\n\tFROM (\n\t\tSELECT \n\t\t\tPolicyOfferingCode,\n\t\t\tPolicyOfferingDescription,\n\t\t\ti_PolicyOfferingAKId,\n\t\t\tPolicyOfferingAKId\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.PolicyOffering\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY PolicyOfferingAKId ORDER BY PolicyOfferingCode) = 1\n),\nLKP_Program AS (\n\tSELECT\n\tProgramCode,\n\tProgramDescription,\n\tProgramAKId\n\tFROM (\n\t\tSELECT \n\t\t\tProgramCode,\n\t\t\tProgramDescription,\n\t\t\tProgramAKId\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.Program\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY ProgramAKId ORDER BY ProgramCode) = 1\n),\nLKP_StrategicProfitCenter AS (\n\tSELECT\n\tStrategicProfitCenterCode,\n\tStrategicProfitCenterDescription,\n\tStrategicProfitCenterAKId\n\tFROM (\n\t\tSELECT \n\t\t\tStrategicProfitCenterCode,\n\t\t\tStrategicProfitCenterDescription,\n\t\t\tStrategicProfitCenterAKId\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.StrategicProfitCenter\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY StrategicProfitCenterAKId ORDER BY StrategicProfitCenterCode) = 1\n),\nEXP_Data AS (\n\tSELECT\n\tEXP_Default.pol_id AS i_pol_id,\n\tEXP_Default.wbconnect_upload_code AS i_wbconnect_upload_code,\n\tEXP_Default.pol_key,\n\tLKP_StrategicProfitCenter.StrategicProfitCenterCode,\n\tLKP_Agency_V2.AgencyCode,\n\tLKP_PolicyOffering.PolicyOfferingCode,\n\tLKP_Program.ProgramCode,\n\tLKP_StrategicProfitCenter.StrategicProfitCenterDescription,\n\tLKP_Agency_V2.LegalName,\n\tLKP_PolicyOffering.PolicyOfferingDescription,\n\tLKP_Program.ProgramDescription,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- i_wbconnect_upload_code = 'B','Rapid',\r\n\t-- IN(:LKP.LKP_BONDPRODUCTS(i_pol_id),'610','620','630','640','650','660')\r\n\t-- and :LKP.LKP_SBAREINSURANCE(i_pol_id,'0125') = 'Y','SBA',\r\n\t-- :LKP.LKP_BONDPRODUCTS(i_pol_id) = '610','Contract',\r\n\t-- IN(:LKP.LKP_BONDPRODUCTS(i_pol_id),'620','630','640','650','660'),'NonContract',\r\n\t-- 'N/A'\r\n\t-- )\n\tDECODE(\n\t    TRUE,\n\t    i_wbconnect_upload_code = 'B', 'Rapid',\n\t    LKP_BONDPRODUCTS_i_pol_id.ProductCode IN ('610','620','630','640','650','660') and LKP_SBAREINSURANCE_i_pol_id_0125.ReturnIndicator = 'Y', 'SBA',\n\t    LKP_BONDPRODUCTS_i_pol_id.ProductCode = '610', 'Contract',\n\t    LKP_BONDPRODUCTS_i_pol_id.ProductCode IN ('620','630','640','650','660'), 'NonContract',\n\t    'N/A'\n\t) AS o_BondCategory\n\tFROM EXP_Default\n\tLEFT JOIN LKP_Agency_V2\n\tON LKP_Agency_V2.AgencyAKID = EXP_Default.AgencyAKId\n\tLEFT JOIN LKP_PolicyOffering\n\tON LKP_PolicyOffering.PolicyOfferingAKId = EXP_Default.PolicyOfferingAKId\n\tLEFT JOIN LKP_Program\n\tON LKP_Program.ProgramAKId = EXP_Default.ProgramAKId\n\tLEFT JOIN LKP_StrategicProfitCenter\n\tON LKP_StrategicProfitCenter.StrategicProfitCenterAKId = EXP_Default.StrategicProfitCenterAKId\n\tLEFT JOIN LKP_BONDPRODUCTS LKP_BONDPRODUCTS_i_pol_id\n\tON LKP_BONDPRODUCTS_i_pol_id.pol_id = i_pol_id\n\n\tLEFT JOIN LKP_SBAREINSURANCE LKP_SBAREINSURANCE_i_pol_id_0125\n\tON LKP_SBAREINSURANCE_i_pol_id_0125.pol_id = i_pol_id\n\tAND LKP_SBAREINSURANCE_i_pol_id_0125.reins_co_num = '0125'\n\n),\nFIL_Validate AS (\n\tSELECT\n\tpol_key, \n\tStrategicProfitCenterCode, \n\tAgencyCode, \n\tPolicyOfferingCode, \n\tProgramCode, \n\tStrategicProfitCenterDescription, \n\tLegalName, \n\tPolicyOfferingDescription, \n\tProgramDescription, \n\to_BondCategory AS BondCategory\n\tFROM EXP_Data\n\tWHERE AgencyCode<>'N/A' AND NOT IN  (AgencyCode,'16998','14998','21999','34999','16999','34998','12999','22999','98999','26999','55555','13999','24999','15999','48001','48966','14967') \r\nAND StrategicProfitCenterCode <> '3'\r\n--and PolicyOfferingCode<>'600'\n),\nRTR_Hierachy AS (\n\tSELECT\n\tpol_key,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyOfferingCode,\n\tProgramCode,\n\tStrategicProfitCenterDescription,\n\tLegalName,\n\tPolicyOfferingDescription,\n\tProgramDescription,\n\tBondCategory\n\tFROM FIL_Validate\n),\nRTR_Hierachy_PolicyOffering AS (SELECT * FROM RTR_Hierachy WHERE ProgramCode='N/A'),\nRTR_Hierachy_Program AS (SELECT * FROM RTR_Hierachy WHERE ProgramCode<>'N/A'),\nRTR_Hierachy_Agency AS (SELECT * FROM RTR_Hierachy WHERE TRUE),\nRTR_Hierachy_Bond AS (SELECT * FROM RTR_Hierachy WHERE BondCategory<>'N/A'),\nLKP_UnderWriterAgencyRelationShip AS (\n\tSELECT\n\tUnderwriterAgencyRelationshipId,\n\tAgencyCode,\n\tStrategicProfitCenterCode\n\tFROM (\n\t\tselect  distinct UAR.UnderwriterAgencyRelationshipId AS UnderwriterAgencyRelationshipId,\r\n\t\tAgency.AgencyCode AS AgencyCode,\r\n\t\tUAR.StrategicProfitCenterCode AS StrategicProfitCenterCode\r\n\t\tfrom @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterAgencyRelationship UAR\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.VWAgency Agency\r\n\t\ton UAR.AgencyId=Agency.AgencyID\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY AgencyCode,StrategicProfitCenterCode ORDER BY UnderwriterAgencyRelationshipId) = 1\n),\nFIL_Agency AS (\n\tSELECT\n\tLKP_UnderWriterAgencyRelationShip.UnderwriterAgencyRelationshipId, \n\tRTR_Hierachy_Agency.pol_key, \n\tRTR_Hierachy_Agency.StrategicProfitCenterCode, \n\tRTR_Hierachy_Agency.AgencyCode, \n\tRTR_Hierachy_Agency.PolicyOfferingCode, \n\tRTR_Hierachy_Agency.ProgramCode, \n\tRTR_Hierachy_Agency.StrategicProfitCenterDescription, \n\tRTR_Hierachy_Agency.LegalName, \n\tRTR_Hierachy_Agency.PolicyOfferingDescription, \n\tRTR_Hierachy_Agency.ProgramDescription\n\tFROM RTR_Hierachy_Agency\n\tLEFT JOIN LKP_UnderWriterAgencyRelationShip\n\tON LKP_UnderWriterAgencyRelationShip.AgencyCode = RTR_Hierachy.AgencyCode4 AND LKP_UnderWriterAgencyRelationShip.StrategicProfitCenterCode = RTR_Hierachy.StrategicProfitCenterCode4\n\tWHERE ISNULL(UnderwriterAgencyRelationshipId)\n),\nEXP_Agency AS (\n\tSELECT\n\tpol_key,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyOfferingCode,\n\tProgramCode,\n\tStrategicProfitCenterDescription,\n\tLegalName,\n\tPolicyOfferingDescription,\n\tProgramDescription,\n\t1 AS Level\n\tFROM FIL_Agency\n),\nSQ_Agency_Bond AS (\n\tselect distinct Associate.DisplayName,\r\n\tAgency.AgencyCode,\r\n\tUPR.StrategicProfitCenterCode,\r\n\tUPR.PolicyOfferingCode,\r\n\tUPR.ProgramCode\r\n\tfrom @{pipeline().parameters.SOURCE_TABLE_OWNER}.VWAgency Agency\r\n\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterAgencyRelationship UAR\r\n\ton Agency.AgencyID=UAR.AgencyId\r\n\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterProductRelationship UPR\r\n\ton UAR.AssociateId=UPR.AssociateId\r\n\tand UAR.StrategicProfitCenterCode=UPR.StrategicProfitCenterCode\r\n\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Associate Associate\r\n\ton Associate.AssociateID=UAR.AssociateId\r\n\tand Associate.AssociateRole='UNDERWRITER'\r\n\tand Associate.UserId<>'N/A'\r\n\tand UPR.StrategicProfitCenterCode <>'3'\n),\nJNR_Bond AS (SELECT\n\tRTR_Hierachy_Bond.pol_key, \n\tRTR_Hierachy_Bond.StrategicProfitCenterCode, \n\tRTR_Hierachy_Bond.AgencyCode, \n\tRTR_Hierachy_Bond.PolicyOfferingCode, \n\tRTR_Hierachy_Bond.ProgramCode, \n\tRTR_Hierachy_Bond.StrategicProfitCenterDescription, \n\tRTR_Hierachy_Bond.LegalName, \n\tRTR_Hierachy_Bond.PolicyOfferingDescription, \n\tRTR_Hierachy_Bond.ProgramDescription, \n\tRTR_Hierachy_Bond.BondCategory, \n\tSQ_Agency_Bond.DisplayName, \n\tSQ_Agency_Bond.AgencyCode AS i_AgencyCode, \n\tSQ_Agency_Bond.StrategicProfitCenterCode AS i_StrategicProfitCenterCode, \n\tSQ_Agency_Bond.PolicyOfferingCode AS i_PolicyOfferingCode, \n\tSQ_Agency_Bond.ProgramCode AS i_ProgramCode, \n\tSQ_Agency_Bond.BondCategory AS i_BondCategory\n\tFROM RTR_Hierachy_Bond\n\tLEFT OUTER JOIN SQ_Agency_Bond\n\tON SQ_Agency_Bond.StrategicProfitCenterCode = RTR_Hierachy.StrategicProfitCenterCode5 AND SQ_Agency_Bond.AgencyCode = RTR_Hierachy.AgencyCode5 AND SQ_Agency_Bond.PolicyOfferingCode = RTR_Hierachy.PolicyOfferingCode5 AND SQ_Agency_Bond.ProgramCode = RTR_Hierachy.ProgramCode5 AND SQ_Agency_Bond.BondCategory = RTR_Hierachy.BondCategory5\n),\nEXP_Bond AS (\n\tSELECT\n\tpol_key,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyOfferingCode,\n\tProgramCode,\n\tStrategicProfitCenterDescription,\n\tLegalName,\n\tPolicyOfferingDescription,\n\tProgramDescription,\n\tBondCategory,\n\tDisplayName,\n\t4 AS Level\n\tFROM JNR_Bond\n),\nSQ_Agency_PolicyOffering AS (\n\tselect distinct Associate.DisplayName,\r\n\tAgency.AgencyCode,\r\n\tUPR.StrategicProfitCenterCode,\r\n\tUPR.PolicyOfferingCode\r\n\tfrom @{pipeline().parameters.SOURCE_TABLE_OWNER}.VWAgency Agency\r\n\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterAgencyRelationship UAR\r\n\ton Agency.AgencyID=UAR.AgencyId\r\n\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterProductRelationship UPR\r\n\ton UAR.AssociateId=UPR.AssociateId\r\n\tand UAR.StrategicProfitCenterCode=UPR.StrategicProfitCenterCode\r\n\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Associate Associate\r\n\ton Associate.AssociateID=UAR.AssociateId\r\n\tand Associate.AssociateRole='UNDERWRITER'\r\n\tand Associate.UserId<>'N/A'\r\n\tand UPR.StrategicProfitCenterCode <> '3'\n),\nJNR_PolicyOffering AS (SELECT\n\tRTR_Hierachy_PolicyOffering.pol_key, \n\tRTR_Hierachy_PolicyOffering.StrategicProfitCenterCode, \n\tRTR_Hierachy_PolicyOffering.AgencyCode, \n\tRTR_Hierachy_PolicyOffering.PolicyOfferingCode, \n\tRTR_Hierachy_PolicyOffering.StrategicProfitCenterDescription, \n\tRTR_Hierachy_PolicyOffering.LegalName, \n\tRTR_Hierachy_PolicyOffering.PolicyOfferingDescription, \n\tSQ_Agency_PolicyOffering.DisplayName, \n\tSQ_Agency_PolicyOffering.AgencyCode AS AgencyCode_ODS, \n\tSQ_Agency_PolicyOffering.StrategicProfitCenterCode AS StrategicProfitCenterCode_ODS, \n\tSQ_Agency_PolicyOffering.PolicyOfferingCode AS PolicyOfferingCode_ODS\n\tFROM RTR_Hierachy_PolicyOffering\n\tLEFT OUTER JOIN SQ_Agency_PolicyOffering\n\tON SQ_Agency_PolicyOffering.AgencyCode = RTR_Hierachy.AgencyCode2 AND SQ_Agency_PolicyOffering.StrategicProfitCenterCode = RTR_Hierachy.StrategicProfitCenterCode2 AND SQ_Agency_PolicyOffering.PolicyOfferingCode = RTR_Hierachy.PolicyOfferingCode2\n),\nEXP_PolicyOffering AS (\n\tSELECT\n\tpol_key,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyOfferingCode,\n\t'N/A' AS ProgramCode,\n\tStrategicProfitCenterDescription,\n\tLegalName,\n\tPolicyOfferingDescription,\n\t'Not Applicable' AS ProgramDescription,\n\tDisplayName,\n\t2 AS Level\n\tFROM JNR_PolicyOffering\n),\nSQ_Agency_Program AS (\n\tselect distinct Associate.DisplayName,\r\n\tAgency.AgencyCode,\r\n\tUPR.StrategicProfitCenterCode,\r\n\tUPR.PolicyOfferingCode,\r\n\tUPR.ProgramCode\r\n\tfrom @{pipeline().parameters.SOURCE_TABLE_OWNER}.VWAgency Agency\r\n\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterAgencyRelationship UAR\r\n\ton Agency.AgencyID=UAR.AgencyId\r\n\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterProductRelationship UPR\r\n\ton UAR.AssociateId=UPR.AssociateId\r\n\tand UAR.StrategicProfitCenterCode=UPR.StrategicProfitCenterCode\r\n\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Associate Associate\r\n\ton Associate.AssociateID=UAR.AssociateId\r\n\tand Associate.AssociateRole='UNDERWRITER'\r\n\tand Associate.UserId<>'N/A'\r\n\tand UPR.StrategicProfitCenterCode <> '3'\n),\nJNR_Program AS (SELECT\n\tRTR_Hierachy_Program.pol_key, \n\tRTR_Hierachy_Program.StrategicProfitCenterCode, \n\tRTR_Hierachy_Program.AgencyCode, \n\tRTR_Hierachy_Program.PolicyOfferingCode, \n\tRTR_Hierachy_Program.ProgramCode, \n\tRTR_Hierachy_Program.StrategicProfitCenterDescription, \n\tRTR_Hierachy_Program.LegalName, \n\tRTR_Hierachy_Program.PolicyOfferingDescription, \n\tRTR_Hierachy_Program.ProgramDescription, \n\tSQ_Agency_Program.DisplayName, \n\tSQ_Agency_Program.AgencyCode AS AgencyCode_ODS, \n\tSQ_Agency_Program.StrategicProfitCenterCode AS StrategicProfitCenterCode_ODS, \n\tSQ_Agency_Program.PolicyOfferingCode AS PolicyOfferingCode_ODS, \n\tSQ_Agency_Program.ProgramCode AS ProgramCode_ODS\n\tFROM RTR_Hierachy_Program\n\tLEFT OUTER JOIN SQ_Agency_Program\n\tON SQ_Agency_Program.AgencyCode = RTR_Hierachy.AgencyCode3 AND SQ_Agency_Program.StrategicProfitCenterCode = RTR_Hierachy.StrategicProfitCenterCode3 AND SQ_Agency_Program.PolicyOfferingCode = RTR_Hierachy.PolicyOfferingCode3 AND SQ_Agency_Program.ProgramCode = RTR_Hierachy.ProgramCode3\n),\nEXP_Program AS (\n\tSELECT\n\tpol_key,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyOfferingCode,\n\tProgramCode,\n\tStrategicProfitCenterDescription,\n\tLegalName,\n\tPolicyOfferingDescription,\n\tProgramDescription,\n\tDisplayName,\n\t3 AS Level\n\tFROM JNR_Program\n),\nUnion AS (\n\tSELECT pol_key, StrategicProfitCenterCode, AgencyCode, PolicyOfferingCode, ProgramCode, StrategicProfitCenterDescription, LegalName, PolicyOfferingDescription, ProgramDescription, Level\n\tFROM EXP_Agency\n\tUNION\n\tSELECT pol_key, StrategicProfitCenterCode, AgencyCode, PolicyOfferingCode, ProgramCode, StrategicProfitCenterDescription, LegalName, PolicyOfferingDescription, ProgramDescription, DisplayName, Level\n\tFROM EXP_PolicyOffering\n\tUNION\n\tSELECT pol_key, StrategicProfitCenterCode, AgencyCode, PolicyOfferingCode, ProgramCode, StrategicProfitCenterDescription, LegalName, PolicyOfferingDescription, ProgramDescription, DisplayName, Level\n\tFROM EXP_Program\n\tUNION\n\tSELECT pol_key, StrategicProfitCenterCode, AgencyCode, PolicyOfferingCode, ProgramCode, StrategicProfitCenterDescription, LegalName, PolicyOfferingDescription, ProgramDescription, DisplayName, Level, BondCategory\n\tFROM EXP_Bond\n),\nAGG_Level AS (\n\tSELECT\n\tpol_key,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyOfferingCode,\n\tProgramCode,\n\tStrategicProfitCenterDescription,\n\tLegalName,\n\tPolicyOfferingDescription,\n\tProgramDescription,\n\tDisplayName,\n\tBondCategory,\n\tLevel AS i_Level,\n\t-- *INF*: MIN(i_Level)\n\tMIN(i_Level) AS Level\n\tFROM Union\n\tGROUP BY pol_key, StrategicProfitCenterCode, AgencyCode, PolicyOfferingCode, ProgramCode, DisplayName\n),\nSRT_Policy AS (\n\tSELECT\n\tpol_key, \n\tStrategicProfitCenterCode, \n\tAgencyCode, \n\tPolicyOfferingCode, \n\tProgramCode, \n\tStrategicProfitCenterDescription, \n\tLegalName, \n\tPolicyOfferingDescription, \n\tProgramDescription, \n\tDisplayName, \n\tBondCategory, \n\tLevel\n\tFROM AGG_Level\n\tORDER BY pol_key ASC, StrategicProfitCenterCode ASC, AgencyCode ASC, PolicyOfferingCode ASC, ProgramCode ASC, DisplayName ASC\n),\nEXP_MetaData AS (\n\tSELECT\n\tpol_key,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyOfferingCode,\n\tProgramCode,\n\tStrategicProfitCenterDescription,\n\tLegalName,\n\tPolicyOfferingDescription,\n\tProgramDescription,\n\tDisplayName AS i_DisplayName,\n\tBondCategory,\n\tLevel,\n\t-- *INF*: IIF(pol_key=v_pol_key,i_DisplayName || ', ' || v_AssociateName,i_DisplayName)\n\tIFF(pol_key = v_pol_key, i_DisplayName || ', ' || v_AssociateName, i_DisplayName) AS v_AssociateName,\n\tpol_key AS v_pol_key,\n\t-- *INF*: LTRIM(RTRIM(v_AssociateName))\n\tLTRIM(RTRIM(v_AssociateName)) AS o_AssociateId_List\n\tFROM SRT_Policy\n),\nAGG_Underwriter AS (\n\tSELECT\n\tpol_key,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyOfferingCode,\n\tProgramCode,\n\tStrategicProfitCenterDescription,\n\tLegalName,\n\tPolicyOfferingDescription,\n\tProgramDescription,\n\tBondCategory,\n\tLevel,\n\to_AssociateId_List AS AssociateId_List,\n\t-- *INF*: LAST(AssociateId_List)\n\tLAST(AssociateId_List) AS o_AssociateId_List,\n\t-- *INF*: COUNT(1)\n\tCOUNT(1) AS o_Count\n\tFROM EXP_MetaData\n\tGROUP BY pol_key, StrategicProfitCenterCode, AgencyCode, PolicyOfferingCode, ProgramCode, Level\n),\nEXP_Result AS (\n\tSELECT\n\tpol_key,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyOfferingCode,\n\tProgramCode,\n\tStrategicProfitCenterDescription,\n\tLegalName,\n\tPolicyOfferingDescription,\n\tProgramDescription,\n\tBondCategory,\n\tLevel,\n\to_AssociateId_List AS AssociateId_List,\n\t@{pipeline().parameters.WBMI_SESSION_CONTROL_RUN_ID} AS o_Session_Id,\n\t'E' AS o_type_code,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- Level=1,'Policy: ' || pol_key\r\n\t--  || ';  StrategicProfitCenter: ' || StrategicProfitCenterCode\r\n\t--  || ',  ' || StrategicProfitCenterDescription\r\n\t--  || ';  AgencyCode: ' || AgencyCode\r\n\t--  || ',  ' || LegalName\r\n\t--  || ' does not exist in AgencyODS',\r\n\t-- Level=2,IIF(NOT ISNULL(AssociateId_List),'Policy: ' || pol_key\r\n\t--  || ';  StrategicProfitCenter: ' || StrategicProfitCenterCode\r\n\t--  || ',  ' || StrategicProfitCenterDescription\r\n\t--  || ';  AgencyCode: ' || AgencyCode\r\n\t--  || ',  ' || LegalName\r\n\t--  || ';  PolicyOffering:  ' || PolicyOfferingCode\r\n\t--  || ',  ' || PolicyOfferingDescription\r\n\t--  || ' has underwriter: '  || AssociateId_List, \r\n\t-- 'Policy: ' || pol_key\r\n\t--  || ';  StrategicProfitCenter: ' || StrategicProfitCenterCode\r\n\t--  || ',  ' || StrategicProfitCenterDescription\r\n\t--  || ';  AgencyCode: ' || AgencyCode\r\n\t--  || ',  ' || LegalName\r\n\t--  || ';  PolicyOffering: ' || PolicyOfferingCode\r\n\t--  || ',  ' || PolicyOfferingDescription\r\n\t--  || ' does not exist in AgencyODS'),\r\n\t-- Level=3,IIF(NOT ISNULL(AssociateId_List),'Policy: ' || pol_key\r\n\t--  || ';  StrategicProfitCenter: ' || StrategicProfitCenterCode\r\n\t--  || ',  ' || StrategicProfitCenterDescription\r\n\t--  || ';  AgencyCode: ' || AgencyCode\r\n\t--  || ',  ' || LegalName\r\n\t--  || ';  PolicyOffering: ' || PolicyOfferingCode\r\n\t--  || ',  ' || PolicyOfferingDescription\r\n\t--  || ';  Program: ' || ProgramCode\r\n\t--  || ',  ' || ProgramDescription\r\n\t--  || ' has underwriter: '  || AssociateId_List, \r\n\t-- 'Policy: ' || pol_key\r\n\t--  || ';  StrategicProfitCenter: ' || StrategicProfitCenterCode\r\n\t--  || ',  ' || StrategicProfitCenterDescription\r\n\t--  || ';  AgencyCode: ' || AgencyCode\r\n\t--  || ',  ' || LegalName\r\n\t--  || ';  PolicyOffering: ' || PolicyOfferingCode\r\n\t--  || ',  ' || PolicyOfferingDescription\r\n\t--  || ';  Program: ' || ProgramCode\r\n\t--  || ',  ' || ProgramDescription\r\n\t--  || ' does not exist in AgencyODS'),\r\n\t-- Level=4,IIF(NOT ISNULL(AssociateId_List),'Policy: ' || pol_key\r\n\t--  || ';  StrategicProfitCenter: ' || StrategicProfitCenterCode\r\n\t--  || ',  ' || StrategicProfitCenterDescription\r\n\t--  || ';  AgencyCode: ' || AgencyCode\r\n\t--  || ',  ' || LegalName\r\n\t--  || ';  PolicyOffering: ' || PolicyOfferingCode\r\n\t--  || ',  ' || PolicyOfferingDescription\r\n\t--  || ';  Program: ' || ProgramCode\r\n\t--  || ',  ' || ProgramDescription\r\n\t--  || ',  Bond Category: ' || BondCategory\r\n\t--  || ' has underwriter: '  || AssociateId_List, \r\n\t-- 'Policy: ' || pol_key\r\n\t--  || ';  StrategicProfitCenter: ' || StrategicProfitCenterCode\r\n\t--  || ',  ' || StrategicProfitCenterDescription\r\n\t--  || ';  AgencyCode: ' || AgencyCode\r\n\t--  || ',  ' || LegalName\r\n\t--  || ';  PolicyOffering: ' || PolicyOfferingCode\r\n\t--  || ',  ' || PolicyOfferingDescription\r\n\t--  || ';  Program: ' || ProgramCode\r\n\t--  || ',  ' || ProgramDescription\r\n\t--  || ',  Bond Category: ' || BondCategory\r\n\t--  || ' does not exist in AgencyODS'))\n\tDECODE(\n\t    TRUE,\n\t    Level = 1, 'Policy: ' || pol_key || ';  StrategicProfitCenter: ' || StrategicProfitCenterCode || ',  ' || StrategicProfitCenterDescription || ';  AgencyCode: ' || AgencyCode || ',  ' || LegalName || ' does not exist in AgencyODS',\n\t    Level = 2, IFF(\n\t        AssociateId_List IS NOT NULL,\n\t        'Policy: ' || pol_key || ';  StrategicProfitCenter: ' || StrategicProfitCenterCode || ',  ' || StrategicProfitCenterDescription || ';  AgencyCode: ' || AgencyCode || ',  ' || LegalName || ';  PolicyOffering:  ' || PolicyOfferingCode || ',  ' || PolicyOfferingDescription || ' has underwriter: ' || AssociateId_List,\n\t        'Policy: ' || pol_key || ';  StrategicProfitCenter: ' || StrategicProfitCenterCode || ',  ' || StrategicProfitCenterDescription || ';  AgencyCode: ' || AgencyCode || ',  ' || LegalName || ';  PolicyOffering: ' || PolicyOfferingCode || ',  ' || PolicyOfferingDescription || ' does not exist in AgencyODS'\n\t    ),\n\t    Level = 3, IFF(\n\t        AssociateId_List IS NOT NULL,\n\t        'Policy: ' || pol_key || ';  StrategicProfitCenter: ' || StrategicProfitCenterCode || ',  ' || StrategicProfitCenterDescription || ';  AgencyCode: ' || AgencyCode || ',  ' || LegalName || ';  PolicyOffering: ' || PolicyOfferingCode || ',  ' || PolicyOfferingDescription || ';  Program: ' || ProgramCode || ',  ' || ProgramDescription || ' has underwriter: ' || AssociateId_List,\n\t        'Policy: ' || pol_key || ';  StrategicProfitCenter: ' || StrategicProfitCenterCode || ',  ' || StrategicProfitCenterDescription || ';  AgencyCode: ' || AgencyCode || ',  ' || LegalName || ';  PolicyOffering: ' || PolicyOfferingCode || ',  ' || PolicyOfferingDescription || ';  Program: ' || ProgramCode || ',  ' || ProgramDescription || ' does not exist in AgencyODS'\n\t    ),\n\t    Level = 4, IFF(\n\t        AssociateId_List IS NOT NULL,\n\t        'Policy: ' || pol_key || ';  StrategicProfitCenter: ' || StrategicProfitCenterCode || ',  ' || StrategicProfitCenterDescription || ';  AgencyCode: ' || AgencyCode || ',  ' || LegalName || ';  PolicyOffering: ' || PolicyOfferingCode || ',  ' || PolicyOfferingDescription || ';  Program: ' || ProgramCode || ',  ' || ProgramDescription || ',  Bond Category: ' || BondCategory || ' has underwriter: ' || AssociateId_List,\n\t        'Policy: ' || pol_key || ';  StrategicProfitCenter: ' || StrategicProfitCenterCode || ',  ' || StrategicProfitCenterDescription || ';  AgencyCode: ' || AgencyCode || ',  ' || LegalName || ';  PolicyOffering: ' || PolicyOfferingCode || ',  ' || PolicyOfferingDescription || ';  Program: ' || ProgramCode || ',  ' || ProgramDescription || ',  Bond Category: ' || BondCategory || ' does not exist in AgencyODS'\n\t    )\n\t) AS o_Msg,\n\t'V2.policy' AS o_name,\n\to_Count AS Count,\n\tSYSDATE AS o_Sysdate,\n\t'InformS' AS o_user,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS o_AuditId\n\tFROM AGG_Underwriter\n),\nwbmi_checkout_Underwriter AS (\n\tINSERT INTO wbmi_checkout\n\t(wbmi_session_control_run_id, checkout_type_code, checkout_message, source_name, target_count, created_user_id, created_date, modified_user_id, modified_date, AuditID)\n\tSELECT \n\to_Session_Id AS WBMI_SESSION_CONTROL_RUN_ID, \n\to_type_code AS CHECKOUT_TYPE_CODE, \n\to_Msg AS CHECKOUT_MESSAGE, \n\to_name AS SOURCE_NAME, \n\tCount AS TARGET_COUNT, \n\to_user AS CREATED_USER_ID, \n\to_Sysdate AS CREATED_DATE, \n\to_user AS MODIFIED_USER_ID, \n\to_Sysdate AS MODIFIED_DATE, \n\to_AuditId AS AUDITID\n\tFROM EXP_Result\n),\nSQ_UnderwriterAgencyRelationship AS (\n\tSELECT\n\t\tAgencyID,\n\t\tAssociateID\n\tFROM UnderwriterAgencyRelationship\n\tWHERE UnderwriterAgencyRelationship.StrategicProfitCenterCode<>'X' and UnderwriterAgencyRelationship.StrategicProfitCenterCode <>'3'\n),\nLKP_Associate_ODS AS (\n\tSELECT\n\tDisplayName,\n\tAssociateID\n\tFROM (\n\t\tSELECT \n\t\t\tDisplayName,\n\t\t\tAssociateID\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.Associate\n\t\tWHERE AssociateRole='UNDERWRITER ASSISTANT'\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY AssociateID ORDER BY DisplayName) = 1\n),\nLKP_VWAgency_ODS AS (\n\tSELECT\n\tAgencyCode,\n\tLegalName,\n\tAgencyID\n\tFROM (\n\t\tSELECT \n\t\t\tAgencyCode,\n\t\t\tLegalName,\n\t\t\tAgencyID\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.VWAgency\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY AgencyID ORDER BY AgencyCode) = 1\n),\nFIL_Valid AS (\n\tSELECT\n\tLKP_VWAgency_ODS.AgencyCode, \n\tLKP_VWAgency_ODS.LegalName, \n\tLKP_Associate_ODS.DisplayName\n\tFROM \n\tLEFT JOIN LKP_Associate_ODS\n\tON LKP_Associate_ODS.AssociateID = SQ_UnderwriterAgencyRelationship.AssociateID\n\tLEFT JOIN LKP_VWAgency_ODS\n\tON LKP_VWAgency_ODS.AgencyID = SQ_UnderwriterAgencyRelationship.AgencyID\n\tWHERE NOT ISNULL(AgencyCode) AND NOT ISNULL(DisplayName)\n),\nAGG_Duplicate AS (\n\tSELECT\n\tAgencyCode,\n\tLegalName,\n\tDisplayName\n\tFROM FIL_Valid\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY AgencyCode, LegalName, DisplayName ORDER BY NULL) = 1\n),\nEXP_UWA_Check AS (\n\tSELECT\n\tAgencyCode,\n\tLegalName,\n\tDisplayName,\n\t@{pipeline().parameters.WBMI_SESSION_CONTROL_RUN_ID} AS o_Session_Id,\n\t'E' AS o_type_code,\n\t'For Agency: ' || AgencyCode || '   ' || LegalName || ', UnderwriterAssistant ' || DisplayName\r\n || ' is assigned which is incorrect.' AS o_Msg,\n\t'AgencyManagement' AS o_name,\n\tSYSDATE AS o_Sysdate,\n\t'InformS' AS o_user,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS o_AuditId\n\tFROM AGG_Duplicate\n),\nwbmi_checkout_UnderwriterAssistant AS (\n\tINSERT INTO wbmi_checkout\n\t(wbmi_session_control_run_id, checkout_type_code, checkout_message, source_name, created_user_id, created_date, modified_user_id, modified_date, AuditID)\n\tSELECT \n\to_Session_Id AS WBMI_SESSION_CONTROL_RUN_ID, \n\to_type_code AS CHECKOUT_TYPE_CODE, \n\to_Msg AS CHECKOUT_MESSAGE, \n\to_name AS SOURCE_NAME, \n\to_user AS CREATED_USER_ID, \n\to_Sysdate AS CREATED_DATE, \n\to_user AS MODIFIED_USER_ID, \n\to_Sysdate AS MODIFIED_DATE, \n\to_AuditId AS AUDITID\n\tFROM EXP_UWA_Check\n),\nSQ_UnderwriterProductRelationship AS (\n\tselect distinct AssociateId\r\n\tfrom @{pipeline().parameters.SOURCE_TABLE_OWNER}.underwriterProductRelationship\r\n\twhere AssociateId not in (select AssociateId \r\n\tfrom @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterAgencyRelationship)\r\n\tand StrategicProfitCenterCode<>'X'\r\n\tand StrategicProfitCenterCode<>'3'\n),\nLKP_Associate_ODS_Product AS (\n\tSELECT\n\tDisplayName,\n\tAssociateID\n\tFROM (\n\t\tSELECT \n\t\t\tDisplayName,\n\t\t\tAssociateID\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.Associate\n\t\tWHERE AssociateRole='UNDERWRITER ASSISTANT'\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY AssociateID ORDER BY DisplayName) = 1\n),\nFIL_Valid_Product AS (\n\tSELECT\n\tDisplayName\n\tFROM LKP_Associate_ODS_Product\n\tWHERE NOT ISNULL(DisplayName)\n),\nEXP_UWA_Check_Product AS (\n\tSELECT\n\tDisplayName,\n\t@{pipeline().parameters.WBMI_SESSION_CONTROL_RUN_ID} AS o_Session_Id,\n\t'E' AS o_type_code,\n\t'UnderwriterAssistant ' || DisplayName\r\n || ' is assigned in UnderwriterProductRelationShip table which is incorrect.' AS o_Msg,\n\t'AgencyManagement' AS o_name,\n\tSYSDATE AS o_Sysdate,\n\t'InformS' AS o_user,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS o_AuditId\n\tFROM FIL_Valid_Product\n),\nwbmi_checkout_UnderwriterAssistant_Product AS (\n\tINSERT INTO wbmi_checkout\n\t(wbmi_session_control_run_id, checkout_type_code, checkout_message, source_name, created_user_id, created_date, modified_user_id, modified_date, AuditID)\n\tSELECT \n\to_Session_Id AS WBMI_SESSION_CONTROL_RUN_ID, \n\to_type_code AS CHECKOUT_TYPE_CODE, \n\to_Msg AS CHECKOUT_MESSAGE, \n\to_name AS SOURCE_NAME, \n\to_user AS CREATED_USER_ID, \n\to_Sysdate AS CREATED_DATE, \n\to_user AS MODIFIED_USER_ID, \n\to_Sysdate AS MODIFIED_DATE, \n\to_AuditId AS AUDITID\n\tFROM EXP_UWA_Check_Product\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "SOURCE_TABLE_OWNER_V2": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WHERE_CLAUSE": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WBMI_SESSION_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            }
        },
        "folder": {
            "name": "PolicyDataWarehouse/"
        },
        "annotations": []
    }
}