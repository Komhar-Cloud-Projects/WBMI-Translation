WITH
SQ_DC_BP_Building AS (
	WITH cte_DCBPBuilding(Sessionid) as
	(select sessionid from @{pipeline().parameters.SOURCE_DATABASE_WB}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.WB_EDWIncrementalDataQualitySessions where ModifiedDate between '@{pipeline().parameters.SELECTION_START_TS}' and '@{pipeline().parameters.SELECTION_END_TS}' 
	AND Autoshred<> '1' 
	 UNION 
	 select distinct A.sessionid from @{pipeline().parameters.SOURCE_TABLE_OWNER}.DC_Session A Inner join @{pipeline().parameters.SOURCE_TABLE_OWNER}.DC_Transaction B on A.SessionID=B.SessionID where B.State<> 'committed' and A.CreateDateTime>='@{pipeline().parameters.SELECTION_START_TS}')
	SELECT 
	X.BP_LocationId, 
	X.BP_BuildingId, 
	X.SessionId, 
	X.Id, 
	X.AutomaticFireAlarm, 
	X.BuildingGroup, 
	X.BuildingType, 
	X.ConstructionARate, 
	X.ConstructionCode, 
	X.CSP, 
	X.Description, 
	X.DesignCode, 
	X.DesignExposure, 
	X.DoorStrength, 
	X.DoorType, 
	X.InternalPressureDesign, 
	X.MaximumSquareFeet, 
	X.MixedConstruction, 
	X.MixedConstructionSub, 
	X.NumberOfStories, 
	X.OpeningProtection, 
	X.OpeningProtectionSC, 
	X.PredominantBuildingEQ, 
	X.PredominantBuildingEQSL, 
	X.PredominantBuildingLiabClassGroup, 
	X.PredominantBuildingLiabExpBase, 
	X.PredominantBuildingOccupancyType, 
	X.PredominantBuildingRateNumber, 
	X.PredominantBuildingSICCode, 
	X.PredominantLiabilityEQ, 
	X.PredominantLiabilityEQSL, 
	X.PredominantLiabilityLiabClassGroup, 
	X.PredominantLiabilityLiabExpBase, 
	X.PredominantLiabilityOccupancyType, 
	X.PredominantLiabilityRateNumber, 
	X.PredominantLiabilitySICCode, 
	X.PredominantPersonalPropertyEQ, 
	X.PredominantPersonalPropertyEQSL, 
	X.PredominantPersonalPropertyLiabClassGroup, 
	X.PredominantPersonalPropertyLiabExpBase, 
	X.PredominantPersonalPropertyOccupancyType, 
	X.PredominantPersonalPropertyRateNumber, 
	X.PredominantPersonalPropertySICCode, 
	X.ProtectiveDeviceP9, 
	X.RoofCovering, 
	X.RoofCoveringSC, 
	X.RoofDeck, 
	X.RoofDeckAttachment, 
	X.RoofGeometry, 
	X.RoofShape, 
	X.RoofWallConnection, 
	X.RoofWallConstruction, 
	X.SCArea, 
	X.SecondaryWaterResistance, 
	X.SecurityService, 
	X.ServiceContract, 
	X.Sprinkler, 
	X.SquareFt, 
	X.Terrain, 
	X.Vacant, 
	X.WindBorneDebrisRegion, 
	X.WindowProtection, 
	X.WindSpeedDesignSpeed, 
	X.WindSpeedGustWindSpeedOfDesign, 
	X.WindSpeedGustWindSpeedOfLocation, 
	X.WindstormHailRoofDamageACV, 
	X.WindstormLossMitigation, 
	X.WindstormProtectiveDevices, 
	X.YearBuilt 
	FROM
	 DC_BP_Building X
	inner join
	cte_DCBPBuilding Y on X.Sessionid = Y.Sessionid
	@{pipeline().parameters.WHERE_CLAUSE}
),
EXP_Metadata AS (
	SELECT
	BP_LocationId,
	BP_BuildingId,
	SessionId,
	Id,
	AutomaticFireAlarm,
	BuildingGroup,
	BuildingType,
	ConstructionARate,
	ConstructionCode,
	CSP,
	Description,
	DesignCode,
	DesignExposure,
	DoorStrength,
	DoorType,
	InternalPressureDesign,
	MaximumSquareFeet,
	MixedConstruction,
	MixedConstructionSub,
	NumberOfStories,
	OpeningProtection,
	OpeningProtectionSC,
	PredominantBuildingEQ,
	PredominantBuildingEQSL,
	PredominantBuildingLiabClassGroup,
	PredominantBuildingLiabExpBase,
	PredominantBuildingOccupancyType,
	PredominantBuildingRateNumber,
	PredominantBuildingSICCode,
	PredominantLiabilityEQ,
	PredominantLiabilityEQSL,
	PredominantLiabilityLiabClassGroup,
	PredominantLiabilityLiabExpBase,
	PredominantLiabilityOccupancyType,
	PredominantLiabilityRateNumber,
	PredominantLiabilitySICCode,
	PredominantPersonalPropertyEQ,
	PredominantPersonalPropertyEQSL,
	PredominantPersonalPropertyLiabClassGroup,
	PredominantPersonalPropertyLiabExpBase,
	PredominantPersonalPropertyOccupancyType,
	PredominantPersonalPropertyRateNumber,
	PredominantPersonalPropertySICCode,
	ProtectiveDeviceP9,
	RoofCovering,
	RoofCoveringSC,
	RoofDeck,
	RoofDeckAttachment,
	RoofGeometry,
	RoofShape,
	RoofWallConnection,
	RoofWallConstruction,
	SCArea,
	SecondaryWaterResistance,
	SecurityService,
	ServiceContract,
	Sprinkler,
	SquareFt,
	Terrain,
	Vacant,
	WindBorneDebrisRegion,
	WindowProtection,
	WindSpeedDesignSpeed,
	WindSpeedGustWindSpeedOfDesign,
	WindSpeedGustWindSpeedOfLocation,
	WindstormHailRoofDamageACV,
	WindstormLossMitigation,
	WindstormProtectiveDevices,
	YearBuilt,
	sysdate AS o_ExtractDate,
	@{pipeline().parameters.SOURCE_SYSTEM_ID} AS o_SourceSystemId
	FROM SQ_DC_BP_Building
),
DCBPBuildingStage1 AS (
	TRUNCATE TABLE @{pipeline().parameters.TARGET_TABLE_OWNER}.DCBPBuildingStage;
	INSERT INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.DCBPBuildingStage
	(BPLocationId, BPBuildingId, SessionId, Id, AutomaticFireAlarm, BuildingGroup, BuildingType, ConstructionARate, ConstructionCode, CSP, Description, DesignCode, DesignExposure, DoorStrength, DoorType, InternalPressureDesign, MaximumSquareFeet, MixedConstruction, MixedConstructionSub, NumberOfStories, OpeningProtection, OpeningProtectionSC, PredominantBuildingEQ, PredominantBuildingEQSL, PredominantBuildingLiabClassGroup, PredominantBuildingLiabExpBase, PredominantBuildingOccupancyType, PredominantBuildingRateNumber, PredominantBuildingSICCode, PredominantLiabilityEQ, PredominantLiabilityEQSL, PredominantLiabilityLiabClassGroup, PredominantLiabilityLiabExpBase, PredominantLiabilityOccupancyType, PredominantLiabilityRateNumber, PredominantLiabilitySICCode, PredominantPersonalPropertyEQ, PredominantPersonalPropertyEQSL, PredominantPersonalPropertyLiabClassGroup, PredominantPersonalPropertyLiabExpBase, PredominantPersonalPropertyOccupancyType, PredominantPersonalPropertyRateNumber, PredominantPersonalPropertySICCode, ProtectiveDeviceP9, RoofCovering, RoofCoveringSC, RoofDeck, RoofDeckAttachment, RoofGeometry, RoofShape, RoofWallConnection, RoofWallConstruction, SCArea, SecondaryWaterResistance, SecurityService, ServiceContract, Sprinkler, SquareFt, Terrain, Vacant, WindBorneDebrisRegion, WindowProtection, WindSpeedDesignSpeed, WindSpeedGustWindSpeedOfDesign, WindSpeedGustWindSpeedOfLocation, WindstormHailRoofDamageACV, WindstormLossMitigation, WindstormProtectiveDevices, YearBuilt, ExtractDate, SourceSystemId)
	SELECT 
	BP_LocationId AS BPLOCATIONID, 
	BP_BuildingId AS BPBUILDINGID, 
	SESSIONID, 
	ID, 
	AUTOMATICFIREALARM, 
	BUILDINGGROUP, 
	BUILDINGTYPE, 
	CONSTRUCTIONARATE, 
	CONSTRUCTIONCODE, 
	CSP, 
	DESCRIPTION, 
	DESIGNCODE, 
	DESIGNEXPOSURE, 
	DOORSTRENGTH, 
	DOORTYPE, 
	INTERNALPRESSUREDESIGN, 
	MAXIMUMSQUAREFEET, 
	MIXEDCONSTRUCTION, 
	MIXEDCONSTRUCTIONSUB, 
	NUMBEROFSTORIES, 
	OPENINGPROTECTION, 
	OPENINGPROTECTIONSC, 
	PREDOMINANTBUILDINGEQ, 
	PREDOMINANTBUILDINGEQSL, 
	PREDOMINANTBUILDINGLIABCLASSGROUP, 
	PREDOMINANTBUILDINGLIABEXPBASE, 
	PREDOMINANTBUILDINGOCCUPANCYTYPE, 
	PREDOMINANTBUILDINGRATENUMBER, 
	PREDOMINANTBUILDINGSICCODE, 
	PREDOMINANTLIABILITYEQ, 
	PREDOMINANTLIABILITYEQSL, 
	PREDOMINANTLIABILITYLIABCLASSGROUP, 
	PREDOMINANTLIABILITYLIABEXPBASE, 
	PREDOMINANTLIABILITYOCCUPANCYTYPE, 
	PREDOMINANTLIABILITYRATENUMBER, 
	PREDOMINANTLIABILITYSICCODE, 
	PREDOMINANTPERSONALPROPERTYEQ, 
	PREDOMINANTPERSONALPROPERTYEQSL, 
	PREDOMINANTPERSONALPROPERTYLIABCLASSGROUP, 
	PREDOMINANTPERSONALPROPERTYLIABEXPBASE, 
	PREDOMINANTPERSONALPROPERTYOCCUPANCYTYPE, 
	PREDOMINANTPERSONALPROPERTYRATENUMBER, 
	PREDOMINANTPERSONALPROPERTYSICCODE, 
	PROTECTIVEDEVICEP9, 
	ROOFCOVERING, 
	ROOFCOVERINGSC, 
	ROOFDECK, 
	ROOFDECKATTACHMENT, 
	ROOFGEOMETRY, 
	ROOFSHAPE, 
	ROOFWALLCONNECTION, 
	ROOFWALLCONSTRUCTION, 
	SCAREA, 
	SECONDARYWATERRESISTANCE, 
	SECURITYSERVICE, 
	SERVICECONTRACT, 
	SPRINKLER, 
	SQUAREFT, 
	TERRAIN, 
	VACANT, 
	WINDBORNEDEBRISREGION, 
	WINDOWPROTECTION, 
	WINDSPEEDDESIGNSPEED, 
	WINDSPEEDGUSTWINDSPEEDOFDESIGN, 
	WINDSPEEDGUSTWINDSPEEDOFLOCATION, 
	WINDSTORMHAILROOFDAMAGEACV, 
	WINDSTORMLOSSMITIGATION, 
	WINDSTORMPROTECTIVEDEVICES, 
	YEARBUILT, 
	o_ExtractDate AS EXTRACTDATE, 
	o_SourceSystemId AS SOURCESYSTEMID
	FROM EXP_Metadata
),