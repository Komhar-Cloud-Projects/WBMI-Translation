{
    "name": "m_POL_CUS_DW_LOAD_contract_customer",
    "properties": {
        "activities": [
            {
                "name": "m_POL_CUS_DW_LOAD_contract_customer",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nSQ_pif_02_stage AS (\n\tSELECT\r\n\ta.pif_symbol\r\n\t, a.pif_policy_number\r\n\t, a.pif_module\r\n\t, a.pif_line_business\r\n\t,a.pif_sort_name\r\n\t, a.pif_customer_number\r\n\t, a.wb_class_of_business\r\n\t, a.pif_address_line_1\r\n\t, a.pif_insured_name_cont\r\n\t, a.pif_address_line_2_b\r\n\t, a.pif_address_line_3\r\n\t, a.pif_address_line_4\r\n\t, a.pif_legal_entity\r\n\t,a.pif_prgm_id\r\n\t, a.pif_sic \r\n\t, b.Pmdl4w1FedEmpIdNumber\r\n\tFROM\r\n\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.pif_02_stage a\r\n\tLEFT JOIN\r\n\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.Pif43LXZWCStage b\r\n\tON ltrim(rtrim(a.pif_symbol)) = ltrim(rtrim(b.PifSymbol))\r\n\tand ltrim(rtrim(a.pif_policy_number))= ltrim(rtrim(b.PifPolicyNumber))\r\n\tand ltrim(rtrim(a.pif_module))=ltrim(rtrim(b.PifModule))\r\n\tand  ltrim(rtrim(b.Pmdl4w1SegmentPartCode)) = 'X'\r\n\tAND b.Pif43LXZWCStageId in (\r\n\tselect max(c.Pif43LXZWCStageId) from @{pipeline().parameters.SOURCE_TABLE_OWNER}.Pif43LXZWCStage c\r\n\twhere ltrim(rtrim(b.PifSymbol))=ltrim(rtrim(c.PifSymbol))\r\n\tand ltrim(rtrim(b.PifPolicyNumber))=ltrim(rtrim(c.PifPolicyNumber))\r\n\tand ltrim(rtrim(b.PifModule))=ltrim(rtrim(c.PifModule))\r\n\tand ltrim(rtrim(c.Pmdl4w1SegmentPartCode)) = 'X')\n),\nLKP_pif_43jj_stage AS (\n\tSELECT\n\tpmd4j_phone_area,\n\tpmd4j_phone_exchange,\n\tpmd4j_phone_number,\n\tpif_symbol,\n\tpif_policy_number,\n\tpif_module\n\tFROM (\n\t\tSELECT \r\n\t\tpmd4j_phone_area as pmd4j_phone_area, \r\n\t\tpmd4j_phone_exchange as pmd4j_phone_exchange, \r\n\t\tpmd4j_phone_number as pmd4j_phone_number, \r\n\t\tpif_symbol as pif_symbol, \r\n\t\tpif_policy_number as pif_policy_number, \r\n\t\tpif_module as pif_module \r\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.pif_43jj_stage\r\n\t\tWHERE pmd4j_location_number='0001'\r\n\t\tORDER BY pif_symbol,pif_policy_number,pif_module,pif_43jj_stage_id DESC--\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY pif_symbol,pif_policy_number,pif_module ORDER BY pmd4j_phone_area) = 1\n),\nEXP_values AS (\n\tSELECT\n\tSQ_pif_02_stage.pif_symbol AS in_pif_symbol,\n\tSQ_pif_02_stage.pif_policy_number AS in_pif_policy_number,\n\tSQ_pif_02_stage.pif_module AS in_pif_module,\n\tSQ_pif_02_stage.pif_line_business AS in_pif_line_business,\n\tSQ_pif_02_stage.pif_sort_name AS in_pif_sort_name,\n\tSQ_pif_02_stage.pif_customer_number AS in_pif_customer_number,\n\tSQ_pif_02_stage.wb_class_of_business AS in_wb_class_of_business,\n\tSQ_pif_02_stage.pif_address_line_1 AS in_pif_address_line_1,\n\tSQ_pif_02_stage.pif_insured_name_cont AS in_pif_insured_name_cont,\n\tSQ_pif_02_stage.pif_address_line_2_b AS in_pif_address_line_2_b,\n\tSQ_pif_02_stage.pif_address_line_3 AS in_pif_address_line_3,\n\tSQ_pif_02_stage.pif_address_line_4 AS in_pif_address_line_4,\n\tSQ_pif_02_stage.pif_legal_entity AS in_pif_legal_entity,\n\tSQ_pif_02_stage.pif_prgm_id AS in_pif_prgm_id,\n\tSQ_pif_02_stage.pif_sic AS in_pif_sic,\n\tSQ_pif_02_stage.Pmdl4w1FedEmpIdNumber AS in_Pmdl4w1FedEmpIdNumber,\n\tLKP_pif_43jj_stage.pmd4j_phone_area AS in_pmd4j_phone_area,\n\tLKP_pif_43jj_stage.pmd4j_phone_exchange AS in_pmd4j_phone_exchange,\n\tLKP_pif_43jj_stage.pmd4j_phone_number AS in_pmd4j_phone_number,\n\t-- *INF*: ltrim(rtrim(in_pif_symbol)) || ltrim(rtrim(in_pif_policy_number)) || ltrim(rtrim(in_pif_module))\n\tltrim(rtrim(in_pif_symbol)) || ltrim(rtrim(in_pif_policy_number)) || ltrim(rtrim(in_pif_module)) AS v_contract_key,\n\t-- *INF*: IIF(ISNULL(in_Pmdl4w1FedEmpIdNumber) or IS_SPACES(in_Pmdl4w1FedEmpIdNumber)  or LENGTH(in_Pmdl4w1FedEmpIdNumber)=0,'N/A',LTRIM(RTRIM(in_Pmdl4w1FedEmpIdNumber)))\n\tIFF(in_Pmdl4w1FedEmpIdNumber IS NULL OR IS_SPACES(in_Pmdl4w1FedEmpIdNumber) OR LENGTH(in_Pmdl4w1FedEmpIdNumber) = 0, 'N/A', LTRIM(RTRIM(in_Pmdl4w1FedEmpIdNumber))) AS v_Pmdl4w1FedEmpIdNumber,\n\t-- *INF*: iif(isnull(in_wb_class_of_business) or IS_SPACES(in_wb_class_of_business)  or LENGTH(in_wb_class_of_business)=0,'N/A',ltrim(rtrim(in_wb_class_of_business)))\r\n\t-- \r\n\t-- \r\n\t-- \n\tIFF(in_wb_class_of_business IS NULL OR IS_SPACES(in_wb_class_of_business) OR LENGTH(in_wb_class_of_business) = 0, 'N/A', ltrim(rtrim(in_wb_class_of_business))) AS v_wb_class_of_business,\n\t-- *INF*: iif(isnull(in_pif_customer_number) or IS_SPACES(in_pif_customer_number) or LENGTH(in_pif_customer_number)=0,'0000000000',ltrim(rtrim(in_pif_customer_number)))\r\n\t-- \n\tIFF(in_pif_customer_number IS NULL OR IS_SPACES(in_pif_customer_number) OR LENGTH(in_pif_customer_number) = 0, '0000000000', ltrim(rtrim(in_pif_customer_number))) AS v_customer_num,\n\t'INSURED' AS v_cust_role_code,\n\t-- *INF*: ltrim(rtrim(in_pif_address_line_1))\n\tltrim(rtrim(in_pif_address_line_1)) AS v_pif_address_line_1,\n\t-- *INF*: ltrim(rtrim(in_pif_address_line_2_b))\n\tltrim(rtrim(in_pif_address_line_2_b)) AS v_pif_address_line_2_b,\n\t-- *INF*: ltrim(rtrim(in_pif_address_line_3))\n\tltrim(rtrim(in_pif_address_line_3)) AS v_pif_address_line_3,\n\t-- *INF*: ltrim(rtrim(in_pif_address_line_4))\n\tltrim(rtrim(in_pif_address_line_4)) AS v_pif_address_line_4,\n\t-- *INF*: ltrim(in_pif_insured_name_cont || v_pif_address_line_2_b)\n\tltrim(in_pif_insured_name_cont || v_pif_address_line_2_b) AS v_pif_insured_cont_add_line_2,\n\t-- *INF*: iif(iif(IS_SPACES(v_pif_address_line_4) or isnull(v_pif_address_line_4) or LENGTH(v_pif_address_line_4)=0,\r\n\t-- 1,0)=1,\r\n\t-- (iif(decode(SUBSTR(v_pif_address_line_2_b,(LENGTH(v_pif_address_line_2_b)-3),4),\r\n\t-- ' LLC',1,\r\n\t-- ' DBA',1,\r\n\t-- ' BA;',1,\r\n\t-- ' BA,',1,\r\n\t-- ' SOC',1,\r\n\t-- 'PLAN',1,\r\n\t-- 'CORP',1,\r\n\t-- 0)=1,v_pif_address_line_1||' '|| v_pif_insured_cont_add_line_2,v_pif_address_line_1)),\r\n\t-- iif(iif(IN(SUBSTR(v_pif_address_line_2_b,1,1),'1','2','3','4','5','6','7','8','9','0',0)=1,1,iif(decode(substr(v_pif_insured_cont_add_line_2,1,4),\r\n\t-- 'POST',1,\r\n\t-- 'PO B',1,0)=1,1,0))=0,\r\n\t-- iif(decode(SUBSTR(v_pif_address_line_2_b,(LENGTH(v_pif_address_line_2_b)-2),3) ,\r\n\t-- ' ST',1,\r\n\t-- ' RD',1,\r\n\t-- ' PL',1,0)=1,v_pif_address_line_1,v_pif_address_line_1||' '|| v_pif_insured_cont_add_line_2),\r\n\t-- iif(iif(decode(SUBSTR(v_pif_address_line_2_b,(LENGTH(v_pif_address_line_2_b)-3),4),\r\n\t-- ' LLC',1,\r\n\t-- ' DBA',1,\r\n\t-- ' BA;',1,\r\n\t-- ' BA,',1,\r\n\t-- ' SOC',1,\r\n\t-- 'PLAN',1,\r\n\t-- 'CORP',1,\r\n\t-- 0)=1,1,iif(IIF(NOT (ISNULL(v_pif_address_line_2_b)) OR NOT (IS_SPACES(v_pif_address_line_2_b)), instr(v_pif_address_line_2_b,'TRUST'),0) != 0,1,iif(IIF(NOT (ISNULL(v_pif_address_line_1)) OR NOT (IS_SPACES(v_pif_address_line_1)), instr(v_pif_address_line_1,'TRUST'),0) != 0,1,0))) =1,v_pif_address_line_1||' '|| v_pif_insured_cont_add_line_2,v_pif_address_line_1)))\n\tIFF(IFF(IS_SPACES(v_pif_address_line_4) OR v_pif_address_line_4 IS NULL OR LENGTH(v_pif_address_line_4) = 0, 1, 0) = 1, ( IFF(decode(SUBSTR(v_pif_address_line_2_b, ( LENGTH(v_pif_address_line_2_b) - 3 ), 4),\n\t' LLC', 1,\n\t' DBA', 1,\n\t' BA;', 1,\n\t' BA,', 1,\n\t' SOC', 1,\n\t'PLAN', 1,\n\t'CORP', 1,\n\t0) = 1, v_pif_address_line_1 || ' ' || v_pif_insured_cont_add_line_2, v_pif_address_line_1) ), IFF(IFF(IN(SUBSTR(v_pif_address_line_2_b, 1, 1), '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', 0) = 1, 1, IFF(decode(substr(v_pif_insured_cont_add_line_2, 1, 4),\n\t'POST', 1,\n\t'PO B', 1,\n\t0) = 1, 1, 0)) = 0, IFF(decode(SUBSTR(v_pif_address_line_2_b, ( LENGTH(v_pif_address_line_2_b) - 2 ), 3),\n\t' ST', 1,\n\t' RD', 1,\n\t' PL', 1,\n\t0) = 1, v_pif_address_line_1, v_pif_address_line_1 || ' ' || v_pif_insured_cont_add_line_2), IFF(IFF(decode(SUBSTR(v_pif_address_line_2_b, ( LENGTH(v_pif_address_line_2_b) - 3 ), 4),\n\t' LLC', 1,\n\t' DBA', 1,\n\t' BA;', 1,\n\t' BA,', 1,\n\t' SOC', 1,\n\t'PLAN', 1,\n\t'CORP', 1,\n\t0) = 1, 1, IFF(IFF(NOT ( v_pif_address_line_2_b IS NULL ) OR NOT ( IS_SPACES(v_pif_address_line_2_b) ), instr(v_pif_address_line_2_b, 'TRUST'), 0) != 0, 1, IFF(IFF(NOT ( v_pif_address_line_1 IS NULL ) OR NOT ( IS_SPACES(v_pif_address_line_1) ), instr(v_pif_address_line_1, 'TRUST'), 0) != 0, 1, 0))) = 1, v_pif_address_line_1 || ' ' || v_pif_insured_cont_add_line_2, v_pif_address_line_1))) AS v_name,\n\t-- *INF*: iif(isnull(in_pif_prgm_id) or is_spaces(in_pif_prgm_id) or LENGTH(in_pif_prgm_id)=0,'N/A',LTRIM(RTRIM(in_pif_prgm_id)))\n\tIFF(in_pif_prgm_id IS NULL OR is_spaces(in_pif_prgm_id) OR LENGTH(in_pif_prgm_id) = 0, 'N/A', LTRIM(RTRIM(in_pif_prgm_id))) AS v_pif_prgm_id,\n\t-- *INF*: --:LKP.LKP_SUP_LEGAL_ENTITY(in_pif_legal_entity)\n\t'' AS v_sup_legal_entity_id,\n\t-- *INF*: --:LKP.LKP_SUP_SIC_CODE(ltrim(rtrim(in_pif_sic)))\n\t'' AS v_sup_sic_code_id,\n\t-- *INF*: IIF(LTRIM(RTRIM(in_pif_line_business)) = 'WC' OR LTRIM(RTRIM(in_pif_line_business)) = 'WCP', v_Pmdl4w1FedEmpIdNumber, 'N/A')\n\tIFF(LTRIM(RTRIM(in_pif_line_business)) = 'WC' OR LTRIM(RTRIM(in_pif_line_business)) = 'WCP', v_Pmdl4w1FedEmpIdNumber, 'N/A') AS v_fed_tax_id,\n\t-- *INF*: LTRIM(RTRIM(in_pmd4j_phone_area))||LTRIM(RTRIM(in_pmd4j_phone_exchange))||LTRIM(RTRIM(in_pmd4j_phone_number))\n\tLTRIM(RTRIM(in_pmd4j_phone_area)) || LTRIM(RTRIM(in_pmd4j_phone_exchange)) || LTRIM(RTRIM(in_pmd4j_phone_number)) AS v_ph_num_full,\n\t-- *INF*: ltrim(rtrim(v_contract_key))\n\tltrim(rtrim(v_contract_key)) AS o_contract_key,\n\t-- *INF*: ---iif(ltrim(rtrim(v_sup_assoc_program_type))='Other',v_wb_class_of_business,'N/A')\n\t'' AS o_Pol_other_clb_code,\n\t-- *INF*: LTRIM(RTRIM(v_cust_role_code))\n\tLTRIM(RTRIM(v_cust_role_code)) AS o_cust_role,\n\tv_customer_num AS o_customer_number,\n\t-- *INF*: iif(isnull(v_name) or IS_SPACES(v_name) or LENGTH(v_name)=0,'N/A',LTRIM(RTRIM(v_name)))\n\tIFF(v_name IS NULL OR IS_SPACES(v_name) OR LENGTH(v_name) = 0, 'N/A', LTRIM(RTRIM(v_name))) AS o_name,\n\t-- *INF*: iif(isnull(in_pif_legal_entity) or IS_SPACES(in_pif_legal_entity)  or LENGTH(in_pif_legal_entity)=0,'N/A',ltrim(rtrim(in_pif_legal_entity)))\n\tIFF(in_pif_legal_entity IS NULL OR IS_SPACES(in_pif_legal_entity) OR LENGTH(in_pif_legal_entity) = 0, 'N/A', ltrim(rtrim(in_pif_legal_entity))) AS o_lgl_ent_code,\n\t-- *INF*: iif(isnull(in_pif_sic) or IS_SPACES(in_pif_sic)  or LENGTH(in_pif_sic)=0,'N/A',ltrim(rtrim(in_pif_sic)))\r\n\t-- \n\tIFF(in_pif_sic IS NULL OR IS_SPACES(in_pif_sic) OR LENGTH(in_pif_sic) = 0, 'N/A', ltrim(rtrim(in_pif_sic))) AS o_sic_code,\n\t-- *INF*: ltrim(rtrim(in_pif_sort_name))\n\tltrim(rtrim(in_pif_sort_name)) AS o_pif_sort_name,\n\t'N/A' AS o_naics_code,\n\tv_fed_tax_id AS o_fed_tax_id,\n\t'N/A' AS o_doing_bus_as,\n\t-1 AS o_yr_in_bus,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(v_ph_num_full)\n\t:UDF.DEFAULT_VALUE_FOR_STRINGS(v_ph_num_full) AS o_ph_num_full,\n\t'N/A' AS o_ph_area_code,\n\t'N/A' AS o_ph_exchange,\n\t'N/A' AS o_ph_num,\n\t'N/A' AS o_ph_extension,\n\t'N/A' AS o_bus_email_addr\n\tFROM SQ_pif_02_stage\n\tLEFT JOIN LKP_pif_43jj_stage\n\tON LKP_pif_43jj_stage.pif_symbol = SQ_pif_02_stage.pif_symbol AND LKP_pif_43jj_stage.pif_policy_number = SQ_pif_02_stage.pif_policy_number AND LKP_pif_43jj_stage.pif_module = SQ_pif_02_stage.pif_module\n),\nLKP_contract_customer AS (\n\tSELECT\n\tcontract_cust_id,\n\tcontract_cust_ak_id,\n\tcust_num,\n\tname,\n\tfed_tax_id,\n\tdoing_bus_as,\n\tsic_code,\n\tnaics_code,\n\tlgl_ent_code,\n\tyr_in_bus,\n\tph_num_full,\n\tph_area_code,\n\tph_exchange,\n\tph_num,\n\tph_extension,\n\tbus_email_addr,\n\tsort_name,\n\tsup_lgl_ent_code_id,\n\tcontract_key,\n\tcust_role\n\tFROM (\n\t\tSELECT \n\t\t\tcontract_cust_id,\n\t\t\tcontract_cust_ak_id,\n\t\t\tcust_num,\n\t\t\tname,\n\t\t\tfed_tax_id,\n\t\t\tdoing_bus_as,\n\t\t\tsic_code,\n\t\t\tnaics_code,\n\t\t\tlgl_ent_code,\n\t\t\tyr_in_bus,\n\t\t\tph_num_full,\n\t\t\tph_area_code,\n\t\t\tph_exchange,\n\t\t\tph_num,\n\t\t\tph_extension,\n\t\t\tbus_email_addr,\n\t\t\tsort_name,\n\t\t\tsup_lgl_ent_code_id,\n\t\t\tcontract_key,\n\t\t\tcust_role\n\t\tFROM @{pipeline().parameters.TARGET_TABLE_OWNER}.contract_customer\n\t\tWHERE contract_customer.crrnt_snpsht_flag=1 AND source_sys_id='@{pipeline().parameters.SOURCE_SYSTEM_ID}'\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY contract_key,cust_role ORDER BY contract_cust_id) = 1\n),\nLKP_sup_legal_entity_code AS (\n\tSELECT\n\tsup_lgl_ent_code_id,\n\tlgl_ent_code\n\tFROM (\n\t\tSELECT \n\t\t\tsup_lgl_ent_code_id,\n\t\t\tlgl_ent_code\n\t\tFROM @{pipeline().parameters.TARGET_TABLE_OWNER}.sup_legal_entity_code\n\t\tWHERE crrnt_snpsht_flag=1 and source_sys_id='@{pipeline().parameters.SOURCE_SYSTEM_ID}'\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY lgl_ent_code ORDER BY sup_lgl_ent_code_id) = 1\n),\nEXP_Detect_Changes AS (\n\tSELECT\n\tLKP_contract_customer.contract_cust_id AS lkp_cust_id,\n\tLKP_contract_customer.contract_cust_ak_id AS lkp_cust_ak_id,\n\tLKP_contract_customer.cust_num AS lkp_cust_num,\n\tLKP_contract_customer.name AS lkp_name,\n\tLKP_contract_customer.fed_tax_id AS lkp_fed_tax_id,\n\tLKP_contract_customer.doing_bus_as AS lkp_doing_bus_as,\n\tLKP_contract_customer.sic_code AS lkp_sic_code,\n\tLKP_contract_customer.naics_code AS lkp_naics_code,\n\tLKP_contract_customer.lgl_ent_code AS lkp_lgl_ent_code,\n\tLKP_contract_customer.yr_in_bus AS lkp_yr_in_bus,\n\tLKP_contract_customer.ph_num_full AS lkp_ph_num_full,\n\tLKP_contract_customer.ph_area_code AS lkp_ph_area_code,\n\tLKP_contract_customer.ph_exchange AS lkp_ph_exchange,\n\tLKP_contract_customer.ph_num AS lkp_ph_num,\n\tLKP_contract_customer.ph_extension AS lkp_ph_extension,\n\tLKP_contract_customer.bus_email_addr AS lkp_bus_email_addr,\n\tLKP_contract_customer.sort_name AS lkp_sort_name,\n\tLKP_contract_customer.sup_lgl_ent_code_id AS lkp_sup_lgl_ent_code_id,\n\tEXP_values.o_contract_key AS contract_key,\n\tEXP_values.o_cust_role AS cust_role,\n\tEXP_values.o_customer_number AS customer_number,\n\tEXP_values.o_name AS name,\n\tEXP_values.o_fed_tax_id AS fed_tax_id,\n\tEXP_values.o_doing_bus_as AS doing_bus_as,\n\tEXP_values.o_sic_code AS sic_code,\n\tEXP_values.o_naics_code AS naics_code,\n\tEXP_values.o_lgl_ent_code AS lgl_ent_code,\n\tEXP_values.o_yr_in_bus AS yr_in_bus,\n\tEXP_values.o_ph_num_full AS ph_num_full,\n\tEXP_values.o_ph_area_code AS ph_area_code,\n\tEXP_values.o_ph_exchange AS ph_exchange,\n\tEXP_values.o_ph_num AS ph_num,\n\tEXP_values.o_ph_extension AS ph_extension,\n\tEXP_values.o_bus_email_addr AS bus_email_addr,\n\tEXP_values.o_pif_sort_name AS pif_sort_name,\n\tLKP_sup_legal_entity_code.sup_lgl_ent_code_id AS in_sup_lgl_ent_code_id,\n\t-- *INF*: IIF(\r\n\t--   ISNULL(in_sup_lgl_ent_code_id),\r\n\t--   -1,\r\n\t--   in_sup_lgl_ent_code_id\r\n\t-- )\n\tIFF(in_sup_lgl_ent_code_id IS NULL, - 1, in_sup_lgl_ent_code_id) AS v_sup_lgl_ent_code_id,\n\t-- *INF*: IIF(ISNULL(lkp_cust_ak_id), 'NEW', IIF(\r\n\t-- lkp_cust_num != customer_number OR\r\n\t-- lkp_name != name OR\r\n\t-- lkp_fed_tax_id != fed_tax_id OR\r\n\t-- lkp_doing_bus_as != doing_bus_as  OR\r\n\t-- lkp_sic_code != sic_code  OR\r\n\t-- lkp_naics_code != naics_code  OR\r\n\t-- lkp_lgl_ent_code != lgl_ent_code  OR \r\n\t-- lkp_yr_in_bus != yr_in_bus OR\r\n\t-- lkp_ph_num_full != ph_num_full OR\r\n\t-- lkp_ph_area_code != ph_area_code OR\t\r\n\t-- lkp_ph_exchange != ph_area_code OR\r\n\t-- lkp_ph_num != ph_num OR\r\n\t-- lkp_ph_extension != ph_extension OR\r\n\t-- lkp_bus_email_addr != bus_email_addr OR\r\n\t-- LTRIM(RTRIM(lkp_sort_name)) != pif_sort_name\r\n\t-- \r\n\t-- --OR\r\n\t-- --lkp_ProgramCode != v_ProgramCode\r\n\t-- --OR lkp_StandardLegalEntityCode != v_StandardLegalEntityCode OR lkp_StandardLegalEntityDescription != v_StandardLegalEntityDescription OR lkp_StandardAssociationCode != v_StandardAssociationCode OR lkp_StandardAssociationDescription != v_StandardAssociationDescription OR lkp_StandardProgramCode != v_StandardProgramCode OR lkp_StandardProgramDescription != v_StandardProgramDescription\r\n\t-- ,\r\n\t-- 'UPDATE', 'NOCHANGE'))\r\n\t-- \r\n\t-- \r\n\t-- --IIF(NewLookupRow=1,'NEW',IIF(NewLookupRow=2,'UPDATE','NOCHANGE'\r\n\t-- \n\tIFF(lkp_cust_ak_id IS NULL, 'NEW', IFF(lkp_cust_num != customer_number OR lkp_name != name OR lkp_fed_tax_id != fed_tax_id OR lkp_doing_bus_as != doing_bus_as OR lkp_sic_code != sic_code OR lkp_naics_code != naics_code OR lkp_lgl_ent_code != lgl_ent_code OR lkp_yr_in_bus != yr_in_bus OR lkp_ph_num_full != ph_num_full OR lkp_ph_area_code != ph_area_code OR lkp_ph_exchange != ph_area_code OR lkp_ph_num != ph_num OR lkp_ph_extension != ph_extension OR lkp_bus_email_addr != bus_email_addr OR LTRIM(RTRIM(lkp_sort_name)) != pif_sort_name, 'UPDATE', 'NOCHANGE')) AS v_changed_flag,\n\tv_changed_flag AS changed_flag,\n\t1 AS crrnt_snpsht_flag,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS audit_id,\n\t-- *INF*: iif(v_changed_flag='NEW',\r\n\t-- \tto_date('01/01/1800 01:00:00','MM/DD/YYYY HH24:MI:SS'),sysdate)\n\tIFF(v_changed_flag = 'NEW', to_date('01/01/1800 01:00:00', 'MM/DD/YYYY HH24:MI:SS'), sysdate) AS v_eff_from_date,\n\tv_eff_from_date AS eff_from_date,\n\t-- *INF*: TO_DATE('12/31/2100 23:59:59','MM/DD/YYYY HH24:MI:SS')\n\tTO_DATE('12/31/2100 23:59:59', 'MM/DD/YYYY HH24:MI:SS') AS eff_to_date,\n\t@{pipeline().parameters.SOURCE_SYSTEM_ID} AS source_sys_id,\n\tSYSDATE AS created_date,\n\tSYSDATE AS modified_date,\n\tv_sup_lgl_ent_code_id AS o_sup_lgl_ent_code_id\n\tFROM EXP_values\n\tLEFT JOIN LKP_contract_customer\n\tON LKP_contract_customer.contract_key = EXP_values.o_contract_key AND LKP_contract_customer.cust_role = EXP_values.o_cust_role\n\tLEFT JOIN LKP_sup_legal_entity_code\n\tON LKP_sup_legal_entity_code.lgl_ent_code = EXP_values.o_lgl_ent_code\n),\nFIL_insert AS (\n\tSELECT\n\tlkp_cust_ak_id, \n\tcontract_key, \n\tcust_role, \n\tcustomer_number, \n\tname, \n\tfed_tax_id, \n\tdoing_bus_as, \n\tsic_code, \n\tnaics_code, \n\tlgl_ent_code, \n\tyr_in_bus, \n\tph_num_full, \n\tph_area_code, \n\tph_exchange, \n\tph_num, \n\tph_extension, \n\tbus_email_addr, \n\tpif_sort_name, \n\tchanged_flag, \n\tcrrnt_snpsht_flag, \n\taudit_id, \n\teff_from_date, \n\teff_to_date, \n\tsource_sys_id, \n\tcreated_date, \n\tmodified_date, \n\to_sup_lgl_ent_code_id AS sup_lgl_ent_code_id\n\tFROM EXP_Detect_Changes\n\tWHERE changed_flag='NEW'  OR changed_flag='UPDATE'\n),\nSEQ_customer AS (\n\tCREATE SEQUENCE SEQ_customer\n\tSTART = 0\n\tINCREMENT = 1;\n),\nEXP_customer_ak_id AS (\n\tSELECT\n\tlkp_cust_ak_id,\n\t-- *INF*: IIF(ISNULL(lkp_cust_ak_id),NEXTVAL,lkp_cust_ak_id)\n\tIFF(lkp_cust_ak_id IS NULL, NEXTVAL, lkp_cust_ak_id) AS cust_ak_id,\n\tcontract_key,\n\tcust_role,\n\tcustomer_number,\n\tname,\n\tfed_tax_id,\n\tdoing_bus_as,\n\tsic_code,\n\tnaics_code,\n\tlgl_ent_code,\n\tyr_in_bus,\n\tph_num_full,\n\tph_area_code,\n\tph_exchange,\n\tph_num,\n\tph_extension,\n\tbus_email_addr,\n\tpif_sort_name,\n\tcrrnt_snpsht_flag,\n\taudit_id,\n\teff_from_date,\n\teff_to_date,\n\tsource_sys_id,\n\tcreated_date,\n\tmodified_date,\n\tSEQ_customer.NEXTVAL,\n\tsup_lgl_ent_code_id,\n\t-- *INF*: 'N/A'\r\n\t-- -- Default values for PMS\n\t'N/A' AS DEFAULT\n\tFROM FIL_insert\n),\nTGT_contract_customer_INSERT AS (\n\tINSERT INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.contract_customer\n\t(crrnt_snpsht_flag, audit_id, eff_from_date, eff_to_date, source_sys_id, created_date, modified_date, contract_cust_ak_id, cust_num, contract_key, cust_role, name, fed_tax_id, doing_bus_as, sic_code, naics_code, lgl_ent_code, yr_in_bus, ph_num_full, ph_area_code, ph_exchange, ph_num, ph_extension, bus_email_addr, sort_name, sup_lgl_ent_code_id, FirstName, LastName, MiddleName)\n\tSELECT \n\tCRRNT_SNPSHT_FLAG, \n\tAUDIT_ID, \n\tEFF_FROM_DATE, \n\tEFF_TO_DATE, \n\tSOURCE_SYS_ID, \n\tCREATED_DATE, \n\tMODIFIED_DATE, \n\tcust_ak_id AS CONTRACT_CUST_AK_ID, \n\tcustomer_number AS CUST_NUM, \n\tCONTRACT_KEY, \n\tCUST_ROLE, \n\tNAME, \n\tFED_TAX_ID, \n\tDOING_BUS_AS, \n\tSIC_CODE, \n\tNAICS_CODE, \n\tLGL_ENT_CODE, \n\tYR_IN_BUS, \n\tPH_NUM_FULL, \n\tPH_AREA_CODE, \n\tPH_EXCHANGE, \n\tPH_NUM, \n\tPH_EXTENSION, \n\tBUS_EMAIL_ADDR, \n\tpif_sort_name AS SORT_NAME, \n\tSUP_LGL_ENT_CODE_ID, \n\tDEFAULT AS FIRSTNAME, \n\tDEFAULT AS LASTNAME, \n\tDEFAULT AS MIDDLENAME\n\tFROM EXP_customer_ak_id\n),\nSQ_contract_customer AS (\n\tSELECT \r\n\t\tcontract_cust_id,\r\n\t\teff_from_date,\r\n\t\teff_to_date,\r\n\t\tcontract_cust_ak_id \r\n\tFROM\r\n\t\t@{pipeline().parameters.TARGET_TABLE_OWNER}. contract_customer\r\n\tWHERE  contract_cust_ak_id  IN \r\n\t\t   (SELECT contract_cust_ak_id  FROM @{pipeline().parameters.TARGET_TABLE_OWNER}. contract_customer\r\n\t           WHERE crrnt_snpsht_flag = 1 GROUP BY contract_cust_ak_id  HAVING count(*) > 1)\r\n\tAND source_sys_id='@{pipeline().parameters.SOURCE_SYSTEM_ID}'\r\n\tORDER BY  contract_cust_ak_id , eff_from_date  DESC\r\n\t\r\n\t--IN Subquery exists to pick AK ID column values that have multiple rows with a 12/31/2100 eff_to_date.\r\n\t--When this condition occurs this is an indication that we must expire one or more of these rows.\r\n\t--WHERE clause is always made up of current snapshot flag \r\n\t--GROUP BY clause is always on AK\r\n\t--HAVING clause stays the same\n),\nEXP_Lag_eff_from_date AS (\n\tSELECT\n\tcontract_cust_id AS cust_id,\n\teff_from_date AS in_eff_from_date,\n\teff_to_date AS orig_eff_to_date,\n\tcontract_cust_ak_id AS cust_ak_id,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- cust_ak_id = v_prev_cust_ak_id  ,\r\n\t-- ADD_TO_DATE(v_prev_eff_from_date,'SS',-1),orig_eff_to_date)\n\tDECODE(TRUE,\n\tcust_ak_id = v_prev_cust_ak_id, ADD_TO_DATE(v_prev_eff_from_date, 'SS', - 1),\n\torig_eff_to_date) AS v_eff_to_date,\n\tv_eff_to_date AS eff_to_date,\n\tcust_ak_id AS v_prev_cust_ak_id,\n\tin_eff_from_date AS v_prev_eff_from_date,\n\t0 AS crrnt_snpsht_flag,\n\tSYSDATE AS modified_date\n\tFROM SQ_contract_customer\n),\nFIL_FirstRowInAKGroup AS (\n\tSELECT\n\tcust_id, \n\torig_eff_to_date, \n\teff_to_date, \n\tcrrnt_snpsht_flag, \n\tmodified_date\n\tFROM EXP_Lag_eff_from_date\n\tWHERE orig_eff_to_date != eff_to_date\n),\nUPD_customer AS (\n\tSELECT\n\tcust_id, \n\teff_to_date, \n\tcrrnt_snpsht_flag, \n\tmodified_date\n\tFROM FIL_FirstRowInAKGroup\n),\nTGT_contract_customer_UPDATE AS (\n\tMERGE INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.contract_customer AS T\n\tUSING UPD_customer AS S\n\tON T.contract_cust_id = S.cust_id\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.crrnt_snpsht_flag = S.crrnt_snpsht_flag, T.eff_to_date = S.eff_to_date, T.modified_date = S.modified_date\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "88918"
            },
            "WBMI_BATCH_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "149035"
            },
            "WBMI_SESSION_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "2458277"
            },
            "SELECTION_START_TS": {
                "type": "string",
                "defaultValue": "04/13/2016 10:31:27"
            },
            "SELECTION_END_TS": {
                "type": "string",
                "defaultValue": "04/14/2016 03:33:18"
            },
            "DBCONNECTION_SOURCE": {
                "type": "string",
                "defaultValue": "SQLServer_WC_Stage_Policy"
            },
            "DBCONNECTION_TARGET": {
                "type": "string",
                "defaultValue": "SQLServer_RPT_EDM_Policy"
            },
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "dbo"
            },
            "TARGET_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "dbo"
            },
            "SOURCE_SYSTEM_ID": {
                "type": "string",
                "defaultValue": "PMS"
            }
        },
        "folder": {
            "name": "Policy DataWarehouse/"
        },
        "annotations": []
    }
}