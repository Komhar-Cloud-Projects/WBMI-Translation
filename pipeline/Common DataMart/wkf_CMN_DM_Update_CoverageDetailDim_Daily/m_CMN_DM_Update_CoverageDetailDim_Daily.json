{
    "name": "m_CMN_DM_Update_CoverageDetailDim_Daily",
    "properties": {
        "activities": [
            {
                "name": "m_CMN_DM_Update_CoverageDetailDim_Daily",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nLKP_Policy AS (\n\tSELECT\n\tpol_cancellation_date,\n\tPolicyAKID\n\tFROM (\n\t\tselect  PolicyAKID  as PolicyAKID   , pol_cancellation_date  as  pol_cancellation_date \r\n\t\tfrom  (\r\n\t\tSELECT DISTINCT PC.PolicyAKID  AS PolicyAKID\r\n\t\t        ,P.pol_cancellation_date AS pol_cancellation_date\r\n\t\t  FROM  V2.policy P   INNER JOIN dbo.PolicyCoverage PC  ON   PC.PolicyAKID=P.pol_ak_id  AND  P.crrnt_snpsht_flag=1   \r\n\t\t  inner join StatisticalCoverage sc on sc.PolicyCoverageAKID =pc.PolicyCoverageAKID AND  PC.CurrentSnapshotFlag=1 \r\n\t\t  inner join PremiumTransaction pt on  pt.StatisticalCoverageAKID =sc.StatisticalCoverageAKID and sc.CurrentSnapshotFlag =1 \r\n\t\t  WHERE P.pol_status_code='C' and pt.CreatedDate > '@{pipeline().parameters.SELECTION_START_TS}'\r\n\t\t\r\n\t\tunion \r\n\t\t\r\n\t\tSELECT DISTINCT PC.PolicyAKID  AS PolicyAKID\r\n\t\t        ,P.pol_cancellation_date AS pol_cancellation_date\r\n\t\t  FROM  V2.policy P   INNER JOIN dbo.PolicyCoverage PC  ON   PC.PolicyAKID=P.pol_ak_id  AND  P.crrnt_snpsht_flag=1   \r\n\t\t  inner join RatingCoverage rc on rc.PolicyCoverageAKID =pc.PolicyCoverageAKID AND  PC.CurrentSnapshotFlag=1 \r\n\t\t  inner join PremiumTransaction pt on  pt.RatingCoverageAKId  =rc.RatingCoverageAKID and pt.EffectiveDate =rc.EffectiveDate and  rc.CurrentSnapshotFlag =1 \r\n\t\t  WHERE P.pol_status_code='C' and pt.CreatedDate > '@{pipeline().parameters.SELECTION_START_TS}' )   as PMSDCT\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY PolicyAKID ORDER BY pol_cancellation_date) = 1\n),\nSQ_PMS AS (\n\tSELECT  Distinct    PT.PremiumTransactionID\r\n\t           ,SC.CoverageGuid\r\n\t           ,SC.StatisticalCoverageAKID AS CoverageAKID\r\n\t           ,SC.SourceSystemID\r\n\t           ,MIN(SC.StatisticalCoverageEffectiveDate) over (partition by SC.CoverageGuid ,SC.StatisticalCoverageAKID ,SC.SourceSystemID )AS CoverageEffectiveDate   \r\n\t           ,MIN(PT.PremiumTransactionEffectiveDate)  over (partition by SC.CoverageGuid ,SC.StatisticalCoverageAKID ,SC.SourceSystemID )AS PremiumTransactionEffectiveDate\r\n\t           ,MAX(PT.PremiumTransactionExpirationDate) over (partition by SC.CoverageGuid ,SC.StatisticalCoverageAKID ,SC.SourceSystemID )AS  PremiumTransactionExpirationDate\r\n\t\t\t   ,PC.PolicyAKID\r\n\tFROM         @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PremiumTransaction PT\r\n\tINNER JOIN   @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.StatisticalCoverage SC\r\n\tON          SC.StatisticalCoverageAKID=PT.StatisticalCoverageAKID\r\n\tAND         PT.SourceSystemID='PMS'\r\n\tINNER JOIN  @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PolicyCoverage PC\r\n\tON          PC.PolicyCoverageAKID=SC.PolicyCoverageAKID\r\n\tAND         PC.SourceSystemID='PMS'\r\n\tAND         PC.CurrentSnapshotFlag =1\r\n\tINNER JOIN ( select SC2.StatisticalCoverageAKID\r\n\t               from  @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PremiumTransaction PT2\r\n\t\t\t\t   INNER JOIN  @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.StatisticalCoverage SC2 ON SC2.StatisticalCoverageAKID=PT2.StatisticalCoverageAKID AND SC2.CurrentSnapshotFlag=1\r\n\t\t\t\t   AND PT2.CreatedDate>='@{pipeline().parameters.SELECTION_START_TS}' \r\n\t               AND PT2.SourceSystemId='PMS' ) B\r\n\t\t\t\t   ON B.StatisticalCoverageAKID = SC.StatisticalCoverageAKID  \r\n\t@{pipeline().parameters.WHERE_CLAUSE_PMS}\n),\nSQ_StatisticalCoverage AS (\n\tselect  \r\n\tstep2.SourceSystemID as SourceSystemID\r\n\t,step2.StatisticalCoverageAKID as StatisticalCoverageAKID\r\n\t,MAX(step2.StatisticalCoverageCancellationDate) as StatisticalCoverageCancellationDate\r\n\t,STEP2.RunDate \r\n\t,STEP2.PolicyAKID\r\n\t\r\n\tfrom \r\n\t(\r\n\tselect STEP1.SourceSystemID AS SourceSystemID\r\n\t       ,STEP1.StatisticalCoverageAKID  AS StatisticalCoverageAKID  \r\n\t       ,step1.StatisticalCoverageCancellationDate as StatisticalCoverageCancellationDate\r\n\t\t   ,MAX (rundate ) OVER ( partition by STEP1.StatisticalCoverageAKID, STEP1.PolicyAKID ) maxrundate\r\n\t       ,STEP1.RunDate AS RunDate\r\n\t\t   ,STEP1.PolicyAKID AS PolicyAKID \r\n\tfrom \r\n\t(\r\n\t select A.StatisticalCoverageAKID,StatisticalCoverageCancellationDate,A.RunDate ,A.SourceSystemID,A.PolicyAKID\r\n\t from @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.WorkEarnedPremiumCoverageMonthly A\r\n\t INNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.StatisticalCoverage SC ON A.StatisticalCoverageAKID = SC.StatisticalCoverageAKID\r\n\t INNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PremiumTransaction PT ON SC.StatisticalCoverageAKID=PT.StatisticalCoverageAKID AND SC.CurrentSnapshotFlag = 1\r\n\t   AND PT.CreatedDate > '@{pipeline().parameters.SELECTION_START_TS}' \r\n\t inner join \r\n\t (select StatisticalCoverageAKID,PolicyAKID,max(rundate) Rundate \r\n\t  from @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.WorkEarnedPremiumCoverageMonthly\r\n\t  group by StatisticalCoverageAKID,PolicyAKID\r\n\t ) B\r\n\t on A.StatisticalCoverageAKID=B.StatisticalCoverageAKID\r\n\t and A.RunDate=B.Rundate\r\n\t and A.PolicyAKID=B.PolicyAKID\r\n\t where A.SourceSystemID='PMS' and A.PremiumType='D' \r\n\t\r\n\t\r\n\t UNION\r\n\t\r\n\t select A.StatisticalCoverageAKID,StatisticalCoverageCancellationDate,A.RunDate ,A.SourceSystemID,A.PolicyAKID\r\n\t from @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.WorkEarnedPremiumCoverageDaily A\r\n\t INNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.StatisticalCoverage SC ON A.StatisticalCoverageAKID = SC.StatisticalCoverageAKID\r\n\t INNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PremiumTransaction PT ON SC.StatisticalCoverageAKID=PT.StatisticalCoverageAKID AND SC.CurrentSnapshotFlag = 1\r\n\t   AND PT.CreatedDate > '@{pipeline().parameters.SELECTION_START_TS}' \r\n\t inner join \r\n\t (select StatisticalCoverageAKID,PolicyAKID,max(rundate) Rundate \r\n\t from @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.WorkEarnedPremiumCoverageDaily\r\n\t group by StatisticalCoverageAKID,PolicyAKID) B\r\n\t on A.StatisticalCoverageAKID=B.StatisticalCoverageAKID\r\n\t and A.RunDate=B.Rundate\r\n\t AND A.PolicyAKID=B.PolicyAKID\r\n\t where A.StatisticalCoverageCancellationDate<>'2100-12-31 23:59:59'\r\n\t and A.SourceSystemID='PMS' and A.PremiumType='D'\r\n\t ) STEP1)\r\n\t STEP2  \r\n\tWHERE maxrundate  = RunDate\r\n\tGROUP BY STEP2.StatisticalCoverageAKID,STEP2.PolicyAKID,STEP2.SourceSystemID,RunDate\n),\nJNR_GetPMSCancellationDate AS (SELECT\n\tSQ_StatisticalCoverage.SourceSystemID, \n\tSQ_StatisticalCoverage.StatisticalCoverageAKID, \n\tSQ_StatisticalCoverage.StatisticalCoverageCancellationDate, \n\tSQ_StatisticalCoverage.Rundate, \n\tSQ_StatisticalCoverage.PolicyAKID, \n\tSQ_PMS.PremiumTransactionID, \n\tSQ_PMS.CoverageGuid, \n\tSQ_PMS.CoverageAKID, \n\tSQ_PMS.SourceSystemID AS SourceSystemID1, \n\tSQ_PMS.CoverageEffectiveDate, \n\tSQ_PMS.PremiumTransactionEffectiveDate, \n\tSQ_PMS.PremiumTransactionExpirationDate, \n\tSQ_PMS.PolicyAKID AS PolicyAKID1\n\tFROM SQ_StatisticalCoverage\n\tRIGHT OUTER JOIN SQ_PMS\n\tON SQ_PMS.CoverageAKID = SQ_StatisticalCoverage.StatisticalCoverageAKID AND SQ_PMS.PolicyAKID = SQ_StatisticalCoverage.PolicyAKID\n),\nSQ_DCT AS (\n\tWITH STEP1 AS\r\n\t(\r\n\tselect DISTINCT RC3.RatingCoverageAKID\r\n\t               from @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PremiumTransaction PT3 \r\n\t\t\t\t   INNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.RatingCoverage RC3 \r\n\tON RC3.RatingCoverageAKID=PT3.RatingCoverageAKID AND RC3.EffectiveDate=PT3.EffectiveDate AND RC3.CurrentSnapshotFlag = 1\r\n\t\t\t\t\t\t  AND PT3.CreatedDate>='@{pipeline().parameters.SELECTION_START_TS}'\r\n\t)\r\n\t\r\n\t\r\n\tSELECT   Distinct   PT.PremiumTransactionID\r\n\t           ,RC.CoverageGuid\r\n\t           ,RC.RatingCoverageAKID AS CoverageAKID\r\n\t           ,RC.SourceSystemID\r\n\t           ,MIN(RC.RatingCoverageEffectiveDate) over (partition by RC.CoverageGuid ,PC.PolicyAKID,RC.RatingCoverageAKID ,RC.SourceSystemID )AS CoverageEffectiveDate   \r\n\t           ,MIN(PT.PremiumTransactionEffectiveDate)  over (partition by RC.CoverageGuid ,PC.PolicyAKID,RC.RatingCoverageAKID ,RC.SourceSystemID )AS PremiumTransactionEffectiveDate\r\n\t           ,MAX(PT.PremiumTransactionExpirationDate) over (partition by RC.CoverageGuid ,PC.PolicyAKID,RC.RatingCoverageAKID ,RC.SourceSystemID )AS  PremiumTransactionExpirationDate\r\n\t\t\t    ,PC.PolicyAKID\r\n\tFROM       @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PremiumTransaction PT\r\n\tINNER JOIN  @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.RatingCoverage RC\r\n\tON          RC.RatingCoverageAKID=PT.RatingCoverageAKID\r\n\tAND         RC.EffectiveDate=PT.EffectiveDate\r\n\tAND         PT.SourceSystemID='DCT'\r\n\tINNER JOIN  @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PolicyCoverage PC\r\n\tON \t\t\tRC.PolicyCoverageAKID=PC.PolicyCoverageAKID\r\n\tAND         PC.SourceSystemID='DCT'\r\n\tINNER JOIN  STEP1   ON STEP1.RatingCoverageAKID = RC.RatingCoverageAKID\r\n\t@{pipeline().parameters.WHERE_CLAUSE_DCT}\n),\nLKP_RatingCoverage AS (\n\tSELECT\n\tStatisticalCoverageCancellationDate,\n\tRunDate,\n\tRatingCoverageAKId,\n\tPolicyAKID\n\tFROM (\n\t\tSELECT Distinct \r\n\t\t        STEP2.RatingCoverageAKId AS RatingCoverageAKId\r\n\t\t\t   ,STEP2.StatisticalCoverageCancellationDate  AS StatisticalCoverageCancellationDate  \r\n\t\t\t   ,STEP2.RunDate AS RunDate \r\n\t\t\t   ,STEP2.SourceSystemID AS SourceSystemID\r\n\t\t\t   ,STEP2.PolicyAKID AS PolicyAKID\r\n\t\tFROM \r\n\t\t(\r\n\t\tSELECT A.RatingCoverageAKID,A.StatisticalCoverageCancellationDate,A.RunDate,A.SourceSystemID      ,A.PolicyAKID   \r\n\t\tFROM     @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.WorkEarnedPremiumCoverageMonthly A\r\n\t\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.RatingCoverage RC ON A.RatingCoverageAKID = RC.RatingCoverageAKID\r\n\t\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PremiumTransaction PT ON RC.RatingCoverageAKID=PT.RatingCoverageAKID  AND RC.EffectiveDate = PT.EffectiveDate\r\n\t\tAND PT.CreatedDate > '@{pipeline().parameters.SELECTION_START_TS}' AND PT.SourceSystemID='DCT'\r\n\t\tINNER JOIN   (select RatingCoverageAKID,PolicyAKID,max(rundate) Rundate  \r\n\t\t\t\t\t  FROM @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.WorkEarnedPremiumCoverageMonthly \r\n\t\t                WHERE SourceSystemID = 'DCT'\r\n\t\t\t\t\t  GROUP BY RatingCoverageAKID,PolicyAKID  ) AM\r\n\t\tON          A.RatingCoverageAKID = AM.RatingCoverageAKID\r\n\t\tAND         A.PolicyAKID = AM.PolicyAKID\r\n\t\tAND         A.RunDate = AM.Rundate\r\n\t\tWHERE   A.SourceSystemID='DCT' and A.PremiumType='D'\r\n\t\t\r\n\t\tUNION \r\n\t\t\r\n\t\tSELECT A.RatingCoverageAKID,A.StatisticalCoverageCancellationDate,A.RunDate,A.SourceSystemID     ,A.PolicyAKID    \r\n\t\tFROM     @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.WorkEarnedPremiumCoverageDaily A\r\n\t\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.RatingCoverage RC ON A.RatingCoverageAKID = RC.RatingCoverageAKID\r\n\t\tINNER JOIN @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PremiumTransaction PT ON RC.RatingCoverageAKID=PT.RatingCoverageAKID  AND RC.EffectiveDate = PT.EffectiveDate\r\n\t\tAND PT.CreatedDate > '@{pipeline().parameters.SELECTION_START_TS}' AND PT.SourceSystemID='DCT'\r\n\t\tINNER JOIN (SELECT RatingCoverageAKID,PolicyAKID,max(rundate) Rundate  \r\n\t\t\t\t           FROM  @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.WorkEarnedPremiumCoverageDaily \r\n\t\t                     WHERE SourceSystemID = 'DCT'\r\n\t\t\t\t\t      GROUP BY RatingCoverageAKID ,PolicyAKID ) AM\r\n\t\tON          A.RatingCoverageAKID = AM.RatingCoverageAKID\r\n\t\tAND         A.PolicyAKID=AM.PolicyAKID\r\n\t\tAND         A.RunDate = AM.Rundate\r\n\t\tWHERE  A.SourceSystemID='DCT' and A.PremiumType='D' \r\n\t\t--ADDED BY Hongjie On May 11,2015\r\n\t\tAND A.StatisticalCoverageCancellationDate<>'2100-12-31 23:59:59'\r\n\t\t) STEP2\r\n\t\tORDER BY STEP2.RatingCoverageAKId, STEP2.PolicyAKID,STEP2.RunDate,  STEP2.StatisticalCoverageCancellationDate ASC \r\n\t\t--\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY RatingCoverageAKId,PolicyAKID ORDER BY StatisticalCoverageCancellationDate DESC) = 1\n),\nUnion AS (\n\tSELECT PremiumTransactionID, CoverageGuid, SourceSystemID, StatisticalCoverageCancellationDate, Rundate AS RunDate, CoverageEffectiveDate, PremiumTransactionEffectiveDate, PremiumTransactionExpirationDate, PolicyAKID1 AS PolicyAKID\n\tFROM JNR_GetPMSCancellationDate\n\tUNION\n\tSELECT PremiumTransactionID, CoverageGuid, SourceSystemID, StatisticalCoverageCancellationDate, RunDate, CoverageEffectiveDate, PremiumTransactionEffectiveDate, PremiumTransactionExpirationDate\n\tFROM LKP_RatingCoverage\n\t-- Manually join with SQ_DCT\n),\nEXP_Value AS (\n\tSELECT\n\tPremiumTransactionID,\n\tCoverageGuid,\n\tStatisticalCoverageCancellationDate AS i_StatisticalCoverageCancellationDate,\n\tRunDate AS i_RunDate,\n\tCoverageEffectiveDate AS i_CoverageEffectiveDate,\n\tPremiumTransactionEffectiveDate AS i_PremiumTransactionEffectiveDate,\n\tPremiumTransactionExpirationDate AS i_PremiumTransactionExpirationDate,\n\tPolicyAKID AS i_PolicyAKID,\n\t-- *INF*: IIF( ISNULL( i_CoverageEffectiveDate ),  TO_DATE('1800-01-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS')   , i_CoverageEffectiveDate )\n\tIFF(i_CoverageEffectiveDate IS NULL, TO_DATE('1800-01-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS'), i_CoverageEffectiveDate) AS v_CoverageEffectiveDate,\n\t-- *INF*: IIF( ISNULL( i_StatisticalCoverageCancellationDate ),  TO_DATE('2100-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS')  , i_StatisticalCoverageCancellationDate)\n\tIFF(i_StatisticalCoverageCancellationDate IS NULL, TO_DATE('2100-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS'), i_StatisticalCoverageCancellationDate) AS v_StatisticalCoverageCancellationDate,\n\t-- *INF*: IIF( ISNULL(  i_PremiumTransactionEffectiveDate ),  TO_DATE('1800-01-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS')  , i_PremiumTransactionEffectiveDate )\n\tIFF(i_PremiumTransactionEffectiveDate IS NULL, TO_DATE('1800-01-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS'), i_PremiumTransactionEffectiveDate) AS v_PremiumTransactionEffectiveDate,\n\t-- *INF*: IIF( (v_PremiumTransactionEffectiveDate<=v_RunDate AND i_PremiumTransactionExpirationDate > v_RunDate  AND  \r\n\t-- TO_CHAR(  v_RunDate,'YYYY-MM_DD')  = TO_CHAR(SYSDATE,'YYYY-MM-DD')   )\r\n\t-- OR\r\n\t-- (   v_PremiumTransactionEffectiveDate<=v_RunDate AND GET_DATE_PART( i_PremiumTransactionExpirationDate ,'YYYY') > GET_DATE_PART( v_RunDate ,'YYYY')  )\r\n\t-- OR\r\n\t-- (   v_PremiumTransactionEffectiveDate<=v_RunDate AND GET_DATE_PART( i_PremiumTransactionExpirationDate ,'YYYY') = GET_DATE_PART( v_RunDate ,'YYYY') AND   GET_DATE_PART( i_PremiumTransactionExpirationDate ,'MM') >=  GET_DATE_PART( v_RunDate,'MM')   ), v_StatisticalCoverageCancellationDate,                                             TO_DATE('2100-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS')\r\n\t--   )\n\tIFF(( v_PremiumTransactionEffectiveDate <= v_RunDate AND i_PremiumTransactionExpirationDate > v_RunDate AND TO_CHAR(v_RunDate, 'YYYY-MM_DD') = TO_CHAR(SYSDATE, 'YYYY-MM-DD') ) OR ( v_PremiumTransactionEffectiveDate <= v_RunDate AND GET_DATE_PART(i_PremiumTransactionExpirationDate, 'YYYY') > GET_DATE_PART(v_RunDate, 'YYYY') ) OR ( v_PremiumTransactionEffectiveDate <= v_RunDate AND GET_DATE_PART(i_PremiumTransactionExpirationDate, 'YYYY') = GET_DATE_PART(v_RunDate, 'YYYY') AND GET_DATE_PART(i_PremiumTransactionExpirationDate, 'MM') >= GET_DATE_PART(v_RunDate, 'MM') ), v_StatisticalCoverageCancellationDate, TO_DATE('2100-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS')) AS v_CoverageCancellationDate,\n\t-- *INF*: IIF( ISNULL( i_RunDate ),  TO_DATE('1800-01-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS')   , i_RunDate )\n\tIFF(i_RunDate IS NULL, TO_DATE('1800-01-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS'), i_RunDate) AS v_RunDate,\n\t-- *INF*: (:LKP.LKP_Policy(i_PolicyAKID))\n\t( LKP_POLICY_i_PolicyAKID.pol_cancellation_date ) AS v_lkp_policy,\n\t-- *INF*: IIF( v_CoverageEffectiveDate>v_PremiumTransactionEffectiveDate,v_CoverageEffectiveDate,v_PremiumTransactionEffectiveDate )\n\tIFF(v_CoverageEffectiveDate > v_PremiumTransactionEffectiveDate, v_CoverageEffectiveDate, v_PremiumTransactionEffectiveDate) AS o_CoverageEffectiveDate,\n\t-- *INF*: IIF( ISNULL( i_PremiumTransactionExpirationDate ),  TO_DATE('2100-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS')  , i_PremiumTransactionExpirationDate )\n\tIFF(i_PremiumTransactionExpirationDate IS NULL, TO_DATE('2100-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS'), i_PremiumTransactionExpirationDate) AS o_CoverageExpirationDate,\n\t-- *INF*: DECODE(TRUE,\r\n\t--  ISNULL(v_lkp_policy), v_CoverageCancellationDate,\r\n\t-- v_CoverageCancellationDate<= v_lkp_policy ,v_CoverageCancellationDate,\r\n\t-- v_lkp_policy)\n\tDECODE(TRUE,\n\tv_lkp_policy IS NULL, v_CoverageCancellationDate,\n\tv_CoverageCancellationDate <= v_lkp_policy, v_CoverageCancellationDate,\n\tv_lkp_policy) AS o_CoverageCancellationDate\n\tFROM Union\n\tLEFT JOIN LKP_POLICY LKP_POLICY_i_PolicyAKID\n\tON LKP_POLICY_i_PolicyAKID.PolicyAKID = i_PolicyAKID\n\n),\nSQ_CoverageDetailDim AS (\n\tSELECT \r\n\tCCD.CoverageDetailDimId as CoverageDetailDimId,\r\n\tCCD.CoverageGuid as CoverageGuid,\r\n\tCCD.EDWPremiumTransactionPKId as EDWPremiumTransactionPKId,\r\n\tCCD.CoverageEffectiveDate, \r\n\tCCD.CoverageExpirationDate, \r\n\tCCD.CoverageCancellationDate \r\n\tFROM  @{pipeline().parameters.TARGET_TABLE_OWNER}.CoverageDetailDim  CCD\r\n\tWHERE CCD.CoverageGuid IN \r\n\t(\r\n\tSELECT DISTINCT CCD2.CoverageGuid\r\n\tFROM   @{pipeline().parameters.TARGET_TABLE_OWNER}.CoverageDetailDim  CCD2\r\n\tINNER JOIN   @{pipeline().parameters.SOURCE_DATABASE_NAME}.@{pipeline().parameters.SOURCE_TABLE_OWNER}.PremiumTransaction PT \r\n\tON CCD2.EDWPremiumTransactionPKId=PT.PremiumTransactionID\r\n\tWHERE PT.CreatedDate>='@{pipeline().parameters.SELECTION_START_TS}'\r\n\t)\n),\nJNR_IL_And_DM AS (SELECT\n\tEXP_Value.PremiumTransactionID, \n\tEXP_Value.CoverageGuid, \n\tEXP_Value.o_CoverageEffectiveDate AS CoverageEffectiveDate, \n\tEXP_Value.o_CoverageExpirationDate AS CoverageExpirationDate, \n\tEXP_Value.o_CoverageCancellationDate AS CoverageCancellationDate, \n\tSQ_CoverageDetailDim.CoverageDetailDimId, \n\tSQ_CoverageDetailDim.CoverageGuid AS i_CoverageGuid, \n\tSQ_CoverageDetailDim.EDWPremiumTransactionPKId AS i_EDWPremiumTransactionPKId, \n\tSQ_CoverageDetailDim.CoverageEffectiveDate AS i_CoverageEffectiveDate, \n\tSQ_CoverageDetailDim.CoverageExpirationDate AS i_CoverageExpirationDate, \n\tSQ_CoverageDetailDim.CoverageCancellationDate AS i_CoverageCancellationDate\n\tFROM SQ_CoverageDetailDim\n\tINNER JOIN EXP_Value\n\tON EXP_Value.PremiumTransactionID = SQ_CoverageDetailDim.EDWPremiumTransactionPKId AND EXP_Value.CoverageGuid = SQ_CoverageDetailDim.CoverageGuid\n),\nEXP_UPDATE_Change AS (\n\tSELECT\n\tCoverageEffectiveDate,\n\tCoverageExpirationDate,\n\tCoverageCancellationDate,\n\tCoverageDetailDimId,\n\ti_CoverageGuid,\n\ti_EDWPremiumTransactionPKId,\n\ti_CoverageEffectiveDate,\n\ti_CoverageExpirationDate,\n\ti_CoverageCancellationDate,\n\t-- *INF*: iif (\r\n\t-- \r\n\t-- CoverageEffectiveDate=i_CoverageEffectiveDate\r\n\t-- and CoverageExpirationDate=i_CoverageExpirationDate\r\n\t-- and CoverageCancellationDate=i_CoverageCancellationDate,\r\n\t-- 'UNCHANGED',\r\n\t-- 'UPDATE')\n\tIFF(CoverageEffectiveDate = i_CoverageEffectiveDate AND CoverageExpirationDate = i_CoverageExpirationDate AND CoverageCancellationDate = i_CoverageCancellationDate, 'UNCHANGED', 'UPDATE') AS Change_Flag\n\tFROM JNR_IL_And_DM\n),\nFLTR_ONLY_CHANGED_UPDATE AS (\n\tSELECT\n\tCoverageEffectiveDate, \n\tCoverageExpirationDate, \n\tCoverageCancellationDate, \n\tCoverageDetailDimId, \n\tChange_Flag\n\tFROM EXP_UPDATE_Change\n\tWHERE Change_Flag='UPDATE'\n),\nUDP_CoverageDetailDim AS (\n\tSELECT\n\tCoverageEffectiveDate, \n\tCoverageExpirationDate, \n\tCoverageCancellationDate, \n\tCoverageDetailDimId\n\tFROM FLTR_ONLY_CHANGED_UPDATE\n),\nCoverageDetailDim AS (\n\tMERGE INTO CoverageDetailDim AS T\n\tUSING UDP_CoverageDetailDim AS S\n\tON T.CoverageDetailDimId = S.CoverageDetailDimId\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.CoverageEffectiveDate = S.CoverageEffectiveDate, T.CoverageExpirationDate = S.CoverageExpirationDate, T.CoverageCancellationDate = S.CoverageCancellationDate\n),"
                        }
                    ]
                }
            }
        ],
        "parameters": {
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "246503"
            },
            "WBMI_BATCH_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "905513"
            },
            "WBMI_SESSION_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "7604123"
            },
            "SELECTION_START_TS": {
                "type": "string",
                "defaultValue": "08/30/2023 01:14:33"
            },
            "SELECTION_END_TS": {
                "type": "string",
                "defaultValue": "08/31/2023 01:30:27"
            },
            "DBCONNECTION_SOURCE": {
                "type": "string",
                "defaultValue": "SQLServer_RPT_EDM_Policy"
            },
            "DBCONNECTION_TARGET": {
                "type": "string",
                "defaultValue": "SQLServer_WC_Data_Mart_Policy"
            },
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "DBO"
            },
            "TARGET_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "DBO"
            },
            "SOURCE_DATABASE_NAME": {
                "type": "string",
                "defaultValue": "RPT_EDM"
            },
            "TARGET_DATABASE_NAME": {
                "type": "string",
                "defaultValue": "WC_DATA_MART"
            },
            "WHERE_CLAUSE_DCT": {
                "type": "string",
                "defaultValue": ""
            },
            "WHERE_CLAUSE_PMS": {
                "type": "string",
                "defaultValue": ""
            },
            "UPDATE_CLAUSE": {
                "type": "string",
                "defaultValue": ""
            },
            "UPDATE_STATEMENT": {
                "type": "string",
                "defaultValue": "UPDATE $$TARGET_TABLE_OWNER.CoverageDetailDim SET ModifedDate = :TU.ModifedDate, EffectiveDate = :TU.EffectiveDate, ExpirationDate = :TU.ExpirationDate WHERE CoverageDetailDimId = :TU.CoverageDetailDimId"
            }
        },
        "folder": {
            "name": ""
        },
        "annotations": []
    }
}