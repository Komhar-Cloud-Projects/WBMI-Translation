{
    "name": "m_AGY_DM_Load_AgencyDim_v3",
    "properties": {
        "activities": [
            {
                "name": "m_AGY_DM_Load_AgencyDim_v3",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nLKP_Agency_V2 AS (\n\tSELECT\n\tAgencyCode,\n\tAgencyAKID\n\tFROM (\n\t\tSELECT \n\t\t\tAgencyCode,\n\t\t\tAgencyAKID\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER_V2}.Agency\n\t\tWHERE CurrentSnapshotFlag = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY AgencyAKID ORDER BY AgencyCode) = 1\n),\nSQ_Agency_V2 AS (\n\tSELECT\n\t\tAgencyID,\n\t\tCurrentSnapshotFlag,\n\t\tAuditID,\n\t\tEffectiveDate,\n\t\tExpirationDate,\n\t\tSourceSystemID,\n\t\tCreatedDate,\n\t\tModifiedDate,\n\t\tHashKey,\n\t\tAgencyAKID,\n\t\tSalesTerritoryAKID,\n\t\tRegionalSalesManagerAKID,\n\t\tAgencyCode,\n\t\tLegalName,\n\t\tDoingBusinessAsName,\n\t\tPrimaryPhoneNumber,\n\t\tPrimaryFaxNumber,\n\t\tPrimaryEmailAddress,\n\t\tStatusCode,\n\t\tStatusDescription,\n\t\tAppointedDate,\n\t\tTerminatedDate,\n\t\tCustomerCareStatus,\n\t\tFederalTaxId,\n\t\tProfitSharingGuaranteeFlag,\n\t\tLicensedIndicator,\n\t\tAbbreviatedName,\n\t\tAssignedStateCode,\n\t\tClosedDate\n\tFROM Agency_V2\n\tWHERE CurrentSnapshotFlag = 1\n),\nLKP_LegalParent AS (\n\tSELECT\n\tRelatedAgencyAKID,\n\tAgencyAKID\n\tFROM (\n\t\tSELECT AgencyRelationship.RelatedAgencyAKID as RelatedAgencyAKID, AgencyRelationship.AgencyAKID as AgencyAKID FROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.AgencyRelationship AgencyRelationship\r\n\t\tWHERE AgencyRelationship.CurrentSnapshotFlag = 1 and AgencyRelationship.RelationshipType in ('LEGAL SPECIAL ACCOUNT', 'LEGAL BRANCH', 'LEGAL TERMINATED', 'LEGAL MERGED')\r\n\t\tORDER BY AgencyRelationship.AgencyAKID,AgencyRelationship.AgencyRelationshipExpirationDate ---\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY AgencyAKID ORDER BY RelatedAgencyAKID DESC) = 1\n),\nLKP_LegalParent_deleted AS (\n\tSELECT\n\tRelatedAgencyAKID,\n\tAgencyAKID\n\tFROM (\n\t\tSELECT \n\t\t\tRelatedAgencyAKID,\n\t\t\tAgencyAKID\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.AgencyRelationship\n\t\tWHERE CurrentSnapshotFlag = 1 and RelationshipType in ('LEGAL DELETED')\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY AgencyAKID ORDER BY RelatedAgencyAKID DESC) = 1\n),\nLKP_MailingAddress AS (\n\tSELECT\n\tAgencyAddressID,\n\tAgencyAddressAKID,\n\tAddressLine1,\n\tAddressLine2,\n\tAddressLine3,\n\tCity,\n\tZipCode,\n\tCountyCode,\n\tCountyName,\n\tStateAbbreviation,\n\tCountryAbbreviation,\n\tLatitude,\n\tLongitude,\n\tAgencyAKID\n\tFROM (\n\t\tSELECT \n\t\t\tAgencyAddressID,\n\t\t\tAgencyAddressAKID,\n\t\t\tAddressLine1,\n\t\t\tAddressLine2,\n\t\t\tAddressLine3,\n\t\t\tCity,\n\t\t\tZipCode,\n\t\t\tCountyCode,\n\t\t\tCountyName,\n\t\t\tStateAbbreviation,\n\t\t\tCountryAbbreviation,\n\t\t\tLatitude,\n\t\t\tLongitude,\n\t\t\tAgencyAKID\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.AgencyAddress\n\t\tWHERE CurrentSnapshotFlag = 1 and AddressType = 'Mailing'\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY AgencyAKID ORDER BY AgencyAddressID DESC) = 1\n),\nLKP_PhysicalAddress AS (\n\tSELECT\n\tAgencyAddressID,\n\tAgencyAddressAKID,\n\tAddressLine1,\n\tAddressLine2,\n\tAddressLine3,\n\tCity,\n\tZipCode,\n\tCountyCode,\n\tCountyName,\n\tStateAbbreviation,\n\tCountryAbbreviation,\n\tLatitude,\n\tLongitude,\n\tAgencyAKID\n\tFROM (\n\t\tSELECT \n\t\t\tAgencyAddressID,\n\t\t\tAgencyAddressAKID,\n\t\t\tAddressLine1,\n\t\t\tAddressLine2,\n\t\t\tAddressLine3,\n\t\t\tCity,\n\t\t\tZipCode,\n\t\t\tCountyCode,\n\t\t\tCountyName,\n\t\t\tStateAbbreviation,\n\t\t\tCountryAbbreviation,\n\t\t\tLatitude,\n\t\t\tLongitude,\n\t\t\tAgencyAKID\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.AgencyAddress\n\t\tWHERE CurrentSnapshotFlag = 1 and AddressType = 'Physical'\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY AgencyAKID ORDER BY AgencyAddressID DESC) = 1\n),\nEXP_CleanupData AS (\n\tSELECT\n\tLKP_PhysicalAddress.AgencyAddressID AS lkp_physical_AgencyAddressID,\n\tLKP_PhysicalAddress.AgencyAddressAKID AS lkp_physical_AgencyAddressAKID,\n\tLKP_PhysicalAddress.AddressLine1 AS lkp_physical_AddressLine1,\n\tLKP_PhysicalAddress.AddressLine2 AS lkp_physical_AddressLine2,\n\tLKP_PhysicalAddress.AddressLine3 AS lkp_physical_AddressLine3,\n\tLKP_PhysicalAddress.City AS lkp_physical_City,\n\tLKP_PhysicalAddress.ZipCode AS lkp_physical_ZipCode,\n\tLKP_PhysicalAddress.CountyCode AS lkp_physical_CountyCode,\n\tLKP_PhysicalAddress.CountyName AS lkp_physical_CountyName,\n\tLKP_PhysicalAddress.StateAbbreviation AS lkp_physical_StateAbbreviation,\n\tLKP_PhysicalAddress.CountryAbbreviation AS lkp_physical_CountryAbbreviation,\n\tLKP_PhysicalAddress.Latitude AS lkp_physical_Latitude,\n\tLKP_PhysicalAddress.Longitude AS lkp_physical_Longitude,\n\tLKP_MailingAddress.AgencyAddressID AS lkp_mail_AgencyAddressID,\n\tLKP_MailingAddress.AgencyAddressAKID AS lkp_mail_AgencyAddressAKID,\n\tLKP_MailingAddress.AddressLine1 AS lkp_mail_AddressLine1,\n\tLKP_MailingAddress.AddressLine2 AS lkp_mail_AddressLine2,\n\tLKP_MailingAddress.AddressLine3 AS lkp_mail_AddressLine3,\n\tLKP_MailingAddress.City AS lkp_mail_City,\n\tLKP_MailingAddress.ZipCode AS lkp_mail_ZipCode,\n\tLKP_MailingAddress.CountyCode AS lkp_mail_CountyCode,\n\tLKP_MailingAddress.CountyName AS lkp_mail_CountyName,\n\tLKP_MailingAddress.StateAbbreviation AS lkp_mail_StateAbbreviation,\n\tLKP_MailingAddress.CountryAbbreviation AS lkp_mail_CountryAbbreviation,\n\tLKP_MailingAddress.Latitude AS lkp_mail_Latitude,\n\tLKP_MailingAddress.Longitude AS lkp_mail_Longitude,\n\tLKP_LegalParent.RelatedAgencyAKID AS lkp_LegalParentAgencyAKID,\n\tLKP_LegalParent_deleted.RelatedAgencyAKID AS lkp_LegalParentAgencyAKID_Deleted,\n\tSQ_Agency_V2.AgencyID AS AgencyPKID,\n\tSQ_Agency_V2.AgencyAKID,\n\tSQ_Agency_V2.AgencyCode,\n\tSQ_Agency_V2.LegalName,\n\tSQ_Agency_V2.DoingBusinessAsName,\n\tSQ_Agency_V2.PrimaryPhoneNumber,\n\tSQ_Agency_V2.PrimaryFaxNumber,\n\tSQ_Agency_V2.PrimaryEmailAddress,\n\tSQ_Agency_V2.StatusCode,\n\tSQ_Agency_V2.StatusDescription,\n\tSQ_Agency_V2.AppointedDate,\n\tSQ_Agency_V2.TerminatedDate,\n\tSQ_Agency_V2.CustomerCareStatus,\n\tSQ_Agency_V2.LicensedIndicator,\n\t-- *INF*: Decode(true,\r\n\t-- LicensedIndicator = 'Y', '1', \r\n\t-- LicensedIndicator = 'N', '0', \r\n\t-- '1')\n\tDecode(true,\n\tLicensedIndicator = 'Y', '1',\n\tLicensedIndicator = 'N', '0',\n\t'1') AS o_LicensedIndicator,\n\tSQ_Agency_V2.AbbreviatedName,\n\tSQ_Agency_V2.AssignedStateCode,\n\t'NA' AS v_DefaultCharCode,\n\t-1 AS v_DefaultInt,\n\t'N/A' AS v_DefaultChar,\n\t0 AS v_DefaultDecimal,\n\t-- *INF*: :LKP.LKP_AGENCY_V2(lkp_LegalParentAgencyAKID)\n\tLKP_AGENCY_V2_lkp_LegalParentAgencyAKID.AgencyCode AS v_LegalPrimaryAgencyCode,\n\t-- *INF*: IIF(IsNull(lkp_mail_AgencyAddressID), v_DefaultInt, lkp_mail_AgencyAddressID)\n\tIFF(lkp_mail_AgencyAddressID IS NULL, v_DefaultInt, lkp_mail_AgencyAddressID) AS o_mail_AgencyAddressID,\n\t-- *INF*: IIF(IsNull(lkp_mail_AgencyAddressID), v_DefaultInt, lkp_mail_AgencyAddressAKID)\n\tIFF(lkp_mail_AgencyAddressID IS NULL, v_DefaultInt, lkp_mail_AgencyAddressAKID) AS o_mail_AgencyAddressAKID,\n\t-- *INF*: IIF(IsNull(lkp_physical_AgencyAddressID), v_DefaultInt, lkp_physical_AgencyAddressID)\n\tIFF(lkp_physical_AgencyAddressID IS NULL, v_DefaultInt, lkp_physical_AgencyAddressID) AS o_physical_AgencyAddressID,\n\t-- *INF*: IIF(IsNull(lkp_physical_AgencyAddressID), v_DefaultInt, lkp_physical_AgencyAddressAKID)\n\tIFF(lkp_physical_AgencyAddressID IS NULL, v_DefaultInt, lkp_physical_AgencyAddressAKID) AS o_physical_AgencyAddressAKID,\n\t-- *INF*: IIF(IsNull(lkp_LegalParentAgencyAKID), 'Yes', 'No')\n\tIFF(lkp_LegalParentAgencyAKID IS NULL, 'Yes', 'No') AS o_PrimaryAgencyIndicator,\n\t-- *INF*: IIF(IsNull(lkp_physical_AgencyAddressID), v_DefaultChar, lkp_physical_AddressLine1)\n\tIFF(lkp_physical_AgencyAddressID IS NULL, v_DefaultChar, lkp_physical_AddressLine1) AS o_physical_AddressLine1,\n\t-- *INF*: IIF(IsNull(lkp_physical_AgencyAddressID), v_DefaultChar, lkp_physical_AddressLine2)\n\tIFF(lkp_physical_AgencyAddressID IS NULL, v_DefaultChar, lkp_physical_AddressLine2) AS o_physical_AddressLine2,\n\t-- *INF*: IIF(IsNull(lkp_physical_AgencyAddressID), v_DefaultChar, lkp_physical_AddressLine3)\n\tIFF(lkp_physical_AgencyAddressID IS NULL, v_DefaultChar, lkp_physical_AddressLine3) AS o_physical_AddressLine3,\n\t-- *INF*: IIF(IsNull(lkp_physical_AgencyAddressID), v_DefaultChar, lkp_physical_City)\n\tIFF(lkp_physical_AgencyAddressID IS NULL, v_DefaultChar, lkp_physical_City) AS o_physical_City,\n\t-- *INF*: IIF(IsNull(lkp_physical_AgencyAddressID), v_DefaultChar, lkp_physical_ZipCode)\n\tIFF(lkp_physical_AgencyAddressID IS NULL, v_DefaultChar, lkp_physical_ZipCode) AS o_physical_ZipCode,\n\t-- *INF*: IIF(IsNull(lkp_physical_AgencyAddressID), v_DefaultChar, lkp_physical_CountyCode)\n\tIFF(lkp_physical_AgencyAddressID IS NULL, v_DefaultChar, lkp_physical_CountyCode) AS o_physical_CountyCode,\n\t-- *INF*: IIF(IsNull(lkp_physical_AgencyAddressID), v_DefaultChar, lkp_physical_CountyName)\n\tIFF(lkp_physical_AgencyAddressID IS NULL, v_DefaultChar, lkp_physical_CountyName) AS o_physical_CountyName,\n\t-- *INF*: IIF(IsNull(lkp_physical_AgencyAddressID), v_DefaultCharCode, lkp_physical_StateAbbreviation)\n\tIFF(lkp_physical_AgencyAddressID IS NULL, v_DefaultCharCode, lkp_physical_StateAbbreviation) AS o_physical_StateAbbreviation,\n\t-- *INF*: IIF(IsNull(lkp_physical_AgencyAddressID), v_DefaultChar, lkp_physical_CountryAbbreviation)\n\tIFF(lkp_physical_AgencyAddressID IS NULL, v_DefaultChar, lkp_physical_CountryAbbreviation) AS o_physical_CountryAbbreviation,\n\t-- *INF*: IIF(IsNull(lkp_physical_AgencyAddressID), v_DefaultDecimal, lkp_physical_Latitude)\n\tIFF(lkp_physical_AgencyAddressID IS NULL, v_DefaultDecimal, lkp_physical_Latitude) AS o_physical_Latitude,\n\t-- *INF*: IIF(IsNull(lkp_physical_AgencyAddressID), v_DefaultDecimal, lkp_physical_Longitude)\n\tIFF(lkp_physical_AgencyAddressID IS NULL, v_DefaultDecimal, lkp_physical_Longitude) AS o_physical_Longitude,\n\t-- *INF*: IIF(IsNull(lkp_mail_AgencyAddressID), v_DefaultChar, lkp_mail_AddressLine1)\n\tIFF(lkp_mail_AgencyAddressID IS NULL, v_DefaultChar, lkp_mail_AddressLine1) AS o_mail_AddressLine1,\n\t-- *INF*: IIF(IsNull(lkp_mail_AgencyAddressID), v_DefaultChar, lkp_mail_AddressLine2)\n\tIFF(lkp_mail_AgencyAddressID IS NULL, v_DefaultChar, lkp_mail_AddressLine2) AS o_mail_AddressLine2,\n\t-- *INF*: IIF(IsNull(lkp_mail_AgencyAddressID), v_DefaultChar, lkp_mail_AddressLine3)\n\tIFF(lkp_mail_AgencyAddressID IS NULL, v_DefaultChar, lkp_mail_AddressLine3) AS o_mail_AddressLine3,\n\t-- *INF*: IIF(IsNull(lkp_mail_AgencyAddressID), v_DefaultChar, lkp_mail_City)\n\tIFF(lkp_mail_AgencyAddressID IS NULL, v_DefaultChar, lkp_mail_City) AS o_mail_City,\n\t-- *INF*: IIF(IsNull(lkp_mail_AgencyAddressID), v_DefaultChar, lkp_mail_ZipCode)\n\tIFF(lkp_mail_AgencyAddressID IS NULL, v_DefaultChar, lkp_mail_ZipCode) AS o_mail_ZipCode,\n\t-- *INF*: IIF(IsNull(lkp_mail_AgencyAddressID), v_DefaultChar, lkp_mail_CountyCode)\n\tIFF(lkp_mail_AgencyAddressID IS NULL, v_DefaultChar, lkp_mail_CountyCode) AS o_mail_CountyCode,\n\t-- *INF*: IIF(IsNull(lkp_mail_AgencyAddressID), v_DefaultChar, lkp_mail_CountyName)\n\tIFF(lkp_mail_AgencyAddressID IS NULL, v_DefaultChar, lkp_mail_CountyName) AS o_mail_CountyName,\n\t-- *INF*: IIF(IsNull(lkp_mail_AgencyAddressID), v_DefaultCharCode, lkp_mail_StateAbbreviation)\n\tIFF(lkp_mail_AgencyAddressID IS NULL, v_DefaultCharCode, lkp_mail_StateAbbreviation) AS o_mail_StateAbbreviation,\n\t-- *INF*: IIF(IsNull(lkp_mail_AgencyAddressID), v_DefaultChar, lkp_mail_CountryAbbreviation)\n\tIFF(lkp_mail_AgencyAddressID IS NULL, v_DefaultChar, lkp_mail_CountryAbbreviation) AS o_mail_CountryAbbreviation,\n\t-- *INF*: IIF(IsNull(lkp_mail_AgencyAddressID), v_DefaultDecimal, lkp_mail_Latitude)\n\tIFF(lkp_mail_AgencyAddressID IS NULL, v_DefaultDecimal, lkp_mail_Latitude) AS o_mail_Latitude,\n\t-- *INF*: IIF(IsNull(lkp_mail_AgencyAddressID), v_DefaultDecimal, lkp_mail_Longitude)\n\tIFF(lkp_mail_AgencyAddressID IS NULL, v_DefaultDecimal, lkp_mail_Longitude) AS o_mail_Longitude,\n\t-- *INF*: IIF(IsNull(v_LegalPrimaryAgencyCode) OR lkp_LegalParentAgencyAKID = lkp_LegalParentAgencyAKID_Deleted,AgencyCode,v_LegalPrimaryAgencyCode)\n\tIFF(v_LegalPrimaryAgencyCode IS NULL OR lkp_LegalParentAgencyAKID = lkp_LegalParentAgencyAKID_Deleted, AgencyCode, v_LegalPrimaryAgencyCode) AS o_LegalPrimaryAgencyCode,\n\tSQ_Agency_V2.CurrentSnapshotFlag,\n\tSQ_Agency_V2.AuditID,\n\tSQ_Agency_V2.EffectiveDate,\n\tSQ_Agency_V2.ExpirationDate,\n\tSQ_Agency_V2.SourceSystemID,\n\tSQ_Agency_V2.CreatedDate,\n\tSQ_Agency_V2.ModifiedDate,\n\tSQ_Agency_V2.HashKey,\n\tSQ_Agency_V2.SalesTerritoryAKID,\n\tSQ_Agency_V2.RegionalSalesManagerAKID,\n\tSQ_Agency_V2.FederalTaxId,\n\tSQ_Agency_V2.ProfitSharingGuaranteeFlag,\n\tSQ_Agency_V2.ClosedDate\n\tFROM SQ_Agency_V2\n\tLEFT JOIN LKP_LegalParent\n\tON LKP_LegalParent.AgencyAKID = SQ_Agency_V2.AgencyAKID\n\tLEFT JOIN LKP_LegalParent_deleted\n\tON LKP_LegalParent_deleted.AgencyAKID = SQ_Agency_V2.AgencyAKID\n\tLEFT JOIN LKP_MailingAddress\n\tON LKP_MailingAddress.AgencyAKID = SQ_Agency_V2.AgencyAKID\n\tLEFT JOIN LKP_PhysicalAddress\n\tON LKP_PhysicalAddress.AgencyAKID = SQ_Agency_V2.AgencyAKID\n\tLEFT JOIN LKP_AGENCY_V2 LKP_AGENCY_V2_lkp_LegalParentAgencyAKID\n\tON LKP_AGENCY_V2_lkp_LegalParentAgencyAKID.AgencyAKID = lkp_LegalParentAgencyAKID\n\n),\nLKP_AgencyDim_ExistingData AS (\n\tSELECT\n\tAgencyDimID,\n\tAgencyDimHashKey,\n\tEDWAgencyPKID,\n\tEDWAgencyAddressPhysicalPKID,\n\tEDWAgencyAddressMailingPKID,\n\tSalesDivisionDimID,\n\tAgencyClosedDate,\n\tEDWAgencyAKID\n\tFROM (\n\t\tSELECT \n\t\t\tAgencyDimID,\n\t\t\tAgencyDimHashKey,\n\t\t\tEDWAgencyPKID,\n\t\t\tEDWAgencyAddressPhysicalPKID,\n\t\t\tEDWAgencyAddressMailingPKID,\n\t\t\tSalesDivisionDimID,\n\t\t\tAgencyClosedDate,\n\t\t\tEDWAgencyAKID\n\t\tFROM @{pipeline().parameters.TARGET_TABLE_OWNER}.AgencyDim\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY EDWAgencyAKID ORDER BY AgencyDimID DESC) = 1\n),\nEXP_CheckForChange AS (\n\tSELECT\n\tLKP_AgencyDim_ExistingData.AgencyDimID AS lkp_ExistingAgencyDimId,\n\tLKP_AgencyDim_ExistingData.AgencyDimHashKey AS lkp_AgencyDimHashKey,\n\tLKP_AgencyDim_ExistingData.EDWAgencyPKID AS lkp_ExistingAgencyPKID,\n\tLKP_AgencyDim_ExistingData.EDWAgencyAddressPhysicalPKID AS lkp_ExistingAgencyAddressPhysicalPKID,\n\tLKP_AgencyDim_ExistingData.EDWAgencyAddressMailingPKID AS lkp_ExistingAgencyAddressMailingPKID,\n\tLKP_AgencyDim_ExistingData.SalesDivisionDimID AS lkp_SalesDivisionDimID,\n\tLKP_AgencyDim_ExistingData.AgencyClosedDate AS lkp_AgencyClosedDate,\n\tEXP_CleanupData.AgencyPKID AS i_AgencyPKID,\n\tEXP_CleanupData.AgencyAKID AS i_AgencyAKID,\n\tEXP_CleanupData.AgencyCode AS i_AgencyCode,\n\tEXP_CleanupData.LegalName AS i_LegalName,\n\tEXP_CleanupData.DoingBusinessAsName AS i_DoingBusinessAsName,\n\tEXP_CleanupData.PrimaryPhoneNumber AS i_PrimaryPhoneNumber,\n\tEXP_CleanupData.PrimaryFaxNumber AS i_PrimaryFaxNumber,\n\tEXP_CleanupData.PrimaryEmailAddress AS i_PrimaryEmailAddress,\n\tEXP_CleanupData.StatusCode AS i_StatusCode,\n\tEXP_CleanupData.StatusDescription AS i_StatusDescription,\n\tEXP_CleanupData.AppointedDate AS i_AppointedDate,\n\tEXP_CleanupData.TerminatedDate AS i_TerminatedDate,\n\tEXP_CleanupData.CustomerCareStatus AS i_CustomerCareStatus,\n\tEXP_CleanupData.o_mail_AgencyAddressID AS i_mail_AgencyAddressPKID,\n\tEXP_CleanupData.o_mail_AgencyAddressAKID AS i_mail_AgencyAddressAKID,\n\tEXP_CleanupData.o_physical_AgencyAddressID AS i_physical_AgencyAddressPKID,\n\tEXP_CleanupData.o_physical_AgencyAddressAKID AS i_physical_AgencyAddressAKID,\n\tEXP_CleanupData.o_PrimaryAgencyIndicator AS i_PrimaryAgencyIndicator,\n\tEXP_CleanupData.o_physical_AddressLine1 AS i_physical_AddressLine1,\n\tEXP_CleanupData.o_physical_AddressLine2 AS i_physical_AddressLine2,\n\tEXP_CleanupData.o_physical_AddressLine3 AS i_physical_AddressLine3,\n\tEXP_CleanupData.o_physical_City AS i_physical_City,\n\tEXP_CleanupData.o_physical_ZipCode AS i_physical_ZipCode,\n\tEXP_CleanupData.o_physical_CountyCode AS i_physical_CountyCode,\n\tEXP_CleanupData.o_physical_CountyName AS i_physical_CountyName,\n\tEXP_CleanupData.o_physical_StateAbbreviation AS i_physical_StateAbbreviation,\n\tEXP_CleanupData.o_physical_CountryAbbreviation AS i_physical_CountryAbbreviation,\n\tEXP_CleanupData.o_physical_Latitude AS i_physical_Latitude,\n\tEXP_CleanupData.o_physical_Longitude AS i_physical_Longitude,\n\tEXP_CleanupData.o_mail_AddressLine1 AS i_mail_AddressLine1,\n\tEXP_CleanupData.o_mail_AddressLine2 AS i_mail_AddressLine2,\n\tEXP_CleanupData.o_mail_AddressLine3 AS i_mail_AddressLine3,\n\tEXP_CleanupData.o_mail_City AS i_mail_City,\n\tEXP_CleanupData.o_mail_ZipCode AS i_mail_ZipCode,\n\tEXP_CleanupData.o_mail_CountyCode AS i_mail_CountyCode,\n\tEXP_CleanupData.o_mail_CountyName AS i_mail_CountyName,\n\tEXP_CleanupData.o_mail_StateAbbreviation AS i_mail_StateAbbreviation,\n\tEXP_CleanupData.o_mail_CountryAbbreviation AS i_mail_CountryAbbreviation,\n\tEXP_CleanupData.o_mail_Latitude AS i_mail_Latitude,\n\tEXP_CleanupData.o_mail_Longitude AS i_mail_Longitude,\n\tEXP_CleanupData.o_LegalPrimaryAgencyCode AS i_LegalPrimaryAgencyCode,\n\tEXP_CleanupData.o_LicensedIndicator AS LicensedIndicator,\n\tEXP_CleanupData.AbbreviatedName,\n\tEXP_CleanupData.AssignedStateCode,\n\tEXP_CleanupData.ClosedDate,\n\t-1 AS SalesDivisionDimID,\n\t-- *INF*: MD5(i_AgencyCode ||'&'|| i_LegalName ||'&'|| i_StatusCode ||'&'|| TO_CHAR(i_AppointedDate) || '&'||TO_CHAR(i_TerminatedDate) ||'&'|| i_PrimaryAgencyIndicator ||'&'|| i_physical_ZipCode||'&'||i_LegalPrimaryAgencyCode ||'&'|| TO_CHAR(LicensedIndicator) || '&'||TO_CHAR(AbbreviatedName) || '&'||TO_CHAR(AssignedStateCode))\r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- --MD5(AgencyCode || LegalName || StatusCode || to_char(AppointedDate) || to_char(TerminatedDate) || to_char(LegalParentAgencyAKID) || to_char(physical_AgencyAddressAKID) || to_char(mail_AgencyAddressAKID) || physical_ZipCode)\n\tMD5(i_AgencyCode || '&' || i_LegalName || '&' || i_StatusCode || '&' || TO_CHAR(i_AppointedDate) || '&' || TO_CHAR(i_TerminatedDate) || '&' || i_PrimaryAgencyIndicator || '&' || i_physical_ZipCode || '&' || i_LegalPrimaryAgencyCode || '&' || TO_CHAR(LicensedIndicator) || '&' || TO_CHAR(AbbreviatedName) || '&' || TO_CHAR(AssignedStateCode)) AS v_new_Type2HashKey,\n\t-- *INF*: DECODE(TRUE, \r\n\t-- i_AgencyPKID <> lkp_ExistingAgencyPKID, 'Y',\r\n\t-- i_mail_AgencyAddressPKID <> lkp_ExistingAgencyAddressMailingPKID, 'Y',\r\n\t-- i_physical_AgencyAddressPKID <> lkp_ExistingAgencyAddressPhysicalPKID, 'Y',\r\n\t-- lkp_AgencyClosedDate<>ClosedDate,'Y',\r\n\t-- 'N')\n\tDECODE(TRUE,\n\ti_AgencyPKID <> lkp_ExistingAgencyPKID, 'Y',\n\ti_mail_AgencyAddressPKID <> lkp_ExistingAgencyAddressMailingPKID, 'Y',\n\ti_physical_AgencyAddressPKID <> lkp_ExistingAgencyAddressPhysicalPKID, 'Y',\n\tlkp_AgencyClosedDate <> ClosedDate, 'Y',\n\t'N') AS v_ChangeToEDWRecord,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ISNULL(lkp_AgencyDimHashKey), 'Insert',\r\n\t-- (lkp_AgencyDimHashKey = v_new_Type2HashKey) and (v_ChangeToEDWRecord = 'N'), 'Ignore',\r\n\t-- (lkp_AgencyDimHashKey <> v_new_Type2HashKey), 'Expire',\r\n\t-- (lkp_AgencyDimHashKey = v_new_Type2HashKey) and (v_ChangeToEDWRecord = 'Y'), 'Update',\r\n\t-- 'Ignore')\r\n\t-- \r\n\t-- -- If the existing record is not found based on the AKID, it's always an insert\r\n\t-- -- If there are no changes, we ignore the record\r\n\t-- -- If one of the type 2 attributes changed, we expire the old record (also inserts a new record, see router)\r\n\t-- -- If there was no change to the type 2 attributes AND there was a change to the PKID in the EDW then we update the record.  Important to have the logic comparing the hash keys, otherwise we might attempt to update records where we are already expiring and inserting a new record.\r\n\t-- \t\r\n\t-- \r\n\t-- \n\tDECODE(TRUE,\n\tlkp_AgencyDimHashKey IS NULL, 'Insert',\n\t( lkp_AgencyDimHashKey = v_new_Type2HashKey ) AND ( v_ChangeToEDWRecord = 'N' ), 'Ignore',\n\t( lkp_AgencyDimHashKey <> v_new_Type2HashKey ), 'Expire',\n\t( lkp_AgencyDimHashKey = v_new_Type2HashKey ) AND ( v_ChangeToEDWRecord = 'Y' ), 'Update',\n\t'Ignore') AS v_InsertUpdateExpireOrIgnore,\n\t1 AS o_CurrentSnapshotFlag,\n\t0 AS o_ExpireSnapshotFlag,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS o_AuditID,\n\t-- *INF*: DECODE(v_InsertUpdateExpireOrIgnore, \r\n\t-- 'Insert', TO_DATE('1800-01-01 01:00:00', 'YYYY-MM-DD HH24:MI:SS'),\r\n\t-- SYSDATE)\r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- --Decode(v_InsertUpdateExpireOrIgnore, 'Insert', trunc(sysdate, 'DD'), lkp_ExistingEffectiveDate)\n\tDECODE(v_InsertUpdateExpireOrIgnore,\n\t'Insert', TO_DATE('1800-01-01 01:00:00', 'YYYY-MM-DD HH24:MI:SS'),\n\tSYSDATE) AS o_EffectiveDate,\n\t-- *INF*: TO_DATE('2100-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS')\r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- --Decode(v_InsertUpdateExpireOrIgnore, 'Expire', add_to_date(trunc(sysdate, 'DD'), 'MS', -1 ), to_date('2100-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS'))\n\tTO_DATE('2100-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS') AS o_ExpirationDate,\n\t-- *INF*: ADD_TO_DATE(SYSDATE, 'SS', -1 )\r\n\t-- \r\n\t-- \r\n\t-- --ADD_TO_DATE(TRUNC(SYSDATE, 'DD'), 'MS', -1 )\n\tADD_TO_DATE(SYSDATE, 'SS', - 1) AS o_ExpirationDate_ForExpire,\n\tSYSDATE AS o_CurrentDate,\n\tv_new_Type2HashKey AS o_HashKey,\n\ti_AgencyPKID AS o_AgencyPKID,\n\tv_InsertUpdateExpireOrIgnore AS o_InsertUpdateExpireOrIgnore\n\tFROM EXP_CleanupData\n\tLEFT JOIN LKP_AgencyDim_ExistingData\n\tON LKP_AgencyDim_ExistingData.EDWAgencyAKID = EXP_CleanupData.AgencyAKID\n),\nRTR_InsertUpdateOrExpire AS (\n\tSELECT\n\tlkp_ExistingAgencyDimId AS AgencyDimId_Existing,\n\to_CurrentSnapshotFlag AS CurrentSnapshotFlag,\n\to_ExpireSnapshotFlag AS ExpireSnapshotFlag,\n\to_AuditID AS AuditID,\n\to_EffectiveDate AS EffectiveDate,\n\to_ExpirationDate AS ExpirationDate,\n\to_ExpirationDate_ForExpire AS ExpirationDate_ForExpire,\n\to_CurrentDate AS CreatedDate,\n\to_CurrentDate AS ModifiedDate,\n\to_HashKey AS HashKey,\n\to_AgencyPKID AS AgencyPKID,\n\ti_physical_AgencyAddressPKID AS PhysicalAgencyAddressPKID,\n\ti_mail_AgencyAddressPKID AS MailAgencyAddressPKID,\n\ti_AgencyAKID AS AgencyAKID,\n\ti_physical_AgencyAddressAKID AS PhysicalAgencyAddressAKID,\n\ti_mail_AgencyAddressAKID AS MailAgencyAddressAKID,\n\ti_AgencyCode AS AgencyCode,\n\ti_LegalName AS LegalName,\n\ti_DoingBusinessAsName AS DoingBusinessAsName,\n\ti_PrimaryPhoneNumber AS PrimaryPhoneNumber,\n\ti_PrimaryFaxNumber AS PrimaryFaxNumber,\n\ti_PrimaryEmailAddress AS PrimaryEmailAddress,\n\ti_StatusCode AS StatusCode,\n\ti_StatusDescription AS StatusDescription,\n\ti_AppointedDate AS AppointedDate,\n\ti_TerminatedDate AS TerminatedDate,\n\ti_CustomerCareStatus AS CustomerCareStatus,\n\ti_PrimaryAgencyIndicator AS PrimaryAgencyIndicator,\n\ti_physical_AddressLine1 AS PhysicalAddressLine1,\n\ti_physical_AddressLine2 AS PhysicalAddressLine2,\n\ti_physical_AddressLine3 AS PhysicalAddressLine3,\n\ti_physical_City AS PhysicalCity,\n\ti_physical_ZipCode AS PhysicalZipCode,\n\ti_physical_CountyCode AS PhysicalCountyCode,\n\ti_physical_CountyName AS PhysicalCountyName,\n\ti_physical_StateAbbreviation AS PhysicalStateAbbreviation,\n\ti_physical_CountryAbbreviation AS PhysicalCountryAbbreviation,\n\ti_physical_Latitude AS PhysicalLatitude,\n\ti_physical_Longitude AS PhysicalLongitude,\n\ti_mail_AddressLine1 AS MailAddressLine1,\n\ti_mail_AddressLine2 AS MailAddressLine2,\n\ti_mail_AddressLine3 AS MailAddressLine3,\n\ti_mail_City AS MailCity,\n\ti_mail_ZipCode AS MailZipCode,\n\ti_mail_CountyCode AS MailCountyCode,\n\ti_mail_CountyName AS MailCountyName,\n\ti_mail_StateAbbreviation AS MailStateAbbreviation,\n\ti_mail_CountryAbbreviation AS MailCountryAbbreviation,\n\ti_mail_Latitude AS MailLatitude,\n\ti_mail_Longitude AS MailLongitude,\n\ti_LegalPrimaryAgencyCode AS LegalPrimaryAgencyCode,\n\to_InsertUpdateExpireOrIgnore AS InsertUpdateExpireOrIgnore,\n\tLicensedIndicator,\n\tAbbreviatedName,\n\tAssignedStateCode,\n\tSalesDivisionDimID,\n\tClosedDate\n\tFROM EXP_CheckForChange\n),\nRTR_InsertUpdateOrExpire_Expire AS (SELECT * FROM RTR_InsertUpdateOrExpire WHERE InsertUpdateExpireOrIgnore = 'Expire'),\nRTR_InsertUpdateOrExpire_Insert AS (SELECT * FROM RTR_InsertUpdateOrExpire WHERE InsertUpdateExpireOrIgnore = 'Insert' or InsertUpdateExpireOrIgnore = 'Expire'),\nRTR_InsertUpdateOrExpire_Update AS (SELECT * FROM RTR_InsertUpdateOrExpire WHERE InsertUpdateExpireOrIgnore = 'Update'),\nUPD_Inserts AS (\n\tSELECT\n\tCurrentSnapshotFlag, \n\tAuditID, \n\tEffectiveDate, \n\tExpirationDate, \n\tCreatedDate, \n\tModifiedDate, \n\tHashKey, \n\tAgencyPKID, \n\tPhysicalAgencyAddressPKID, \n\tMailAgencyAddressPKID, \n\tAgencyAKID, \n\tPhysicalAgencyAddressAKID, \n\tMailAgencyAddressAKID, \n\tAgencyCode, \n\tLegalName, \n\tDoingBusinessAsName, \n\tPrimaryPhoneNumber, \n\tPrimaryFaxNumber, \n\tPrimaryEmailAddress, \n\tStatusCode, \n\tStatusDescription, \n\tAppointedDate, \n\tTerminatedDate, \n\tCustomerCareStatus, \n\tPrimaryAgencyIndicator, \n\tPhysicalAddressLine1, \n\tPhysicalAddressLine2, \n\tPhysicalAddressLine AS PhysicalAddressLine3, \n\tPhysicalCity, \n\tPhysicalZipCode, \n\tPhysicalCountyCode, \n\tPhysicalCountyName, \n\tPhysicalStateAbbreviation, \n\tPhysicalCountryAbbreviation, \n\tPhysicalLatitude, \n\tPhysicalLongitude, \n\tMailAddressLine1, \n\tMailAddressLine2, \n\tMailAddressLine AS MailAddressLine3, \n\tMailCity, \n\tMailZipCode, \n\tMailCountyCode, \n\tMailCountyName, \n\tMailStateAbbreviation, \n\tMailCountryAbbreviation, \n\tMailLatitude, \n\tMailLongitude, \n\tLegalPrimaryAgencyCode, \n\tLicensedIndicator, \n\tAbbreviatedName, \n\tAssignedStateCode, \n\tSalesDivisionDimID AS SalesDivisionDimID3, \n\tClosedDate\n\tFROM RTR_InsertUpdateOrExpire_Insert\n),\nTGT_AgencyDim_InsertNew AS (\n\tINSERT INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.AgencyDim\n\t(CurrentSnapshotFlag, AuditID, EffectiveDate, ExpirationDate, CreatedDate, ModifiedDate, AgencyDimHashKey, EDWAgencyPKID, EDWAgencyAddressPhysicalPKID, EDWAgencyAddressMailingPKID, EDWAgencyAKID, EDWAgencyAddressPhysicalAKID, EDWAgencyAddressMailingAKID, AgencyCode, AgencyLegalName, AgencyDoingBusinessAsName, AgencyPrimaryPhoneNumber, AgencyPrimaryFaxNumber, AgencyPrimaryEmailAddress, AgencyStatusCode, AgencyStatusDescription, AgencyAppointedDate, AgencyTerminatedDate, AgencyCustomerCareStatus, PrimaryAgencyIndicator, PhysicalAddressLine1, PhysicalAddressLine2, PhysicalAddressLine3, PhysicalCity, PhysicalZipCode, PhysicalCountyCode, PhysicalCountyName, PhysicalStateAbbreviation, PhysicalCountryAbbreviation, PhysicalLatitude, PhysicalLongitude, MailingAddressLine1, MailingAddressLine2, MailingAddressLine3, MailingCity, MailingZipCode, MailingCountyCode, MailingCountyName, MailingStateAbbreviation, MailingCountryAbbreviation, MailingLatitude, MailingLongitude, LegalPrimaryAgencyCode, LicensedIndicator, AbbreviatedName, AssignedStateCode, SalesDivisionDimId, AgencyClosedDate)\n\tSELECT \n\tCURRENTSNAPSHOTFLAG, \n\tAUDITID, \n\tEFFECTIVEDATE, \n\tEXPIRATIONDATE, \n\tCREATEDDATE, \n\tMODIFIEDDATE, \n\tHashKey AS AGENCYDIMHASHKEY, \n\tAgencyPKID AS EDWAGENCYPKID, \n\tPhysicalAgencyAddressPKID AS EDWAGENCYADDRESSPHYSICALPKID, \n\tMailAgencyAddressPKID AS EDWAGENCYADDRESSMAILINGPKID, \n\tAgencyAKID AS EDWAGENCYAKID, \n\tPhysicalAgencyAddressAKID AS EDWAGENCYADDRESSPHYSICALAKID, \n\tMailAgencyAddressAKID AS EDWAGENCYADDRESSMAILINGAKID, \n\tAGENCYCODE, \n\tLegalName AS AGENCYLEGALNAME, \n\tDoingBusinessAsName AS AGENCYDOINGBUSINESSASNAME, \n\tPrimaryPhoneNumber AS AGENCYPRIMARYPHONENUMBER, \n\tPrimaryFaxNumber AS AGENCYPRIMARYFAXNUMBER, \n\tPrimaryEmailAddress AS AGENCYPRIMARYEMAILADDRESS, \n\tStatusCode AS AGENCYSTATUSCODE, \n\tStatusDescription AS AGENCYSTATUSDESCRIPTION, \n\tAppointedDate AS AGENCYAPPOINTEDDATE, \n\tTerminatedDate AS AGENCYTERMINATEDDATE, \n\tCustomerCareStatus AS AGENCYCUSTOMERCARESTATUS, \n\tPRIMARYAGENCYINDICATOR, \n\tPHYSICALADDRESSLINE1, \n\tPHYSICALADDRESSLINE2, \n\tPHYSICALADDRESSLINE3, \n\tPHYSICALCITY, \n\tPHYSICALZIPCODE, \n\tPHYSICALCOUNTYCODE, \n\tPHYSICALCOUNTYNAME, \n\tPHYSICALSTATEABBREVIATION, \n\tPHYSICALCOUNTRYABBREVIATION, \n\tPHYSICALLATITUDE, \n\tPHYSICALLONGITUDE, \n\tMailAddressLine1 AS MAILINGADDRESSLINE1, \n\tMailAddressLine2 AS MAILINGADDRESSLINE2, \n\tMailAddressLine3 AS MAILINGADDRESSLINE3, \n\tMailCity AS MAILINGCITY, \n\tMailZipCode AS MAILINGZIPCODE, \n\tMailCountyCode AS MAILINGCOUNTYCODE, \n\tMailCountyName AS MAILINGCOUNTYNAME, \n\tMailStateAbbreviation AS MAILINGSTATEABBREVIATION, \n\tMailCountryAbbreviation AS MAILINGCOUNTRYABBREVIATION, \n\tMailLatitude AS MAILINGLATITUDE, \n\tMailLongitude AS MAILINGLONGITUDE, \n\tLEGALPRIMARYAGENCYCODE, \n\tLICENSEDINDICATOR, \n\tABBREVIATEDNAME, \n\tASSIGNEDSTATECODE, \n\tSalesDivisionDimID3 AS SALESDIVISIONDIMID, \n\tClosedDate AS AGENCYCLOSEDDATE\n\tFROM UPD_Inserts\n),\nUPD_Updates AS (\n\tSELECT\n\tAgencyDimId_Existing AS AgencyDimId, \n\tAuditID, \n\tModifiedDate, \n\tAgencyPKID, \n\tPhysicalAgencyAddressPKID, \n\tMailAgencyAddressPKID, \n\tDoingBusinessAsName, \n\tPrimaryPhoneNumber, \n\tPrimaryFaxNumber, \n\tPrimaryEmailAddress, \n\tStatusDescription, \n\tCustomerCareStatus, \n\tPhysicalAddressLine1, \n\tPhysicalAddressLine2, \n\tPhysicalAddressLine3, \n\tPhysicalCity, \n\tPhysicalZipCode, \n\tPhysicalCountyCode, \n\tPhysicalCountyName, \n\tPhysicalStateAbbreviation, \n\tPhysicalCountryAbbreviation, \n\tPhysicalLatitude, \n\tPhysicalLongitude, \n\tMailAddressLine1, \n\tMailAddressLine2, \n\tMailAddressLine3, \n\tMailCity, \n\tMailZipCode, \n\tMailCountyCode, \n\tMailCountyName, \n\tMailStateAbbreviation, \n\tMailCountryAbbreviation, \n\tMailLatitude, \n\tMailLongitude, \n\tSalesDivisionDimID AS SalesDivisionDimID4, \n\tClosedDate\n\tFROM RTR_InsertUpdateOrExpire_Update\n),\nTGT_AgencyDim_UpdateExisting AS (\n\tMERGE INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.AgencyDim AS T\n\tUSING UPD_Updates AS S\n\tON T.AgencyDimID = S.AgencyDimId\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.AuditID = S.AuditID, T.ModifiedDate = S.ModifiedDate, T.EDWAgencyPKID = S.AgencyPKID, T.EDWAgencyAddressPhysicalPKID = S.PhysicalAgencyAddressPKID, T.EDWAgencyAddressMailingPKID = S.MailAgencyAddressPKID, T.AgencyDoingBusinessAsName = S.DoingBusinessAsName, T.AgencyPrimaryPhoneNumber = S.PrimaryPhoneNumber, T.AgencyPrimaryFaxNumber = S.PrimaryFaxNumber, T.AgencyPrimaryEmailAddress = S.PrimaryEmailAddress, T.AgencyStatusDescription = S.StatusDescription, T.AgencyCustomerCareStatus = S.CustomerCareStatus, T.PhysicalAddressLine1 = S.PhysicalAddressLine1, T.PhysicalAddressLine2 = S.PhysicalAddressLine2, T.PhysicalAddressLine3 = S.PhysicalAddressLine3, T.PhysicalCity = S.PhysicalCity, T.PhysicalZipCode = S.PhysicalZipCode, T.PhysicalCountyCode = S.PhysicalCountyCode, T.PhysicalCountyName = S.PhysicalCountyName, T.PhysicalStateAbbreviation = S.PhysicalStateAbbreviation, T.PhysicalCountryAbbreviation = S.PhysicalCountryAbbreviation, T.PhysicalLatitude = S.PhysicalLatitude, T.PhysicalLongitude = S.PhysicalLongitude, T.MailingAddressLine1 = S.MailAddressLine1, T.MailingAddressLine2 = S.MailAddressLine2, T.MailingAddressLine3 = S.MailAddressLine3, T.MailingCity = S.MailCity, T.MailingZipCode = S.MailZipCode, T.MailingCountyCode = S.MailCountyCode, T.MailingCountyName = S.MailCountyName, T.MailingStateAbbreviation = S.MailStateAbbreviation, T.MailingCountryAbbreviation = S.MailCountryAbbreviation, T.MailingLatitude = S.MailLatitude, T.MailingLongitude = S.MailLongitude, T.AgencyClosedDate = S.ClosedDate\n),\nUPD_ExpireOld AS (\n\tSELECT\n\tAgencyDimId_Existing AS AgencyDimId, \n\tExpireSnapshotFlag AS ExpireCurrentSnapshotFlag, \n\tExpirationDate_ForExpire AS ExpirationDate, \n\tModifiedDate\n\tFROM RTR_InsertUpdateOrExpire_Expire\n),\nTGT_AgencyDim_ExpireOld AS (\n\tMERGE INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.AgencyDim AS T\n\tUSING UPD_ExpireOld AS S\n\tON T.AgencyDimID = S.AgencyDimId\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.CurrentSnapshotFlag = S.ExpireCurrentSnapshotFlag, T.ExpirationDate = S.ExpirationDate, T.ModifiedDate = S.ModifiedDate\n),\nSQ_Agency_SalesDivisionDim AS (\n\tSELECT\n\t\tAgencyAKID,\n\t\tSalesTerritoryAKID,\n\t\tRegionalSalesManagerAKID\n\tFROM Agency_V2\n\tWHERE CurrentSnapshotFlag=1\n),\nLKP_RegionalSalesManager AS (\n\tSELECT\n\tSalesDirectorAKID,\n\tRegionalSalesManagerAKID\n\tFROM (\n\t\tSELECT \n\t\t\tSalesDirectorAKID,\n\t\t\tRegionalSalesManagerAKID\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.RegionalSalesManager\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY RegionalSalesManagerAKID ORDER BY SalesDirectorAKID) = 1\n),\nLKP_SalesDivisionDim AS (\n\tSELECT\n\tSalesDivisionDimID,\n\tEDWRegionalSalesManagerAKID,\n\tEDWSalesDirectorAKID,\n\tEDWSalesTerritoryAKID\n\tFROM (\n\t\tSELECT \n\t\t\tSalesDivisionDimID,\n\t\t\tEDWRegionalSalesManagerAKID,\n\t\t\tEDWSalesDirectorAKID,\n\t\t\tEDWSalesTerritoryAKID\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.SalesDivisionDim\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY EDWRegionalSalesManagerAKID,EDWSalesDirectorAKID,EDWSalesTerritoryAKID ORDER BY SalesDivisionDimID) = 1\n),\nUPD_AgencyDim_SalesDivisionDimId AS (\n\tSELECT\n\tSQ_Agency_SalesDivisionDim.AgencyAKID AS EDWAgencyAKID, \n\tLKP_SalesDivisionDim.SalesDivisionDimID AS SalesDivisionDimId\n\tFROM SQ_Agency_SalesDivisionDim\n\tLEFT JOIN LKP_SalesDivisionDim\n\tON LKP_SalesDivisionDim.EDWRegionalSalesManagerAKID = SQ_Agency_SalesDivisionDim.RegionalSalesManagerAKID AND LKP_SalesDivisionDim.EDWSalesDirectorAKID = LKP_RegionalSalesManager.SalesDirectorAKID AND LKP_SalesDivisionDim.EDWSalesTerritoryAKID = SQ_Agency_SalesDivisionDim.SalesTerritoryAKID\n),\nAgencyDim_UpdateHistory AS (\n\tUPDATE @{pipeline().parameters.TARGET_TABLE_OWNER}.AgencyDim SET SalesDivisionDimId = S.SalesDivisionDimId \r\n\tWHERE EDWAgencyAKID = S.EDWAgencyAKID\n\tFROM UPD_AgencyDim_SalesDivisionDimId S\n),"
                        }
                    ]
                }
            }
        ],
        "parameters": {
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "246490"
            },
            "WBMI_BATCH_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "905471"
            },
            "WBMI_SESSION_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "7603198"
            },
            "SELECTION_START_TS": {
                "type": "string",
                "defaultValue": "08/29/2023 22:20:50"
            },
            "SELECTION_END_TS": {
                "type": "string",
                "defaultValue": "08/30/2023 22:20:23"
            },
            "DBCONNECTION_SOURCE": {
                "type": "string",
                "defaultValue": "SQLServer_RPT_EDM_Claim"
            },
            "DBCONNECTION_TARGET": {
                "type": "string",
                "defaultValue": "SQLServer_WC_Data_Mart_Claim"
            },
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "DBO"
            },
            "TARGET_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "V3"
            },
            "SOURCESYSTEMID": {
                "type": "string",
                "defaultValue": "AgencyODS"
            },
            "TARGET_TABLE_OWNER_V2": {
                "type": "string",
                "defaultValue": "V2"
            },
            "SOURCE_TABLE_OWNER_V2": {
                "type": "string",
                "defaultValue": "V2"
            }
        },
        "folder": {
            "name": "Agency DataMart/"
        },
        "annotations": []
    }
}