{
    "name": "s_m_AGY_DW_LOAD_Agency",
    "properties": {
        "activities": [
            {
                "name": "m_AGY_DW_LOAD_Agency",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nLKP_RSM_Territory_Name_Rule AS (\n\tSELECT\n\trsm_terr_name_rule_id,\n\trsm_terr_sym\n\tFROM (\n\t\tSELECT rsm_territory_name_rule.rsm_terr_name_rule_id as rsm_terr_name_rule_id,\r\n\t\trsm_territory_name_rule.rsm_terr_sym as rsm_terr_sym FROM rsm_territory_name_rule\r\n\t\twhere crrnt_rule_flag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY rsm_terr_sym ORDER BY rsm_terr_name_rule_id) = 1\n),\nSQ_agency_stage AS (\n\tSELECT\n\t\tAGENCY_STAGE_ID,\n\t\tSTATE_CODE,\n\t\tAGENCY_NUM,\n\t\tAPPOINTED_DATE,\n\t\tAGENCY_STATUS,\n\t\tAGENCY_FULL_NAME,\n\t\tAGENCY_DBA_NAME,\n\t\tAGENCY_ABBREV_NAME,\n\t\tAGENCY_SORT_NAME,\n\t\tTERRITORY_CODE,\n\t\tTELEPHONE,\n\t\tFAX,\n\t\tEMAIL_ADDRESS,\n\t\tEMAIL_RETRIEVAL,\n\t\tWEB_ADDRESS,\n\t\tAUTHORITY_LEVEL,\n\t\tCOMPARATIVE_RATER,\n\t\tLINE_APPOINTED,\n\t\tTAX_ID,\n\t\tTAX_ID_TYPE,\n\t\tTAX_LOCATION,\n\t\tWEBSITE_TYPE,\n\t\tSUBAGENT,\n\t\tEMAIL_HTML_FLAG,\n\t\tSR22_AUTHORITY,\n\t\tKEY_AGENT_FLG,\n\t\tTAX_REPORTABLE_FLG,\n\t\tELECTRONIC_RPT_FLG,\n\t\tADVISORY_BOARD,\n\t\tWBC_STEER_COMM,\n\t\tCONTGNT_GUARANTEED,\n\t\tDIRCONN_PER_DATE,\n\t\tREINSTATEMENT_DATE,\n\t\tCOMMENT_ID,\n\t\tDIRCONN_COMM_DATE,\n\t\tAGENCY_CODE,\n\t\tMGMT_SYSTEM_ID,\n\t\tCHOICEPOINT_ACCT,\n\t\tINTERNET_CONN_ID,\n\t\tEXTRACT_DATE,\n\t\tAS_OF_DATE,\n\t\tRECORD_COUNT,\n\t\tSOURCE_SYSTEM_ID\n\tFROM agency_stage\n),\nEXP_Values AS (\n\tSELECT\n\tAGENCY_STAGE_ID AS AGENCY_stage_ID,\n\tSTATE_CODE,\n\tAGENCY_NUM,\n\tAPPOINTED_DATE,\n\tAGENCY_STATUS,\n\tAGENCY_FULL_NAME,\n\tAGENCY_DBA_NAME,\n\tAGENCY_ABBREV_NAME,\n\tAGENCY_SORT_NAME,\n\tTERRITORY_CODE,\n\tTELEPHONE,\n\tFAX,\n\tEMAIL_ADDRESS,\n\tEMAIL_RETRIEVAL,\n\tWEB_ADDRESS,\n\tAUTHORITY_LEVEL,\n\tCOMPARATIVE_RATER,\n\tLINE_APPOINTED,\n\tTAX_ID,\n\tTAX_ID_TYPE,\n\tTAX_LOCATION,\n\tWEBSITE_TYPE,\n\tSUBAGENT,\n\tEMAIL_HTML_FLAG,\n\tSR22_AUTHORITY,\n\tKEY_AGENT_FLG,\n\tTAX_REPORTABLE_FLG,\n\tELECTRONIC_RPT_FLG,\n\tADVISORY_BOARD,\n\tWBC_STEER_COMM,\n\tCONTGNT_GUARANTEED,\n\tDIRCONN_PER_DATE,\n\tREINSTATEMENT_DATE,\n\tCOMMENT_ID,\n\tDIRCONN_COMM_DATE,\n\tAGENCY_CODE,\n\tMGMT_SYSTEM_ID,\n\tCHOICEPOINT_ACCT,\n\tINTERNET_CONN_ID,\n\tSOURCE_SYSTEM_ID\n\tFROM SQ_agency_stage\n),\nLKP_Territory_Stage AS (\n\tSELECT\n\tRSM_ID,\n\tTERRITORY_CODE,\n\tSTATE_CODE,\n\tTERRITORY_SYMBOL,\n\tTERRITORY_NAME\n\tFROM (\n\t\tSELECT territory_stage.RSM_ID as RSM_ID, territory_stage.TERRITORY_SYMBOL as TERRITORY_SYMBOL, territory_stage.TERRITORY_NAME as TERRITORY_NAME, territory_stage.TERRITORY_CODE as TERRITORY_CODE, territory_stage.STATE_CODE as STATE_CODE \r\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.territory_stage territory_stage\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY TERRITORY_CODE,STATE_CODE ORDER BY RSM_ID) = 1\n),\nLKP_RSM_Stage AS (\n\tSELECT\n\tRSM_FIRST_NAME,\n\tRSM_LAST_NAME,\n\tRSM_ID\n\tFROM (\n\t\tSELECT R.RSM_FIRST_NAME as RSM_FIRST_NAME, R.RSM_LAST_NAME as RSM_LAST_NAME, R.RSM_ID as RSM_ID FROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.RSM_stage R\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY RSM_ID ORDER BY RSM_FIRST_NAME) = 1\n),\nLKP_State_Sup AS (\n\tSELECT\n\tstate_abbrev,\n\tstate_descript,\n\tstate_code\n\tFROM (\n\t\tSELECT dbo.State_Sup.state_abbrev as state_abbrev, dbo.State_Sup.state_descript as state_descript, dbo.State_Sup.state_code as state_code FROM dbo.State_Sup\r\n\t\twhere crrnt_flag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY state_code ORDER BY state_abbrev) = 1\n),\nEXP_Lkp_Values AS (\n\tSELECT\n\tEXP_Values.STATE_CODE,\n\tLKP_Territory_Stage.TERRITORY_SYMBOL AS in_rsm_terr_sym,\n\t-- *INF*: iif(isnull(in_rsm_terr_sym),'N/A',\r\n\t-- iif(is_spaces(in_rsm_terr_sym),'N/A',in_rsm_terr_sym))\n\tIFF(\n\t    in_rsm_terr_sym IS NULL, 'N/A',\n\t    IFF(\n\t        LENGTH(in_rsm_terr_sym)>0 AND TRIM(in_rsm_terr_sym)='', 'N/A', in_rsm_terr_sym\n\t    )\n\t) AS out_rsm_TERR_SYM,\n\tLKP_Territory_Stage.TERRITORY_NAME AS in_rsm_TERR_NAME,\n\t-- *INF*: iif(isnull(in_rsm_TERR_NAME),'Not Found',iif(is_spaces(in_rsm_TERR_NAME),'Not Found',ltrim(rtrim(in_rsm_TERR_NAME))))\n\tIFF(\n\t    in_rsm_TERR_NAME IS NULL, 'Not Found',\n\t    IFF(\n\t        LENGTH(in_rsm_TERR_NAME)>0\n\t    and TRIM(in_rsm_TERR_NAME)='', 'Not Found',\n\t        ltrim(rtrim(in_rsm_TERR_NAME))\n\t    )\n\t) AS out_rsm_TERR_NAME,\n\tLKP_Territory_Stage.TERRITORY_CODE AS in_rsm_TERR_CODE,\n\t-- *INF*: iif(isnull(TO_CHAR(in_rsm_TERR_CODE)),'N/A',TO_CHAR(in_rsm_TERR_CODE))\n\tIFF(TO_CHAR(in_rsm_TERR_CODE) IS NULL, 'N/A', TO_CHAR(in_rsm_TERR_CODE)) AS out_rsm_TERR_CODE,\n\t-- *INF*: iif(isnull(STATE_CODE),'N/A',iif(is_spaces(STATE_CODE),'N/A',STATE_CODE))\n\tIFF(\n\t    STATE_CODE IS NULL, 'N/A',\n\t    IFF(\n\t        LENGTH(STATE_CODE)>0 AND TRIM(STATE_CODE)='', 'N/A', STATE_CODE\n\t    )\n\t) AS v_STATE_CODE,\n\tv_STATE_CODE AS agency_state_code,\n\tLKP_State_Sup.state_abbrev AS in_agency_state_abbrev,\n\t-- *INF*: iif(isnull(in_agency_state_abbrev),'N/A',iif(IS_SPACES(in_agency_state_abbrev),'N/A',in_agency_state_abbrev))\r\n\t-- \r\n\t-- \n\tIFF(\n\t    in_agency_state_abbrev IS NULL, 'N/A',\n\t    IFF(\n\t        LENGTH(in_agency_state_abbrev)>0\n\t    and TRIM(in_agency_state_abbrev)='', 'N/A',\n\t        in_agency_state_abbrev\n\t    )\n\t) AS agency_state_abbrev,\n\tLKP_State_Sup.state_descript AS in_agency_state_descript,\n\t-- *INF*: iif(isnull(in_agency_state_descript),'Not Available',\r\n\t-- iif(is_spaces(in_agency_state_descript),'Not Available',in_agency_state_descript))\n\tIFF(\n\t    in_agency_state_descript IS NULL, 'Not Available',\n\t    IFF(\n\t        LENGTH(in_agency_state_descript)>0\n\t    and TRIM(in_agency_state_descript)='',\n\t        'Not Available',\n\t        in_agency_state_descript\n\t    )\n\t) AS out_agency_state_descript,\n\tEXP_Values.AGENCY_NUM AS in_AGENCY_NUM,\n\t-- *INF*: iif(isnull(in_AGENCY_NUM),'N/A',\r\n\t-- iif(is_spaces(in_AGENCY_NUM),'N/A',in_AGENCY_NUM))\n\tIFF(\n\t    in_AGENCY_NUM IS NULL, 'N/A',\n\t    IFF(\n\t        LENGTH(in_AGENCY_NUM)>0 AND TRIM(in_AGENCY_NUM)='', 'N/A', in_AGENCY_NUM\n\t    )\n\t) AS out_AGENCY_NUM,\n\tEXP_Values.AGENCY_ABBREV_NAME AS in_AGENCY_NAME,\n\t-- *INF*: iif(isnull(in_AGENCY_NAME),'Not Available',\r\n\t-- iif(is_spaces(in_AGENCY_NAME),'Not Available',ltrim(rtrim(in_AGENCY_NAME))))\n\tIFF(\n\t    in_AGENCY_NAME IS NULL, 'Not Available',\n\t    IFF(\n\t        LENGTH(in_AGENCY_NAME)>0\n\t    and TRIM(in_AGENCY_NAME)='', 'Not Available',\n\t        ltrim(rtrim(in_AGENCY_NAME))\n\t    )\n\t) AS out_AGENCY_NAME,\n\t-- *INF*: :LKP.LKP_RSM_TERRITORY_NAME_RULE(in_rsm_terr_sym)\n\tLKP_RSM_TERRITORY_NAME_RULE_in_rsm_terr_sym.rsm_terr_name_rule_id AS v_Audit_Terr_Name_Rule_id,\n\t-- *INF*: iif(isnull(v_Audit_Terr_Name_Rule_id),0,v_Audit_Terr_Name_Rule_id)\n\tIFF(v_Audit_Terr_Name_Rule_id IS NULL, 0, v_Audit_Terr_Name_Rule_id) AS out_v_Audit_Terr_Name_Rule_id,\n\tEXP_Values.DIRCONN_PER_DATE AS in_DIRCONN_PER_DATE,\n\t-- *INF*: iif(isnull(in_DIRCONN_PER_DATE),TO_DATE('1/1/1800','MM/DD/YYYY'),in_DIRCONN_PER_DATE)\n\tIFF(\n\t    in_DIRCONN_PER_DATE IS NULL, TO_TIMESTAMP('1/1/1800', 'MM/DD/YYYY'), in_DIRCONN_PER_DATE\n\t) AS out_DIRCONN_PER_DATE,\n\tEXP_Values.DIRCONN_COMM_DATE AS in_DIRCONN_COMM_DATE,\n\t-- *INF*: iif(isnull(in_DIRCONN_COMM_DATE),TO_DATE('1/1/1800','MM/DD/YYYY'),in_DIRCONN_COMM_DATE)\n\tIFF(\n\t    in_DIRCONN_COMM_DATE IS NULL, TO_TIMESTAMP('1/1/1800', 'MM/DD/YYYY'), in_DIRCONN_COMM_DATE\n\t) AS out_DIRCONN_COMM_DATE,\n\tLKP_RSM_Stage.RSM_LAST_NAME,\n\t-- *INF*: iif(isnull(RSM_LAST_NAME),'Not Available',iif(is_spaces(RSM_LAST_NAME),'Not Available',(ltrim(rtrim(RSM_LAST_NAME)))))\n\tIFF(\n\t    RSM_LAST_NAME IS NULL, 'Not Available',\n\t    IFF(\n\t        LENGTH(RSM_LAST_NAME)>0\n\t    and TRIM(RSM_LAST_NAME)='', 'Not Available',\n\t        (ltrim(rtrim(RSM_LAST_NAME)))\n\t    )\n\t) AS v_RSM_Last_Name,\n\tv_RSM_Last_Name AS out_rsm_last_name,\n\tLKP_RSM_Stage.RSM_FIRST_NAME,\n\t-- *INF*: iif(isnull(RSM_FIRST_NAME),'N/A',iif(is_spaces(RSM_FIRST_NAME),'N/A',(ltrim(rtrim(RSM_FIRST_NAME)))))\n\tIFF(\n\t    RSM_FIRST_NAME IS NULL, 'N/A',\n\t    IFF(\n\t        LENGTH(RSM_FIRST_NAME)>0\n\t    and TRIM(RSM_FIRST_NAME)='', 'N/A',\n\t        (ltrim(rtrim(RSM_FIRST_NAME)))\n\t    )\n\t) AS v_RSM_FIRST_NAME,\n\t-- *INF*: iif(isnull\r\n\t-- (ltrim(rtrim(RSM_FIRST_NAME))\r\n\t-- ||' ' || (ltrim(rtrim(RSM_LAST_NAME)))),'Not Available',(ltrim(rtrim(RSM_FIRST_NAME)))||' ' || (ltrim(rtrim(RSM_LAST_NAME))))\r\n\t-- \n\tIFF(\n\t    ltrim(rtrim(RSM_FIRST_NAME)) || ' ' || (ltrim(rtrim(RSM_LAST_NAME))) IS NULL,\n\t    'Not Available',\n\t    (ltrim(rtrim(RSM_FIRST_NAME))) || ' ' || (ltrim(rtrim(RSM_LAST_NAME)))\n\t) AS out_rsm_full_name,\n\tSTATE_CODE || in_AGENCY_NUM AS v_Agency_key,\n\t-- *INF*: iif(isnull(v_Agency_key), 'N/A',v_Agency_key)\n\tIFF(v_Agency_key IS NULL, 'N/A', v_Agency_key) AS out_Agency_Key,\n\t1 AS crrnt_snpsht_flag,\n\tEXP_Values.SOURCE_SYSTEM_ID\n\tFROM EXP_Values\n\tLEFT JOIN LKP_RSM_Stage\n\tON LKP_RSM_Stage.RSM_ID = LKP_Territory_Stage.RSM_ID\n\tLEFT JOIN LKP_State_Sup\n\tON LKP_State_Sup.state_code = EXP_Values.STATE_CODE\n\tLEFT JOIN LKP_Territory_Stage\n\tON LKP_Territory_Stage.TERRITORY_CODE = EXP_Values.TERRITORY_CODE AND LKP_Territory_Stage.STATE_CODE = EXP_Values.STATE_CODE\n\tLEFT JOIN LKP_RSM_TERRITORY_NAME_RULE LKP_RSM_TERRITORY_NAME_RULE_in_rsm_terr_sym\n\tON LKP_RSM_TERRITORY_NAME_RULE_in_rsm_terr_sym.rsm_terr_sym = in_rsm_terr_sym\n\n),\nLKP_Related_Agency_Stage_Prim_Agency_key AS (\n\tSELECT\n\tREL_RSN_CODE,\n\tPRIM_STATE_CODE,\n\tPRIM_AGENCY_NUM,\n\tPRIM_AGENCY_ABBREV_NAME,\n\tREL_STATE_CODE,\n\tREL_AGENCY_NUM\n\tFROM (\n\t\tSELECT \r\n\t\t\r\n\t\trelated_agency_Stage.REL_STATE_CODE as REL_STATE_CODE, \r\n\t\trelated_agency_Stage.REL_AGENCY_NUM as REL_AGENCY_NUM,\r\n\t\trelated_agency_Stage.REL_RSN_CODE as REL_RSN_CODE,\r\n\t\trelated_agency_Stage.STATE_CODE as PRIM_STATE_CODE,\r\n\t\trelated_agency_Stage.AGENCY_NUM as PRIM_AGENCY_NUM,\r\n\t\tagency_stage.AGENCY_ABBREV_NAME as PRIM_AGENCY_ABBREV_NAME\r\n\t\t\r\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.related_agency_Stage  related_agency_Stage,\r\n\t\t              @{pipeline().parameters.SOURCE_TABLE_OWNER}.agency_stage agency_stage\r\n\t\t\r\n\t\tWhere\r\n\t\tagency_stage.state_code = related_agency_Stage.STATE_CODE\r\n\t\tAND agency_stage.AGENCY_NUM = related_agency_Stage.AGENCY_NUM\r\n\t\tAND related_agency_Stage.REL_EFF_DATE <= getdate()\r\n\t\tAND related_agency_Stage.REL_RSN_CODE <> 'D'\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY REL_STATE_CODE,REL_AGENCY_NUM ORDER BY REL_RSN_CODE) = 1\n),\nLKP_State_Sup1 AS (\n\tSELECT\n\tstate_abbrev,\n\tstate_descript,\n\tstate_code\n\tFROM (\n\t\tSELECT \n\t\t\tstate_abbrev,\n\t\t\tstate_descript,\n\t\t\tstate_code\n\t\tFROM dbo.State_Sup\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY state_code ORDER BY state_abbrev) = 1\n),\nLKP_agency AS (\n\tSELECT\n\tagency_id,\n\tagency_ak_id,\n\trsm_terr_sym,\n\trsm_terr_code,\n\trsm_terr_name,\n\trsm_full_name,\n\trsm_last_name,\n\tprim_agency_state_code,\n\tprim_agency_state_abbrev,\n\tprim_agency_state_descript,\n\tprim_agency_num,\n\tprim_agency_key,\n\tprim_agency_name,\n\tagency_state_code,\n\tagency_state_abbrev,\n\tagency_state_descript,\n\tagency_num,\n\tagency_key,\n\tagency_name,\n\trsm_terr_name_rule_id,\n\tdirconn_per_date,\n\tdirconn_comm_date,\n\tagency_pay_code,\n\tagency_pay_code_eff_to_date,\n\tagency_pay_code_eff_from_date,\n\tout_Agency_Key\n\tFROM (\n\t\tSELECT \r\n\t\ta.agency_id as agency_id, \r\n\t\ta.agency_ak_id as agency_ak_id,\r\n\t\ta.rsm_terr_sym as rsm_terr_sym, \r\n\t\ta.rsm_terr_code as rsm_terr_code, \r\n\t\ta.rsm_terr_name as rsm_terr_name, \r\n\t\ta.rsm_full_name as rsm_full_name, \r\n\t\ta.rsm_last_name as rsm_last_name, \r\n\t\ta.prim_agency_state_code as prim_agency_state_code, \r\n\t\ta.prim_agency_state_abbrev as prim_agency_state_abbrev, \r\n\t\ta.prim_agency_state_descript as prim_agency_state_descript, \r\n\t\ta.prim_agency_num as prim_agency_num, \r\n\t\ta.prim_agency_key as prim_agency_key,\r\n\t\ta.prim_agency_name as prim_agency_name, \r\n\t\ta.agency_state_abbrev as agency_state_abbrev, \r\n\t\ta.agency_state_descript as agency_state_descript, \r\n\t\ta.agency_key as agency_key, \r\n\t\ta.agency_name as agency_name, \r\n\t\ta.rsm_terr_name_rule_id as rsm_terr_name_rule_id, \r\n\t\ta.dirconn_per_date as dirconn_per_date, \r\n\t\ta.dirconn_comm_date as dirconn_comm_date, \r\n\t\ta.agency_state_code as agency_state_code, \r\n\t\ta.agency_num as agency_num,\r\n\t\ta.agency_pay_code as agency_pay_code, \r\n\t\ta.agency_pay_code_eff_to_date as agency_pay_code_eff_to_date, \r\n\t\ta.agency_pay_code_eff_from_date as agency_pay_code_eff_from_date \r\n\t\tFROM \r\n\t\t\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.agency a\r\n\t\tWHERE  a.agency_id IN (SELECT MAX(b.agency_id)\r\n\t\t\tfrom \r\n\t\t\t\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.agency b\r\n\t\t\tWHERE crrnt_snpsht_flag=1\r\n\t\t\tGROUP BY b.agency_state_code,\r\n\t\t\tb.agency_num)\r\n\t\tORDER BY a.agency_state_code,\r\n\t\t\ta.agency_num\r\n\t\t--IN Subquery exists so that we only pick the MAX value of the PK for each AK Group\r\n\t\t--WHERE clause is always eff_to_date = '12/31/2100'\r\n\t\t--GROUP BY clause is always the AK\r\n\t\t--ORDER BY clause is always the AK.  When any comments exist in the SQL override Informatica will no longer generate an ORDER BY statemen\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY agency_key ORDER BY agency_id) = 1\n),\nLKP_pay_code_stage AS (\n\tSELECT\n\tpay_code_stage_id,\n\tstate_code,\n\tagency_num,\n\tpay_code,\n\tpay_code_exp_date,\n\tpay_code_eff_date,\n\tagency_code,\n\tagency_num_IN,\n\tagency_key_IN\n\tFROM (\n\t\tSELECT \r\n\t\tPC.pay_code_stage_id as pay_code_stage_id, \r\n\t\tPC.pay_code as pay_code, \r\n\t\tPC.pay_code_exp_date as pay_code_exp_date, \r\n\t\tPC.pay_code_eff_date as pay_code_eff_date, \r\n\t\tPC.state_code as state_code, \r\n\t\tPC.agency_num as agency_num, \r\n\t\tPC.agency_code as agency_code \r\n\t\t\r\n\t\tFROM \r\n\t\tpay_code_stage PC\r\n\t\torder by pay_code_exp_date desc --\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY state_code,agency_num,agency_code ORDER BY pay_code_stage_id) = 1\n),\nSEQ_Agency AS (\n\tCREATE SEQUENCE SEQ_Agency\n\tSTART = 0\n\tINCREMENT = 1;\n),\nEXP_Detect_Changes AS (\n\tSELECT\n\tEXP_Lkp_Values.out_rsm_TERR_SYM AS rsm_TERR_SYM,\n\tEXP_Lkp_Values.out_rsm_TERR_CODE AS in_rsm_TERR_CODE,\n\tEXP_Lkp_Values.out_rsm_TERR_NAME AS rsm_TERR_NAME,\n\tEXP_Lkp_Values.out_rsm_full_name,\n\tEXP_Lkp_Values.out_rsm_last_name,\n\tLKP_Related_Agency_Stage_Prim_Agency_key.PRIM_STATE_CODE AS in_prim_agency_state_code,\n\t-- *INF*: IIF(ISNULL(in_prim_agency_state_code),agency_state_code,in_prim_agency_state_code)\n\tIFF(in_prim_agency_state_code IS NULL, agency_state_code, in_prim_agency_state_code) AS v_prim_agency_state_code,\n\tv_prim_agency_state_code || '  ' AS prim_agency_state_code,\n\tLKP_State_Sup1.state_abbrev AS in_prim_agency_state_abbrev,\n\t-- *INF*: IIF(ISNULL(in_prim_agency_state_abbrev),agency_state_abbrev,in_prim_agency_state_abbrev)\n\tIFF(in_prim_agency_state_abbrev IS NULL, agency_state_abbrev, in_prim_agency_state_abbrev) AS v_prim_agency_state_abbrev,\n\tv_prim_agency_state_abbrev AS prim_agency_state_abbrev,\n\tLKP_State_Sup1.state_descript AS in_prim_agency_state_descript,\n\t-- *INF*: IIF(ISNULL(in_prim_agency_state_descript),agency_state_descript,in_prim_agency_state_descript)\n\tIFF(\n\t    in_prim_agency_state_descript IS NULL, agency_state_descript, in_prim_agency_state_descript\n\t) AS v_prim_agency_state_descript,\n\tv_prim_agency_state_descript AS prim_agency_state_descript,\n\tLKP_Related_Agency_Stage_Prim_Agency_key.PRIM_AGENCY_NUM AS in_prim_AGENCY_NUM,\n\t-- *INF*: IIF(ISNULL(in_prim_AGENCY_NUM),AGENCY_NUM,in_prim_AGENCY_NUM)\n\tIFF(in_prim_AGENCY_NUM IS NULL, AGENCY_NUM, in_prim_AGENCY_NUM) AS v_prim_AGENCY_NUM,\n\tv_prim_AGENCY_NUM AS prim_AGENCY_NUM,\n\tv_prim_agency_state_code || v_prim_AGENCY_NUM AS V_out_prim_agency_key,\n\tV_out_prim_agency_key AS OUT_PRIM_AGENCY_KEY,\n\tLKP_Related_Agency_Stage_Prim_Agency_key.PRIM_AGENCY_ABBREV_NAME AS in_prim_AGENCY_NAME,\n\t-- *INF*: RTRIM(IIF(ISNULL(in_prim_AGENCY_NAME),AGENCY_NAME,in_prim_AGENCY_NAME))\n\tRTRIM(\n\t    IFF(\n\t        in_prim_AGENCY_NAME IS NULL, AGENCY_NAME, in_prim_AGENCY_NAME\n\t    )) AS v_prim_AGENCY_NAME,\n\tv_prim_AGENCY_NAME AS prim_AGENCY_NAME,\n\tEXP_Lkp_Values.agency_state_code,\n\tEXP_Lkp_Values.agency_state_abbrev,\n\tEXP_Lkp_Values.out_agency_state_descript AS agency_state_descript,\n\tEXP_Lkp_Values.out_AGENCY_NUM AS AGENCY_NUM,\n\tEXP_Lkp_Values.out_Agency_Key,\n\tEXP_Lkp_Values.out_AGENCY_NAME AS AGENCY_NAME,\n\tEXP_Lkp_Values.out_v_Audit_Terr_Name_Rule_id AS out_Audit_Terr_Name_Rule_id,\n\tEXP_Lkp_Values.out_DIRCONN_PER_DATE AS DIRCONN_PER_DATE,\n\tEXP_Lkp_Values.out_DIRCONN_COMM_DATE AS DIRCONN_COMM_DATE,\n\tLKP_pay_code_stage.pay_code AS in_pay_code,\n\t-- *INF*: IIF(isnull(in_pay_code),'N/A',in_pay_code)\n\tIFF(in_pay_code IS NULL, 'N/A', in_pay_code) AS v_pay_code,\n\tv_pay_code AS pay_code,\n\tLKP_pay_code_stage.pay_code_exp_date AS in_pay_code_exp_date,\n\t-- *INF*: iif(isnull(in_pay_code_exp_date),TO_DATE('1/1/1800','MM/DD/YYYY'),in_pay_code_exp_date)\n\tIFF(\n\t    in_pay_code_exp_date IS NULL, TO_TIMESTAMP('1/1/1800', 'MM/DD/YYYY'), in_pay_code_exp_date\n\t) AS v_pay_code_exp_date,\n\tv_pay_code_exp_date AS pay_code_exp_date,\n\tLKP_pay_code_stage.pay_code_eff_date AS in_pay_code_eff_date,\n\t-- *INF*: iif(isnull(in_pay_code_eff_date),TO_DATE('1/1/1800','MM/DD/YYYY'),in_pay_code_eff_date)\n\tIFF(\n\t    in_pay_code_eff_date IS NULL, TO_TIMESTAMP('1/1/1800', 'MM/DD/YYYY'), in_pay_code_eff_date\n\t) AS v_pay_code_eff_date,\n\tv_pay_code_eff_date AS pay_code_eff_date,\n\tLKP_agency.agency_ak_id,\n\tEXP_Lkp_Values.crrnt_snpsht_flag,\n\tLKP_agency.rsm_terr_sym AS rsm_terr_sym_old,\n\tLKP_agency.rsm_terr_code AS rsm_terr_code_old,\n\tLKP_agency.rsm_terr_name AS rsm_terr_name_old,\n\tLKP_agency.rsm_full_name AS rsm_full_name_old,\n\tLKP_agency.rsm_last_name AS rsm_last_name_old,\n\tLKP_agency.prim_agency_state_code AS prim_agency_state_code_old,\n\tLKP_agency.prim_agency_state_abbrev AS prim_agency_state_abbrev_old,\n\tLKP_agency.prim_agency_state_descript AS prim_agency_state_descript_old,\n\tLKP_agency.prim_agency_num AS prim_agency_num_old,\n\tLKP_agency.prim_agency_key AS prim_agency_key_old,\n\tLKP_agency.prim_agency_name AS prim_agency_name_old,\n\tLKP_agency.agency_state_code AS agency_state_code_old,\n\tLKP_agency.agency_state_abbrev AS agency_state_abbrev_old,\n\tLKP_agency.agency_state_descript AS agency_state_descript_old,\n\tLKP_agency.agency_num AS agency_num_old,\n\tLKP_agency.agency_key AS agency_key_old,\n\tLKP_agency.agency_name AS agency_name_old,\n\tLKP_agency.rsm_terr_name_rule_id AS rsm_terr_name_rule_id_old,\n\tLKP_agency.dirconn_per_date AS dirconn_per_date_old,\n\tLKP_agency.dirconn_comm_date AS dirconn_comm_date_old,\n\tLKP_agency.agency_pay_code,\n\tLKP_agency.agency_pay_code_eff_to_date,\n\tLKP_agency.agency_pay_code_eff_from_date,\n\t-- *INF*:  iif(isnull(agency_id_old),'NEW',\r\n\t-- iif((rsm_TERR_SYM <> rsm_terr_sym_old ) or\r\n\t-- (in_rsm_TERR_CODE  <> RTrim (rsm_terr_code_old, '  ') ) or\r\n\t-- (rsm_TERR_NAME <> rsm_terr_name_old) or\r\n\t-- (out_rsm_full_name<> rsm_full_name_old) or\r\n\t-- (out_rsm_last_name <> rsm_last_name_old ) or\r\n\t-- (LPAD(v_prim_agency_state_code,2) <> LPAD (prim_agency_state_code_old,2))  or\r\n\t-- (v_prim_agency_state_abbrev<> prim_agency_state_abbrev_old ) or\r\n\t-- (v_prim_agency_state_descript<>prim_agency_state_descript_old ) or\r\n\t-- (v_prim_AGENCY_NUM<> prim_agency_num_old ) or\r\n\t-- (V_out_prim_agency_key<> prim_agency_key_old ) or\r\n\t-- (v_prim_AGENCY_NAME<> prim_agency_name_old ) or\r\n\t-- (LPAD(agency_state_code,2) <> LPAD(agency_state_code_old,2)) or\r\n\t-- (agency_state_abbrev<> agency_state_abbrev_old ) or\r\n\t-- (agency_state_descript<>agency_state_descript_old ) or\r\n\t-- (AGENCY_NUM<>agency_num_old ) or\r\n\t-- (out_Agency_Key<>agency_key_old ) or\r\n\t-- (AGENCY_NAME<> agency_name_old ) or\r\n\t-- (out_Audit_Terr_Name_Rule_id<> rsm_terr_name_rule_id_old ) or\r\n\t-- (DIRCONN_PER_DATE<> dirconn_per_date_old) or\r\n\t-- (DIRCONN_COMM_DATE<> dirconn_comm_date_old ) or\r\n\t-- (v_pay_code <> agency_pay_code) or\r\n\t-- (v_pay_code_exp_date <> agency_pay_code_eff_to_date) or\r\n\t-- (v_pay_code_eff_date <> agency_pay_code_eff_from_date)\r\n\t-- ,\r\n\t-- 'UPDATE',\r\n\t-- 'NOCHANGE'))\n\tIFF(\n\t    agency_id_old IS NULL, 'NEW',\n\t    IFF(\n\t        (rsm_TERR_SYM <> rsm_terr_sym_old)\n\t        or (in_rsm_TERR_CODE <> RTrim(rsm_terr_code_old, '  '))\n\t        or (rsm_TERR_NAME <> rsm_terr_name_old)\n\t        or (out_rsm_full_name <> rsm_full_name_old)\n\t        or (out_rsm_last_name <> rsm_last_name_old)\n\t        or (LPAD(v_prim_agency_state_code, 2) <> LPAD(prim_agency_state_code_old, 2))\n\t        or (v_prim_agency_state_abbrev <> prim_agency_state_abbrev_old)\n\t        or (v_prim_agency_state_descript <> prim_agency_state_descript_old)\n\t        or (v_prim_AGENCY_NUM <> prim_agency_num_old)\n\t        or (V_out_prim_agency_key <> prim_agency_key_old)\n\t        or (v_prim_AGENCY_NAME <> prim_agency_name_old)\n\t        or (LPAD(agency_state_code, 2) <> LPAD(agency_state_code_old, 2))\n\t        or (agency_state_abbrev <> agency_state_abbrev_old)\n\t        or (agency_state_descript <> agency_state_descript_old)\n\t        or (AGENCY_NUM <> agency_num_old)\n\t        or (out_Agency_Key <> agency_key_old)\n\t        or (AGENCY_NAME <> agency_name_old)\n\t        or (out_Audit_Terr_Name_Rule_id <> rsm_terr_name_rule_id_old)\n\t        or (DIRCONN_PER_DATE <> dirconn_per_date_old)\n\t        or (DIRCONN_COMM_DATE <> dirconn_comm_date_old)\n\t        or (v_pay_code <> agency_pay_code)\n\t        or (v_pay_code_exp_date <> agency_pay_code_eff_to_date)\n\t        or (v_pay_code_eff_date <> agency_pay_code_eff_from_date),\n\t        'UPDATE',\n\t        'NOCHANGE'\n\t    )\n\t) AS v_changed_flag,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS audit_id,\n\t-- *INF*: iif(v_changed_flag='NEW',\r\n\t-- \tto_date('01/01/1800 01:00:00','MM/DD/YYYY HH24:MI:SS'),sysdate)\n\tIFF(\n\t    v_changed_flag = 'NEW', TO_TIMESTAMP('01/01/1800 01:00:00', 'MM/DD/YYYY HH24:MI:SS'),\n\t    CURRENT_TIMESTAMP\n\t) AS eff_from_date,\n\t-- *INF*: to_date('12/31/2100 23:59:59','MM/DD/YYYY HH24:MI:SS')\n\tTO_TIMESTAMP('12/31/2100 23:59:59', 'MM/DD/YYYY HH24:MI:SS') AS eff_to_date,\n\tv_changed_flag AS changed_flag,\n\tLKP_agency.agency_id AS agency_id_old,\n\tEXP_Lkp_Values.SOURCE_SYSTEM_ID,\n\tsysdate AS created_date,\n\tsysdate AS modified_date,\n\tSEQ_Agency.NEXTVAL,\n\t-- *INF*: IIF(v_changed_flag='NEW',\r\n\t-- NEXTVAL,\r\n\t-- agency_ak_id)\n\tIFF(v_changed_flag = 'NEW', NEXTVAL, agency_ak_id) AS out_agency_ak_id\n\tFROM EXP_Lkp_Values\n\tLEFT JOIN LKP_Related_Agency_Stage_Prim_Agency_key\n\tON LKP_Related_Agency_Stage_Prim_Agency_key.REL_STATE_CODE = EXP_Lkp_Values.agency_state_code AND LKP_Related_Agency_Stage_Prim_Agency_key.REL_AGENCY_NUM = EXP_Lkp_Values.out_AGENCY_NUM\n\tLEFT JOIN LKP_State_Sup1\n\tON LKP_State_Sup1.state_code = LKP_Related_Agency_Stage_Prim_Agency_key.PRIM_STATE_CODE\n\tLEFT JOIN LKP_agency\n\tON LKP_agency.agency_key = EXP_Lkp_Values.out_Agency_Key\n\tLEFT JOIN LKP_pay_code_stage\n\tON LKP_pay_code_stage.state_code = EXP_Lkp_Values.agency_state_code AND LKP_pay_code_stage.agency_num = EXP_Lkp_Values.out_AGENCY_NUM AND LKP_pay_code_stage.agency_code = EXP_Lkp_Values.out_Agency_Key\n),\nFLT_Insert AS (\n\tSELECT\n\tEXP_Detect_Changes.out_agency_ak_id, \n\tEXP_Detect_Changes.rsm_TERR_SYM, \n\tEXP_Detect_Changes.in_rsm_TERR_CODE AS rsm_TERR_CODE, \n\tEXP_Detect_Changes.rsm_TERR_NAME, \n\tEXP_Detect_Changes.out_rsm_full_name, \n\tEXP_Detect_Changes.out_rsm_last_name, \n\tEXP_Detect_Changes.prim_agency_state_code, \n\tEXP_Detect_Changes.prim_agency_state_abbrev, \n\tEXP_Detect_Changes.prim_agency_state_descript, \n\tEXP_Detect_Changes.prim_AGENCY_NUM, \n\tEXP_Detect_Changes.OUT_PRIM_AGENCY_KEY AS out_prim_agency_key, \n\tEXP_Detect_Changes.prim_AGENCY_NAME, \n\tEXP_Detect_Changes.agency_state_code, \n\tEXP_Detect_Changes.agency_state_abbrev, \n\tEXP_Detect_Changes.agency_state_descript, \n\tEXP_Detect_Changes.AGENCY_NUM, \n\tEXP_Detect_Changes.out_Agency_Key, \n\tEXP_Detect_Changes.AGENCY_NAME, \n\tEXP_Detect_Changes.out_Audit_Terr_Name_Rule_id, \n\tEXP_Detect_Changes.DIRCONN_PER_DATE, \n\tEXP_Detect_Changes.DIRCONN_COMM_DATE, \n\tEXP_Detect_Changes.crrnt_snpsht_flag, \n\tEXP_Detect_Changes.audit_id, \n\tEXP_Detect_Changes.eff_from_date, \n\tEXP_Detect_Changes.eff_to_date, \n\tEXP_Detect_Changes.changed_flag, \n\tEXP_Detect_Changes.SOURCE_SYSTEM_ID, \n\tEXP_Detect_Changes.created_date, \n\tEXP_Detect_Changes.modified_date, \n\tLKP_Related_Agency_Stage_Prim_Agency_key.REL_RSN_CODE, \n\tLKP_Territory_Stage.STATE_CODE AS Terr_STATE_CODE, \n\tEXP_Detect_Changes.pay_code, \n\tEXP_Detect_Changes.pay_code_exp_date, \n\tEXP_Detect_Changes.pay_code_eff_date\n\tFROM EXP_Detect_Changes\n\tLEFT JOIN LKP_Related_Agency_Stage_Prim_Agency_key\n\tON LKP_Related_Agency_Stage_Prim_Agency_key.REL_STATE_CODE = EXP_Lkp_Values.agency_state_code AND LKP_Related_Agency_Stage_Prim_Agency_key.REL_AGENCY_NUM = EXP_Lkp_Values.out_AGENCY_NUM\n\tLEFT JOIN LKP_Territory_Stage\n\tON LKP_Territory_Stage.TERRITORY_CODE = EXP_Values.TERRITORY_CODE AND LKP_Territory_Stage.STATE_CODE = EXP_Values.STATE_CODE\n\tWHERE (changed_flag='NEW' or changed_flag='UPDATE')\r\n\r\nAND REL_RSN_CODE <> 'D'\r\n\r\nAND Terr_STATE_CODE = agency_state_code\n),\nagency_Insert AS (\n\tINSERT INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.agency\n\t(agency_ak_id, rsm_terr_sym, rsm_terr_code, rsm_terr_name, rsm_full_name, rsm_last_name, prim_agency_state_code, prim_agency_state_abbrev, prim_agency_state_descript, prim_agency_num, prim_agency_key, prim_agency_name, agency_state_code, agency_state_abbrev, agency_state_descript, agency_num, agency_key, agency_name, rsm_terr_name_rule_id, dirconn_per_date, dirconn_comm_date, crrnt_snpsht_flag, audit_id, eff_from_date, eff_to_date, source_system_id, created_date, modified_date, agency_pay_code, agency_pay_code_eff_from_date, agency_pay_code_eff_to_date)\n\tSELECT \n\tout_agency_ak_id AS AGENCY_AK_ID, \n\trsm_TERR_SYM AS RSM_TERR_SYM, \n\trsm_TERR_CODE AS RSM_TERR_CODE, \n\trsm_TERR_NAME AS RSM_TERR_NAME, \n\tout_rsm_full_name AS RSM_FULL_NAME, \n\tout_rsm_last_name AS RSM_LAST_NAME, \n\tPRIM_AGENCY_STATE_CODE, \n\tPRIM_AGENCY_STATE_ABBREV, \n\tPRIM_AGENCY_STATE_DESCRIPT, \n\tprim_AGENCY_NUM AS PRIM_AGENCY_NUM, \n\tout_prim_agency_key AS PRIM_AGENCY_KEY, \n\tprim_AGENCY_NAME AS PRIM_AGENCY_NAME, \n\tAGENCY_STATE_CODE, \n\tAGENCY_STATE_ABBREV, \n\tAGENCY_STATE_DESCRIPT, \n\tAGENCY_NUM AS AGENCY_NUM, \n\tout_Agency_Key AS AGENCY_KEY, \n\tAGENCY_NAME AS AGENCY_NAME, \n\tout_Audit_Terr_Name_Rule_id AS RSM_TERR_NAME_RULE_ID, \n\tDIRCONN_PER_DATE AS DIRCONN_PER_DATE, \n\tDIRCONN_COMM_DATE AS DIRCONN_COMM_DATE, \n\tCRRNT_SNPSHT_FLAG, \n\tAUDIT_ID, \n\tEFF_FROM_DATE, \n\tEFF_TO_DATE, \n\tSOURCE_SYSTEM_ID AS SOURCE_SYSTEM_ID, \n\tCREATED_DATE, \n\tMODIFIED_DATE, \n\tpay_code AS AGENCY_PAY_CODE, \n\tpay_code_eff_date AS AGENCY_PAY_CODE_EFF_FROM_DATE, \n\tpay_code_exp_date AS AGENCY_PAY_CODE_EFF_TO_DATE\n\tFROM FLT_Insert\n),\nSQ_agency AS (\n\tSELECT a.agency_id, \r\n\ta.agency_state_code, \r\n\ta.agency_num, \r\n\ta.eff_from_date, \r\n\ta.eff_to_date \r\n\tFROM\r\n\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.agency a\r\n\tWHERE EXISTS(SELECT 1\t\t\t\r\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.agency b\r\n\t\tWHERE eff_to_date = '12/31/2100 23:59:59'\r\n\t\tand a.agency_state_code  = b.agency_state_code\r\n\t\tand a.agency_num = b.agency_num\r\n\t\tGROUP BY agency_state_code, \r\n\t\tagency_num\r\n\t\tHAVING COUNT(*) > 1)\r\n\tORDER BY agency_state_code,agency_num,eff_from_date  DESC\n),\nEXP_Lag_eff_from_date AS (\n\tSELECT\n\tagency_id,\n\tagency_state_code,\n\tagency_num,\n\teff_from_date,\n\teff_to_date AS orig_eff_to_date,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- \tagency_state_code=v_PREV_ROW_agency_state_code and agency_num=v_PREV_ROW_agency_num, ADD_TO_DATE(v_PREV_ROW_eff_from_date,'SS',-1),\r\n\t-- \torig_eff_to_date)\r\n\t-- \t\r\n\t-- \r\n\t-- \r\n\t-- \n\tDECODE(\n\t    TRUE,\n\t    agency_state_code = v_PREV_ROW_agency_state_code and agency_num = v_PREV_ROW_agency_num, DATEADD(SECOND,- 1,v_PREV_ROW_eff_from_date),\n\t    orig_eff_to_date\n\t) AS v_eff_to_date,\n\tv_eff_to_date AS eff_to_date,\n\teff_from_date AS v_PREV_ROW_eff_from_date,\n\tagency_state_code AS v_PREV_ROW_agency_state_code,\n\tagency_num AS v_PREV_ROW_agency_num,\n\tsysdate AS modified_date,\n\t0 AS crrnt_snpsht_flag\n\tFROM SQ_agency\n),\nFIL_FirstRowInAKGroup AS (\n\tSELECT\n\tagency_id, \n\torig_eff_to_date, \n\teff_to_date, \n\tmodified_date, \n\tcrrnt_snpsht_flag\n\tFROM EXP_Lag_eff_from_date\n\tWHERE orig_eff_to_date <> eff_to_date\n),\nUPD_Agency AS (\n\tSELECT\n\tagency_id, \n\teff_to_date, \n\tmodified_date, \n\tcrrnt_snpsht_flag\n\tFROM FIL_FirstRowInAKGroup\n),\nagency_Update AS (\n\tMERGE INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.agency AS T\n\tUSING UPD_Agency AS S\n\tON T.agency_id = S.agency_id\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.crrnt_snpsht_flag = S.crrnt_snpsht_flag, T.eff_to_date = S.eff_to_date, T.modified_date = S.modified_date\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "TARGET_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "Default Value"
            }
        },
        "folder": {
            "name": "RPT_EDM and EDW/Agency DataWarehouse/"
        },
        "annotations": []
    }
}