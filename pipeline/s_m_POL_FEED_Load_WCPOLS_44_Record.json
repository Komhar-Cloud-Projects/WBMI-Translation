{
    "name": "s_m_POL_FEED_Load_WCPOLS_44_Record",
    "properties": {
        "activities": [
            {
                "name": "m_POL_FEED_Load_WCPOLS_44_Record",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nSQ_WCPols00Record AS (\n\tSELECT\r\n\t\tWCTrackHistoryID,\r\n\t\tLinkData,\r\n\t      AuditId\r\n\tFROM dbo.WCPols00Record\r\n\tWHERE \r\n\t AuditId = @{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID}\r\n\tORDER BY WCTrackHistoryID\n),\nSQ_WorkWCTrackHistory AS (\n\tSELECT Distinct \r\n\tTrack.WCTrackHistoryID as WCTrackHistoryID, \r\n\tForms.FormName as FormName, \r\n\t'WC000424' as ParsedFormName,\r\n\tParty.Name as Name,\r\n\tPolicy.TransactionEffectiveDate as TransactionEffectiveDate,\r\n\tTerm.[State] as State,\r\n\tTerm.BasisOfAuditNonComplianceCharge as BasisOfAuditNonComplianceCharge,\r\n\tTerm.AuditNoncomplianceChargeMultiplier as AuditNoncomplianceChargeMultiplier\r\n\tFROM\r\n\tWorkWCForms Forms\r\n\tinner join WorkWCTrackHistory Track \ton \r\n\t\tForms.WCTrackHistoryID=Track.WCTrackHistoryID and \r\n\t\tForms.FormName like 'WC000424%' and \r\n\t\t((Forms.OnPolicy=1 OR Forms.[Add] = 1) AND (Forms.Remove is null OR Forms.Remove = 0))\r\n\tinner join WorkWCParty Party on \r\n\t\tParty.WCTrackHistoryID=Track.WCTrackHistoryID AND \r\n\t\tParty.PartyAssociationType='Account'\r\n\tinner join WorkWCPolicy Policy on \r\n\t\tPolicy.WCTrackHistoryID=Track.WCTrackHistoryID\r\n\tinner join WorkWCStateTerm Term on\r\n\t\tPolicy.WCTrackHistoryID=Term.WCTrackHistoryID\r\n\tWHERE\r\n\tForms.Auditid = @{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID}\r\n\t@{pipeline().parameters.WHERE_CLAUSE_44}\r\n\torder by Track.WCTrackHistoryID, Forms.FormName,Party.Name,Policy.TransactionEffectiveDate\n),\nJNR_CombineRecordData AS (SELECT\n\tSQ_WCPols00Record.WCTrackHistoryID AS WCTrackHistoryID_Record00, \n\tSQ_WCPols00Record.LinkData, \n\tSQ_WCPols00Record.AuditId, \n\tSQ_WorkWCTrackHistory.WCTrackHistoryID AS WCTrackHistoryID_tracking, \n\tSQ_WorkWCTrackHistory.FormName, \n\tSQ_WorkWCTrackHistory.ParsedFormName, \n\tSQ_WorkWCTrackHistory.Name, \n\tSQ_WorkWCTrackHistory.TransactionEffectiveDate, \n\tSQ_WorkWCTrackHistory.State, \n\tSQ_WorkWCTrackHistory.BasisOfAuditNonComplianceCharge, \n\tSQ_WorkWCTrackHistory.AuditNoncomplianceChargeMultiplier\n\tFROM SQ_WCPols00Record\n\tINNER JOIN SQ_WorkWCTrackHistory\n\tON SQ_WorkWCTrackHistory.WCTrackHistoryID = SQ_WCPols00Record.WCTrackHistoryID\n),\nmplt_Parse_FormNameField AS (WITH\n\tINPUT_FormName AS (\n\t\t\n\t),\n\tEXPTRANS AS (\n\t\tSELECT\n\t\tParsedNameOfForm,\n\t\tFormNameFromSource,\n\t\t-- *INF*: REVERSE(FormNameFromSource)\n\t\tREVERSE(FormNameFromSource) AS vReversedFromNameFromSource,\n\t\t-- *INF*: REVERSE(substr(vReversedFromNameFromSource,1,4))\n\t\tREVERSE(substr(vReversedFromNameFromSource, 1, 4)) AS vFormEdition,\n\t\t-- *INF*: DECODE(TRUE,\r\n\t\t-- substr(vReversedFromNameFromSource,5,1) >='A' and substr(vReversedFromNameFromSource,5,1) <='Z', substr(vReversedFromNameFromSource,5,1),\r\n\t\t-- ' '\r\n\t\t-- )\r\n\t\t-- \r\n\t\t-- -- check if within A and Z, if not then space\n\t\tDECODE(\n\t\t    TRUE,\n\t\t    substr(vReversedFromNameFromSource, 5, 1) >= 'A' and substr(vReversedFromNameFromSource, 5, 1) <= 'Z', substr(vReversedFromNameFromSource, 5, 1),\n\t\t    ' '\n\t\t) AS vBureauCode,\n\t\tvFormEdition AS oFormEdition,\n\t\tvBureauCode AS oBureauCode\n\t\tFROM INPUT_FormName\n\t),\n\tOUTPUT_FormName AS (\n\t\tSELECT\n\t\tParsedNameOfForm, \n\t\tFormNameFromSource, \n\t\toFormEdition AS FormEdition, \n\t\toBureauCode AS BureauCode\n\t\tFROM EXPTRANS\n\t),\n),\nEXP_Counter AS (\n\tSELECT\n\tJNR_CombineRecordData.WCTrackHistoryID_Record00 AS WCTrackHistoryID,\n\tCURRENT_TIMESTAMP AS ExtractDate,\n\tJNR_CombineRecordData.AuditId,\n\tJNR_CombineRecordData.LinkData,\n\t'44' AS RecordTypeCode,\n\tmplt_Parse_FormNameField.ParsedNameOfForm1 AS ParsedNameOfForm,\n\tmplt_Parse_FormNameField.FormEdition,\n\tmplt_Parse_FormNameField.BureauCode,\n\tJNR_CombineRecordData.Name,\n\tJNR_CombineRecordData.TransactionEffectiveDate AS i_TransactionEffectiveDate,\n\t-- *INF*: TO_CHAR(i_TransactionEffectiveDate,'YYMMDD')\n\tTO_CHAR(i_TransactionEffectiveDate, 'YYMMDD') AS o_TransactionEffectiveDate,\n\tWCTrackHistoryID AS v_CurrentRecord,\n\t-- *INF*: IIF(v_CurrentRecord<>v_PreviousRecord,0,1)\n\tIFF(v_CurrentRecord <> v_PreviousRecord, 0, 1) AS v_ChangeFlag,\n\tWCTrackHistoryID AS v_PreviousRecord,\n\t-- *INF*: IIF(v_ChangeFlag=1,v_Counter+1,1)\n\tIFF(v_ChangeFlag = 1, v_Counter + 1, 1) AS v_Counter,\n\t-- *INF*: MOD(v_Counter,3)\n\tMOD(v_Counter, 3) AS Split,\n\t-- *INF*: CEIL(v_Counter/3)\n\tCEIL(v_Counter / 3) AS GroupKey,\n\tJNR_CombineRecordData.State,\n\tJNR_CombineRecordData.BasisOfAuditNonComplianceCharge,\n\tJNR_CombineRecordData.AuditNoncomplianceChargeMultiplier,\n\t-- *INF*: IIF(ISNULL(AuditNoncomplianceChargeMultiplier),AuditNoncomplianceChargeMultiplier,AuditNoncomplianceChargeMultiplier*1000)\n\tIFF(\n\t    AuditNoncomplianceChargeMultiplier IS NULL, AuditNoncomplianceChargeMultiplier,\n\t    AuditNoncomplianceChargeMultiplier * 1000\n\t) AS O_AuditNoncomplianceChargeMultiplier\n\tFROM JNR_CombineRecordData\n\t -- Manually join with mplt_Parse_FormNameField\n),\nEXP_Split AS (\n\tSELECT\n\tWCTrackHistoryID,\n\tExtractDate,\n\tAuditId,\n\tLinkData,\n\tRecordTypeCode,\n\tParsedNameOfForm,\n\tFormEdition,\n\tBureauCode,\n\tName,\n\to_TransactionEffectiveDate,\n\tSplit,\n\tGroupKey,\n\tState AS IN_State,\n\tBasisOfAuditNonComplianceCharge AS IN_BasisOfAuditNonComplianceCharge,\n\tO_AuditNoncomplianceChargeMultiplier AS IN_AuditNoncomplianceChargeMultiplier,\n\t-- *INF*: IIF(Split=1,IN_State,'')\n\tIFF(Split = 1, IN_State, '') AS State,\n\t-- *INF*: IIF(Split=1,IN_BasisOfAuditNonComplianceCharge,'')\n\tIFF(Split = 1, IN_BasisOfAuditNonComplianceCharge, '') AS BasisOfAuditNonComplianceCharge,\n\t-- *INF*: IIF(Split=1,IN_AuditNoncomplianceChargeMultiplier,0)\n\tIFF(Split = 1, IN_AuditNoncomplianceChargeMultiplier, 0) AS AuditNoncomplianceChargeMultiplier,\n\t-- *INF*: IIF(Split=2,IN_State,'')\n\tIFF(Split = 2, IN_State, '') AS State2,\n\t-- *INF*: IIF(Split=2,IN_BasisOfAuditNonComplianceCharge,'')\n\tIFF(Split = 2, IN_BasisOfAuditNonComplianceCharge, '') AS BasisOfAuditNonComplianceCharge2,\n\t-- *INF*: IIF(Split=2,IN_AuditNoncomplianceChargeMultiplier,0)\n\tIFF(Split = 2, IN_AuditNoncomplianceChargeMultiplier, 0) AS AuditNoncomplianceChargeMultiplier2,\n\t-- *INF*: IIF(Split=0,IN_State,'')\n\tIFF(Split = 0, IN_State, '') AS State3,\n\t-- *INF*: IIF(Split=0,IN_BasisOfAuditNonComplianceCharge,'')\n\tIFF(Split = 0, IN_BasisOfAuditNonComplianceCharge, '') AS BasisOfAuditNonComplianceCharge3,\n\t-- *INF*: IIF(Split=0,IN_AuditNoncomplianceChargeMultiplier,0)\n\tIFF(Split = 0, IN_AuditNoncomplianceChargeMultiplier, 0) AS AuditNoncomplianceChargeMultiplier3\n\tFROM EXP_Counter\n),\nAGG_GroupData AS (\n\tSELECT\n\tExtractDate,\n\tAuditId,\n\tWCTrackHistoryID,\n\tLinkData,\n\tRecordTypeCode,\n\tParsedNameOfForm,\n\tBureauCode,\n\tFormEdition,\n\tSplit,\n\tGroupKey,\n\tState AS IN_State,\n\tBasisOfAuditNonComplianceCharge AS IN_BasisOfAuditNonComplianceCharge,\n\tAuditNoncomplianceChargeMultiplier AS IN_AuditNoncomplianceChargeMultiplier,\n\tState2 AS IN_State2,\n\tBasisOfAuditNonComplianceCharge2 AS IN_BasisOfAuditNonComplianceCharge2,\n\tAuditNoncomplianceChargeMultiplier2 AS IN_AuditNoncomplianceChargeMultiplier2,\n\tState3 AS IN_State3,\n\tBasisOfAuditNonComplianceCharge3 AS IN_BasisOfAuditNonComplianceCharge3,\n\tAuditNoncomplianceChargeMultiplier3 AS IN_AuditNoncomplianceChargeMultiplier3,\n\t-- *INF*: MAX(IN_State)\n\tMAX(IN_State) AS State,\n\t-- *INF*: MAX(IN_BasisOfAuditNonComplianceCharge)\n\tMAX(IN_BasisOfAuditNonComplianceCharge) AS BasisOfAuditNonComplianceCharge,\n\t-- *INF*: MAX(IN_AuditNoncomplianceChargeMultiplier)\n\tMAX(IN_AuditNoncomplianceChargeMultiplier) AS AuditNoncomplianceChargeMultiplier,\n\t-- *INF*: MAX(IN_State2)\n\tMAX(IN_State2) AS State2,\n\t-- *INF*: MAX(IN_BasisOfAuditNonComplianceCharge2)\n\tMAX(IN_BasisOfAuditNonComplianceCharge2) AS BasisOfAuditNonComplianceCharge2,\n\t-- *INF*: MAX(IN_AuditNoncomplianceChargeMultiplier2)\n\tMAX(IN_AuditNoncomplianceChargeMultiplier2) AS AuditNoncomplianceChargeMultiplier2,\n\t-- *INF*: MAX(IN_State3)\n\tMAX(IN_State3) AS State3,\n\t-- *INF*: MAX(IN_BasisOfAuditNonComplianceCharge3)\n\tMAX(IN_BasisOfAuditNonComplianceCharge3) AS BasisOfAuditNonComplianceCharge3,\n\t-- *INF*: MAX(IN_AuditNoncomplianceChargeMultiplier3)\n\tMAX(IN_AuditNoncomplianceChargeMultiplier3) AS AuditNoncomplianceChargeMultiplier3,\n\tName,\n\to_TransactionEffectiveDate AS TransactionEffectiveDate\n\tFROM EXP_Split\n\tGROUP BY WCTrackHistoryID, GroupKey\n),\nEXP_Target AS (\n\tSELECT\n\tExtractDate,\n\tAuditId,\n\tWCTrackHistoryID,\n\tLinkData,\n\tRecordTypeCode,\n\tParsedNameOfForm,\n\tBureauCode,\n\tFormEdition,\n\tState,\n\tBasisOfAuditNonComplianceCharge,\n\tAuditNoncomplianceChargeMultiplier,\n\tState2,\n\tBasisOfAuditNonComplianceCharge2,\n\tAuditNoncomplianceChargeMultiplier2,\n\tState3,\n\tBasisOfAuditNonComplianceCharge3,\n\tAuditNoncomplianceChargeMultiplier3,\n\tName,\n\tTransactionEffectiveDate\n\tFROM AGG_GroupData\n),\nWCPols44Record AS (\n\n\t------------ PRE SQL ----------\n\tDELETE\r\n\t  FROM dbo.WCPols44Record\r\n\tWHERE AuditId = @{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID}\n\t-------------------------------\n\n\n\tINSERT INTO WCPols44Record\n\t(ExtractDate, AuditId, WCTrackHistoryID, LinkData, RecordTypeCode, EndorsementNumber, BureauVersionIdentifierEditionIdentifier, CarrierVersionIdentifier, StateAbbreviation, BasisOfAuditNoncomplianceCharge, MaximumAuditNoncomplianceChargeMultiplier, StateAbbreviation2, BasisOfAuditNoncomplianceCharge2, MaximumAuditNoncomplianceChargeMultiplier2, StateAbbreviation3, BasisOfAuditNoncomplianceCharge3, MaximumAuditNoncomplianceChargeMultiplier3, NameOfInsured, EndorsementEffectiveDate)\n\tSELECT \n\tEXTRACTDATE, \n\tAUDITID, \n\tWCTRACKHISTORYID, \n\tLINKDATA, \n\tRECORDTYPECODE, \n\tParsedNameOfForm AS ENDORSEMENTNUMBER, \n\tBureauCode AS BUREAUVERSIONIDENTIFIEREDITIONIDENTIFIER, \n\tFormEdition AS CARRIERVERSIONIDENTIFIER, \n\tState AS STATEABBREVIATION, \n\tBasisOfAuditNonComplianceCharge AS BASISOFAUDITNONCOMPLIANCECHARGE, \n\tAuditNoncomplianceChargeMultiplier AS MAXIMUMAUDITNONCOMPLIANCECHARGEMULTIPLIER, \n\tState2 AS STATEABBREVIATION2, \n\tBasisOfAuditNonComplianceCharge2 AS BASISOFAUDITNONCOMPLIANCECHARGE2, \n\tAuditNoncomplianceChargeMultiplier2 AS MAXIMUMAUDITNONCOMPLIANCECHARGEMULTIPLIER2, \n\tState3 AS STATEABBREVIATION3, \n\tBasisOfAuditNonComplianceCharge3 AS BASISOFAUDITNONCOMPLIANCECHARGE3, \n\tAuditNoncomplianceChargeMultiplier3 AS MAXIMUMAUDITNONCOMPLIANCECHARGEMULTIPLIER3, \n\tName AS NAMEOFINSURED, \n\tTransactionEffectiveDate AS ENDORSEMENTEFFECTIVEDATE\n\tFROM EXP_Target\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WHERE_CLAUSE_44": {
                "type": "string",
                "defaultValue": "Default Value"
            }
        },
        "folder": {
            "name": "DataFeed -Informatica/PolicyDataServices/"
        },
        "annotations": []
    }
}