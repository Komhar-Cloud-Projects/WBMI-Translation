{
    "name": "s_m_POL_CUS_DW_UPDATE_Underwriter_in_Policy",
    "properties": {
        "activities": [
            {
                "name": "m_POL_CUS_DW_UPDATE_Underwriter_in_Policy",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nLKP_UnderwriterProductRelationship_UnderwritingAssociateAKID_ByAgySPCPOProg AS (\n\tSELECT\n\tAssociateCode,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyAmountMinimum,\n\tPolicyAmountMaximum,\n\tPolicyOfferingCode,\n\tProgramCode\n\tFROM (\n\t\tSELECT DISTINCT \r\n\t\tUPR.StrategicProfitCenterCode as StrategicProfitCenterCode, \r\n\t\tAgency.AgencyCode as AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum as PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum as PolicyAmountMaximum, \r\n\t\tUPR.PolicyOfferingCode as PolicyOfferingCode,\r\n\t\tUPR.ProgramCode as ProgramCode,\r\n\t\tMAX(UA.RoleSpecificUserCode) as AssociateCode\r\n\t\tFROM \r\n\t\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterProductRelationship UPR\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterAgencyRelationship UAR\r\n\t\ton UPR.AssociateId=UAR.AssociateId\r\n\t\tand UAR.StrategicProfitCenterCode=UPR.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Associate UA\r\n\t\ton UAR.AssociateId=UA.AssociateID\r\n\t\tAND UAR.StrategicProfitCenterCode=UA.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.VWAgency Agency\r\n\t\ton UAR.AgencyId=Agency.AgencyID\r\n\t\tWhere UA.associaterole = 'UNDERWRITER'\r\n\t\tgroup by \r\n\t\tUPR.StrategicProfitCenterCode,\r\n\t\tAgency.AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum,\r\n\t\tUPR.PolicyOfferingCode,\r\n\t\tUPR.ProgramCode\r\n\t\thaving count(distinct UA.RoleSpecificUserCode) = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY StrategicProfitCenterCode,AgencyCode,PolicyAmountMinimum,PolicyAmountMaximum,PolicyOfferingCode,ProgramCode ORDER BY AssociateCode DESC) = 1\n),\nLKP_UnderwriterProductRelationship_UnderwritingAssociateAKID_byAgency AS (\n\tSELECT\n\tAssociateCode,\n\tStrategicProfitCenterCode,\n\tAgencyCode\n\tFROM (\n\t\tSELECT DISTINCT MAX(UA.RoleSpecificUserCode) AS AssociateCode,\r\n\t\tUAR.StrategicProfitCenterCode as StrategicProfitCenterCode,\r\n\t\tAgency.AgencyCode as AgencyCode\r\n\t\tFROM \r\n\t\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterAgencyRelationship UAR\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Associate UA\r\n\t\ton UAR.AssociateId=UA.AssociateID\r\n\t\tAND UAR.StrategicProfitCenterCode=UA.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.VWAgency Agency\r\n\t\ton UAR.AgencyId=Agency.AgencyID\r\n\t\tWHERE UA.associaterole = 'UNDERWRITER'\r\n\t\tgroup by \r\n\t\tUAR.StrategicProfitCenterCode,\r\n\t\tAgency.AgencyCode\r\n\t\thaving count(DISTINCT UA.RoleSpecificUserCode) = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY StrategicProfitCenterCode,AgencyCode ORDER BY AssociateCode DESC) = 1\n),\nLKP_UnderwriterProductRelationship_UnderwritingAssociateAKID_byAgySPC AS (\n\tSELECT\n\tAssociateCode,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyAmountMinimum,\n\tPolicyAmountMaximum\n\tFROM (\n\t\tSELECT DISTINCT \r\n\t\tUPR.StrategicProfitCenterCode as StrategicProfitCenterCode, \r\n\t\tAgency.AgencyCode as AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum as PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum as PolicyAmountMaximum, \r\n\t\tMAX(UA.RoleSpecificUserCode) as AssociateCode\r\n\t\tFROM \r\n\t\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterProductRelationship UPR\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterAgencyRelationship UAR\r\n\t\ton UPR.AssociateId=UAR.AssociateId\r\n\t\tand UAR.StrategicProfitCenterCode=UPR.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Associate UA\r\n\t\ton UAR.AssociateId=UA.AssociateID\r\n\t\tAND UAR.StrategicProfitCenterCode=UA.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.VWAgency Agency\r\n\t\ton UAR.AgencyId=Agency.AgencyID\r\n\t\tWhere UA.associaterole = 'UNDERWRITER'\r\n\t\tgroup by \r\n\t\tUPR.StrategicProfitCenterCode, \r\n\t\tAgency.AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum\r\n\t\thaving count(distinct UA.RoleSpecificUserCode) = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY StrategicProfitCenterCode,AgencyCode,PolicyAmountMinimum,PolicyAmountMaximum ORDER BY AssociateCode DESC) = 1\n),\nLKP_UnderwriterProductRelationship_UnderwritingAssociateAKID_byAgySPCPO AS (\n\tSELECT\n\tAssociateCode,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyAmountMinimum,\n\tPolicyAmountMaximum,\n\tPolicyOfferingCode\n\tFROM (\n\t\tSELECT DISTINCT \r\n\t\tUPR.StrategicProfitCenterCode as StrategicProfitCenterCode, \r\n\t\tAgency.AgencyCode as AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum as PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum as PolicyAmountMaximum, \r\n\t\tUPR.PolicyOfferingCode as PolicyOfferingCode,\r\n\t\tMAX(UA.RoleSpecificUserCode) as AssociateCode\r\n\t\tFROM \r\n\t\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterProductRelationship UPR\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterAgencyRelationship UAR\r\n\t\ton UPR.AssociateId=UAR.AssociateId\r\n\t\tand UAR.StrategicProfitCenterCode=UPR.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Associate UA\r\n\t\ton UAR.AssociateId=UA.AssociateID\r\n\t\tAND UAR.StrategicProfitCenterCode=UA.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.VWAgency Agency\r\n\t\ton UAR.AgencyId=Agency.AgencyID\r\n\t\tWhere UA.associaterole = 'UNDERWRITER'\r\n\t\tgroup by \r\n\t\tUPR.StrategicProfitCenterCode, \r\n\t\tAgency.AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum,\r\n\t\tUPR.PolicyOfferingCode\r\n\t\thaving count(distinct UA.RoleSpecificUserCode) = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY StrategicProfitCenterCode,AgencyCode,PolicyAmountMinimum,PolicyAmountMaximum,PolicyOfferingCode ORDER BY AssociateCode DESC) = 1\n),\nLKP_PremiumSum AS (\n\tSELECT\n\tPremiumTransactionAmount,\n\tpol_id\n\tFROM (\n\t\tSELECT P.pol_id as pol_id,\r\n\t\tSUM(PT.premiumtransactionamount) as PremiumTransactionAmount\r\n\t\tFROM V2.policy P\r\n\t\tJOIN dbo.StrategicProfitCenter SPC\r\n\t\tON P.StrategicProfitCenterAKId = SPC.StrategicProfitCenterAKId and SPC.StrategicProfitCenterDescription = 'Argent'\r\n\t\tJOIN DBO.PolicyCoverage PC\r\n\t\tON PC.PolicyAKID=P.pol_ak_id\r\n\t\tAND PC.CurrentSnapshotFlag=1\r\n\t\tJOIN DBO.StatisticalCoverage SC\r\n\t\tON SC.PolicyCoverageAKID=PC.PolicyCoverageAKID\r\n\t\tAND SC.CurrentSnapshotFlag=1\r\n\t\tJOIN DBO.PremiumTransaction PT\r\n\t\tON PT.StatisticalCoverageAKID=SC.StatisticalCoverageAKID\r\n\t\tAND PT.CurrentSnapshotFlag=1\r\n\t\tWHERE PT.PremiumType = 'D'\r\n\t\tGROUP BY P.pol_id\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY pol_id ORDER BY PremiumTransactionAmount DESC) = 1\n),\nLKP_UnderwriterProductRelationship_UnderwritingAssociateAKID_ByAgySPCPOProgBond AS (\n\tSELECT\n\tAssociateCode,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyAmountMinimum,\n\tPolicyAmountMaximum,\n\tPolicyOfferingCode,\n\tProgramCode,\n\tBondCategory\n\tFROM (\n\t\tSELECT DISTINCT \r\n\t\tUPR.StrategicProfitCenterCode as StrategicProfitCenterCode, \r\n\t\tAgency.AgencyCode as AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum as PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum as PolicyAmountMaximum, \r\n\t\tUPR.PolicyOfferingCode as PolicyOfferingCode,\r\n\t\tUPR.ProgramCode as ProgramCode,\r\n\t\tUPR.BondCategory as BondCategory,\r\n\t\tMAX(UA.RoleSpecificUserCode) as AssociateCode\r\n\t\tFROM \r\n\t\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterProductRelationship UPR\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterAgencyRelationship UAR\r\n\t\ton UPR.AssociateId=UAR.AssociateId\r\n\t\tand UAR.StrategicProfitCenterCode=UPR.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Associate UA\r\n\t\ton UAR.AssociateId=UA.AssociateID\r\n\t\tAND UAR.StrategicProfitCenterCode=UA.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.VWAgency Agency\r\n\t\ton UAR.AgencyId=Agency.AgencyID\r\n\t\tWhere UA.associaterole = 'UNDERWRITER'\r\n\t\tgroup by \r\n\t\tUPR.StrategicProfitCenterCode,\r\n\t\tAgency.AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum,\r\n\t\tUPR.PolicyOfferingCode,\r\n\t\tUPR.ProgramCode,\r\n\t\tUPR.BondCategory\r\n\t\thaving count(distinct UA.RoleSpecificUserCode) = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY StrategicProfitCenterCode,AgencyCode,PolicyAmountMinimum,PolicyAmountMaximum,PolicyOfferingCode,ProgramCode,BondCategory ORDER BY AssociateCode DESC) = 1\n),\nLKP_UnderwriterWorkCompPool AS (\n\tSELECT\n\tAssociateCode,\n\tDummy\n\tFROM (\n\t\tselect distinct 1 as Dummy,\r\n\t\ta.RoleSpecificUserCode as AssociateCode\r\n\t\tfrom @{pipeline().parameters.SOURCE_TABLE_OWNER}.associate a\r\n\t\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterProductRelationship b on a.AssociateID = b.AssociateId\r\n\t\twhere a.associaterole = 'UNDERWRITER'\r\n\t\tand b.InsuranceSegmentCode = '3'\r\n\t\tgroup by a.RoleSpecificUserCode\r\n\t\thaving count(DISTINCT a.RoleSpecificUserCode) = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY Dummy ORDER BY AssociateCode DESC) = 1\n),\nLKP_BondProducts AS (\n\tSELECT\n\tProductCode,\n\tpol_id\n\tFROM (\n\t\tselect distinct p.pol_id as pol_id,\r\n\t\tprod.ProductCode as ProductCode\r\n\t\tfrom v2.policy p\r\n\t\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.PolicyCoverage pc on p.pol_ak_id = pc.PolicyAKID\r\n\t\t\t\tand pc.CurrentSnapshotFlag = 1\r\n\t\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.StatisticalCoverage sc on pc.PolicyCoverageAKID = sc.PolicyCoverageAKID\r\n\t\t\t\tand sc.CurrentSnapshotFlag = 1\r\n\t\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Product prod on sc.ProductAKId = prod.ProductAKId\r\n\t\t\t\tand prod.CurrentSnapshotFlag = 1\r\n\t\twhere p.source_sys_id = 'PMS'\r\n\t\t and p.crrnt_snpsht_flag = 1\r\n\t\t and prod.ProductCode in('610','620','630','640','650','660')\r\n\t\tunion\r\n\t\tselect distinct p.pol_id, prod.ProductCode\r\n\t\tfrom v2.policy p\r\n\t\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.PolicyCoverage pc on p.pol_ak_id = pc.PolicyAKID\r\n\t\t\t\tand pc.CurrentSnapshotFlag = 1\r\n\t\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.RatingCoverage rc on pc.PolicyCoverageAKID = rc.PolicyCoverageAKID\r\n\t\t\t\tand rc.CurrentSnapshotFlag = 1\r\n\t\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Product prod on rc.ProductAKId = prod.ProductAKId\r\n\t\t\t\tand prod.CurrentSnapshotFlag = 1\r\n\t\twhere p.source_sys_id = 'DCT'\r\n\t\t and p.crrnt_snpsht_flag = 1\r\n\t\t and prod.ProductCode in('610','620','630','640','650','660')\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY pol_id ORDER BY ProductCode DESC) = 1\n),\nLKP_SBAReinsurance AS (\n\tSELECT\n\tReturnIndicator,\n\tpol_id,\n\treins_co_num\n\tFROM (\n\t\tselect b.pol_id as pol_id,\r\n\t\ta.reins_co_num as reins_co_num,\r\n\t\t'Y' as ReturnIndicator\r\n\t\tfrom @{pipeline().parameters.SOURCE_TABLE_OWNER}.reinsurance_coverage a\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER_V2}.policy b \r\n\t\ton a.pol_ak_id = b.pol_ak_id\r\n\t\twhere a.crrnt_snpsht_flag = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY pol_id,reins_co_num ORDER BY ReturnIndicator DESC) = 1\n),\nSQ_policy AS (\n\tSELECT P.pol_id,\r\n\tP.agencyakid,\r\n\tP.strategicprofitcenterakid,\r\n\tP.PolicyOfferingAKID,\r\n\tP.ProgramAKID,\r\n\tP.InsuranceSegmentAKId,\r\n\tP.wbconnect_upload_code\r\n\tFROM V2.policy P\r\n\tWHERE P.crrnt_snpsht_flag=1\n),\nEXP_Policy_AgencyRelationship AS (\n\tSELECT\n\tpol_id AS i_pol_id,\n\tAgencyAKId AS i_AgencyAKId,\n\tStrategicProfitCenterAKId AS i_StrategicProfitCenterAKId,\n\t-- *INF*: IIF(i_StrategicProfitCenterAKId = 4,:LKP.LKP_PREMIUMSUM(i_pol_id),0)\n\tIFF(i_StrategicProfitCenterAKId = 4, LKP_PREMIUMSUM_i_pol_id.PremiumTransactionAmount, 0) AS v_PremiumTransactionAmount,\n\tPolicyOfferingAKID AS i_PolicyOfferingAKID,\n\tProgramAKID AS i_ProgramAKID,\n\tInsuranceSegmentAKId AS i_InsuranceSegmentAKId,\n\twbconnect_upload_code AS i_wbconnect_upload_code,\n\ti_pol_id AS o_pol_id,\n\ti_StrategicProfitCenterAKId AS o_StrategicProfitCenterAKId,\n\ti_AgencyAKId AS o_AgencyAKId,\n\t-- *INF*: IIF(v_PremiumTransactionAmount < 0,0,v_PremiumTransactionAmount)\n\tIFF(v_PremiumTransactionAmount < 0, 0, v_PremiumTransactionAmount) AS o_PremiumTransactionAmount,\n\ti_PolicyOfferingAKID AS o_PolicyOfferingAKID,\n\ti_ProgramAKID AS o_ProgramAKID,\n\ti_InsuranceSegmentAKId AS o_InsuranceSegmentAKId,\n\ti_wbconnect_upload_code AS o_wbconnect_upload_code\n\tFROM SQ_policy\n\tLEFT JOIN LKP_PREMIUMSUM LKP_PREMIUMSUM_i_pol_id\n\tON LKP_PREMIUMSUM_i_pol_id.pol_id = i_pol_id\n\n),\nLKP_Agency_V2 AS (\n\tSELECT\n\tAgencyCode,\n\tTerminatedDate,\n\tAgencyAKID\n\tFROM (\n\t\tSELECT \n\t\t\tAgencyCode,\n\t\t\tTerminatedDate,\n\t\t\tAgencyAKID\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER_V2}.Agency\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY AgencyAKID ORDER BY AgencyCode) = 1\n),\nLKP_InsuranceSegment AS (\n\tSELECT\n\tInsuranceSegmentCode,\n\tInsuranceSegmentAKId\n\tFROM (\n\t\tSELECT \n\t\t\tInsuranceSegmentCode,\n\t\t\tInsuranceSegmentAKId\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.InsuranceSegment\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY InsuranceSegmentAKId ORDER BY InsuranceSegmentCode) = 1\n),\nLKP_PolicyOffering AS (\n\tSELECT\n\tPolicyOfferingCode,\n\tPolicyOfferingAKId\n\tFROM (\n\t\tSELECT \n\t\t\tPolicyOfferingCode,\n\t\t\tPolicyOfferingAKId\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.PolicyOffering\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY PolicyOfferingAKId ORDER BY PolicyOfferingCode) = 1\n),\nLKP_Program AS (\n\tSELECT\n\tProgramCode,\n\tProgramAKId\n\tFROM (\n\t\tSELECT \n\t\t\tProgramCode,\n\t\t\tProgramAKId\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.Program\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY ProgramAKId ORDER BY ProgramCode) = 1\n),\nLKP_StrategicProfitCenter AS (\n\tSELECT\n\tStrategicProfitCenterCode,\n\tStrategicProfitCenterAKId\n\tFROM (\n\t\tSELECT \n\t\t\tStrategicProfitCenterCode,\n\t\t\tStrategicProfitCenterAKId\n\t\tFROM StrategicProfitCenter\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY StrategicProfitCenterAKId ORDER BY StrategicProfitCenterCode) = 1\n),\nEXP_Policy_ProductRelationship AS (\n\tSELECT\n\tLKP_StrategicProfitCenter.StrategicProfitCenterCode AS i_StrategicProfitCenterCode,\n\tLKP_Agency_V2.AgencyCode AS i_AgencyCode,\n\tEXP_Policy_AgencyRelationship.o_pol_id AS i_pol_id,\n\tEXP_Policy_AgencyRelationship.o_PremiumTransactionAmount AS i_PremiumTransactionAmount,\n\tLKP_PolicyOffering.PolicyOfferingCode AS i_PolicyOfferingCode,\n\tLKP_Program.ProgramCode AS i_ProgramCode,\n\tLKP_Agency_V2.TerminatedDate AS i_TerminatedDate,\n\tLKP_InsuranceSegment.InsuranceSegmentCode AS i_InsuranceSegmentCode,\n\tEXP_Policy_AgencyRelationship.o_wbconnect_upload_code AS i_wbconnect_upload_code,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- \r\n\t-- --Look for work comp pool underwriter\r\n\t-- i_InsuranceSegmentCode = '3',\r\n\t-- :LKP.LKP_UNDERWRITERWORKCOMPPOOL(1),\r\n\t-- \r\n\t-- NULL\r\n\t-- \r\n\t-- )\n\tDECODE(\n\t    TRUE,\n\t    i_InsuranceSegmentCode = '3', LKP_UNDERWRITERWORKCOMPPOOL_1.AssociateCode,\n\t    NULL\n\t) AS v_UnderwritingAssociateAKID_WorkComp,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ISNULL(v_UnderwritingAssociateAKID_WorkComp), :LKP.LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGENCY(i_StrategicProfitCenterCode,i_AgencyCode),v_UnderwritingAssociateAKID_WorkComp)\n\tDECODE(\n\t    TRUE,\n\t    v_UnderwritingAssociateAKID_WorkComp IS NULL, LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGENCY_i_StrategicProfitCenterCode_i_AgencyCode.AssociateCode,\n\t    v_UnderwritingAssociateAKID_WorkComp\n\t) AS v_UnderwritingAssociateAKID_Agy,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ISNULL(v_UnderwritingAssociateAKID_Agy), :LKP.LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPC(i_StrategicProfitCenterCode,i_AgencyCode,i_PremiumTransactionAmount),v_UnderwritingAssociateAKID_Agy)\n\tDECODE(\n\t    TRUE,\n\t    v_UnderwritingAssociateAKID_Agy IS NULL, LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPC_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount.AssociateCode,\n\t    v_UnderwritingAssociateAKID_Agy\n\t) AS v_UnderwritingAssociateAKID_AgySPC,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ISNULL(v_UnderwritingAssociateAKID_AgySPC), :LKP.LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO(i_StrategicProfitCenterCode,i_AgencyCode,i_PremiumTransactionAmount,i_PolicyOfferingCode),v_UnderwritingAssociateAKID_AgySPC)\n\tDECODE(\n\t    TRUE,\n\t    v_UnderwritingAssociateAKID_AgySPC IS NULL, LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode.AssociateCode,\n\t    v_UnderwritingAssociateAKID_AgySPC\n\t) AS v_UnderwritingAssociateAKID_AgySPCPO,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ISNULL(v_UnderwritingAssociateAKID_AgySPCPO),\r\n\t-- :LKP.LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG(i_StrategicProfitCenterCode,i_AgencyCode,i_PremiumTransactionAmount,i_PolicyOfferingCode, i_ProgramCode),v_UnderwritingAssociateAKID_AgySPCPO)\n\tDECODE(\n\t    TRUE,\n\t    v_UnderwritingAssociateAKID_AgySPCPO IS NULL, LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode.AssociateCode,\n\t    v_UnderwritingAssociateAKID_AgySPCPO\n\t) AS v_UnderwritingAssociateAKID_AgySPCPOProg,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ISNULL(v_UnderwritingAssociateAKID_AgySPCPOProg),\r\n\t-- \r\n\t-- DECODE(TRUE,\r\n\t-- i_wbconnect_upload_code = 'B', :LKP.LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND(i_StrategicProfitCenterCode,i_AgencyCode,i_PremiumTransactionAmount,i_PolicyOfferingCode, i_ProgramCode,'Rapid'),\r\n\t-- \r\n\t-- IN(:LKP.LKP_BONDPRODUCTS(i_pol_id),'610','620','630','640','650','660')\r\n\t-- \tand :LKP.LKP_SBAREINSURANCE(i_pol_id,'0125') = 'Y',\r\n\t-- :LKP.LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND(i_StrategicProfitCenterCode,i_AgencyCode,i_PremiumTransactionAmount,i_PolicyOfferingCode, i_ProgramCode,'SBA'),\r\n\t-- \r\n\t-- :LKP.LKP_BONDPRODUCTS(i_pol_id) = '610',\r\n\t-- :LKP.LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND(i_StrategicProfitCenterCode,i_AgencyCode,i_PremiumTransactionAmount,i_PolicyOfferingCode, i_ProgramCode,'Contract'),\r\n\t-- \r\n\t-- IN(:LKP.LKP_BONDPRODUCTS(i_pol_id),'620','630','640','650','660'),\r\n\t-- :LKP.LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND(i_StrategicProfitCenterCode,i_AgencyCode,i_PremiumTransactionAmount,i_PolicyOfferingCode, i_ProgramCode,'Non-Contract')\r\n\t-- \r\n\t-- \r\n\t-- ),v_UnderwritingAssociateAKID_AgySPCPOProg)\n\tDECODE(\n\t    TRUE,\n\t    v_UnderwritingAssociateAKID_AgySPCPOProg IS NULL, DECODE(\n\t        TRUE,\n\t        i_wbconnect_upload_code = 'B', LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Rapid.AssociateCode,\n\t        LKP_BONDPRODUCTS_i_pol_id.ProductCode IN ('610','620','630','640','650','660') and LKP_SBAREINSURANCE_i_pol_id_0125.ReturnIndicator = 'Y', LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_SBA.AssociateCode,\n\t        LKP_BONDPRODUCTS_i_pol_id.ProductCode = '610', LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Contract.AssociateCode,\n\t        LKP_BONDPRODUCTS_i_pol_id.ProductCode IN ('620','630','640','650','660'), LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Non_Contract.AssociateCode\n\t    ),\n\t    v_UnderwritingAssociateAKID_AgySPCPOProg\n\t) AS v_UnderwritingAssociateAKID_AgySPCPOProgBond,\n\t-- *INF*: IIF(ISNULL(v_UnderwritingAssociateAKID_AgySPCPOProgBond),'N/A', v_UnderwritingAssociateAKID_AgySPCPOProgBond)\n\tIFF(\n\t    v_UnderwritingAssociateAKID_AgySPCPOProgBond IS NULL, 'N/A',\n\t    v_UnderwritingAssociateAKID_AgySPCPOProgBond\n\t) AS v_UnderwritingAssociateCode,\n\ti_pol_id AS o_pol_id,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- \r\n\t-- --other checks\r\n\t-- v_UnderwritingAssociateCode='N/A' AND i_TerminatedDate<>TO_DATE('12/31/2100','MM/DD/YYYY'),'0998',\r\n\t-- v_UnderwritingAssociateCode='N/A' AND IN  (i_AgencyCode,'16998','14998','21999','34999','16999','34998','12999','22999','98999','26999','55555','13999','24999','15999','48001','48966','14967','15966'),'0999',\r\n\t-- v_UnderwritingAssociateCode='N/A' AND i_PolicyOfferingCode='000','0999',\r\n\t-- LTRIM(RTRIM(v_UnderwritingAssociateCode)))\n\tDECODE(\n\t    TRUE,\n\t    v_UnderwritingAssociateCode = 'N/A' AND i_TerminatedDate <> TO_TIMESTAMP('12/31/2100', 'MM/DD/YYYY'), '0998',\n\t    v_UnderwritingAssociateCode = 'N/A' AND i_AgencyCode IN ('16998','14998','21999','34999','16999','34998','12999','22999','98999','26999','55555','13999','24999','15999','48001','48966','14967','15966'), '0999',\n\t    v_UnderwritingAssociateCode = 'N/A' AND i_PolicyOfferingCode = '000', '0999',\n\t    LTRIM(RTRIM(v_UnderwritingAssociateCode))\n\t) AS o_UnderwritingAssociateCode,\n\tSYSDATE AS o_modified_date\n\tFROM EXP_Policy_AgencyRelationship\n\tLEFT JOIN LKP_Agency_V2\n\tON LKP_Agency_V2.AgencyAKID = EXP_Policy_AgencyRelationship.o_AgencyAKId\n\tLEFT JOIN LKP_InsuranceSegment\n\tON LKP_InsuranceSegment.InsuranceSegmentAKId = EXP_Policy_AgencyRelationship.o_InsuranceSegmentAKId\n\tLEFT JOIN LKP_PolicyOffering\n\tON LKP_PolicyOffering.PolicyOfferingAKId = EXP_Policy_AgencyRelationship.o_PolicyOfferingAKID\n\tLEFT JOIN LKP_Program\n\tON LKP_Program.ProgramAKId = EXP_Policy_AgencyRelationship.o_ProgramAKID\n\tLEFT JOIN LKP_StrategicProfitCenter\n\tON LKP_StrategicProfitCenter.StrategicProfitCenterAKId = EXP_Policy_AgencyRelationship.o_StrategicProfitCenterAKId\n\tLEFT JOIN LKP_UNDERWRITERWORKCOMPPOOL LKP_UNDERWRITERWORKCOMPPOOL_1\n\tON LKP_UNDERWRITERWORKCOMPPOOL_1.Dummy = 1\n\n\tLEFT JOIN LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGENCY LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGENCY_i_StrategicProfitCenterCode_i_AgencyCode\n\tON LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGENCY_i_StrategicProfitCenterCode_i_AgencyCode.StrategicProfitCenterCode = i_StrategicProfitCenterCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGENCY_i_StrategicProfitCenterCode_i_AgencyCode.AgencyCode = i_AgencyCode\n\n\tLEFT JOIN LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPC LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPC_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount\n\tON LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPC_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount.StrategicProfitCenterCode = i_StrategicProfitCenterCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPC_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount.AgencyCode = i_AgencyCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPC_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount.PolicyAmountMinimum = i_PremiumTransactionAmount\n\n\tLEFT JOIN LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode\n\tON LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode.StrategicProfitCenterCode = i_StrategicProfitCenterCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode.AgencyCode = i_AgencyCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode.PolicyAmountMinimum = i_PremiumTransactionAmount\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode.PolicyAmountMaximum = i_PolicyOfferingCode\n\n\tLEFT JOIN LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode\n\tON LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode.StrategicProfitCenterCode = i_StrategicProfitCenterCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode.AgencyCode = i_AgencyCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode.PolicyAmountMinimum = i_PremiumTransactionAmount\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode.PolicyAmountMaximum = i_PolicyOfferingCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode.PolicyOfferingCode = i_ProgramCode\n\n\tLEFT JOIN LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Rapid\n\tON LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Rapid.StrategicProfitCenterCode = i_StrategicProfitCenterCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Rapid.AgencyCode = i_AgencyCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Rapid.PolicyAmountMinimum = i_PremiumTransactionAmount\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Rapid.PolicyAmountMaximum = i_PolicyOfferingCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Rapid.PolicyOfferingCode = i_ProgramCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Rapid.ProgramCode = 'Rapid'\n\n\tLEFT JOIN LKP_BONDPRODUCTS LKP_BONDPRODUCTS_i_pol_id\n\tON LKP_BONDPRODUCTS_i_pol_id.pol_id = i_pol_id\n\n\tLEFT JOIN LKP_SBAREINSURANCE LKP_SBAREINSURANCE_i_pol_id_0125\n\tON LKP_SBAREINSURANCE_i_pol_id_0125.pol_id = i_pol_id\n\tAND LKP_SBAREINSURANCE_i_pol_id_0125.reins_co_num = '0125'\n\n\tLEFT JOIN LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_SBA\n\tON LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_SBA.StrategicProfitCenterCode = i_StrategicProfitCenterCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_SBA.AgencyCode = i_AgencyCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_SBA.PolicyAmountMinimum = i_PremiumTransactionAmount\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_SBA.PolicyAmountMaximum = i_PolicyOfferingCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_SBA.PolicyOfferingCode = i_ProgramCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_SBA.ProgramCode = 'SBA'\n\n\tLEFT JOIN LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Contract\n\tON LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Contract.StrategicProfitCenterCode = i_StrategicProfitCenterCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Contract.AgencyCode = i_AgencyCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Contract.PolicyAmountMinimum = i_PremiumTransactionAmount\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Contract.PolicyAmountMaximum = i_PolicyOfferingCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Contract.PolicyOfferingCode = i_ProgramCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Contract.ProgramCode = 'Contract'\n\n\tLEFT JOIN LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Non_Contract\n\tON LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Non_Contract.StrategicProfitCenterCode = i_StrategicProfitCenterCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Non_Contract.AgencyCode = i_AgencyCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Non_Contract.PolicyAmountMinimum = i_PremiumTransactionAmount\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Non_Contract.PolicyAmountMaximum = i_PolicyOfferingCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Non_Contract.PolicyOfferingCode = i_ProgramCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_i_PremiumTransactionAmount_i_PolicyOfferingCode_i_ProgramCode_Non_Contract.ProgramCode = 'Non-Contract'\n\n),\nLKP_UnderwriterAssociate AS (\n\tSELECT\n\tUnderwritingAssociateAKID,\n\tUnderwriterCode\n\tFROM (\n\t\tSELECT \n\t\t\tUnderwritingAssociateAKID,\n\t\t\tUnderwriterCode\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwritingAssociate\n\t\tWHERE CurrentSnapshotFlag=1 and AssociateRole in ('UNDERWRITER','CUSTOM UNDERWRITER')\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY UnderwriterCode ORDER BY UnderwritingAssociateAKID DESC) = 1\n),\nEXP_MetaValues AS (\n\tSELECT\n\tEXP_Policy_ProductRelationship.o_pol_id AS pol_id,\n\tLKP_UnderwriterAssociate.UnderwritingAssociateAKID,\n\tEXP_Policy_ProductRelationship.o_modified_date AS modified_date\n\tFROM EXP_Policy_ProductRelationship\n\tLEFT JOIN LKP_UnderwriterAssociate\n\tON LKP_UnderwriterAssociate.UnderwriterCode = EXP_Policy_ProductRelationship.o_UnderwritingAssociateCode\n),\nLKP_Tgt_Policy AS (\n\tSELECT\n\tUnderwritingAssociateAKId,\n\to_pol_id,\n\tpol_id\n\tFROM (\n\t\tSELECT policy.UnderwritingAssociateAKId as UnderwritingAssociateAKId, policy.pol_id as pol_id \r\n\t\tFROM v2.policy\r\n\t\tWHERE crrnt_snpsht_flag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY pol_id ORDER BY UnderwritingAssociateAKId) = 1\n),\nFIL_Valid_UnderwritingAssociateAKId AS (\n\tSELECT\n\tEXP_MetaValues.pol_id, \n\tEXP_MetaValues.UnderwritingAssociateAKID AS UnderwritingAssociateAKId, \n\tLKP_Tgt_Policy.UnderwritingAssociateAKId AS UnderwritingAssociateAKId_old, \n\tEXP_MetaValues.modified_date\n\tFROM EXP_MetaValues\n\tLEFT JOIN LKP_Tgt_Policy\n\tON LKP_Tgt_Policy.pol_id = EXP_MetaValues.pol_id\n\tWHERE UnderwritingAssociateAKId<>UnderwritingAssociateAKId_old\n),\nUPD_UnderwritingAssociateAKId AS (\n\tSELECT\n\tpol_id, \n\tmodified_date, \n\tUnderwritingAssociateAKId\n\tFROM FIL_Valid_UnderwritingAssociateAKId\n),\nTGT_policy_Update AS (\n\n\t------------ PRE SQL ----------\n\texec [spSetIndexStatus] @Enable = 0, @Schema = 'V2', @TableName = 'POLICY', @IndexWildcard = 'Ak3Policy'\n\t-------------------------------\n\n\n\tMERGE INTO @{pipeline().parameters.SOURCE_TABLE_OWNER_V2}.policy AS T\n\tUSING UPD_UnderwritingAssociateAKId AS S\n\tON T.pol_id = S.pol_id\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.modified_date = S.modified_date, T.UnderwritingAssociateAKId = S.UnderwritingAssociateAKId\n\n\t------------ POST SQL ----------\n\texec [spSetIndexStatus] @Enable = 1, @Schema = 'V2', @TableName = 'POLICY', @IndexWildcard = 'Ak3Policy'\n\t-------------------------------\n\n\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "SOURCE_TABLE_OWNER_V2": {
                "type": "string",
                "defaultValue": "Default Value"
            }
        },
        "folder": {
            "name": "RPT_EDM and EDW/Policy DataWarehouse/"
        },
        "annotations": []
    }
}