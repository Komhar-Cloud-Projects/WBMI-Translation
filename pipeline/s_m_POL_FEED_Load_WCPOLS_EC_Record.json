{
    "name": "s_m_POL_FEED_Load_WCPOLS_EC_Record",
    "properties": {
        "activities": [
            {
                "name": "m_POL_FEED_Load_WCPOLS_EC_Record",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nSQ_WorkWCTrackHistory AS (\n\tSELECT \r\n\tTrack.WCTrackHistoryID as WCTrackHistoryID, \r\n\tCase When SubString(Forms.FormName,1,8) in ( 'WC480314','WC480315','WC480317') then SubString(Forms.FormName,1,8) END as ParsedFormName,\r\n\tForms.FormName as FormName,\r\n\tParty.Name as Name,\r\n\tPolicy.TransactionEffectiveDate as TransactionEffectiveDate,\r\n\tDetail.Attribute, Detail.Value, Detail.ProcessID as ProcessID \r\n\tFROM\r\n\tWorkWCForms Forms\r\n\tinner join WorkWCTrackHistory Track \ton \r\n\t\tForms.WCTrackHistoryID=Track.WCTrackHistoryID and \r\n\t\t(Forms.FormName like 'WC480314%' or  \r\n\t\t Forms.FormName like 'WC480315%' or \r\n\t\t Forms.FormName like 'WC480317%')\r\n\t\tand \r\n\t\t((Forms.OnPolicy=1 OR Forms.[Add] = 1) AND (Forms.Remove is null OR Forms.Remove = 0))\r\n\tinner join WorkWCParty Party on \r\n\t\tParty.WCTrackHistoryID=Track.WCTrackHistoryID AND \r\n\t\tParty.PartyAssociationType='Account'\r\n\tinner join WorkWCPolicy Policy on \r\n\t\tPolicy.WCTrackHistoryID=Track.WCTrackHistoryID\r\n\tinner join WorkWCPolicyDetails Detail on \r\n\t\tpolicy.WCTrackHistoryID=Detail.WCTrackHistoryID and policy.PolicyId=Detail.PolicyID\r\n\t\tand Detail.Attribute in ('IncludedClientName', 'IncludedClientAddress', 'ClientFEINNumber', 'EstimatedPremium', 'ClientNameEmployeeLeasing', 'ClientFEINNumberEmployeeLeasing', 'ClientAddressEmployeeLeasing', 'LaborContractorAddress', 'LaborContractor')\r\n\tWHERE\r\n\tForms.Auditid = @{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID}\r\n\t@{pipeline().parameters.WHERE_CLAUSE_EC}\n),\nAGG_AlignWithPolicyDetails AS (\n\tSELECT\n\tWCTrackHistoryID,\n\tParsedFormName,\n\tFormName,\n\tName,\n\tTransactionEffectiveDate,\n\tProcessID,\n\tAttribute,\n\tValue,\n\t-- *INF*: MAX(Value,Attribute='IncludedClientName')\n\tMAX(Value, Attribute = 'IncludedClientName') AS IncludedClientName,\n\t-- *INF*: MAX(Value,Attribute='IncludedClientAddress')\r\n\t-- \n\tMAX(Value, Attribute = 'IncludedClientAddress') AS IncludedClientAddress,\n\t-- *INF*: MAX(Value,Attribute='ClientFEINNumber')\r\n\t-- \n\tMAX(Value, Attribute = 'ClientFEINNumber') AS ClientFEINNumber,\n\t-- *INF*: MAX(Value,Attribute='EstimatedPremium')\n\tMAX(Value, Attribute = 'EstimatedPremium') AS EstimatedPremium,\n\t-- *INF*: MAX(Value,Attribute='ClientNameEmployeeLeasing')\r\n\t-- \n\tMAX(Value, Attribute = 'ClientNameEmployeeLeasing') AS ClientNameEmployeeLeasing,\n\t-- *INF*: MAX(Value,Attribute='ClientFEINNumberEmployeeLeasing')\r\n\t-- \n\tMAX(Value, Attribute = 'ClientFEINNumberEmployeeLeasing') AS ClientFEINNumberEmployeeLeasing,\n\t-- *INF*: MAX(Value,Attribute='ClientAddressEmployeeLeasing')\r\n\t-- \n\tMAX(Value, Attribute = 'ClientAddressEmployeeLeasing') AS ClientAddressEmployeeLeasing,\n\t-- *INF*: MAX(Value,Attribute='LaborContractorAddress')\r\n\t-- \n\tMAX(Value, Attribute = 'LaborContractorAddress') AS LaborContractorAddress,\n\t-- *INF*: MAX(Value,Attribute='LaborContractor')\r\n\t-- \n\tMAX(Value, Attribute = 'LaborContractor') AS LaborContractor\n\tFROM SQ_WorkWCTrackHistory\n\tGROUP BY WCTrackHistoryID, ParsedFormName, FormName, Name, TransactionEffectiveDate, ProcessID\n),\nEXP_applyrules AS (\n\tSELECT\n\tWCTrackHistoryID,\n\tParsedFormName,\n\tFormName,\n\tName,\n\tTransactionEffectiveDate,\n\tProcessID AS FormIterationID,\n\tIncludedClientName,\n\tIncludedClientAddress,\n\tClientFEINNumber,\n\tEstimatedPremium,\n\tClientNameEmployeeLeasing,\n\tClientFEINNumberEmployeeLeasing,\n\tClientAddressEmployeeLeasing,\n\tLaborContractorAddress,\n\tLaborContractor,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ParsedFormName='WC480314',IncludedClientName,\r\n\t-- ParsedFormName='WC480315',ClientNameEmployeeLeasing,\r\n\t-- ParsedFormName='WC480317',LaborContractor,\r\n\t-- '')\n\tDECODE(\n\t    TRUE,\n\t    ParsedFormName = 'WC480314', IncludedClientName,\n\t    ParsedFormName = 'WC480315', ClientNameEmployeeLeasing,\n\t    ParsedFormName = 'WC480317', LaborContractor,\n\t    ''\n\t) AS v_NameOfClientOrNameOfLaborContractor,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ParsedFormName='WC480314',ClientFEINNumber,\r\n\t-- ParsedFormName='WC480315',ClientFEINNumberEmployeeLeasing,\r\n\t-- '')\n\tDECODE(\n\t    TRUE,\n\t    ParsedFormName = 'WC480314', ClientFEINNumber,\n\t    ParsedFormName = 'WC480315', ClientFEINNumberEmployeeLeasing,\n\t    ''\n\t) AS v_FederalEmployerIdentificationNumber,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ParsedFormName='WC480314',LPAD(EstimatedPremium,10,'0'),\r\n\t-- '')\n\tDECODE(\n\t    TRUE,\n\t    ParsedFormName = 'WC480314', LPAD(EstimatedPremium, 10, '0'),\n\t    ''\n\t) AS v_ClientPremiumAmount,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ParsedFormName='WC480314',IncludedClientAddress,\r\n\t-- ParsedFormName='WC480315',ClientAddressEmployeeLeasing,\r\n\t-- ParsedFormName='WC480317',LaborContractorAddress,\r\n\t-- '')\r\n\t-- -- determine which record address to use\n\tDECODE(\n\t    TRUE,\n\t    ParsedFormName = 'WC480314', IncludedClientAddress,\n\t    ParsedFormName = 'WC480315', ClientAddressEmployeeLeasing,\n\t    ParsedFormName = 'WC480317', LaborContractorAddress,\n\t    ''\n\t) AS v_Address_Base,\n\tv_Address_Base AS o_Address,\n\t',' AS AddressDelimiter,\n\tv_NameOfClientOrNameOfLaborContractor AS o_NameOfClientOrNameOfLaborContractor,\n\tv_ClientPremiumAmount AS o_ClientPremiumAmount,\n\tv_FederalEmployerIdentificationNumber AS o_FederalEmployerIdentificationNumber\n\tFROM AGG_AlignWithPolicyDetails\n),\njtx_split_string AS (-- jtx_split_string\n\n\t##############################################\n\n\t# TODO: Place holder for Custom transformation\n\n\t##############################################\n),\nEXP_Address_Check_And_Passthrough AS (\n\tSELECT\n\tEXP_applyrules.o_Address AS i_FullAddress,\n\tjtx_split_string.OUTPUT_Field1 AS i_StreetAddress,\n\tjtx_split_string.OUTPUT_Field2 AS i_City,\n\tjtx_split_string.OUTPUT_Field3 AS i_State,\n\tjtx_split_string.OUTPUT_Field4 AS i_Zip,\n\t-- *INF*: IIF(NOT ISNULL(i_StreetAddress) AND NOT ISNULL(i_City) AND NOT ISNULL(i_State) AND NOT ISNULL(i_Zip),1,0)\n\tIFF(\n\t    i_StreetAddress IS NULL\n\t    and i_City IS NULL\n\t    and i_State IS NULL\n\t    and i_Zip IS NOT NOT NOT NOT NULL,\n\t    1,\n\t    0\n\t) AS v_AddressFieldsPopulated,\n\t-- *INF*: IIF(v_AddressFieldsPopulated=1,rtrim(ltrim(i_StreetAddress)),i_FullAddress)\n\tIFF(v_AddressFieldsPopulated = 1, rtrim(ltrim(i_StreetAddress)), i_FullAddress) AS o_StreetAddress,\n\t-- *INF*: IIF(v_AddressFieldsPopulated=1,rtrim(ltrim(i_City)),'')\n\tIFF(v_AddressFieldsPopulated = 1, rtrim(ltrim(i_City)), '') AS o_City,\n\t-- *INF*: IIF(v_AddressFieldsPopulated=1,rtrim(ltrim(i_State)),'')\n\tIFF(v_AddressFieldsPopulated = 1, rtrim(ltrim(i_State)), '') AS o_State,\n\t-- *INF*: IIF(v_AddressFieldsPopulated=1,rtrim(ltrim(i_Zip)),'')\n\tIFF(v_AddressFieldsPopulated = 1, rtrim(ltrim(i_Zip)), '') AS o_Zip,\n\tEXP_applyrules.WCTrackHistoryID,\n\tEXP_applyrules.ParsedFormName,\n\tEXP_applyrules.FormName,\n\tEXP_applyrules.Name,\n\tEXP_applyrules.TransactionEffectiveDate,\n\tEXP_applyrules.o_NameOfClientOrNameOfLaborContractor AS NameOfClientOrNameOfLaborContractor,\n\tEXP_applyrules.o_ClientPremiumAmount AS ClientPremiumAmount,\n\tEXP_applyrules.o_FederalEmployerIdentificationNumber AS FederalEmployerIdentificationNumber\n\tFROM EXP_applyrules\n\t -- Manually join with jtx_split_string\n),\nSQ_WCPols00Record AS (\n\tSELECT\r\n\t\tWCTrackHistoryID,\r\n\t\tLinkData,\r\n\t      AuditId\r\n\tFROM dbo.WCPols00Record\r\n\tWHERE \r\n\t AuditId = @{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID}\r\n\tORDER BY WCTrackHistoryID\n),\nJNR_DataCollect AS (SELECT\n\tSQ_WCPols00Record.WCTrackHistoryID, \n\tSQ_WCPols00Record.LinkData, \n\tSQ_WCPols00Record.AuditId, \n\tEXP_Address_Check_And_Passthrough.WCTrackHistoryID AS WCTrackHistoryID1, \n\tEXP_Address_Check_And_Passthrough.ParsedFormName, \n\tEXP_Address_Check_And_Passthrough.FormName, \n\tEXP_Address_Check_And_Passthrough.Name, \n\tEXP_Address_Check_And_Passthrough.TransactionEffectiveDate, \n\tEXP_Address_Check_And_Passthrough.NameOfClientOrNameOfLaborContractor, \n\tEXP_Address_Check_And_Passthrough.ClientPremiumAmount, \n\tEXP_Address_Check_And_Passthrough.o_StreetAddress AS AddressStreet, \n\tEXP_Address_Check_And_Passthrough.o_City AS AddressCity, \n\tEXP_Address_Check_And_Passthrough.o_State AS AddressState, \n\tEXP_Address_Check_And_Passthrough.o_Zip AS AddressZipcode, \n\tEXP_Address_Check_And_Passthrough.FederalEmployerIdentificationNumber\n\tFROM SQ_WCPols00Record\n\tINNER JOIN EXP_Address_Check_And_Passthrough\n\tON EXP_Address_Check_And_Passthrough.WCTrackHistoryID = SQ_WCPols00Record.WCTrackHistoryID\n),\nmplt_Parse_FormNameField AS (WITH\n\tINPUT_FormName AS (\n\t\t\n\t),\n\tEXPTRANS AS (\n\t\tSELECT\n\t\tParsedNameOfForm,\n\t\tFormNameFromSource,\n\t\t-- *INF*: REVERSE(FormNameFromSource)\n\t\tREVERSE(FormNameFromSource) AS vReversedFromNameFromSource,\n\t\t-- *INF*: REVERSE(substr(vReversedFromNameFromSource,1,4))\n\t\tREVERSE(substr(vReversedFromNameFromSource, 1, 4)) AS vFormEdition,\n\t\t-- *INF*: DECODE(TRUE,\r\n\t\t-- substr(vReversedFromNameFromSource,5,1) >='A' and substr(vReversedFromNameFromSource,5,1) <='Z', substr(vReversedFromNameFromSource,5,1),\r\n\t\t-- ' '\r\n\t\t-- )\r\n\t\t-- \r\n\t\t-- -- check if within A and Z, if not then space\n\t\tDECODE(\n\t\t    TRUE,\n\t\t    substr(vReversedFromNameFromSource, 5, 1) >= 'A' and substr(vReversedFromNameFromSource, 5, 1) <= 'Z', substr(vReversedFromNameFromSource, 5, 1),\n\t\t    ' '\n\t\t) AS vBureauCode,\n\t\tvFormEdition AS oFormEdition,\n\t\tvBureauCode AS oBureauCode\n\t\tFROM INPUT_FormName\n\t),\n\tOUTPUT_FormName AS (\n\t\tSELECT\n\t\tParsedNameOfForm, \n\t\tFormNameFromSource, \n\t\toFormEdition AS FormEdition, \n\t\toBureauCode AS BureauCode\n\t\tFROM EXPTRANS\n\t),\n),\nEXP_PrepareOutput AS (\n\tSELECT\n\tCURRENT_TIMESTAMP AS ExtractDate,\n\tJNR_DataCollect.AuditId,\n\tJNR_DataCollect.WCTrackHistoryID,\n\tJNR_DataCollect.LinkData,\n\t'EC' AS RecordTypeCode,\n\tmplt_Parse_FormNameField.ParsedNameOfForm1,\n\tmplt_Parse_FormNameField.BureauCode,\n\tmplt_Parse_FormNameField.FormEdition,\n\tJNR_DataCollect.NameOfClientOrNameOfLaborContractor,\n\tJNR_DataCollect.ClientPremiumAmount,\n\tJNR_DataCollect.Name,\n\tJNR_DataCollect.TransactionEffectiveDate AS i_TransactionEffectiveDate,\n\t-- *INF*: TO_CHAR(i_TransactionEffectiveDate,'YYMMDD')\n\tTO_CHAR(i_TransactionEffectiveDate, 'YYMMDD') AS o_TransactionEffectiveDate,\n\tJNR_DataCollect.AddressStreet,\n\tJNR_DataCollect.AddressCity,\n\tJNR_DataCollect.AddressState,\n\tJNR_DataCollect.AddressZipcode,\n\tJNR_DataCollect.FederalEmployerIdentificationNumber,\n\t'48' AS o_StateCode\n\tFROM JNR_DataCollect\n\t -- Manually join with mplt_Parse_FormNameField\n),\nWCPolsECRecord AS (\n\n\t------------ PRE SQL ----------\n\tDELETE\r\n\t  FROM dbo.WCPolsECRecord\r\n\t  WHERE 1=1\r\n\t  AND AuditId = @{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID}\n\t-------------------------------\n\n\n\tINSERT INTO WCPolsECRecord\n\t(ExtractDate, AuditId, WCTrackHistoryID, LinkData, StateCode, RecordTypeCode, EndorsementNumber, BureauVersionIdentifierEditionIdentifier, CarrierVersionIdentifier, NameOfClientOrNameOfLaborContractor, AddressStreet, AddressCity, AddressState, AddressZipcode, FederalEmployerIdentificationNumber, ClientPremiumAmount, NameOfInsured, EndorsementEffectiveDate)\n\tSELECT \n\tEXTRACTDATE, \n\tAUDITID, \n\tWCTRACKHISTORYID, \n\tLINKDATA, \n\to_StateCode AS STATECODE, \n\tRECORDTYPECODE, \n\tParsedNameOfForm1 AS ENDORSEMENTNUMBER, \n\tBureauCode AS BUREAUVERSIONIDENTIFIEREDITIONIDENTIFIER, \n\tFormEdition AS CARRIERVERSIONIDENTIFIER, \n\tNAMEOFCLIENTORNAMEOFLABORCONTRACTOR, \n\tADDRESSSTREET, \n\tADDRESSCITY, \n\tADDRESSSTATE, \n\tADDRESSZIPCODE, \n\tFEDERALEMPLOYERIDENTIFICATIONNUMBER, \n\tCLIENTPREMIUMAMOUNT, \n\tName AS NAMEOFINSURED, \n\to_TransactionEffectiveDate AS ENDORSEMENTEFFECTIVEDATE\n\tFROM EXP_PrepareOutput\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WHERE_CLAUSE_EC": {
                "type": "string",
                "defaultValue": "Default Value"
            }
        },
        "folder": {
            "name": "PolicyDataServices/"
        },
        "annotations": []
    }
}