{
    "name": "s_m_POL_DW_LOAD_CoverageDetailCommercialUmbrella_DCT",
    "properties": {
        "activities": [
            {
                "name": "m_POL_DW_LOAD_CoverageDetailCommercialUmbrella_DCT",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nSQ_DCCUUmbrella AS (\n\twith DCCOVERAGE as \r\n\t(\r\n\t SELECT sessionid,\r\n\t       lineid,\r\n\t       NULL             AS BO_Description,\r\n\t       NULL             AS BO_PolicyNumber,\r\n\t       NULL             AS CA_Description,\r\n\t       NULL             AS CA_PolicyNumber,\r\n\t       UMEL.description  AS EL_Description,\r\n\t       UMEL.policynumber AS EL_PolicyNumber,\r\n\t       NULL             AS GL_Description,\r\n\t       NULL             AS GL_PolicyNumber,\r\n\t       NULL             AS SMART_Description,\r\n\t       NULL             AS SMART_PolicyNumber,\r\n\t       NULL             AS SBOP_Description,\r\n\t       NULL             AS SBOP_PolicyNumber,\r\n\t       NULL              AS RetroDate\r\n\tFROM   @{pipeline().parameters.SOURCE_TABLE_OWNER}.dccuumbrellaemployersliabilitystaging UMEL\r\n\tUNION ALL\r\n\tSELECT sessionid,\r\n\t       lineid,\r\n\t       NULL             AS BO_Description,\r\n\t       NULL             AS BO_PolicyNumber,\r\n\t       UMCA.description  AS CA_Description,\r\n\t       UMCA.policynumber AS CA_PolicyNumber,\r\n\t       NULL             AS EL_Description,\r\n\t       NULL             AS EL_PolicyNumber,\r\n\t       NULL             AS GL_Description,\r\n\t       NULL             AS GL_PolicyNumber,\r\n\t       NULL             AS SMART_Description,\r\n\t       NULL             AS SMART_PolicyNumber,\r\n\t       NULL             AS SBOP_Description,\r\n\t       NULL             AS SBOP_PolicyNumber,\r\n\t       NULL              AS RetroDate\r\n\tFROM   @{pipeline().parameters.SOURCE_TABLE_OWNER}.dccuumbrellacommercialautostaging UMCA\r\n\tUNION ALL\r\n\tSELECT sessionid,\r\n\t       lineid,\r\n\t       UMBO.description  AS BO_Description,\r\n\t       UMBO.policynumber AS BO_PolicyNumber,\r\n\t       NULL             AS CA_Description,\r\n\t       NULL             AS CA_PolicyNumber,\r\n\t       NULL             AS EL_Description,\r\n\t       NULL             AS EL_PolicyNumber,\r\n\t       NULL             AS GL_Description,\r\n\t       NULL             AS GL_PolicyNumber,\r\n\t       NULL             AS SMART_Description,\r\n\t       NULL             AS SMART_PolicyNumber,\r\n\t       NULL             AS SBOP_Description,\r\n\t       NULL             AS SBOP_PolicyNumber,\r\n\t       NULL              AS RetroDate\r\n\tFROM   @{pipeline().parameters.SOURCE_TABLE_OWNER}.dccuumbrellabusinessownersstaging UMBO\r\n\tUNION ALL\r\n\tSELECT UMGL.sessionid,\r\n\t       lineid,\r\n\t       NULL             AS BO_Description,\r\n\t       NULL             AS BO_PolicyNumber,\r\n\t       NULL             AS CA_Description,\r\n\t       NULL             AS CA_PolicyNumber,\r\n\t       NULL             AS EL_Description,\r\n\t       NULL             AS EL_PolicyNumber,\r\n\t       UMGL.description  AS GL_Description,\r\n\t       UMGL.policynumber AS GL_PolicyNumber,\r\n\t       NULL             AS SMART_Description,\r\n\t       NULL             AS SMART_PolicyNumber,\r\n\t       NULL             AS SBOP_Description,\r\n\t       NULL             AS SBOP_PolicyNumber,\r\n\t       WMGL.retrodate\r\n\tFROM   @{pipeline().parameters.SOURCE_TABLE_OWNER}.dccuumbrellageneralliabilitystaging UMGL\r\n\t       LEFT JOIN @{pipeline().parameters.SOURCE_TABLE_OWNER}.wbcuumbrellageneralliabilitystaging WMGL\r\n\t              ON\r\n\t       UMGL.cu_umbrellageneralliabilityid = WMGL.cu_umbrellageneralliabilityid\r\n\t       AND UMGL.sessionid = WMGL.sessionid\r\n\tUNION ALL\r\n\tSELECT sessionid,\r\n\t       lineid,\r\n\t       NULL              AS BO_Description,\r\n\t       NULL              AS BO_PolicyNumber,\r\n\t       NULL              AS CA_Description,\r\n\t       NULL              AS CA_PolicyNumber,\r\n\t       NULL              AS EL_Description,\r\n\t       NULL              AS EL_PolicyNumber,\r\n\t       NULL              AS GL_Description,\r\n\t       NULL              AS GL_PolicyNumber,\r\n\t       WBSMT.description  AS SMART_Description,\r\n\t       WBSMT.policynumber AS SMART_PolicyNumber,\r\n\t       NULL              AS SBOP_Description,\r\n\t       NULL              AS SBOP_PolicyNumber,\r\n\t       NULL               AS RetroDate\r\n\tFROM   @{pipeline().parameters.SOURCE_TABLE_OWNER}.wbcuumbrellasmartbusinessstage WBSMT\r\n\tUNION ALL\r\n\tSELECT sessionid,\r\n\t       lineid,\r\n\t       NULL               AS BO_Description,\r\n\t       NULL               AS BO_PolicyNumber,\r\n\t       NULL               AS CA_Description,\r\n\t       NULL               AS CA_PolicyNumber,\r\n\t       NULL               AS EL_Description,\r\n\t       NULL               AS EL_PolicyNumber,\r\n\t       NULL               AS GL_Description,\r\n\t       NULL               AS GL_PolicyNumber,\r\n\t       NULL               AS SMART_Description,\r\n\t       NULL               AS SMART_PolicyNumber,\r\n\t       WBSBOP.description  AS SBOP_Description,\r\n\t       WBSBOP.policynumber AS SBOP_PolicyNumber,\r\n\t       NULL                AS RetroDate\r\n\tFROM   @{pipeline().parameters.SOURCE_TABLE_OWNER}.wbcuumbrellasbopstage WBSBOP  \r\n\t)\r\n\tselect PT.PremiumTransactionID ,  wUPT.CoverageGUID, \r\n\tDCCOVERAGE.BO_Description as BO_Description,\r\n\tDCCOVERAGE.BO_PolicyNumber as BO_PolicyNumber,\r\n\tDCCOVERAGE.CA_Description as CA_Description,\r\n\tDCCOVERAGE.CA_PolicyNumber as CA_PolicyNumber,\r\n\tDCCOVERAGE.EL_Description as EL_Description,\r\n\tDCCOVERAGE.EL_PolicyNumber as EL_PolicyNumber,\r\n\tDCCOVERAGE.GL_Description as GL_Description,\r\n\tDCCOVERAGE.GL_PolicyNumber as GL_PolicyNumber,\r\n\tDCCOVERAGE.SMART_Description as SMART_Description,\r\n\tDCCOVERAGE.SMART_PolicyNumber as SMART_PolicyNumber,\r\n\tDCCOVERAGE.SBOP_Description as SBOP_Description,\r\n\tDCCOVERAGE.SBOP_PolicyNumber as SBOP_PolicyNumber,\r\n\tDCCOVERAGE.RetroDate as RetroDate,\r\n\tCUPD.Million \r\n\tFROM \r\n\t@{pipeline().parameters.TARGET_DATABASE_NAME}.@{pipeline().parameters.TARGET_TABLE_OWNER}.PremiumTransaction PT  \r\n\tinner join @{pipeline().parameters.TARGET_DATABASE_NAME}.@{pipeline().parameters.TARGET_TABLE_OWNER}.WorkPremiumTransaction WPT\r\n\ton PT.PremiumTransactionAKID = WPT.PremiumTransactionAKId and PT.SourceSystemId='DCT' \r\n\tinner join @{pipeline().parameters.SOURCE_TABLE_OWNER}.WorkDCTCoverageTransaction wUPT on WPT.PremiumTransactionStageId =wUPT.CoverageId\r\n\tinner join @{pipeline().parameters.SOURCE_TABLE_OWNER}.WorkDCTTransactionInsuranceLineLocationBridge a on a.CoverageId=wUPT.CoverageId\r\n\tleft join DCCoverage on DCCoverage.LineId=a.LineId\r\n\tleft join @{pipeline().parameters.SOURCE_TABLE_OWNER}.WBCUPremiumDetailStage CUPD on wUPT.ParentCoverageObjectName='WB_CU_PremiumDetail'\r\n\tand CUPD.WBCUPremiumDetailId=wUPT.ParentCoverageObjectId\r\n\twhere PT.CreatedDate>='@{pipeline().parameters.SELECTION_START_TS}'\r\n\t@{pipeline().parameters.WHERE_CLAUSE}\n),\nAGG_Umbrella AS (\n\tSELECT\n\tPremiumTransactionID,\n\tId AS CoverageGUID,\n\tBO_Description,\n\t-- *INF*: MAX(BO_Description)\n\tMAX(BO_Description) AS o_BO_Description,\n\tBO_PolicyNumber,\n\t-- *INF*: MAX(BO_PolicyNumber)\n\tMAX(BO_PolicyNumber) AS o_BO_PolicyNumber,\n\tCA_Description,\n\t-- *INF*: MAX(CA_Description)\r\n\t-- \n\tMAX(CA_Description) AS o_CA_Description,\n\tCA_PolicyNumber,\n\t-- *INF*: MAX(CA_PolicyNumber)\n\tMAX(CA_PolicyNumber) AS o_CA_PolicyNumber,\n\tEL_Description,\n\t-- *INF*: MAX(EL_Description)\n\tMAX(EL_Description) AS o_EL_Description,\n\tEL_PolicyNumber,\n\t-- *INF*: MAX(EL_PolicyNumber)\n\tMAX(EL_PolicyNumber) AS o_EL_PolicyNumber,\n\tGL_Description,\n\t-- *INF*: MAX(GL_Description)\n\tMAX(GL_Description) AS o_GL_Description,\n\tGL_PolicyNumber,\n\t-- *INF*: MAX(GL_PolicyNumber)\n\tMAX(GL_PolicyNumber) AS o_GL_PolicyNumber,\n\tSMART_Description,\n\t-- *INF*: MAX(SMART_Description)\n\tMAX(SMART_Description) AS o_SMART_Description,\n\tSMART_PolicyNumber,\n\t-- *INF*: max(SMART_PolicyNumber)\n\tmax(SMART_PolicyNumber) AS o_SMART_PolicyNumber,\n\tSBOP_Description,\n\t-- *INF*: max(SBOP_Description)\n\tmax(SBOP_Description) AS o_SBOP_Description,\n\tSBOP_PolicyNumber,\n\t-- *INF*: MAX(SBOP_PolicyNumber)\n\tMAX(SBOP_PolicyNumber) AS o_SBOP_PolicyNumber,\n\tRetroDate,\n\t-- *INF*: MAX(RetroDate)\n\tMAX(RetroDate) AS o_RetroDate,\n\tMillion,\n\t-- *INF*: MAX(Million)\n\tMAX(Million) AS o_Million\n\tFROM SQ_DCCUUmbrella\n\tGROUP BY PremiumTransactionID\n),\nEXP_DefaultValue AS (\n\tSELECT\n\tPremiumTransactionID AS i_PremiumTransactionID,\n\tCoverageGUID AS i_CoverageGuid,\n\to_BO_Description AS i_BO_Description,\n\to_BO_PolicyNumber AS i_BO_PolicyNumber,\n\to_CA_Description AS i_CA_Description,\n\to_CA_PolicyNumber AS i_CA_PolicyNumber,\n\to_EL_Description AS i_EL_Description,\n\to_EL_PolicyNumber AS i_EL_PolicyNumber,\n\to_GL_Description AS i_GL_Description,\n\to_GL_PolicyNumber AS i_GL_PolicyNumber,\n\to_SMART_Description AS i_SMART_Description,\n\to_SMART_PolicyNumber AS i_SMART_PolicyNumber,\n\to_SBOP_Description AS i_SBOP_Description,\n\to_SBOP_PolicyNumber AS i_SBOP_PolicyNumber,\n\to_RetroDate AS i_RetroActiveDate,\n\to_Million AS i_Million,\n\ti_PremiumTransactionID AS o_PremiumTransactionID,\n\t1 AS o_CurrentSnapshotFlag,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS o_AuditID,\n\t-- *INF*: TO_DATE('01/01/1800 00:00:00','MM/DD/YYYY HH24:MI:SS')\n\tTO_TIMESTAMP('01/01/1800 00:00:00', 'MM/DD/YYYY HH24:MI:SS') AS o_EffectiveDate,\n\t-- *INF*: TO_DATE('12/31/2100 23:59:59','MM/DD/YYYY HH24:MI:SS')\n\tTO_TIMESTAMP('12/31/2100 23:59:59', 'MM/DD/YYYY HH24:MI:SS') AS o_ExpirationDate,\n\t@{pipeline().parameters.SOURCE_SYSTEM_ID} AS o_SourceSystemID,\n\tSYSDATE AS o_CreatedDate,\n\tSYSDATE AS o_ModifiedDate,\n\ti_CoverageGuid AS o_CoverageGuid,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(i_EL_Description)\n\tUDF_DEFAULT_VALUE_FOR_STRINGS(i_EL_Description) AS o_UmbrellaEmployersLiabilityUnderlyingInsuranceCompanyName,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(i_EL_PolicyNumber)\n\tUDF_DEFAULT_VALUE_FOR_STRINGS(i_EL_PolicyNumber) AS o_UmbrellaEmployersLiabilityUnderlyingInsurancePolicyKey,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(i_BO_Description)\n\tUDF_DEFAULT_VALUE_FOR_STRINGS(i_BO_Description) AS o_UmbrellaBusinessOwnersUnderlyingInsuranceCompanyName,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(i_BO_PolicyNumber)\n\tUDF_DEFAULT_VALUE_FOR_STRINGS(i_BO_PolicyNumber) AS o_UmbrellaBusinessOwnersUnderlyingInsurancePolicyKey,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(i_GL_Description)\n\tUDF_DEFAULT_VALUE_FOR_STRINGS(i_GL_Description) AS o_UmbrellaGeneralLiabilityUnderlyingInsuranceCompanyName,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(i_GL_PolicyNumber)\n\tUDF_DEFAULT_VALUE_FOR_STRINGS(i_GL_PolicyNumber) AS o_UmbrellaGeneralLiabilityUnderlyingInsurancePolicyKey,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(i_CA_Description)\n\tUDF_DEFAULT_VALUE_FOR_STRINGS(i_CA_Description) AS o_UmbrellaCommercialAutoUnderlyingInsuranceCompanyName,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(i_CA_PolicyNumber)\n\tUDF_DEFAULT_VALUE_FOR_STRINGS(i_CA_PolicyNumber) AS o_UmbrellaCommercialAutoUnderlyingInsurancePolicyKey,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(i_SMART_Description)\n\tUDF_DEFAULT_VALUE_FOR_STRINGS(i_SMART_Description) AS o_UmbrellaSMARTbusinessUnderlyingInsuranceCompanyName,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(i_SMART_PolicyNumber)\n\tUDF_DEFAULT_VALUE_FOR_STRINGS(i_SMART_PolicyNumber) AS o_UmbrellaSMARTbusinessUnderlyingInsurancePolicyKey,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(i_SBOP_Description)\n\tUDF_DEFAULT_VALUE_FOR_STRINGS(i_SBOP_Description) AS o_UmbrellaSBOPUnderlyingInsuranceCompanyName,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(i_SBOP_PolicyNumber)\n\tUDF_DEFAULT_VALUE_FOR_STRINGS(i_SBOP_PolicyNumber) AS o_UmbrellaSBOPUnderlyingInsurancePolicyKey,\n\t'N/A' AS o_UmbrellaCoverageScope,\n\t-- *INF*: IIF(ISNULL(i_RetroActiveDate), TO_DATE('12/31/2100 23:59:59','MM/DD/YYYY HH24:MI:SS'), i_RetroActiveDate)\n\tIFF(\n\t    i_RetroActiveDate IS NULL, TO_TIMESTAMP('12/31/2100 23:59:59', 'MM/DD/YYYY HH24:MI:SS'),\n\t    i_RetroActiveDate\n\t) AS o_RetroActiveDate,\n\t-- *INF*: IIF(ISNULL(i_Million), -1, i_Million)\n\tIFF(i_Million IS NULL, - 1, i_Million) AS o_UmbrellaLayer\n\tFROM AGG_Umbrella\n),\nLKP_CoverageDetailCommercialUmbrella AS (\n\tSELECT\n\tPremiumTransactionID,\n\tCoverageGuid,\n\tUmbrellaCoverageScope,\n\tRetroActiveDate,\n\tUmbrellaLayer\n\tFROM (\n\t\tSELECT \n\t\t\tPremiumTransactionID,\n\t\t\tCoverageGuid,\n\t\t\tUmbrellaCoverageScope,\n\t\t\tRetroActiveDate,\n\t\t\tUmbrellaLayer\n\t\tFROM @{pipeline().parameters.TARGET_TABLE_OWNER}.CoverageDetailCommercialUmbrella\n\t\tWHERE SourceSystemID='@{pipeline().parameters.SOURCE_SYSTEM_ID}'\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY PremiumTransactionID ORDER BY PremiumTransactionID) = 1\n),\nEXP_DetectChange AS (\n\tSELECT\n\tLKP_CoverageDetailCommercialUmbrella.PremiumTransactionID AS lkp_PremiumTransactionID,\n\tLKP_CoverageDetailCommercialUmbrella.CoverageGuid AS lkp_CoverageGuid,\n\tLKP_CoverageDetailCommercialUmbrella.UmbrellaCoverageScope AS lkp_UmbrellaCoverageScope,\n\tLKP_CoverageDetailCommercialUmbrella.RetroActiveDate AS lkp_RetroActiveDate,\n\tLKP_CoverageDetailCommercialUmbrella.UmbrellaLayer AS lkp_UmbrellaLayer,\n\tEXP_DefaultValue.o_PremiumTransactionID AS PremiumTransactionID,\n\tEXP_DefaultValue.o_CurrentSnapshotFlag AS CurrentSnapshotFlag,\n\tEXP_DefaultValue.o_AuditID AS AuditID,\n\tEXP_DefaultValue.o_EffectiveDate AS EffectiveDate,\n\tEXP_DefaultValue.o_ExpirationDate AS ExpirationDate,\n\tEXP_DefaultValue.o_SourceSystemID AS SourceSystemID,\n\tEXP_DefaultValue.o_CreatedDate AS CreatedDate,\n\tEXP_DefaultValue.o_ModifiedDate AS ModifiedDate,\n\tEXP_DefaultValue.o_CoverageGuid AS CoverageGuid,\n\tEXP_DefaultValue.o_UmbrellaEmployersLiabilityUnderlyingInsuranceCompanyName AS UmbrellaEmployersLiabilityUnderlyingInsuranceCompanyName,\n\tEXP_DefaultValue.o_UmbrellaEmployersLiabilityUnderlyingInsurancePolicyKey AS UmbrellaEmployersLiabilityUnderlyingInsurancePolicyKey,\n\tEXP_DefaultValue.o_UmbrellaBusinessOwnersUnderlyingInsuranceCompanyName AS UmbrellaBusinessOwnersUnderlyingInsuranceCompanyName,\n\tEXP_DefaultValue.o_UmbrellaBusinessOwnersUnderlyingInsurancePolicyKey AS UmbrellaBusinessOwnersUnderlyingInsurancePolicyKey,\n\tEXP_DefaultValue.o_UmbrellaGeneralLiabilityUnderlyingInsuranceCompanyName AS UmbrellaGeneralLiabilityUnderlyingInsuranceCompanyName,\n\tEXP_DefaultValue.o_UmbrellaGeneralLiabilityUnderlyingInsurancePolicyKey AS UmbrellaGeneralLiabilityUnderlyingInsurancePolicyKey,\n\tEXP_DefaultValue.o_UmbrellaCommercialAutoUnderlyingInsuranceCompanyName AS UmbrellaCommercialAutoUnderlyingInsuranceCompanyName,\n\tEXP_DefaultValue.o_UmbrellaCommercialAutoUnderlyingInsurancePolicyKey AS UmbrellaCommercialAutoUnderlyingInsurancePolicyKey,\n\tEXP_DefaultValue.o_UmbrellaSMARTbusinessUnderlyingInsuranceCompanyName AS UmbrellaSMARTbusinessUnderlyingInsuranceCompanyName,\n\tEXP_DefaultValue.o_UmbrellaSMARTbusinessUnderlyingInsurancePolicyKey AS UmbrellaSMARTbusinessUnderlyingInsurancePolicyKey,\n\tEXP_DefaultValue.o_UmbrellaSBOPUnderlyingInsuranceCompanyName AS UmbrellaSBOPUnderlyingInsuranceCompanyName,\n\tEXP_DefaultValue.o_UmbrellaSBOPUnderlyingInsurancePolicyKey AS UmbrellaSBOPUnderlyingInsurancePolicyKey,\n\tEXP_DefaultValue.o_UmbrellaCoverageScope AS UmbrellaCoverageScope,\n\tEXP_DefaultValue.o_RetroActiveDate AS RetroActiveDate,\n\tEXP_DefaultValue.o_UmbrellaLayer AS UmbrellaLayer,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ISNULL(lkp_PremiumTransactionID), 'New', \r\n\t-- lkp_CoverageGuid<>CoverageGuid\r\n\t-- or lkp_UmbrellaCoverageScope<>UmbrellaCoverageScope\r\n\t-- or lkp_RetroActiveDate<>RetroActiveDate\r\n\t-- or lkp_UmbrellaLayer<>UmbrellaLayer,  'Update',\r\n\t-- 'No Change'\r\n\t-- ) \r\n\t-- \n\tDECODE(\n\t    TRUE,\n\t    lkp_PremiumTransactionID IS NULL, 'New',\n\t    lkp_CoverageGuid <> CoverageGuid or lkp_UmbrellaCoverageScope <> UmbrellaCoverageScope or lkp_RetroActiveDate <> RetroActiveDate or lkp_UmbrellaLayer <> UmbrellaLayer, 'Update',\n\t    'No Change'\n\t) AS v_ChangeFlag,\n\tv_ChangeFlag AS o_ChangeFlag\n\tFROM EXP_DefaultValue\n\tLEFT JOIN LKP_CoverageDetailCommercialUmbrella\n\tON LKP_CoverageDetailCommercialUmbrella.PremiumTransactionID = EXP_DefaultValue.o_PremiumTransactionID\n),\nFIL_Records AS (\n\tSELECT\n\tPremiumTransactionID, \n\tCurrentSnapshotFlag, \n\tAuditID, \n\tEffectiveDate, \n\tExpirationDate, \n\tSourceSystemID, \n\tCreatedDate, \n\tModifiedDate, \n\tCoverageGuid, \n\tUmbrellaCoverageScope, \n\tRetroActiveDate, \n\tUmbrellaLayer, \n\to_ChangeFlag AS ChangeFlag\n\tFROM EXP_DetectChange\n\tWHERE ChangeFlag='New'\n),\nTGT_CoverageDetailCommercialUmbrella_Insert AS (\n\tINSERT INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.CoverageDetailCommercialUmbrella\n\t(PremiumTransactionID, CurrentSnapshotFlag, AuditID, EffectiveDate, ExpirationDate, SourceSystemID, CreatedDate, ModifiedDate, CoverageGuid, UmbrellaCoverageScope, RetroactiveDate, UmbrellaLayer)\n\tSELECT \n\tPREMIUMTRANSACTIONID, \n\tCURRENTSNAPSHOTFLAG, \n\tAUDITID, \n\tEFFECTIVEDATE, \n\tEXPIRATIONDATE, \n\tSOURCESYSTEMID, \n\tCREATEDDATE, \n\tMODIFIEDDATE, \n\tCOVERAGEGUID, \n\tUMBRELLACOVERAGESCOPE, \n\tRetroActiveDate AS RETROACTIVEDATE, \n\tUMBRELLALAYER\n\tFROM FIL_Records\n),\nSQ_CoverageDetailCommercialUmbrella AS (\n\tSELECT \r\n\tCDCUPrevious.UmbrellaCoverageScope,\r\n\tCDCUPrevious.RetroactiveDate,\r\n\tCDCUPrevious.UmbrellaLayer,\r\n\tWPTOL.PremiumTransactionID AS Wrk_PremiumTransactionID\r\n\tFROM\r\n\tWorkPremiumTransactionOffsetLineage WPTOL\r\n\tinner join CoverageDetailCommercialUmbrella CDCUPrevious\r\n\ton ( CDCUPrevious.PremiumTransactionID= WPTOL.previouspremiumtransactionid)\r\n\tinner join CoverageDetailCommercialUmbrella CDCUToUpdate\r\n\ton ( CDCUToUpdate.PremiumTransactionID= WPTOL.PremiumTransactionID)\r\n\tINNER JOIN premiumtransaction pt WITH (NOLOCK) on\r\n\t\tWPTOL.premiumtransactionid=pt.premiumtransactionid and PT.OffsetOnsetCode='Offset'\r\n\tWHERE\r\n\tWPTOL.UpdateAttributeFlag = 1 \r\n\tAND (\r\n\t  CDCUPrevious.RetroactiveDate <> CDCUToUpdate.RetroactiveDate\r\n\t  OR CDCUPrevious.UmbrellaCoverageScope <> CDCUToUpdate.UmbrellaCoverageScope\r\n\t  OR CDCUPrevious.UmbrellaLayer <> CDCUToUpdate.UmbrellaLayer\r\n\t  )\n),\nExp_CoveargedetailCommercialUmbrella AS (\n\tSELECT\n\tUmbrellaCoverageScope,\n\tRetroactiveDate,\n\tUmbrellaLayer,\n\twrk_PremiumTransactionID,\n\tSYSDATE AS o_ModifiedDate\n\tFROM SQ_CoverageDetailCommercialUmbrella\n),\nUPD_CoveragedetailCommercialUmbrella AS (\n\tSELECT\n\tUmbrellaCoverageScope, \n\tRetroactiveDate, \n\tUmbrellaLayer, \n\twrk_PremiumTransactionID, \n\to_ModifiedDate AS ModifiedDate\n\tFROM Exp_CoveargedetailCommercialUmbrella\n),\nTGT_CoverageDetailCommercialUmbrella_Upd_Offsets AS (\n\tMERGE INTO CoverageDetailCommercialUmbrella AS T\n\tUSING UPD_CoveragedetailCommercialUmbrella AS S\n\tON T.PremiumTransactionID = S.wrk_PremiumTransactionID\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.ModifiedDate = S.ModifiedDate, T.UmbrellaCoverageScope = S.UmbrellaCoverageScope, T.RetroactiveDate = S.RetroactiveDate, T.UmbrellaLayer = S.UmbrellaLayer\n),\nSQ_CoverageDetailCommercialUmbrella_Deprecated AS (\n\tSELECT \r\n\tCDCUPrevious.UmbrellaCoverageScope,\r\n\tCDCUPrevious.RetroactiveDate,\r\n\tCDCUPrevious.UmbrellaLayer,\r\n\tWPTOL.PremiumTransactionID AS Wrk_PremiumTransactionID\r\n\tFROM\r\n\tWorkPremiumTransactionOffsetLineage WPTOL\r\n\tinner join CoverageDetailCommercialUmbrella CDCUPrevious\r\n\ton ( CDCUPrevious.PremiumTransactionID= WPTOL.previouspremiumtransactionid)\r\n\tinner join CoverageDetailCommercialUmbrella CDCUToUpdate\r\n\ton ( CDCUToUpdate.PremiumTransactionID= WPTOL.PremiumTransactionID)\r\n\tINNER JOIN premiumtransaction pt WITH (NOLOCK) on\r\n\t\tWPTOL.premiumtransactionid=pt.premiumtransactionid and PT.OffsetOnsetCode='Deprecated'\r\n\tWHERE\r\n\tWPTOL.UpdateAttributeFlag = 1 \r\n\tAND (\r\n\t  CDCUPrevious.RetroactiveDate <> CDCUToUpdate.RetroactiveDate\r\n\t  OR CDCUPrevious.UmbrellaCoverageScope <> CDCUToUpdate.UmbrellaCoverageScope\r\n\t  OR CDCUPrevious.UmbrellaLayer <> CDCUToUpdate.UmbrellaLayer\r\n\t  )\n),\nExp_CoveargedetailCommercialUmbrella_Deprecated AS (\n\tSELECT\n\tUmbrellaCoverageScope,\n\tRetroactiveDate,\n\tUmbrellaLayer,\n\twrk_PremiumTransactionID,\n\tSYSDATE AS o_ModifiedDate\n\tFROM SQ_CoverageDetailCommercialUmbrella_Deprecated\n),\nUPD_CoveragedetailCommercialUmbrella_Deprecated AS (\n\tSELECT\n\tUmbrellaCoverageScope, \n\tRetroactiveDate, \n\tUmbrellaLayer, \n\twrk_PremiumTransactionID, \n\to_ModifiedDate AS ModifiedDate\n\tFROM Exp_CoveargedetailCommercialUmbrella_Deprecated\n),\nTGT_CoverageDetailCommercialUmbrella_Upd_Deprecated AS (\n\tMERGE INTO CoverageDetailCommercialUmbrella AS T\n\tUSING UPD_CoveragedetailCommercialUmbrella_Deprecated AS S\n\tON T.PremiumTransactionID = S.wrk_PremiumTransactionID\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.ModifiedDate = S.ModifiedDate, T.UmbrellaCoverageScope = S.UmbrellaCoverageScope, T.RetroactiveDate = S.RetroactiveDate, T.UmbrellaLayer = S.UmbrellaLayer\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "TARGET_DATABASE_NAME": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "TARGET_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "SELECTION_START_TS": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WHERE_CLAUSE": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "SOURCE_SYSTEM_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            }
        },
        "folder": {
            "name": "RPT_EDM and EDW/Policy DataWarehouse/"
        },
        "annotations": []
    }
}