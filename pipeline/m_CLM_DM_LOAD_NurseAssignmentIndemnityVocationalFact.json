{
    "name": "m_CLM_DM_LOAD_NurseAssignmentIndemnityVocationalFact",
    "properties": {
        "activities": [
            {
                "name": "m_CLM_DM_LOAD_NurseAssignmentIndemnityVocationalFact",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nSQ_NurseAssignmentImpact AS (\n\tSELECT\r\n\tA.NurseAssignmentImpactId, \r\n\tA.NurseAssignmentAkId, \r\n\tA.SavingsAmount, \r\n\tB.NurseImpactId, \r\n\tB.ImpactCategory \r\n\t\r\n\tFROM\r\n\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.NurseAssignmentImpact A, @{pipeline().parameters.SOURCE_TABLE_OWNER}.SupNurseImpact B\r\n\t\r\n\tWHERE\r\n\t A.NurseImpactId = B.NurseImpactId\r\n\tAND\r\n\tA.CurrentSnapshotFlag = 1\r\n\tAND\r\n\tB.CurrentSnapshotFlag = 1\r\n\tAND\r\n\tB.ImpactType = 'I'\n),\nEXP_Src_Values AS (\n\tSELECT\n\tNurseAssignmentImpactId,\n\tNurseAssignmentAkId,\n\tSavingsAmount,\n\tNurseImpactId1,\n\tImpactCategory\n\tFROM SQ_NurseAssignmentImpact\n),\nSRT_Src_Values AS (\n\tSELECT\n\tNurseAssignmentImpactId, \n\tNurseAssignmentAkId, \n\tSavingsAmount, \n\tNurseImpactId1, \n\tImpactCategory\n\tFROM EXP_Src_Values\n\tORDER BY NurseAssignmentAkId ASC, ImpactCategory ASC\n),\nAGG_Indemnity_SavingsAmount AS (\n\tSELECT\n\tNurseAssignmentImpactId, \n\tNurseAssignmentAkId, \n\tImpactCategory, \n\tSavingsAmount, \n\tsum(SavingsAmount) AS IndemnityVocationalCategorySavings, \n\tNurseImpactId1\n\tFROM SRT_Src_Values\n\tGROUP BY NurseAssignmentAkId, ImpactCategory\n),\nLKP_NurseAssignment AS (\n\tSELECT\n\tNurseAssignmentAkId,\n\tNurseCaseAkId\n\tFROM (\n\t\tSELECT \r\n\t\tN.NurseAssignmentId as NurseAssignmentId, \r\n\t\tN.NurseCaseAkId as NurseCaseAkId, \r\n\t\tN.claim_party_ak_id as claim_party_ak_id, \r\n\t\tN.NurseAssignmentAkId as NurseAssignmentAkId \r\n\t\t\r\n\t\tFROM \r\n\t\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.NurseAssignment N\r\n\t\t\r\n\t\twhere\r\n\t\tN.CurrentSnapshotFlag = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY NurseAssignmentAkId ORDER BY NurseAssignmentAkId) = 1\n),\nLKP_NurseAssignmentDim AS (\n\tSELECT\n\tNurseAssignmentDimId,\n\tEdwNurseAssignmentAkId\n\tFROM (\n\t\tSELECT\r\n\t\tN.NurseAssignmentDimId as NurseAssignmentDimId, \r\n\t\tN.EdwNurseAssignmentAkId as EdwNurseAssignmentAkId\r\n\t\t\r\n\t\t FROM\r\n\t\t @{pipeline().parameters.TARGET_TABLE_OWNER}.NurseAssignmentDim N\r\n\t\t\r\n\t\twhere\r\n\t\tN.CurrentSnapshotFlag = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY EdwNurseAssignmentAkId ORDER BY NurseAssignmentDimId) = 1\n),\nLKP_NurseAssignmentImpactDim AS (\n\tSELECT\n\tNurseAssignmentImpactDimId,\n\tEdwSupNurseImpactPkId\n\tFROM (\n\t\tSELECT\r\n\t\tN.NurseAssignmentImpactDimId as NurseAssignmentImpactDimId,\r\n\t\tN.EdwSupNurseImpactPkId as EdwSupNurseImpactPkId, \r\n\t\tN.ImpactType as ImpactType,\r\n\t\tN.ImpactCategory as ImpactCategory\r\n\t\t\r\n\t\t FROM\r\n\t\t @{pipeline().parameters.TARGET_TABLE_OWNER}.NurseAssignmentImpactDim N\r\n\t\t\r\n\t\twhere\r\n\t\tN.ImpactType = 'I'\r\n\t\tAND\r\n\t\tN.CurrentSnapshotFlag = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY EdwSupNurseImpactPkId ORDER BY NurseAssignmentImpactDimId) = 1\n),\nmplt_Claimant_Occurrence_dim_ids AS (WITH\n\tINPUT AS (\n\t\t\n\t),\n\tLKP_NurseCase_EDW_Scr AS (\n\t\tSELECT\n\t\tclaim_party_occurrence_ak_id,\n\t\tNurseCaseAkId\n\t\tFROM (\n\t\t\tSELECT \r\n\t\t\tN.claim_party_occurrence_ak_id as claim_party_occurrence_ak_id, \r\n\t\t\tN.NurseCaseAkId as NurseCaseAkId\r\n\t\t\t\r\n\t\t\t FROM \r\n\t\t\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.NurseCase N\r\n\t\t\t\r\n\t\t\twhere\r\n\t\t\tCurrentSnapshotFlag = 1\n\t\t)\n\t\tQUALIFY ROW_NUMBER() OVER (PARTITION BY NurseCaseAkId ORDER BY claim_party_occurrence_ak_id) = 1\n\t),\n\tLKP_claimant_dim_DM_Tgt AS (\n\t\tSELECT\n\t\tclaimant_dim_id,\n\t\tedw_claim_party_occurrence_ak_id\n\t\tFROM (\n\t\t\tSELECT \r\n\t\t\tC.claimant_dim_id as claimant_dim_id, C.edw_claim_party_occurrence_ak_id as edw_claim_party_occurrence_ak_id\r\n\t\t\t\r\n\t\t\t FROM\r\n\t\t\t @{pipeline().parameters.TARGET_TABLE_OWNER}.claimant_dim C\r\n\t\t\t\r\n\t\t\twhere\r\n\t\t\tcrrnt_snpsht_flag = 1\n\t\t)\n\t\tQUALIFY ROW_NUMBER() OVER (PARTITION BY edw_claim_party_occurrence_ak_id ORDER BY claimant_dim_id) = 1\n\t),\n\tLKP_claim_party_occurrence_EDW_Scr AS (\n\t\tSELECT\n\t\tclaim_occurrence_ak_id,\n\t\tclaim_party_occurrence_ak_id\n\t\tFROM (\n\t\t\tSELECT \r\n\t\t\tC.claim_occurrence_ak_id as claim_occurrence_ak_id, C.claim_party_occurrence_ak_id as claim_party_occurrence_ak_id\r\n\t\t\t\r\n\t\t\t FROM \r\n\t\t\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.claim_party_occurrence C\r\n\t\t\t\r\n\t\t\twhere\r\n\t\t\tcrrnt_snpsht_flag = 1\r\n\t\t\tAND\r\n\t\t\tclaim_party_role_code in ('CLMT','CMT')\n\t\t)\n\t\tQUALIFY ROW_NUMBER() OVER (PARTITION BY claim_party_occurrence_ak_id ORDER BY claim_occurrence_ak_id) = 1\n\t),\n\tLKP_claim_occurrence_dim_DM_Tgt AS (\n\t\tSELECT\n\t\tclaim_occurrence_dim_id,\n\t\tedw_claim_occurrence_ak_id\n\t\tFROM (\n\t\t\tSELECT\r\n\t\t\tC.claim_occurrence_dim_id as claim_occurrence_dim_id, C.edw_claim_occurrence_ak_id as edw_claim_occurrence_ak_id \r\n\t\t\t\r\n\t\t\tFROM \r\n\t\t\t@{pipeline().parameters.TARGET_TABLE_OWNER}.claim_occurrence_dim C\r\n\t\t\t\r\n\t\t\twhere\r\n\t\t\tcrrnt_snpsht_flag = 1\n\t\t)\n\t\tQUALIFY ROW_NUMBER() OVER (PARTITION BY edw_claim_occurrence_ak_id ORDER BY claim_occurrence_dim_id) = 1\n\t),\n\tOUTPUT AS (\n\t\tSELECT\n\t\tLKP_claimant_dim_DM_Tgt.claimant_dim_id, \n\t\tLKP_claim_occurrence_dim_DM_Tgt.claim_occurrence_dim_id\n\t\tFROM \n\t\tLEFT JOIN LKP_claim_occurrence_dim_DM_Tgt\n\t\tON LKP_claim_occurrence_dim_DM_Tgt.edw_claim_occurrence_ak_id = LKP_claim_party_occurrence_EDW_Scr.claim_occurrence_ak_id\n\t\tLEFT JOIN LKP_claimant_dim_DM_Tgt\n\t\tON LKP_claimant_dim_DM_Tgt.edw_claim_party_occurrence_ak_id = LKP_NurseCase_EDW_Scr.claim_party_occurrence_ak_id\n\t),\n),\nEXP_Default_Values AS (\n\tSELECT\n\tmplt_Claimant_Occurrence_dim_ids.claimant_dim_id AS IN_claimant_dim_id,\n\t-- *INF*: iif(isnull(IN_claimant_dim_id),-1,IN_claimant_dim_id)\n\tIFF(IN_claimant_dim_id IS NULL, - 1, IN_claimant_dim_id) AS v_claimant_dim_id,\n\tv_claimant_dim_id AS claimant_dim_id,\n\tmplt_Claimant_Occurrence_dim_ids.claim_occurrence_dim_id AS IN_claim_occurrence_dim_id,\n\t-- *INF*: iif(isnull(IN_claim_occurrence_dim_id),-1,IN_claim_occurrence_dim_id)\n\tIFF(IN_claim_occurrence_dim_id IS NULL, - 1, IN_claim_occurrence_dim_id) AS v_claim_occurrence_dim_id,\n\tv_claim_occurrence_dim_id AS claim_occurrence_dim_id,\n\tAGG_Indemnity_SavingsAmount.NurseAssignmentImpactId,\n\tLKP_NurseAssignmentDim.NurseAssignmentDimId AS IN_NurseAssignmentDimId,\n\t-- *INF*: iif(isnull(IN_NurseAssignmentDimId),-1,IN_NurseAssignmentDimId)\n\tIFF(IN_NurseAssignmentDimId IS NULL, - 1, IN_NurseAssignmentDimId) AS v_NurseAssignmentDimId,\n\tv_NurseAssignmentDimId AS NurseAssignmentDimId,\n\tLKP_NurseAssignmentImpactDim.NurseAssignmentImpactDimId AS IN_NurseAssignmentImpactDimId,\n\t-- *INF*: iif(isnull(IN_NurseAssignmentImpactDimId),-1,IN_NurseAssignmentImpactDimId)\n\tIFF(IN_NurseAssignmentImpactDimId IS NULL, - 1, IN_NurseAssignmentImpactDimId) AS v_NurseAssignmentImpactDimId,\n\tv_NurseAssignmentImpactDimId AS NurseAssignmentImpactDimId,\n\tAGG_Indemnity_SavingsAmount.IndemnityVocationalCategorySavings AS IN_IndemnityVocationalCategorySavings,\n\t-- *INF*: iif(isnull(IN_IndemnityVocationalCategorySavings),0,IN_IndemnityVocationalCategorySavings)\n\tIFF(IN_IndemnityVocationalCategorySavings IS NULL, 0, IN_IndemnityVocationalCategorySavings) AS v_IndemnityVocationalCategorySavings,\n\tv_IndemnityVocationalCategorySavings AS IndemnityVocationalCategorySavings\n\tFROM AGG_Indemnity_SavingsAmount\n\t -- Manually join with mplt_Claimant_Occurrence_dim_ids\n\tLEFT JOIN LKP_NurseAssignmentDim\n\tON LKP_NurseAssignmentDim.EdwNurseAssignmentAkId = LKP_NurseAssignment.NurseAssignmentAkId\n\tLEFT JOIN LKP_NurseAssignmentImpactDim\n\tON LKP_NurseAssignmentImpactDim.EdwSupNurseImpactPkId = AGG_Indemnity_SavingsAmount.NurseImpactId1\n),\nLKP_NurseAssignmentIndemnityVocationalFact AS (\n\tSELECT\n\tNurseAssignmentIndemnityVocationalFactId,\n\tEdwNurseAssignmentImpactPkId,\n\tclaimant_dim_id,\n\tclaim_occurrence_dim_id,\n\tNurseAssignmentDimId,\n\tNurseAssignmentImpactDimId,\n\tIndemnityVocationalCategorySavings\n\tFROM (\n\t\tSELECT \n\t\t\tNurseAssignmentIndemnityVocationalFactId,\n\t\t\tEdwNurseAssignmentImpactPkId,\n\t\t\tclaimant_dim_id,\n\t\t\tclaim_occurrence_dim_id,\n\t\t\tNurseAssignmentDimId,\n\t\t\tNurseAssignmentImpactDimId,\n\t\t\tIndemnityVocationalCategorySavings\n\t\tFROM NurseAssignmentIndemnityVocationalFact\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY EdwNurseAssignmentImpactPkId ORDER BY NurseAssignmentIndemnityVocationalFactId) = 1\n),\nEXP_Detect_Changes AS (\n\tSELECT\n\tLKP_NurseAssignmentIndemnityVocationalFact.NurseAssignmentIndemnityVocationalFactId AS Lkp_NurseAssignmentIndemnityVocationalFactId,\n\tLKP_NurseAssignmentIndemnityVocationalFact.EdwNurseAssignmentImpactPkId AS Lkp_EdwNurseAssignmentImpactPkId,\n\tLKP_NurseAssignmentIndemnityVocationalFact.claimant_dim_id AS Lkp_claimant_dim_id,\n\tLKP_NurseAssignmentIndemnityVocationalFact.claim_occurrence_dim_id AS Lkp_claim_occurrence_dim_id,\n\tLKP_NurseAssignmentIndemnityVocationalFact.NurseAssignmentDimId AS Lkp_NurseAssignmentDimId,\n\tLKP_NurseAssignmentIndemnityVocationalFact.NurseAssignmentImpactDimId AS Lkp_NurseAssignmentImpactDimId,\n\tLKP_NurseAssignmentIndemnityVocationalFact.IndemnityVocationalCategorySavings AS Lkp_IndemnityVocationalCategorySavings,\n\t-- *INF*: iif(isnull(Lkp_NurseAssignmentIndemnityVocationalFactId),'NEW',\r\n\t-- iif (\r\n\t-- \r\n\t-- Lkp_claimant_dim_id <> claimant_dim_id\r\n\t-- or\r\n\t-- Lkp_claim_occurrence_dim_id <> claim_occurrence_dim_id\r\n\t-- or\r\n\t-- Lkp_EdwNurseAssignmentImpactPkId <> NurseAssignmentImpactId\r\n\t-- or\r\n\t-- Lkp_NurseAssignmentDimId <> NurseAssignmentDimId\r\n\t-- or\r\n\t-- Lkp_NurseAssignmentImpactDimId <> NurseAssignmentImpactDimId\r\n\t-- or \r\n\t-- Lkp_IndemnityVocationalCategorySavings <> IndemnityVocationalCategorySavings,\r\n\t-- \r\n\t--  'UPDATE','NOCHANGE' )\r\n\t-- \r\n\t--   )\n\tIFF(Lkp_NurseAssignmentIndemnityVocationalFactId IS NULL, 'NEW', IFF(Lkp_claimant_dim_id <> claimant_dim_id OR Lkp_claim_occurrence_dim_id <> claim_occurrence_dim_id OR Lkp_EdwNurseAssignmentImpactPkId <> NurseAssignmentImpactId OR Lkp_NurseAssignmentDimId <> NurseAssignmentDimId OR Lkp_NurseAssignmentImpactDimId <> NurseAssignmentImpactDimId OR Lkp_IndemnityVocationalCategorySavings <> IndemnityVocationalCategorySavings, 'UPDATE', 'NOCHANGE')) AS v_ChangedFlag,\n\tv_ChangedFlag AS ChangedFlag,\n\tEXP_Default_Values.claimant_dim_id,\n\tEXP_Default_Values.claim_occurrence_dim_id,\n\tEXP_Default_Values.NurseAssignmentImpactId,\n\tEXP_Default_Values.NurseAssignmentDimId,\n\tEXP_Default_Values.NurseAssignmentImpactDimId,\n\tEXP_Default_Values.IndemnityVocationalCategorySavings,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS o_AuditId\n\tFROM EXP_Default_Values\n\tLEFT JOIN LKP_NurseAssignmentIndemnityVocationalFact\n\tON LKP_NurseAssignmentIndemnityVocationalFact.EdwNurseAssignmentImpactPkId = EXP_Default_Values.NurseAssignmentImpactId\n),\nRTR_Insert_Update AS (\n\tSELECT\n\tChangedFlag,\n\tLkp_NurseAssignmentIndemnityVocationalFactId,\n\tclaimant_dim_id,\n\tclaim_occurrence_dim_id,\n\tNurseAssignmentImpactId,\n\tNurseAssignmentDimId,\n\tNurseAssignmentImpactDimId,\n\tIndemnityVocationalCategorySavings,\n\to_AuditId\n\tFROM EXP_Detect_Changes\n),\nRTR_Insert_Update_Insert AS (SELECT * FROM RTR_Insert_Update WHERE ChangedFlag = 'NEW'),\nRTR_Insert_Update_DEFAULT1 AS (SELECT * FROM RTR_Insert_Update WHERE NOT ( (ChangedFlag = 'NEW') )),\nUPD_Update AS (\n\tSELECT\n\tLkp_NurseAssignmentIndemnityVocationalFactId AS Lkp_NurseAssignmentIndemnityVocationalFactId2, \n\tclaimant_dim_id AS claimant_dim_id2, \n\tclaim_occurrence_dim_id AS claim_occurrence_dim_id2, \n\tNurseAssignmentImpactId AS NurseAssignmentImpactId2, \n\tNurseAssignmentDimId AS NurseAssignmentDimId2, \n\tNurseAssignmentImpactDimId AS NurseAssignmentImpactDimId2, \n\tIndemnityVocationalCategorySavings, \n\to_AuditId AS o_AuditId2\n\tFROM RTR_Insert_Update_DEFAULT1\n),\nNurseAssignmentIndemnityVocationalFact_Update AS (\n\tMERGE INTO NurseAssignmentIndemnityVocationalFact AS T\n\tUSING UPD_Update AS S\n\tON T.NurseAssignmentIndemnityVocationalFactId = S.Lkp_NurseAssignmentIndemnityVocationalFactId2\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.AuditId = S.o_AuditId2, T.EdwNurseAssignmentImpactPkId = S.NurseAssignmentImpactId2, T.claimant_dim_id = S.claimant_dim_id2, T.claim_occurrence_dim_id = S.claim_occurrence_dim_id2, T.NurseAssignmentDimId = S.NurseAssignmentDimId2, T.NurseAssignmentImpactDimId = S.NurseAssignmentImpactDimId2, T.IndemnityVocationalCategorySavings = S.IndemnityVocationalCategorySavings\n),\nUPD_Insert AS (\n\tSELECT\n\tclaimant_dim_id AS claimant_dim_id1, \n\tclaim_occurrence_dim_id AS claim_occurrence_dim_id1, \n\tNurseAssignmentImpactId AS NurseAssignmentImpactId1, \n\tNurseAssignmentDimId AS NurseAssignmentDimId1, \n\tNurseAssignmentImpactDimId AS NurseAssignmentImpactDimId1, \n\tIndemnityVocationalCategorySavings, \n\to_AuditId AS o_AuditId1\n\tFROM RTR_Insert_Update_Insert\n),\nNurseAssignmentIndemnityVocationalFact_Insert AS (\n\tTRUNCATE TABLE NurseAssignmentIndemnityVocationalFact;\n\tINSERT INTO NurseAssignmentIndemnityVocationalFact\n\t(AuditId, EdwNurseAssignmentImpactPkId, claimant_dim_id, claim_occurrence_dim_id, NurseAssignmentDimId, NurseAssignmentImpactDimId, IndemnityVocationalCategorySavings)\n\tSELECT \n\to_AuditId1 AS AUDITID, \n\tNurseAssignmentImpactId1 AS EDWNURSEASSIGNMENTIMPACTPKID, \n\tclaimant_dim_id1 AS CLAIMANT_DIM_ID, \n\tclaim_occurrence_dim_id1 AS CLAIM_OCCURRENCE_DIM_ID, \n\tNurseAssignmentDimId1 AS NURSEASSIGNMENTDIMID, \n\tNurseAssignmentImpactDimId1 AS NURSEASSIGNMENTIMPACTDIMID, \n\tINDEMNITYVOCATIONALCATEGORYSAVINGS\n\tFROM UPD_Insert\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "246514"
            },
            "WBMI_BATCH_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "905534"
            },
            "WBMI_SESSION_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "7604544"
            },
            "SELECTION_START_TS": {
                "type": "string",
                "defaultValue": "08/30/2023 03:42:21"
            },
            "SELECTION_END_TS": {
                "type": "string",
                "defaultValue": "08/31/2023 04:16:04"
            },
            "DBCONNECTION_SOURCE": {
                "type": "string",
                "defaultValue": "SQLServer_RPT_EDM_Claim"
            },
            "DBCONNECTION_TARGET": {
                "type": "string",
                "defaultValue": "SQLServer_WC_Data_Mart_Claim"
            },
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "DBO"
            },
            "TARGET_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "DBO"
            },
            "SOURCE_SYSTEM_ID": {
                "type": "string",
                "defaultValue": "EXCEED"
            }
        },
        "folder": {
            "name": "Claims DataMart/"
        },
        "annotations": []
    }
}