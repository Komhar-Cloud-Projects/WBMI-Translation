{
    "name": "s_m_FEED_Load_WCRB_Merge_Files",
    "properties": {
        "activities": [
            {
                "name": "m_FEED_Load_WCRB_Merge_Files",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nLKP_Get_OutStandingLossReserve_PreviousQuarter AS (\n\tSELECT\n\tOutstandingLossReserveAmount,\n\tReportingQuarter\n\tFROM (\n\t\tSELECT \n\t\t\tOutstandingLossReserveAmount,\n\t\t\tReportingQuarter\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.WorkWCRBOutstandingLossReserveQuarterly\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY ReportingQuarter ORDER BY OutstandingLossReserveAmount) = 1\n),\nSQ_WCRB_Type3_DCT AS (\n\n-- TODO Manual --\n\n),\nSQ_WCRB_Type3_PMS AS (\n\n-- TODO Manual --\n\n),\nUN_Type3 AS (\n\tSELECT Records\n\tFROM SQ_WCRB_Type3_PMS\n\tUNION\n\tSELECT Records\n\tFROM SQ_WCRB_Type3_DCT\n),\nAGG_OutstandingLossReserves_Current AS (\n\tSELECT\n\tRecords AS in_Records,\n\t1 AS out_Dummy,\n\t-- *INF*: sum(to_decimal(ltrim(rtrim(substr(REPLACESTR(0,REPLACESTR(0,in_Records,'~',''),'*',''),192,12))))) + sum(to_decimal(ltrim(rtrim(substr(REPLACESTR(0,REPLACESTR(0,in_Records,'~',''),'*',''),204,12)))))\n\tsum(CAST(ltrim(rtrim(substr(REGEXP_REPLACE(REGEXP_REPLACE(in_Records,'~','','i'),'*','','i'), 192, 12))) AS FLOAT)) + sum(CAST(ltrim(rtrim(substr(REGEXP_REPLACE(REGEXP_REPLACE(in_Records,'~','','i'),'*','','i'), 204, 12))) AS FLOAT)) AS out_OutstandingLossReserves_Current\n\tFROM UN_Type3\n\tGROUP BY out_Dummy\n),\nSQ_Dummy AS (\n\tselect distinct CONCAT(Year(max(PremiumMasterRunDate)),\r\n\tDATEPART(QUARTER,max(PremiumMasterRunDate))) as ReportingQuarter,\r\n\tCONCAT(Year(dateadd(month,-3,max(PremiumMasterRunDate))),\r\n\tDATEPART(QUARTER,dateadd(month,-3,max(PremiumMasterRunDate)))) as PreviousReportingQuarter\r\n\tfrom WcrbWorkTable\r\n\twhere @{pipeline().parameters.EXTRACTDATE}\n),\nEXP_Type1_GetOutstandingLossReservesPreviousQuarter AS (\n\tSELECT\n\tReportingQuarter,\n\tPreviousReportingQuarter AS i_PreviousReportingQuarter,\n\t-- *INF*: IIF( ISNULL(:LKP.LKP_GET_OUTSTANDINGLOSSRESERVE_PREVIOUSQUARTER(i_PreviousReportingQuarter)),'000000000000',\r\n\t-- :LKP.LKP_GET_OUTSTANDINGLOSSRESERVE_PREVIOUSQUARTER(i_PreviousReportingQuarter))\n\tIFF(\n\t    LKP_GET_OUTSTANDINGLOSSRESERVE_PREVIOUSQUARTER_i_PreviousReportingQuarter.OutstandingLossReserveAmount IS NULL,\n\t    '000000000000',\n\t    LKP_GET_OUTSTANDINGLOSSRESERVE_PREVIOUSQUARTER_i_PreviousReportingQuarter.OutstandingLossReserveAmount\n\t) AS lkp_OutstandingAmount_Previous,\n\t1 AS o_Dummy\n\tFROM SQ_Dummy\n\tLEFT JOIN LKP_GET_OUTSTANDINGLOSSRESERVE_PREVIOUSQUARTER LKP_GET_OUTSTANDINGLOSSRESERVE_PREVIOUSQUARTER_i_PreviousReportingQuarter\n\tON LKP_GET_OUTSTANDINGLOSSRESERVE_PREVIOUSQUARTER_i_PreviousReportingQuarter.ReportingQuarter = i_PreviousReportingQuarter\n\n),\nJNR_OutstandingLossReserves_Current AS (SELECT\n\tAGG_OutstandingLossReserves_Current.out_Dummy AS i_Dummy, \n\tAGG_OutstandingLossReserves_Current.out_OutstandingLossReserves_Current AS OutstandingLossReserves_Current, \n\tEXP_Type1_GetOutstandingLossReservesPreviousQuarter.o_Dummy AS Dummy, \n\tEXP_Type1_GetOutstandingLossReservesPreviousQuarter.ReportingQuarter, \n\tEXP_Type1_GetOutstandingLossReservesPreviousQuarter.lkp_OutstandingAmount_Previous AS OutstandingAmount_Previous\n\tFROM AGG_OutstandingLossReserves_Current\n\tINNER JOIN EXP_Type1_GetOutstandingLossReservesPreviousQuarter\n\tON EXP_Type1_GetOutstandingLossReservesPreviousQuarter.o_Dummy = AGG_OutstandingLossReserves_Current.out_Dummy\n),\nEXP_Passthrough AS (\n\tSELECT\n\tsessstarttime AS out_CreatedDate,\n\tsessstarttime AS out_ModifiedDate,\n\tReportingQuarter,\n\tOutstandingLossReserves_Current AS in_OutstandingLossReserves_Current,\n\t-- *INF*: LPAD(TO_CHAR(ROUND(in_OutstandingLossReserves_Current)),12,'0')\n\tLPAD(TO_CHAR(ROUND(in_OutstandingLossReserves_Current)), 12, '0') AS out_OutstandingLossReserves_Current\n\tFROM JNR_OutstandingLossReserves_Current\n),\nWorkWCRBOutstandingLossReserveQuarterly AS (\n\tINSERT INTO WorkWCRBOutstandingLossReserveQuarterly\n\t(CreatedDate, ModifiedDate, ReportingQuarter, OutstandingLossReserveAmount)\n\tSELECT \n\tout_CreatedDate AS CREATEDDATE, \n\tout_ModifiedDate AS MODIFIEDDATE, \n\tREPORTINGQUARTER, \n\tout_OutstandingLossReserves_Current AS OUTSTANDINGLOSSRESERVEAMOUNT\n\tFROM EXP_Passthrough\n),\nSQ_WCRB_Type4 AS (\n\n-- TODO Manual --\n\n),\nSQ_WCRB_Type5 AS (\n\n-- TODO Manual --\n\n),\nSQ_WCRB_Type2_DCT AS (\n\n-- TODO Manual --\n\n),\nSQ_WCRB_Type2_PMS AS (\n\n-- TODO Manual --\n\n),\nUN_Type2 AS (\n\tSELECT Records\n\tFROM SQ_WCRB_Type2_PMS\n\tUNION\n\tSELECT Records\n\tFROM SQ_WCRB_Type2_DCT\n),\nSQ_WCRB_Type6_DCT AS (\n\n-- TODO Manual --\n\n),\nSQ_WCRB_Type6_PMS AS (\n\n-- TODO Manual --\n\n),\nUN_Type6 AS (\n\tSELECT Records\n\tFROM SQ_WCRB_Type6_PMS\n\tUNION\n\tSELECT Records\n\tFROM SQ_WCRB_Type6_DCT\n),\nUN_Type2_to_6 AS (\n\tSELEC\n\tFROM \n\tUNION\n\tSELECT Records\n\tFROM UN_Type2\n\tUNION\n\tSELECT Records\n\tFROM UN_Type3\n\tUNION\n\tSELECT Records\n\tFROM SQ_WCRB_Type4\n\tUNION\n\tSELECT Records\n\tFROM SQ_WCRB_Type5\n\tUNION\n\tSELECT Records\n\tFROM UN_Type6\n),\nAGG_CountOfAllRows AS (\n\tSELECT\n\tRecords,\n\t-- *INF*: COUNT(Records)\n\tCOUNT(Records) AS o_Count,\n\t1 AS o_Dummy\n\tFROM UN_Type2_to_6\n\tGROUP BY \n),\nJNR_CombineType1WithCountAndLossReserve AS (SELECT\n\tJNR_OutstandingLossReserves_Current.ReportingQuarter, \n\tJNR_OutstandingLossReserves_Current.OutstandingLossReserves_Current AS OutstandingAmount_Current, \n\tJNR_OutstandingLossReserves_Current.Dummy AS i_Dummy_Loss, \n\tAGG_CountOfAllRows.o_Count AS Count, \n\tAGG_CountOfAllRows.o_Dummy AS i_Dummy_Count, \n\tJNR_OutstandingLossReserves_Current.OutstandingAmount_Previous\n\tFROM JNR_OutstandingLossReserves_Current\n\tINNER JOIN AGG_CountOfAllRows\n\tON AGG_CountOfAllRows.o_Dummy = JNR_OutstandingLossReserves_Current.Dummy\n),\nEXP_WCRB_Type1 AS (\n\tSELECT\n\tReportingQuarter AS i_ReportingQuarter,\n\tOutstandingAmount_Current AS i_OutstandingAmount_Current,\n\tOutstandingAmount_Previous AS i_OutstandingAmount_Previous,\n\tCount AS i_Count,\n\t'01' AS v_RecordType_01_02,\n\t'17124' AS v_CarrierCode_03_07,\n\t-- *INF*: RPAD('West Bend Mutual Insurance Co',40,' ')\n\tRPAD('West Bend Mutual Insurance Co', 40, ' ') AS v_NameOfCarrier_08_47,\n\ti_ReportingQuarter AS v_ReportingQuarter_48_52,\n\t-- *INF*: RPAD('Chuck Hosp',40,' ')\n\tRPAD('Chuck Hosp', 40, ' ') AS v_ReportPreparer_53_92,\n\t'2623346597' AS v_Tel_93_102,\n\t-- *INF*: RPAD('1900 South 18th Ave',60,' ')\n\tRPAD('1900 South 18th Ave', 60, ' ') AS v_Address_103_162,\n\t-- *INF*: RPAD('West Bend',40,' ')\n\tRPAD('West Bend', 40, ' ') AS v_City_163_202,\n\t'WI' AS v_State_203_204,\n\t-- *INF*: RPAD('53095',9,' ')\n\tRPAD('53095', 9, ' ') AS v_ZipCode_205_213,\n\t-- *INF*: RPAD('chosp@wbmi.com',50,' ')\n\tRPAD('chosp@wbmi.com', 50, ' ') AS v_Email_214_263,\n\t-- *INF*: LPAD(i_OutstandingAmount_Previous,12,0)\r\n\t-- --LPAD(TO_CHAR(ROUND(i_OutstandingAmount_Previous_old)),12,'0')\n\tLPAD(i_OutstandingAmount_Previous, 12, 0) AS v_OutstandingLoss_264_275,\n\t-- *INF*: LPAD(TO_CHAR(ROUND(i_OutstandingAmount_Current)),12,'0')\n\tLPAD(TO_CHAR(ROUND(i_OutstandingAmount_Current)), 12, '0') AS v_OutstandingLoss_276_287,\n\t-- *INF*: LPAD(TO_CHAR(i_Count),9,'0')\n\tLPAD(TO_CHAR(i_Count), 9, '0') AS v_TotalCount_288_296,\n\tv_RecordType_01_02\r\n || v_CarrierCode_03_07\r\n || v_NameOfCarrier_08_47\r\n || v_ReportingQuarter_48_52\r\n || v_ReportPreparer_53_92\r\n || v_Tel_93_102\r\n || v_Address_103_162\r\n || v_City_163_202\r\n || v_State_203_204\r\n || v_ZipCode_205_213\r\n || v_Email_214_263\r\n || v_OutstandingLoss_264_275\r\n || v_OutstandingLoss_276_287\r\n || v_TotalCount_288_296 AS o_Record_Type1\n\tFROM JNR_CombineType1WithCountAndLossReserve\n),\nEXP_WCRB_Type2_to_6 AS (\n\tSELECT\n\tRecords AS i_Records,\n\t-- *INF*: REPLACESTR(0,REPLACESTR(0,i_Records,'~',''),'*','')\n\tREGEXP_REPLACE(REGEXP_REPLACE(i_Records,'~','','i'),'*','','i') AS o_Records\n\tFROM UN_Type2_to_6\n),\nUN_MergeType1WithAllOtherTypes AS (\n\tSELECT o_Record_Type1 AS Records\n\tFROM EXP_WCRB_Type1\n\tUNION\n\tSELECT o_Records AS Records\n\tFROM EXP_WCRB_Type2_to_6\n),\nSRT_SorttheMergedFile AS (\n\tSELECT\n\tRecords\n\tFROM UN_MergeType1WithAllOtherTypes\n\tORDER BY Records ASC\n),\nEXP_PadFileLength AS (\n\tSELECT\n\tRecords AS in_Records,\n\t-- *INF*: RPAD(in_Records,296,' ')\r\n\t-- -- right padding the record to hit the required 296 length\n\tRPAD(in_Records, 296, ' ') AS out_Records\n\tFROM SRT_SorttheMergedFile\n),\nWCRB_FlatFile_Target AS (\n\tINSERT INTO DataFeed_FlatFile\n\t(Record)\n\tSELECT \n\tout_Records AS RECORD\n\tFROM EXP_PadFileLength\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "EXTRACTDATE": {
                "type": "string",
                "defaultValue": "Default Value"
            }
        },
        "folder": {
            "name": "PolicyDataServices/"
        },
        "annotations": []
    }
}