{
    "name": "s_m_POL_DW_LOAD_SupLimitType",
    "properties": {
        "activities": [
            {
                "name": "m_POL_DW_LOAD_SupLimitType",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nSQ_SupLimitType_CSV AS (\n\n-- TODO Manual --\n\n),\nEXP_Default AS (\n\tSELECT\n\tSupLimitTypeId,\n\tCreatedDate,\n\tModifiedDate,\n\tModifiedUserId,\n\tInsuranceLine,\n\tCoverageType,\n\tLimitType,\n\tStandardLimitType,\n\tLimitLevel,\n\tAggregateableFlag,\n\t-- *INF*: SYSDATE\r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- --IIF(ISNULL(LTRIM(RTRIM(CreatedDate))) OR LENGTH(LTRIM(RTRIM(CreatedDate)))=0, SYSDATE, TO_DATE(LTRIM(RTRIM(CreatedDate)),'MM/DD/YYYY'))\n\tCURRENT_TIMESTAMP AS o_CreatedDate,\n\t-- *INF*: SYSDATE\r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- --IIF(ISNULL(LTRIM(RTRIM(ModifiedDate))) OR LENGTH(LTRIM(RTRIM(ModifiedDate)))=0, SYSDATE, TO_DATE(LTRIM(RTRIM(ModifiedDate)),'MM/DD/YYYY'))\n\tCURRENT_TIMESTAMP AS o_ModifiedDate,\n\t-- *INF*: IIF(ISNULL(LTRIM(RTRIM(ModifiedUserId))) OR LENGTH(LTRIM(RTRIM(ModifiedUserId)))=0 OR IS_SPACES(LTRIM(RTRIM(ModifiedUserId))), 'InformS', LTRIM(RTRIM(ModifiedUserId)))\n\tIFF(\n\t    LTRIM(RTRIM(ModifiedUserId)) IS NULL\n\t    or LENGTH(LTRIM(RTRIM(ModifiedUserId))) = 0\n\t    or LENGTH(LTRIM(RTRIM(ModifiedUserId)))>0\n\t    and TRIM(LTRIM(RTRIM(ModifiedUserId)))='',\n\t    'InformS',\n\t    LTRIM(RTRIM(ModifiedUserId))\n\t) AS o_ModifiedUserId,\n\t-- *INF*: IIF(ISNULL(LTRIM(RTRIM(InsuranceLine))) OR LENGTH(LTRIM(RTRIM(InsuranceLine)))=0 OR IS_SPACES(LTRIM(RTRIM(InsuranceLine))), 'InformS', LTRIM(RTRIM(InsuranceLine)))\n\tIFF(\n\t    LTRIM(RTRIM(InsuranceLine)) IS NULL\n\t    or LENGTH(LTRIM(RTRIM(InsuranceLine))) = 0\n\t    or LENGTH(LTRIM(RTRIM(InsuranceLine)))>0\n\t    and TRIM(LTRIM(RTRIM(InsuranceLine)))='',\n\t    'InformS',\n\t    LTRIM(RTRIM(InsuranceLine))\n\t) AS o_InsuranceLine,\n\t-- *INF*: IIF(ISNULL(LTRIM(RTRIM(CoverageType))) OR LENGTH(LTRIM(RTRIM(CoverageType)))=0 OR IS_SPACES(LTRIM(RTRIM(CoverageType))), 'N/A', LTRIM(RTRIM(CoverageType)))\n\tIFF(\n\t    LTRIM(RTRIM(CoverageType)) IS NULL\n\t    or LENGTH(LTRIM(RTRIM(CoverageType))) = 0\n\t    or LENGTH(LTRIM(RTRIM(CoverageType)))>0\n\t    and TRIM(LTRIM(RTRIM(CoverageType)))='',\n\t    'N/A',\n\t    LTRIM(RTRIM(CoverageType))\n\t) AS o_CoverageType,\n\t-- *INF*: IIF(ISNULL(LTRIM(RTRIM(LimitType))) OR LENGTH(LTRIM(RTRIM(LimitType)))=0 OR IS_SPACES(LTRIM(RTRIM(LimitType))), 'N/A', LTRIM(RTRIM(LimitType)))\n\tIFF(\n\t    LTRIM(RTRIM(LimitType)) IS NULL\n\t    or LENGTH(LTRIM(RTRIM(LimitType))) = 0\n\t    or LENGTH(LTRIM(RTRIM(LimitType)))>0\n\t    and TRIM(LTRIM(RTRIM(LimitType)))='',\n\t    'N/A',\n\t    LTRIM(RTRIM(LimitType))\n\t) AS o_LimitType,\n\t-- *INF*: IIF(ISNULL(LTRIM(RTRIM(StandardLimitType))) OR LENGTH(LTRIM(RTRIM(StandardLimitType)))=0 OR IS_SPACES(LTRIM(RTRIM(StandardLimitType))), 'N/A', LTRIM(RTRIM(StandardLimitType)))\n\tIFF(\n\t    LTRIM(RTRIM(StandardLimitType)) IS NULL\n\t    or LENGTH(LTRIM(RTRIM(StandardLimitType))) = 0\n\t    or LENGTH(LTRIM(RTRIM(StandardLimitType)))>0\n\t    and TRIM(LTRIM(RTRIM(StandardLimitType)))='',\n\t    'N/A',\n\t    LTRIM(RTRIM(StandardLimitType))\n\t) AS o_StandardLimitType,\n\t-- *INF*: IIF(ISNULL(LTRIM(RTRIM(LimitLevel))) OR LENGTH(LTRIM(RTRIM(LimitLevel)))=0 OR IS_SPACES(LTRIM(RTRIM(LimitLevel))), 'N/A', LTRIM(RTRIM(LimitLevel)))\n\tIFF(\n\t    LTRIM(RTRIM(LimitLevel)) IS NULL\n\t    or LENGTH(LTRIM(RTRIM(LimitLevel))) = 0\n\t    or LENGTH(LTRIM(RTRIM(LimitLevel)))>0\n\t    and TRIM(LTRIM(RTRIM(LimitLevel)))='',\n\t    'N/A',\n\t    LTRIM(RTRIM(LimitLevel))\n\t) AS o_LimitLevel,\n\tAggregateableFlag AS o_AdditiveFlag\n\tFROM SQ_SupLimitType_CSV\n),\nAGG_SourceFileChecks AS (\n\tSELECT\n\to_CreatedDate AS CreatedDate,\n\to_ModifiedDate AS ModifiedDate,\n\to_ModifiedUserId AS ModifiedUserId,\n\to_InsuranceLine AS InsuranceLine,\n\to_CoverageType AS CoverageType,\n\to_LimitType AS LimitType,\n\to_StandardLimitType AS StandardLimitType,\n\to_LimitLevel AS LimitLevel,\n\to_AdditiveFlag AS AdditiveFlag,\n\t-- *INF*: COUNT(1)\n\tCOUNT(1) AS o_Count\n\tFROM EXP_Default\n\tGROUP BY InsuranceLine, CoverageType, LimitType\n),\nLKP_SupLimitType AS (\n\tSELECT\n\tSupLimitTypeId,\n\tModifiedUserId,\n\tStandardLimitType,\n\tLimitLevel,\n\tAdditiveFlag,\n\tInsuranceLine,\n\tCoverageType,\n\tLimitType\n\tFROM (\n\t\tSELECT \n\t\t\tSupLimitTypeId,\n\t\t\tModifiedUserId,\n\t\t\tStandardLimitType,\n\t\t\tLimitLevel,\n\t\t\tAdditiveFlag,\n\t\t\tInsuranceLine,\n\t\t\tCoverageType,\n\t\t\tLimitType\n\t\tFROM @{pipeline().parameters.TARGET_TABLE_OWNER}.SupLimitType\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY InsuranceLine,CoverageType,LimitType ORDER BY SupLimitTypeId) = 1\n),\nEXP_DetectChange AS (\n\tSELECT\n\tLKP_SupLimitType.SupLimitTypeId AS lkp_SupLimitTypeId,\n\tLKP_SupLimitType.ModifiedUserId AS lkp_ModifiedUserId,\n\tLKP_SupLimitType.StandardLimitType AS lkp_StandardLimitType,\n\tLKP_SupLimitType.LimitLevel AS lkp_LimitLevel,\n\tLKP_SupLimitType.AdditiveFlag AS lkp_AdditiveFlag,\n\tAGG_SourceFileChecks.o_Count AS i_Count,\n\tAGG_SourceFileChecks.CreatedDate,\n\tAGG_SourceFileChecks.ModifiedDate,\n\tAGG_SourceFileChecks.ModifiedUserId,\n\tAGG_SourceFileChecks.InsuranceLine,\n\tAGG_SourceFileChecks.CoverageType,\n\tAGG_SourceFileChecks.LimitType,\n\tAGG_SourceFileChecks.StandardLimitType,\n\tAGG_SourceFileChecks.LimitLevel,\n\tAGG_SourceFileChecks.AdditiveFlag,\n\t'The source file is not good enough to be loaded into the target table. Please check and correct it. The source rows are - InsuranceLine: ' || InsuranceLine || ', CoverageType: ' || CoverageType || ', LimitType: ' || LimitType AS v_Message,\n\t-- *INF*: IIF(i_Count > 1, ABORT(v_Message))\n\tIFF(i_Count > 1, ABORT(v_Message)) AS v_ErrorOut,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ISNULL(lkp_SupLimitTypeId),'New',\r\n\t-- lkp_ModifiedUserId!=ModifiedUserId OR \r\n\t-- lkp_StandardLimitType!=StandardLimitType OR \r\n\t-- lkp_LimitLevel != LimitLevel OR \r\n\t-- IIF(lkp_AdditiveFlag='T',1,0) !=AdditiveFlag, 'Update',\r\n\t-- 'NoChange')\n\tDECODE(\n\t    TRUE,\n\t    lkp_SupLimitTypeId IS NULL, 'New',\n\t    lkp_ModifiedUserId != ModifiedUserId OR lkp_StandardLimitType != StandardLimitType OR lkp_LimitLevel != LimitLevel OR \n\t    IFF(\n\t        lkp_AdditiveFlag = 'T', 1, 0\n\t    ) != AdditiveFlag, 'Update',\n\t    'NoChange'\n\t) AS v_ChangeFlag,\n\tv_ChangeFlag AS o_ChangeFlag\n\tFROM AGG_SourceFileChecks\n\tLEFT JOIN LKP_SupLimitType\n\tON LKP_SupLimitType.InsuranceLine = AGG_SourceFileChecks.InsuranceLine AND LKP_SupLimitType.CoverageType = AGG_SourceFileChecks.CoverageType AND LKP_SupLimitType.LimitType = AGG_SourceFileChecks.LimitType\n),\nRTR_InsertOrUpdate AS (\n\tSELECT\n\tlkp_SupLimitTypeId,\n\tCreatedDate,\n\tModifiedDate,\n\tModifiedUserId,\n\tInsuranceLine,\n\tCoverageType,\n\tLimitType,\n\tStandardLimitType,\n\tLimitLevel,\n\tAdditiveFlag,\n\to_ChangeFlag AS ChangeFlag\n\tFROM EXP_DetectChange\n),\nRTR_InsertOrUpdate_Insert AS (SELECT * FROM RTR_InsertOrUpdate WHERE ChangeFlag='New'),\nRTR_InsertOrUpdate_Update AS (SELECT * FROM RTR_InsertOrUpdate WHERE ChangeFlag='Update'),\nSupLimitType_Insert AS (\n\tINSERT INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.SupLimitType\n\t(CreatedDate, ModifiedDate, ModifiedUserId, InsuranceLine, CoverageType, LimitType, StandardLimitType, LimitLevel, AdditiveFlag)\n\tSELECT \n\tCREATEDDATE, \n\tMODIFIEDDATE, \n\tMODIFIEDUSERID, \n\tINSURANCELINE, \n\tCOVERAGETYPE, \n\tLIMITTYPE, \n\tSTANDARDLIMITTYPE, \n\tLIMITLEVEL, \n\tADDITIVEFLAG\n\tFROM RTR_InsertOrUpdate_Insert\n),\nUPD_Update AS (\n\tSELECT\n\tlkp_SupLimitTypeId AS lkp_SupLimitTypeId3, \n\tModifiedDate AS ModifiedDate3, \n\tModifiedUserId AS ModifiedUserId3, \n\tStandardLimitType AS StandardLimitType3, \n\tLimitLevel AS LimitLevel3, \n\tAdditiveFlag AS AdditiveFlag3\n\tFROM RTR_InsertOrUpdate_Update\n),\nSupLimitType_Update AS (\n\tMERGE INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.SupLimitType AS T\n\tUSING UPD_Update AS S\n\tON T.SupLimitTypeId = S.lkp_SupLimitTypeId3\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.ModifiedDate = S.ModifiedDate3, T.ModifiedUserId = S.ModifiedUserId3, T.StandardLimitType = S.StandardLimitType3, T.LimitLevel = S.LimitLevel3, T.AdditiveFlag = S.AdditiveFlag3\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "TARGET_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "Default Value"
            }
        },
        "folder": {
            "name": "RPT_EDM and EDW/Policy DataWarehouse/"
        },
        "annotations": []
    }
}