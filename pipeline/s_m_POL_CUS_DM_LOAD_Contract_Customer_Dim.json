{
    "name": "s_m_POL_CUS_DM_LOAD_Contract_Customer_Dim",
    "properties": {
        "activities": [
            {
                "name": "m_POL_CUS_DM_LOAD_Contract_Customer_Dim",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nLKP_All_Support_tables AS (\n\tSELECT\n\tdescript,\n\tsource_sys_id,\n\ttablename,\n\tcode\n\tFROM (\n\t\tSELECT \r\n\t\t\tbill_plan_use_code_descript as descript,\r\n\t\t\t'sup_bill_plan_use_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(bill_plan_use_code)) as code\r\n\t\tFROM \tsup_bill_plan_use_code \r\n\t\tWHERE   sup_bill_plan_use_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tbill_type_code_descript as descript,\r\n\t\t\t'sup_bill_type_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(bill_type_code)) as code\r\n\t\tFROM \tsup_bill_type_code \r\n\t\tWHERE   sup_bill_type_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tbill_class_code_descript as descript,\r\n\t\t\t'sup_bill_class_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(bill_class_code)) as code\r\n\t\tFROM \tsup_bill_class_code \r\n\t\tWHERE   sup_bill_class_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tbill_trans_code_descript as descript,\r\n\t\t\t'sup_bill_transaction_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(bill_trans_code)) as code\t\r\n\t\tFROM \tsup_bill_transaction_code \r\n\t\tWHERE   sup_bill_transaction_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tars_type_code_descript as descript,\r\n\t\t\t'sup_bill_ars_type_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(ars_type_code)) as code\r\n\t\tFROM \tsup_bill_ars_type_code \r\n\t\tWHERE   sup_bill_ars_type_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tpayby_code_descript as descript,\r\n\t\t\t'sup_payby_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(payby_code)) as code\r\n\t\tFROM \tsup_payby_code \r\n\t\tWHERE   sup_payby_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tmrktng_pkg_description as descript,\r\n\t\t\t'sup_marketing_package_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(mrktng_pkg_code)) as code\r\n\t\tFROM \tsup_marketing_package_code\r\n\t\tWHERE   sup_marketing_package_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\texcess_claim_code_descript as descript,\r\n\t\t\t'sup_excess_claim_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(excess_claim_code)) as code\r\n\t\tFROM \tsup_excess_claim_code\r\n\t\tWHERE   sup_excess_claim_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tnon_smoker_disc_code_descript as descript,\r\n\t\t\t'sup_non_smoker_discount_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(non_smoker_disc_code)) as code\r\n\t\tFROM \tsup_non_smoker_discount_code\r\n\t\tWHERE   sup_non_smoker_discount_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tvariation_code_descript as descript,\r\n\t\t\t'sup_policy_variation_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(variation_code)) as code\t\r\n\t\tFROM \tsup_policy_variation_code\r\n\t\tWHERE   sup_policy_variation_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tpol_audit_frqncy_descript as descript,\r\n\t\t\t'sup_policy_audit_frequency' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(pol_audit_frqncy)) as code\r\n\t\tFROM \tsup_policy_audit_frequency\r\n\t\tWHERE   sup_policy_audit_frequency.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\trenl_code_descript as descript,\r\n\t\t\t'sup_policy_renewal_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(renl_code)) as code\r\n\t\tFROM \tsup_policy_renewal_code\r\n\t\tWHERE   sup_policy_renewal_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tmvr_request_code_descript as descript,\r\n\t\t\t'sup_mvr_request_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(mvr_request_code)) as code\t\r\n\t\tFROM \tsup_mvr_request_code\r\n\t\tWHERE   sup_mvr_request_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tindustry_risk_grade_code_descript as descript,\r\n\t\t\t'sup_industry_risk_grade_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(industry_risk_grade_code)) as code\t\r\n\t\tFROM \tsup_industry_risk_grade_code\r\n\t\tWHERE   sup_industry_risk_grade_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tpol_issue_code_descript as descript,\r\n\t\t\t'sup_policy_issue_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(pol_issue_code)) as code\r\n\t\tFROM \tsup_policy_issue_code\r\n\t\tWHERE   sup_policy_issue_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT\r\n\t\t\tpol_status_code_descript as descript, \r\n\t\t\t'sup_policy_status_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(pol_status_code)) as code\r\n\t\tFROM \tsup_policy_status_code\r\n\t\tWHERE   sup_policy_status_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT\r\n\t\t\tpol_term_descript as descript, \r\n\t\t\t'sup_policy_term' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(pol_term)) as code\r\n\t\tFROM \tsup_policy_term\r\n\t\tWHERE   sup_policy_term.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tserv_center_support_code_descript as descript,\r\n\t\t\t'sup_service_center_support_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(serv_center_support_code)) as code\r\n\t\tFROM \tsup_service_center_support_code\r\n\t\tWHERE   sup_service_center_support_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\twbconnect_upload_code_descript as descript,\r\n\t\t\t'sup_wbconnect_upload_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(wbconnect_upload_code)) as code\r\n\t\tFROM \tsup_wbconnect_upload_code\r\n\t\tWHERE   sup_wbconnect_upload_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tstate_descript as descript,\r\n\t\t\t'sup_state' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(state_abbrev)) as code\r\n\t\tFROM \tsup_state\r\n\t\tWHERE   sup_state.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tstate_descript as descript,\r\n\t\t\t'sup_state' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(state_code)) as code\r\n\t\tFROM \tsup_state\r\n\t\tWHERE   sup_state.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tstate_code as descript,\r\n\t\t\t'sup_state_abbrev' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(state_abbrev)) as code\r\n\t\tFROM \tsup_state\r\n\t\tWHERE   sup_state.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tpol_co_num_descript as descript,\r\n\t\t\t'sup_policy_company_number' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(pol_co_num)) as code\r\n\t\tFROM \tsup_policy_company_number\r\n\t\tWHERE   sup_policy_company_number.crrnt_snpsht_flag=1\r\n\t\t\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tpol_co_line_code_descript as descript,\r\n\t\t\t'sup_policy_company_line_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(pol_co_line_code)) as code\r\n\t\tFROM \tsup_policy_company_line_code\r\n\t\tWHERE   sup_policy_company_line_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\treins_code_descript as descript,\r\n\t\t\t'sup_reinsurance_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(reins_code)) as code\r\n\t\tFROM \tsup_reinsurance_code\r\n\t\tWHERE   sup_reinsurance_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tbus_class_code_descript as descript,\r\n\t\t\t'sup_business_classification_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(bus_class_code)) as code\r\n\t\tFROM \tsup_business_classification_code\r\n\t\tWHERE   sup_business_classification_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\ttarget_mrkt_code_descript as descript,\r\n\t\t\t'sup_target_market_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(target_mrkt_code)) as code\r\n\t\tFROM \tsup_target_market_code\r\n\t\tWHERE   sup_target_market_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tassoc_prog_code_descript as descript,\r\n\t\t\t'sup_association_program_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(assoc_prog_code)) as code\r\n\t\tFROM \tsup_association_program_code\r\n\t\tWHERE   sup_association_program_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tlgl_ent_code_descript as descript,\r\n\t\t\t'sup_legal_entity_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(lgl_ent_code)) as code\r\n\t\tFROM \tsup_legal_entity_code\r\n\t\tWHERE   sup_legal_entity_code.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tcdt_rating_score_descript as descript,\r\n\t\t\t'sup_credit_rating_score' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(cdt_rating_score)) as code\r\n\t\tFROM \tsup_credit_rating_score\r\n\t\tWHERE   sup_credit_rating_score.crrnt_snpsht_flag=1\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tsic_code_descript as descript,\r\n\t\t\t'sup_sic_code' AS tablename ,\r\n\t\t\tLTRIM(RTRIM(sic_code)) as code\r\n\t\tFROM \tsup_sic_code\r\n\t\tWHERE   sup_sic_code.crrnt_snpsht_flag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY source_sys_id,tablename,code ORDER BY descript DESC) = 1\n),\nSQ_contract_customer_sources AS (\n\n------------ PRE SQL ----------\ntruncate table dbo.work_contract_customer\r\n\r\ninsert dbo.work_contract_customer (contract_customer_ak_id ,\r\n                    EFF_FROM_DATE)\r\nSELECT    CONTRACT_CUST_AK_ID ,\r\n                    EFF_FROM_DATE\r\n          FROM      dbo.CONTRACT_CUSTOMER\r\n          WHERE     CREATED_DATE >= '@{pipeline().parameters.SELECTION_START_TS}'\r\n          UNION\r\n          SELECT    CONTRACT_CUST_AK_ID ,\r\n                    EFF_FROM_DATE\r\n          FROM      dbo.CONTRACT_CUSTOMER_ADDRESS\r\n          WHERE     CREATED_DATE >= '@{pipeline().parameters.SELECTION_START_TS}'\n----------------------\n\n\n\tSELECT \r\n\t\tCONT_CUST.contract_cust_id,\r\n\t\tCONT_CUST.source_sys_id,\t\r\n\t\tCONT_CUST.contract_cust_ak_id,\t\r\n\t\tCONT_CUST.cust_num,\t\r\n\t\tCONT_CUST.contract_key,\t\r\n\t\tCONT_CUST.cust_role,\t\t\r\n\t\tCONT_CUST.name,\t\r\n\t\tCONT_CUST.fed_tax_id,\t\t\r\n\t\tCONT_CUST.doing_bus_as,\t\t\r\n\t\tCONT_CUST.sic_code,\t\r\n\t\tCONT_CUST.naics_code,\t\t\r\n\t\tCONT_CUST.yr_in_bus,\t\t\r\n\t\tCONT_CUST.ph_num_full,\t\t\r\n\t\tCONT_CUST.ph_area_code,\t\t\r\n\t\tCONT_CUST.ph_exchange,\t\t\r\n\t\tCONT_CUST.ph_num,\t\t\r\n\t\tCONT_CUST.ph_extension,\r\n\t\tCONT_CUST.bus_email_addr,\r\n\t\tCONT_CUST.sort_name,\r\n\t\tCONT_CUST_ADDR_M.contract_cust_addr_id AS contract_cust_addr_id_M,\t\t\r\n\t\tCONT_CUST_ADDR_M.loc_unit_num AS loc_unit_num_M,\r\n\t\tCONT_CUST_ADDR_M.addr_line_1 AS addr_line_1_M ,\t\t\t\r\n\t\tCONT_CUST_ADDR_M.addr_line_2 AS addr_line_2_M,\r\n\t\tCONT_CUST_ADDR_M.addr_line_3 AS addr_line_3_M,\t\t\t\r\n\t\tCONT_CUST_ADDR_M.city_name AS city_name_M,\r\n\t\tCONT_CUST_ADDR_M.state_prov_code AS state_prov_code_M,\t\t\r\n\t\tCONT_CUST_ADDR_M.zip_postal_code AS zip_postal_code_M,\r\n\t\tCONT_CUST_ADDR_M.zip_postal_code_extension AS zip_postal_code_extension_M,\t\r\n\t\tCONT_CUST_ADDR_M.county_parish_name AS county_parish_name_M,\r\n\t\tCONT_CUST_ADDR_M.country_name AS country_name_M,\r\n\t\tCONT_CUST_ADDR_O.contract_cust_addr_id AS  contract_cust_addr_id_O,\t\t\r\n\t\tCONT_CUST_ADDR_O.loc_unit_num AS loc_unit_num_O,\r\n\t\tCONT_CUST_ADDR_O.addr_line_1 AS addr_line_1_O,\t\t\t\r\n\t\tCONT_CUST_ADDR_O.addr_line_2 AS addr_line_2_O,\r\n\t\tCONT_CUST_ADDR_O.addr_line_3 AS addr_line_3_O,\t\t\t\r\n\t\tCONT_CUST_ADDR_O.city_name AS city_name_O,\r\n\t\tCONT_CUST_ADDR_O.state_prov_code AS state_prov_code_O,\t\t\r\n\t\tCONT_CUST_ADDR_O.zip_postal_code AS zip_postal_code_O,\r\n\t\tCONT_CUST_ADDR_O.zip_postal_code_extension AS zip_postal_code_extension_O,\t\r\n\t\tCONT_CUST_ADDR_O.county_parish_name AS county_parish_name_O,\r\n\t\tCONT_CUST_ADDR_O.country_name AS country_name_O,\r\n\t\tDISTINCT_EFF_FROM_DATES.EFF_FROM_DATE AS DIST_EFF_FROM_DATE,\r\n\t\tCONT_CUST.sup_lgl_ent_code_id\r\n\tFROM dbo.work_contract_customer AS DISTINCT_EFF_FROM_DATES\r\n\t\r\n\tLEFT OUTER JOIN @{pipeline().parameters.SOURCE_TABLE_OWNER}.CONTRACT_CUSTOMER CONT_CUST\r\n\tON DISTINCT_EFF_FROM_DATES.EFF_FROM_DATE BETWEEN CONT_CUST.EFF_FROM_DATE AND CONT_CUST.EFF_TO_DATE\r\n\tAND DISTINCT_EFF_FROM_DATES.contract_customer_ak_id = CONT_CUST.CONTRACT_CUST_AK_ID\r\n\t\r\n\tLEFT OUTER JOIN @{pipeline().parameters.SOURCE_TABLE_OWNER}.CONTRACT_CUSTOMER_ADDRESS CONT_CUST_ADDR_M\r\n\tON DISTINCT_EFF_FROM_DATES.EFF_FROM_DATE BETWEEN CONT_CUST_ADDR_M.EFF_FROM_DATE AND CONT_CUST_ADDR_M.EFF_TO_DATE\r\n\tAND CONT_CUST.CONTRACT_CUST_AK_ID = CONT_CUST_ADDR_M.CONTRACT_CUST_AK_ID AND CONT_CUST_ADDR_M.ADDR_TYPE='MAILING'\r\n\t\r\n\tLEFT OUTER JOIN @{pipeline().parameters.SOURCE_TABLE_OWNER}.CONTRACT_CUSTOMER_ADDRESS CONT_CUST_ADDR_O\r\n\tON DISTINCT_EFF_FROM_DATES.EFF_FROM_DATE BETWEEN CONT_CUST_ADDR_O.EFF_FROM_DATE AND CONT_CUST_ADDR_O.EFF_TO_DATE\r\n\tAND CONT_CUST.CONTRACT_CUST_AK_ID = CONT_CUST_ADDR_O.CONTRACT_CUST_AK_ID AND CONT_CUST_ADDR_O.ADDR_TYPE='OTHER'\r\n\t\r\n\tWHERE CONT_CUST.contract_cust_id IS NOT NULL\n),\nLKP_v2_policy AS (\n\tSELECT\n\tProgramAKId,\n\tcontract_cust_ak_id\n\tFROM (\n\t\tSELECT \r\n\t\tp.ProgramAKId as ProgramAKId, \r\n\t\tp.contract_cust_ak_id \r\n\t\tas contract_cust_ak_id\r\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER_V2}.policy p\r\n\t\tWHERE p.crrnt_snpsht_flag = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY contract_cust_ak_id ORDER BY ProgramAKId DESC) = 1\n),\nLKP_Program AS (\n\tSELECT\n\tProgramCode,\n\tProgramDescription,\n\tProgramAKId\n\tFROM (\n\t\tSELECT \n\t\t\tProgramCode,\n\t\t\tProgramDescription,\n\t\t\tProgramAKId\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.Program\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY ProgramAKId ORDER BY ProgramCode) = 1\n),\nLKP_sup_legal_entity_code AS (\n\tSELECT\n\tStandardLegalEntityCode,\n\tStandardLegalEntityDescription,\n\tsup_lgl_ent_code_id,\n\tsource_sys_id\n\tFROM (\n\t\tSELECT \n\t\t\tStandardLegalEntityCode,\n\t\t\tStandardLegalEntityDescription,\n\t\t\tsup_lgl_ent_code_id,\n\t\t\tsource_sys_id\n\t\tFROM @{pipeline().parameters.TARGET_TABLE_OWNER}.sup_legal_entity_code\n\t\tWHERE crrnt_snpsht_flag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY sup_lgl_ent_code_id,source_sys_id ORDER BY StandardLegalEntityCode) = 1\n),\nEXP_values AS (\n\tSELECT\n\tSQ_contract_customer_sources.contract_cust_id,\n\tSQ_contract_customer_sources.source_sys_id,\n\tSQ_contract_customer_sources.contract_cust_ak_id,\n\tSQ_contract_customer_sources.cust_num,\n\tSQ_contract_customer_sources.contract_key,\n\tSQ_contract_customer_sources.cust_role,\n\tSQ_contract_customer_sources.name,\n\tSQ_contract_customer_sources.fed_tax_id,\n\tSQ_contract_customer_sources.doing_bus_as,\n\tSQ_contract_customer_sources.sic_code,\n\tSQ_contract_customer_sources.naics_code,\n\tLKP_sup_legal_entity_code.StandardLegalEntityCode AS lgl_ent_code,\n\tLKP_sup_legal_entity_code.StandardLegalEntityDescription AS lgl_ent_code_descript,\n\tSQ_contract_customer_sources.yr_in_bus,\n\tSQ_contract_customer_sources.ph_num_full,\n\tSQ_contract_customer_sources.ph_area_code,\n\tSQ_contract_customer_sources.ph_exchange,\n\tSQ_contract_customer_sources.ph_num,\n\tSQ_contract_customer_sources.ph_extension,\n\tSQ_contract_customer_sources.bus_email_addr,\n\tSQ_contract_customer_sources.sort_name,\n\tSQ_contract_customer_sources.contract_cust_addr_id_M AS in_contract_cust_addr_id_M,\n\tSQ_contract_customer_sources.loc_unit_num_M AS in_loc_unit_num_M,\n\tSQ_contract_customer_sources.addr_line_1_M AS in_addr_line_1_M,\n\tSQ_contract_customer_sources.addr_line_2_M AS in_addr_line_2_M,\n\tSQ_contract_customer_sources.addr_line_3_M AS in_addr_line_3_M,\n\tSQ_contract_customer_sources.city_name_M AS in_city_name_M,\n\tSQ_contract_customer_sources.state_prov_code_M AS in_state_prov_code_M,\n\tSQ_contract_customer_sources.zip_postal_code_M AS in_zip_postal_code_M,\n\tSQ_contract_customer_sources.zip_postal_code_extension_M AS in_zip_postal_code_extension_M,\n\tSQ_contract_customer_sources.county_parish_name_M AS in_county_parish_name_M,\n\tSQ_contract_customer_sources.country_name_M AS in_country_name_M,\n\tSQ_contract_customer_sources.contract_cust_addr_id_O AS in_contract_cust_addr_id_O,\n\tSQ_contract_customer_sources.loc_unit_num_O AS in_loc_unit_num_O,\n\tSQ_contract_customer_sources.addr_line_1_O AS in_addr_line_1_O,\n\tSQ_contract_customer_sources.addr_line_2_O AS in_addr_line_2_O,\n\tSQ_contract_customer_sources.addr_line_3_O AS in_addr_line_3_O,\n\tSQ_contract_customer_sources.city_name_O AS in_city_name_O,\n\tSQ_contract_customer_sources.state_prov_code_O AS in_state_prov_code_O,\n\tSQ_contract_customer_sources.zip_postal_code_O AS in_zip_postal_code_O,\n\tSQ_contract_customer_sources.zip_postal_code_extension_O AS in_zip_postal_code_extension_O,\n\tSQ_contract_customer_sources.county_parish_name_O AS in_county_parish_name_O,\n\tSQ_contract_customer_sources.country_name_O AS in_country_name_O,\n\tLKP_Program.ProgramCode AS in_ProgramCode,\n\tLKP_Program.ProgramDescription AS in_ProgramDescription,\n\t-- *INF*: IIF(ISNULL(in_ProgramCode),'N/A',in_ProgramCode)\n\tIFF(in_ProgramCode IS NULL, 'N/A', in_ProgramCode) AS out_ProgramCode,\n\t-- *INF*: IIF(ISNULL(in_ProgramDescription),'N/A',in_ProgramDescription)\n\tIFF(in_ProgramDescription IS NULL, 'N/A', in_ProgramDescription) AS out_ProgramDescription,\n\t-- *INF*: IIF(ISNULL(in_contract_cust_addr_id_M),-1,in_contract_cust_addr_id_M)\n\tIFF(in_contract_cust_addr_id_M IS NULL, - 1, in_contract_cust_addr_id_M) AS out_contract_cust_addr_id_M,\n\t-- *INF*: IIF(ISNULL(in_loc_unit_num_M),'N/A',in_loc_unit_num_M)\n\tIFF(in_loc_unit_num_M IS NULL, 'N/A', in_loc_unit_num_M) AS out_loc_unit_num_M,\n\t-- *INF*: IIF(ISNULL(in_addr_line_1_M),'N/A',in_addr_line_1_M)\n\tIFF(in_addr_line_1_M IS NULL, 'N/A', in_addr_line_1_M) AS out_addr_line_1_M,\n\t-- *INF*: IIF(ISNULL(in_addr_line_2_M),'N/A',in_addr_line_2_M)\n\tIFF(in_addr_line_2_M IS NULL, 'N/A', in_addr_line_2_M) AS out_addr_line_2_M,\n\t-- *INF*: IIF(ISNULL(in_addr_line_3_M),'N/A',in_addr_line_3_M)\n\tIFF(in_addr_line_3_M IS NULL, 'N/A', in_addr_line_3_M) AS out_addr_line_3_M,\n\t-- *INF*: IIF(ISNULL(in_city_name_M),'N/A',in_city_name_M)\n\tIFF(in_city_name_M IS NULL, 'N/A', in_city_name_M) AS out_city_name_M,\n\t-- *INF*: IIF(ISNULL(in_state_prov_code_M),'N/A',in_state_prov_code_M)\n\tIFF(in_state_prov_code_M IS NULL, 'N/A', in_state_prov_code_M) AS out_state_prov_code_M,\n\t-- *INF*: IIF(ISNULL(in_zip_postal_code_M),'N/A',in_zip_postal_code_M)\n\tIFF(in_zip_postal_code_M IS NULL, 'N/A', in_zip_postal_code_M) AS out_zip_postal_code_M,\n\t-- *INF*: IIF(ISNULL(in_zip_postal_code_extension_M),'N/A',in_zip_postal_code_extension_M)\n\tIFF(in_zip_postal_code_extension_M IS NULL, 'N/A', in_zip_postal_code_extension_M) AS out_zip_postal_code_extension_M,\n\t-- *INF*: IIF(ISNULL(in_county_parish_name_M),'N/A',in_county_parish_name_M)\n\tIFF(in_county_parish_name_M IS NULL, 'N/A', in_county_parish_name_M) AS out_county_parish_name_M,\n\t-- *INF*: IIF(ISNULL(in_country_name_M),'N/A',in_country_name_M)\n\tIFF(in_country_name_M IS NULL, 'N/A', in_country_name_M) AS out_country_name_M,\n\t-- *INF*: IIF(ISNULL(in_contract_cust_addr_id_O),-1,in_contract_cust_addr_id_O)\n\tIFF(in_contract_cust_addr_id_O IS NULL, - 1, in_contract_cust_addr_id_O) AS out_contract_cust_addr_id_O,\n\t-- *INF*: IIF(ISNULL(in_loc_unit_num_O),'N/A',in_loc_unit_num_O)\n\tIFF(in_loc_unit_num_O IS NULL, 'N/A', in_loc_unit_num_O) AS out_loc_unit_num_O,\n\t-- *INF*: IIF(ISNULL(in_addr_line_1_O),'N/A',in_addr_line_1_O)\n\tIFF(in_addr_line_1_O IS NULL, 'N/A', in_addr_line_1_O) AS out_addr_line_1_O,\n\t-- *INF*: IIF(ISNULL(in_addr_line_2_O),'N/A',in_addr_line_2_O)\n\tIFF(in_addr_line_2_O IS NULL, 'N/A', in_addr_line_2_O) AS out_addr_line_2_O,\n\t-- *INF*: IIF(ISNULL(in_addr_line_3_O),'N/A',in_addr_line_3_O)\n\tIFF(in_addr_line_3_O IS NULL, 'N/A', in_addr_line_3_O) AS out_addr_line_3_O,\n\t-- *INF*: IIF(ISNULL(in_city_name_O),'N/A',in_city_name_O)\n\tIFF(in_city_name_O IS NULL, 'N/A', in_city_name_O) AS out_city_name_O,\n\t-- *INF*: IIF(ISNULL(in_state_prov_code_O),'N/A',in_state_prov_code_O)\n\tIFF(in_state_prov_code_O IS NULL, 'N/A', in_state_prov_code_O) AS out_state_prov_code_O,\n\t-- *INF*: IIF(ISNULL(in_zip_postal_code_O),'N/A',in_zip_postal_code_O)\n\tIFF(in_zip_postal_code_O IS NULL, 'N/A', in_zip_postal_code_O) AS out_zip_postal_code_O,\n\t-- *INF*: IIF(ISNULL(in_zip_postal_code_extension_O),'N/A',in_zip_postal_code_extension_O)\n\tIFF(in_zip_postal_code_extension_O IS NULL, 'N/A', in_zip_postal_code_extension_O) AS out_zip_postal_code_extension_O,\n\t-- *INF*: IIF(ISNULL(in_county_parish_name_O),'N/A',in_county_parish_name_O)\n\tIFF(in_county_parish_name_O IS NULL, 'N/A', in_county_parish_name_O) AS out_county_parish_name_O,\n\t-- *INF*: IIF(ISNULL(in_country_name_O),'N/A',in_country_name_O)\n\tIFF(in_country_name_O IS NULL, 'N/A', in_country_name_O) AS out_country_name_O,\n\tSQ_contract_customer_sources.DIST_EFF_FROM_DATE\n\tFROM SQ_contract_customer_sources\n\tLEFT JOIN LKP_Program\n\tON LKP_Program.ProgramAKId = LKP_v2_policy.ProgramAKId\n\tLEFT JOIN LKP_sup_legal_entity_code\n\tON LKP_sup_legal_entity_code.sup_lgl_ent_code_id = SQ_contract_customer_sources.sup_lgl_ent_code_id AND LKP_sup_legal_entity_code.source_sys_id = SQ_contract_customer_sources.source_sys_id\n),\nLKP_SupNaicsCode AS (\n\tSELECT\n\tSupNaicsCodeId,\n\tCreatedDate,\n\tModifiedDate,\n\tSourceSystemId,\n\tNAICSCode,\n\tNAICSCodeDesc,\n\tNAICSIndustryGroupCode,\n\tNAICSIndustryGroupCodeDesc,\n\tNAICSSubsectorCode,\n\tNAICSSubsectorCodeDesc,\n\tNAICSSectorCode,\n\tNAICSSectorCodeDesc\n\tFROM (\n\t\tSELECT \n\t\t\tSupNaicsCodeId,\n\t\t\tCreatedDate,\n\t\t\tModifiedDate,\n\t\t\tSourceSystemId,\n\t\t\tNAICSCode,\n\t\t\tNAICSCodeDesc,\n\t\t\tNAICSIndustryGroupCode,\n\t\t\tNAICSIndustryGroupCodeDesc,\n\t\t\tNAICSSubsectorCode,\n\t\t\tNAICSSubsectorCodeDesc,\n\t\t\tNAICSSectorCode,\n\t\t\tNAICSSectorCodeDesc\n\t\tFROM SupNaicsCode\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY NAICSCode ORDER BY SupNaicsCodeId) = 1\n),\nEXP_sup_description AS (\n\tSELECT\n\tEXP_values.contract_cust_id,\n\tEXP_values.source_sys_id,\n\tEXP_values.contract_cust_ak_id,\n\tEXP_values.cust_num,\n\tEXP_values.contract_key,\n\tEXP_values.cust_role,\n\tEXP_values.name,\n\tEXP_values.fed_tax_id,\n\tEXP_values.doing_bus_as,\n\tEXP_values.sic_code,\n\t-- *INF*: :LKP.LKP_ALL_SUPPORT_TABLES('N/A','sup_sic_code',sic_code)\r\n\t-- \n\tLKP_ALL_SUPPORT_TABLES__N_A_sup_sic_code_sic_code.descript AS v_sic_code_descript,\n\t-- *INF*: IIF(ISNULL(v_sic_code_descript) or IS_SPACES(v_sic_code_descript)  or LENGTH(v_sic_code_descript)=0,'N/A',LTRIM(RTRIM(v_sic_code_descript)))\n\tIFF(v_sic_code_descript IS NULL OR IS_SPACES(v_sic_code_descript) OR LENGTH(v_sic_code_descript) = 0, 'N/A', LTRIM(RTRIM(v_sic_code_descript))) AS sic_code_descript,\n\tEXP_values.naics_code,\n\tLKP_SupNaicsCode.NAICSCodeDesc AS IN_NAICSCodeDesc,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(IN_NAICSCodeDesc)\n\t:UDF.DEFAULT_VALUE_FOR_STRINGS(IN_NAICSCodeDesc) AS naics_code_description,\n\tEXP_values.lgl_ent_code,\n\tEXP_values.lgl_ent_code_descript,\n\tEXP_values.yr_in_bus,\n\tEXP_values.ph_num_full,\n\tEXP_values.ph_area_code,\n\tEXP_values.ph_exchange,\n\tEXP_values.ph_num,\n\tEXP_values.ph_extension,\n\tEXP_values.bus_email_addr,\n\tEXP_values.sort_name,\n\tEXP_values.out_ProgramCode AS ProgramCode,\n\tEXP_values.out_ProgramDescription AS ProgramCodeDescription,\n\tEXP_values.out_contract_cust_addr_id_M AS contract_cust_addr_id_M,\n\tEXP_values.out_loc_unit_num_M AS loc_unit_num_M,\n\tEXP_values.out_addr_line_1_M AS addr_line_1_M,\n\tEXP_values.out_addr_line_2_M AS addr_line_2_M,\n\tEXP_values.out_addr_line_3_M AS addr_line_3_M,\n\tEXP_values.out_city_name_M AS city_name_M,\n\tEXP_values.out_state_prov_code_M AS state_prov_code_M,\n\t-- *INF*: :LKP.LKP_ALL_SUPPORT_TABLES('EXCEED','sup_state',state_prov_code_M)\n\tLKP_ALL_SUPPORT_TABLES__EXCEED_sup_state_state_prov_code_M.descript AS v_state_prov_code_description_M,\n\t-- *INF*: IIF(ISNULL(v_state_prov_code_description_M) or IS_SPACES(v_state_prov_code_description_M)  or LENGTH(v_state_prov_code_description_M)=0,'N/A',LTRIM(RTRIM(v_state_prov_code_description_M)))\n\tIFF(v_state_prov_code_description_M IS NULL OR IS_SPACES(v_state_prov_code_description_M) OR LENGTH(v_state_prov_code_description_M) = 0, 'N/A', LTRIM(RTRIM(v_state_prov_code_description_M))) AS state_prov_code_description_M,\n\tEXP_values.out_zip_postal_code_M AS zip_postal_code_M,\n\tEXP_values.out_zip_postal_code_extension_M AS zip_postal_code_extension_M,\n\tEXP_values.out_county_parish_name_M AS county_parish_name_M,\n\tEXP_values.out_country_name_M AS country_name_M,\n\tEXP_values.out_contract_cust_addr_id_O AS contract_cust_addr_id_O,\n\tEXP_values.out_loc_unit_num_O AS loc_unit_num_O,\n\tEXP_values.out_addr_line_1_O AS addr_line_1_O,\n\tEXP_values.out_addr_line_2_O AS addr_line_2_O,\n\tEXP_values.out_addr_line_3_O AS addr_line_3_O,\n\tEXP_values.out_city_name_O AS city_name_O,\n\tEXP_values.out_state_prov_code_O AS state_prov_code_O,\n\t-- *INF*: :LKP.LKP_ALL_SUPPORT_TABLES('EXCEED','sup_state',state_prov_code_O)\n\tLKP_ALL_SUPPORT_TABLES__EXCEED_sup_state_state_prov_code_O.descript AS v_state_prov_code_description_O,\n\t-- *INF*: IIF(ISNULL(v_state_prov_code_description_O) or IS_SPACES(v_state_prov_code_description_O)  or LENGTH(v_state_prov_code_description_O)=0,'N/A',LTRIM(RTRIM(v_state_prov_code_description_O)))\n\tIFF(v_state_prov_code_description_O IS NULL OR IS_SPACES(v_state_prov_code_description_O) OR LENGTH(v_state_prov_code_description_O) = 0, 'N/A', LTRIM(RTRIM(v_state_prov_code_description_O))) AS state_prov_code_description_O,\n\tEXP_values.out_zip_postal_code_O AS zip_postal_code_O,\n\tEXP_values.out_zip_postal_code_extension_O AS zip_postal_code_extension_O,\n\tEXP_values.out_county_parish_name_O AS county_parish_name_O,\n\tEXP_values.out_country_name_O AS country_name_O,\n\tEXP_values.DIST_EFF_FROM_DATE,\n\t1 AS crrnt_snpsht_flag,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS audit_id,\n\t-- *INF*: TO_DATE('12/31/2100 23:59:59', 'MM/DD/YYYY HH24:MI:SS')\n\tTO_DATE('12/31/2100 23:59:59', 'MM/DD/YYYY HH24:MI:SS') AS eff_to_date,\n\tSYSDATE AS created_date,\n\tSYSDATE AS modified_date,\n\tLKP_SupNaicsCode.NAICSIndustryGroupCode AS IN_NAICSIndustryGroupCode,\n\tLKP_SupNaicsCode.NAICSIndustryGroupCodeDesc AS IN_NAICSIndustryGroupCodeDesc,\n\tLKP_SupNaicsCode.NAICSSubsectorCode AS IN_NAICSSubsectorCode,\n\tLKP_SupNaicsCode.NAICSSubsectorCodeDesc AS IN_NAICSSubsectorCodeDesc,\n\tLKP_SupNaicsCode.NAICSSectorCode AS IN_NAICSSectorCode,\n\tLKP_SupNaicsCode.NAICSSectorCodeDesc AS IN_NAICSSectorCodeDesc,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(IN_NAICSIndustryGroupCode)\n\t:UDF.DEFAULT_VALUE_FOR_STRINGS(IN_NAICSIndustryGroupCode) AS NAICSIndustryGroupCode,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(IN_NAICSIndustryGroupCodeDesc)\n\t:UDF.DEFAULT_VALUE_FOR_STRINGS(IN_NAICSIndustryGroupCodeDesc) AS NAICSIndustryGroupCodeDesc,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(IN_NAICSSubsectorCode)\n\t:UDF.DEFAULT_VALUE_FOR_STRINGS(IN_NAICSSubsectorCode) AS NAICSSubsectorCode,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(IN_NAICSSubsectorCodeDesc)\n\t:UDF.DEFAULT_VALUE_FOR_STRINGS(IN_NAICSSubsectorCodeDesc) AS NAICSSubsectorCodeDesc,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(IN_NAICSSectorCode)\n\t:UDF.DEFAULT_VALUE_FOR_STRINGS(IN_NAICSSectorCode) AS NAICSSectorCode,\n\t-- *INF*: :UDF.DEFAULT_VALUE_FOR_STRINGS(IN_NAICSSectorCodeDesc)\n\t:UDF.DEFAULT_VALUE_FOR_STRINGS(IN_NAICSSectorCodeDesc) AS NAICSSectorCodeDesc\n\tFROM EXP_values\n\tLEFT JOIN LKP_SupNaicsCode\n\tON LKP_SupNaicsCode.NAICSCode = EXP_values.naics_code\n\tLEFT JOIN LKP_ALL_SUPPORT_TABLES LKP_ALL_SUPPORT_TABLES__N_A_sup_sic_code_sic_code\n\tON LKP_ALL_SUPPORT_TABLES__N_A_sup_sic_code_sic_code.source_sys_id = 'N/A'\n\tAND LKP_ALL_SUPPORT_TABLES__N_A_sup_sic_code_sic_code.tablename = 'sup_sic_code'\n\tAND LKP_ALL_SUPPORT_TABLES__N_A_sup_sic_code_sic_code.code = sic_code\n\n\tLEFT JOIN LKP_ALL_SUPPORT_TABLES LKP_ALL_SUPPORT_TABLES__EXCEED_sup_state_state_prov_code_M\n\tON LKP_ALL_SUPPORT_TABLES__EXCEED_sup_state_state_prov_code_M.source_sys_id = 'EXCEED'\n\tAND LKP_ALL_SUPPORT_TABLES__EXCEED_sup_state_state_prov_code_M.tablename = 'sup_state'\n\tAND LKP_ALL_SUPPORT_TABLES__EXCEED_sup_state_state_prov_code_M.code = state_prov_code_M\n\n\tLEFT JOIN LKP_ALL_SUPPORT_TABLES LKP_ALL_SUPPORT_TABLES__EXCEED_sup_state_state_prov_code_O\n\tON LKP_ALL_SUPPORT_TABLES__EXCEED_sup_state_state_prov_code_O.source_sys_id = 'EXCEED'\n\tAND LKP_ALL_SUPPORT_TABLES__EXCEED_sup_state_state_prov_code_O.tablename = 'sup_state'\n\tAND LKP_ALL_SUPPORT_TABLES__EXCEED_sup_state_state_prov_code_O.code = state_prov_code_O\n\n),\nLKP_contract_customer_dim AS (\n\tSELECT\n\tcontract_cust_dim_id,\n\tedw_contract_cust_pk_id,\n\tedw_contract_cust_addr_mailing_pk_id,\n\tedw_contract_cust_addr_other_pk_id\n\tFROM (\n\t\tSELECT \n\t\t\tcontract_cust_dim_id,\n\t\t\tedw_contract_cust_pk_id,\n\t\t\tedw_contract_cust_addr_mailing_pk_id,\n\t\t\tedw_contract_cust_addr_other_pk_id\n\t\tFROM @{pipeline().parameters.TARGET_TABLE_OWNER}.contract_customer_dim\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY edw_contract_cust_pk_id,edw_contract_cust_addr_mailing_pk_id,edw_contract_cust_addr_other_pk_id ORDER BY contract_cust_dim_id DESC) = 1\n),\nRTR_contract_cust_dim_INS_UPD AS (\n\tSELECT\n\tLKP_contract_customer_dim.contract_cust_dim_id AS lkp_contract_cust_dim_id,\n\tEXP_sup_description.contract_cust_id,\n\tEXP_sup_description.contract_cust_ak_id,\n\tEXP_sup_description.cust_num,\n\tEXP_sup_description.contract_key,\n\tEXP_sup_description.cust_role,\n\tEXP_sup_description.name,\n\tEXP_sup_description.fed_tax_id,\n\tEXP_sup_description.doing_bus_as,\n\tEXP_sup_description.sic_code,\n\tEXP_sup_description.sic_code_descript,\n\tEXP_sup_description.naics_code,\n\tEXP_sup_description.naics_code_description,\n\tEXP_sup_description.lgl_ent_code,\n\tEXP_sup_description.lgl_ent_code_descript,\n\tEXP_sup_description.yr_in_bus,\n\tEXP_sup_description.ph_num_full,\n\tEXP_sup_description.ph_area_code,\n\tEXP_sup_description.ph_exchange,\n\tEXP_sup_description.ph_num,\n\tEXP_sup_description.ph_extension,\n\tEXP_sup_description.bus_email_addr,\n\tEXP_sup_description.sort_name,\n\tEXP_sup_description.ProgramCode,\n\tEXP_sup_description.ProgramCodeDescription,\n\tEXP_sup_description.contract_cust_addr_id_M,\n\tEXP_sup_description.loc_unit_num_M,\n\tEXP_sup_description.addr_line_1_M,\n\tEXP_sup_description.addr_line_2_M,\n\tEXP_sup_description.addr_line_3_M,\n\tEXP_sup_description.city_name_M,\n\tEXP_sup_description.state_prov_code_M,\n\tEXP_sup_description.state_prov_code_description_M,\n\tEXP_sup_description.zip_postal_code_M,\n\tEXP_sup_description.zip_postal_code_extension_M,\n\tEXP_sup_description.county_parish_name_M,\n\tEXP_sup_description.country_name_M,\n\tEXP_sup_description.contract_cust_addr_id_O,\n\tEXP_sup_description.loc_unit_num_O,\n\tEXP_sup_description.addr_line_1_O,\n\tEXP_sup_description.addr_line_2_O,\n\tEXP_sup_description.addr_line_3_O,\n\tEXP_sup_description.city_name_O,\n\tEXP_sup_description.state_prov_code_O,\n\tEXP_sup_description.state_prov_code_description_O,\n\tEXP_sup_description.zip_postal_code_O,\n\tEXP_sup_description.zip_postal_code_extension_O,\n\tEXP_sup_description.county_parish_name_O,\n\tEXP_sup_description.country_name_O,\n\tEXP_sup_description.DIST_EFF_FROM_DATE,\n\tEXP_sup_description.crrnt_snpsht_flag,\n\tEXP_sup_description.audit_id,\n\tEXP_sup_description.eff_to_date,\n\tEXP_sup_description.created_date,\n\tEXP_sup_description.modified_date,\n\tEXP_sup_description.NAICSIndustryGroupCode,\n\tEXP_sup_description.NAICSIndustryGroupCodeDesc,\n\tEXP_sup_description.NAICSSubsectorCode,\n\tEXP_sup_description.NAICSSubsectorCodeDesc,\n\tEXP_sup_description.NAICSSectorCode,\n\tEXP_sup_description.NAICSSectorCodeDesc\n\tFROM EXP_sup_description\n\tLEFT JOIN LKP_contract_customer_dim\n\tON LKP_contract_customer_dim.edw_contract_cust_pk_id = EXP_sup_description.contract_cust_id AND LKP_contract_customer_dim.edw_contract_cust_addr_mailing_pk_id = EXP_sup_description.contract_cust_addr_id_M AND LKP_contract_customer_dim.edw_contract_cust_addr_other_pk_id = EXP_sup_description.contract_cust_addr_id_O\n),\nRTR_contract_cust_dim_INS_UPD_INSERT AS (SELECT * FROM RTR_contract_cust_dim_INS_UPD WHERE isnull(lkp_contract_cust_dim_id)),\nRTR_contract_cust_dim_INS_UPD_DEFAULT1 AS (SELECT * FROM RTR_contract_cust_dim_INS_UPD WHERE NOT ( (isnull(lkp_contract_cust_dim_id)) )),\nTGT_contract_customer_dim_INSERT AS (\n\tINSERT INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.contract_customer_dim\n\t(crrnt_snpsht_flag, audit_id, eff_from_date, eff_to_date, created_date, modified_date, edw_contract_cust_pk_id, edw_contract_cust_addr_mailing_pk_id, edw_contract_cust_addr_other_pk_id, edw_contract_cust_ak_id, cust_num, contract_key, cust_role, name, fed_tax_id, doing_bus_as, sic_code, sic_code_descript, naics_code, naics_code_descript, lgl_ent_code, lgl_ent_code_descript, yr_in_bus, ph_num_full, ph_area_code, ph_exchange, ph_num, ph_extension, bus_email_addr, mailing_loc_unit_num, mailing_addr_line_1, mailing_addr_line_2, mailing_addr_line_3, mailing_city_name, mailing_state_prov_code, mailing_state_prov_code_descript, mailing_zip_postal_code, mailing_zip_postal_code_extension, mailing_county_parish_name, mailing_country_name, other_loc_unit_num, other_addr_line_1, other_addr_line_2, other_addr_line_3, other_city_name, other_state_prov_code, other_state_prov_code_descript, other_zip_postal_code, other_zip_postal_code_extension, other_county_parish_name, other_country_name, sort_name, ProgramCode, ProgramCodeDescription, NAICSIndustryGroupCode, NAICSIndustryGroupCodeDescription, NAICSSubsectorCode, NAICSSubsectorCodeDescription, NAICSSectorCode, NAICSSectorCodeDescription)\n\tSELECT \n\tCRRNT_SNPSHT_FLAG, \n\tAUDIT_ID, \n\tDIST_EFF_FROM_DATE AS EFF_FROM_DATE, \n\tEFF_TO_DATE, \n\tCREATED_DATE, \n\tMODIFIED_DATE, \n\tcontract_cust_id AS EDW_CONTRACT_CUST_PK_ID, \n\tcontract_cust_addr_id_M AS EDW_CONTRACT_CUST_ADDR_MAILING_PK_ID, \n\tcontract_cust_addr_id_O AS EDW_CONTRACT_CUST_ADDR_OTHER_PK_ID, \n\tcontract_cust_ak_id AS EDW_CONTRACT_CUST_AK_ID, \n\tCUST_NUM, \n\tCONTRACT_KEY, \n\tCUST_ROLE, \n\tNAME, \n\tFED_TAX_ID, \n\tDOING_BUS_AS, \n\tSIC_CODE, \n\tSIC_CODE_DESCRIPT, \n\tNAICS_CODE, \n\tnaics_code_description AS NAICS_CODE_DESCRIPT, \n\tLGL_ENT_CODE, \n\tLGL_ENT_CODE_DESCRIPT, \n\tYR_IN_BUS, \n\tPH_NUM_FULL, \n\tPH_AREA_CODE, \n\tPH_EXCHANGE, \n\tPH_NUM, \n\tPH_EXTENSION, \n\tBUS_EMAIL_ADDR, \n\tloc_unit_num_M AS MAILING_LOC_UNIT_NUM, \n\taddr_line_1_M AS MAILING_ADDR_LINE_1, \n\taddr_line_2_M AS MAILING_ADDR_LINE_2, \n\taddr_line_3_M AS MAILING_ADDR_LINE_3, \n\tcity_name_M AS MAILING_CITY_NAME, \n\tstate_prov_code_M AS MAILING_STATE_PROV_CODE, \n\tstate_prov_code_description_M AS MAILING_STATE_PROV_CODE_DESCRIPT, \n\tzip_postal_code_M AS MAILING_ZIP_POSTAL_CODE, \n\tzip_postal_code_extension_M AS MAILING_ZIP_POSTAL_CODE_EXTENSION, \n\tcounty_parish_name_M AS MAILING_COUNTY_PARISH_NAME, \n\tcountry_name_M AS MAILING_COUNTRY_NAME, \n\tloc_unit_num_O AS OTHER_LOC_UNIT_NUM, \n\taddr_line_1_O AS OTHER_ADDR_LINE_1, \n\taddr_line_2_O AS OTHER_ADDR_LINE_2, \n\taddr_line_3_O AS OTHER_ADDR_LINE_3, \n\tcity_name_O AS OTHER_CITY_NAME, \n\tstate_prov_code_O AS OTHER_STATE_PROV_CODE, \n\tstate_prov_code_description_O AS OTHER_STATE_PROV_CODE_DESCRIPT, \n\tzip_postal_code_O AS OTHER_ZIP_POSTAL_CODE, \n\tzip_postal_code_extension_O AS OTHER_ZIP_POSTAL_CODE_EXTENSION, \n\tcounty_parish_name_O AS OTHER_COUNTY_PARISH_NAME, \n\tcountry_name_O AS OTHER_COUNTRY_NAME, \n\tSORT_NAME, \n\tPROGRAMCODE, \n\tPROGRAMCODEDESCRIPTION, \n\tNAICSINDUSTRYGROUPCODE, \n\tNAICSIndustryGroupCodeDesc AS NAICSINDUSTRYGROUPCODEDESCRIPTION, \n\tNAICSSUBSECTORCODE, \n\tNAICSSubsectorCodeDesc AS NAICSSUBSECTORCODEDESCRIPTION, \n\tNAICSSECTORCODE, \n\tNAICSSectorCodeDesc AS NAICSSECTORCODEDESCRIPTION\n\tFROM RTR_contract_cust_dim_INS_UPD_INSERT\n),\nUPD_contract_cust_dim AS (\n\tSELECT\n\tlkp_contract_cust_dim_id AS lkp_contract_cust_dim_id2, \n\tcontract_cust_id AS contract_cust_id2, \n\tcontract_cust_ak_id AS contract_cust_ak_id2, \n\tcust_num AS cust_num2, \n\tcontract_key AS contract_key2, \n\tcust_role AS cust_role2, \n\tname AS name2, \n\tfed_tax_id AS fed_tax_id2, \n\tdoing_bus_as AS doing_bus_as2, \n\tsic_code AS sic_code2, \n\tsic_code_descript AS sic_code_descript2, \n\tnaics_code AS naics_code2, \n\tnaics_code_description AS naics_code_description2, \n\tlgl_ent_code AS lgl_ent_code2, \n\tlgl_ent_code_descript AS lgl_ent_code_descript2, \n\tyr_in_bus AS yr_in_bus2, \n\tph_num_full AS ph_num_full2, \n\tph_area_code AS ph_area_code2, \n\tph_exchange AS ph_exchange2, \n\tph_num AS ph_num2, \n\tph_extension AS ph_extension2, \n\tbus_email_addr AS bus_email_addr2, \n\tcontract_cust_addr_id_M AS contract_cust_addr_id_M2, \n\tloc_unit_num_M AS loc_unit_num_M2, \n\taddr_line_1_M AS addr_line_1_M2, \n\taddr_line_2_M AS addr_line_2_M2, \n\taddr_line_3_M AS addr_line_3_M2, \n\tcity_name_M AS city_name_M2, \n\tstate_prov_code_M AS state_prov_code_M2, \n\tstate_prov_code_description_M AS state_prov_code_description_M2, \n\tzip_postal_code_M AS zip_postal_code_M2, \n\tzip_postal_code_extension_M AS zip_postal_code_extension_M2, \n\tcounty_parish_name_M AS county_parish_name_M2, \n\tcountry_name_M AS country_name_M2, \n\tcontract_cust_addr_id_O AS contract_cust_addr_id_O2, \n\tloc_unit_num_O AS loc_unit_num_O2, \n\taddr_line_1_O AS addr_line_1_O2, \n\taddr_line_2_O AS addr_line_2_O2, \n\taddr_line_3_O AS addr_line_3_O2, \n\tcity_name_O AS city_name_O2, \n\tstate_prov_code_O AS state_prov_code_O2, \n\tstate_prov_code_description_O AS state_prov_code_description_O2, \n\tzip_postal_code_O AS zip_postal_code_O2, \n\tzip_postal_code_extension_O AS zip_postal_code_extension_O2, \n\tcounty_parish_name_O AS county_parish_name_O2, \n\tcountry_name_O AS country_name_O2, \n\tsort_name AS sort_name2, \n\tProgramCode AS ProgramCode2, \n\tProgramCodeDescription, \n\tDIST_EFF_FROM_DATE AS DIST_EFF_FROM_DATE2, \n\tcrrnt_snpsht_flag AS crrnt_snpsht_flag2, \n\taudit_id AS audit_id2, \n\teff_to_date AS eff_to_date2, \n\tcreated_date AS created_date2, \n\tmodified_date AS modified_date2, \n\tNAICSIndustryGroupCode AS NAICSIndustryGroupCode2, \n\tNAICSIndustryGroupCodeDesc AS NAICSIndustryGroupCodeDesc2, \n\tNAICSSubsectorCode AS NAICSSubsectorCode2, \n\tNAICSSubsectorCodeDesc AS NAICSSubsectorCodeDesc2, \n\tNAICSSectorCode AS NAICSSectorCode2, \n\tNAICSSectorCodeDesc AS NAICSSectorCodeDesc2\n\tFROM RTR_contract_cust_dim_INS_UPD_DEFAULT1\n),\nTGT_contract_customer_dim_UPDATE AS (\n\tMERGE INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.contract_customer_dim AS T\n\tUSING UPD_contract_cust_dim AS S\n\tON T.contract_cust_dim_id = S.lkp_contract_cust_dim_id2\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.eff_from_date = S.DIST_EFF_FROM_DATE2, T.modified_date = S.modified_date2, T.cust_num = S.cust_num2, T.contract_key = S.contract_key2, T.cust_role = S.cust_role2, T.name = S.name2, T.fed_tax_id = S.fed_tax_id2, T.doing_bus_as = S.doing_bus_as2, T.sic_code = S.sic_code2, T.sic_code_descript = S.sic_code_descript2, T.naics_code = S.naics_code2, T.naics_code_descript = S.naics_code_description2, T.lgl_ent_code = S.lgl_ent_code2, T.lgl_ent_code_descript = S.lgl_ent_code_descript2, T.yr_in_bus = S.yr_in_bus2, T.ph_num_full = S.ph_num_full2, T.ph_area_code = S.ph_area_code2, T.ph_exchange = S.ph_exchange2, T.ph_num = S.ph_num2, T.ph_extension = S.ph_extension2, T.bus_email_addr = S.bus_email_addr2, T.mailing_loc_unit_num = S.loc_unit_num_M2, T.mailing_addr_line_1 = S.addr_line_1_M2, T.mailing_addr_line_2 = S.addr_line_2_M2, T.mailing_addr_line_3 = S.addr_line_3_M2, T.mailing_city_name = S.city_name_M2, T.mailing_state_prov_code = S.state_prov_code_M2, T.mailing_state_prov_code_descript = S.state_prov_code_description_M2, T.mailing_zip_postal_code = S.zip_postal_code_M2, T.mailing_zip_postal_code_extension = S.zip_postal_code_extension_M2, T.mailing_county_parish_name = S.county_parish_name_M2, T.mailing_country_name = S.country_name_M2, T.other_loc_unit_num = S.loc_unit_num_O2, T.other_addr_line_1 = S.addr_line_1_O2, T.other_addr_line_2 = S.addr_line_2_O2, T.other_addr_line_3 = S.addr_line_3_O2, T.other_city_name = S.city_name_O2, T.other_state_prov_code = S.state_prov_code_O2, T.other_state_prov_code_descript = S.state_prov_code_description_O2, T.other_zip_postal_code = S.zip_postal_code_O2, T.other_zip_postal_code_extension = S.zip_postal_code_extension_O2, T.other_county_parish_name = S.county_parish_name_O2, T.other_country_name = S.country_name_O2, T.sort_name = S.sort_name2, T.ProgramCode = S.ProgramCode2, T.ProgramCodeDescription = S.ProgramCodeDescription, T.NAICSIndustryGroupCode = S.NAICSIndustryGroupCode2, T.NAICSIndustryGroupCodeDescription = S.NAICSIndustryGroupCodeDesc2, T.NAICSSubsectorCode = S.NAICSSubsectorCode2, T.NAICSSubsectorCodeDescription = S.NAICSSubsectorCodeDesc2, T.NAICSSectorCode = S.NAICSSectorCode2, T.NAICSSectorCodeDescription = S.NAICSSectorCodeDesc2\n),\nSQ_contract_customer_dim AS (\n\tSELECT \r\n\t\tcontract_cust_dim_id, \r\n\t\teff_from_date, \r\n\t\teff_to_date, \r\n\t\tedw_contract_cust_ak_id \r\n\tFROM\r\n\t\t@{pipeline().parameters.TARGET_TABLE_OWNER}.contract_customer_dim \r\n\tWHERE edw_contract_cust_ak_id   IN \r\n\t\t   (SELECT edw_contract_cust_ak_id   FROM @{pipeline().parameters.TARGET_TABLE_OWNER}. contract_customer_dim\r\n\t           WHERE crrnt_snpsht_flag = 1 GROUP BY edw_contract_cust_ak_id   HAVING count(*) > 1)\r\n\tORDER BY edw_contract_cust_ak_id,eff_from_date  DESC\r\n\t\r\n\t\r\n\t--IN Subquery exists to pick AK ID column values that have multiple rows with a 12/31/2100 eff_to_date.\r\n\t--When this condition occurs this is an indication that we must expire one or more of these rows.\r\n\t--WHERE clause is always made up of current snapshot flag \r\n\t--GROUP BY clause is always on AK\r\n\t--HAVING clause stays the same\n),\nEXP_Lag_eff_from_date AS (\n\tSELECT\n\tcontract_cust_dim_id,\n\teff_from_date AS in_eff_from_date,\n\teff_to_date AS orig_eff_to_date,\n\tedw_contract_cust_ak_id,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- edw_contract_cust_ak_id = v_prev_edw_contract_cust_ak_id  ,\r\n\t-- ADD_TO_DATE(v_prev_eff_from_date,'SS',-1),orig_eff_to_date)\n\tDECODE(TRUE,\n\t\tedw_contract_cust_ak_id = v_prev_edw_contract_cust_ak_id, ADD_TO_DATE(v_prev_eff_from_date, 'SS', - 1),\n\t\torig_eff_to_date) AS v_eff_to_date,\n\tv_eff_to_date AS eff_to_date,\n\tedw_contract_cust_ak_id AS v_prev_edw_contract_cust_ak_id,\n\tin_eff_from_date AS v_prev_eff_from_date,\n\t0 AS crrnt_snpsht_flag,\n\tSYSDATE AS modified_date\n\tFROM SQ_contract_customer_dim\n),\nFIL_FirstRowInAKGroup AS (\n\tSELECT\n\tcontract_cust_dim_id, \n\torig_eff_to_date, \n\teff_to_date, \n\tcrrnt_snpsht_flag, \n\tmodified_date\n\tFROM EXP_Lag_eff_from_date\n\tWHERE orig_eff_to_date != eff_to_date\n),\nUPD_contract_cust_dim_expire AS (\n\tSELECT\n\tcontract_cust_dim_id, \n\teff_to_date, \n\tcrrnt_snpsht_flag, \n\tmodified_date\n\tFROM FIL_FirstRowInAKGroup\n),\nTGT_contract_customer_dim_EXP_UPDATE AS (\n\tMERGE INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.contract_customer_dim AS T\n\tUSING UPD_contract_cust_dim_expire AS S\n\tON T.contract_cust_dim_id = S.contract_cust_dim_id\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.crrnt_snpsht_flag = S.crrnt_snpsht_flag, T.eff_to_date = S.eff_to_date, T.modified_date = S.modified_date\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "246511"
            },
            "WBMI_BATCH_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "905531"
            },
            "WBMI_SESSION_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "7604530"
            },
            "SELECTION_START_TS": {
                "type": "string",
                "defaultValue": "08/30/2023 02:57:01"
            },
            "SELECTION_END_TS": {
                "type": "string",
                "defaultValue": "08/31/2023 03:31:13"
            },
            "DBCONNECTION_SOURCE": {
                "type": "string",
                "defaultValue": "SQLServer_RPT_EDM_Policy"
            },
            "DBCONNECTION_TARGET": {
                "type": "string",
                "defaultValue": "SQLServer_WC_DATA_MART_Policy"
            },
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "dbo"
            },
            "TARGET_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "dbo"
            },
            "SOURCE_SYSTEM_ID": {
                "type": "string",
                "defaultValue": "PMS"
            },
            "TARGET_TABLE_OWNER_V2": {
                "type": "string",
                "defaultValue": "V2"
            },
            "SOURCE_TABLE_OWNER_V2": {
                "type": "string",
                "defaultValue": "v2"
            }
        },
        "folder": {
            "name": "Policy DataMart/"
        },
        "annotations": []
    }
}