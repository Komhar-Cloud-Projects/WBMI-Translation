{
    "name": "m_POL_CUS_DW_LOAD_contract_customer_address",
    "properties": {
        "activities": [
            {
                "name": "m_POL_CUS_DW_LOAD_contract_customer_address",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nSQ_pif_02_stage AS (\n\tSELECT \r\n\ta.pif_symbol\r\n\t, a.pif_policy_number\r\n\t, a.pif_module\r\n\t, CAST(CAST(LTRIM(RTRIM(a.pif_risk_state_prov)) AS INT) AS VARCHAR(2)) AS pif_risk_state_prov\r\n\t, a.pif_customer_number\r\n\t, a.pif_zip_5_digit_code\r\n\t, a.pif_address_line_1\r\n\t, a.pif_insured_name_cont\r\n\t, a.pif_address_line_2_b\r\n\t, a.pif_address_line_3\r\n\t, a.pif_address_line_4\r\n\t, a.pif_wbc_county \r\n\tFROM\r\n\t @{pipeline().parameters.SOURCE_TABLE_OWNER}.pif_02_stage a\n),\nLKP_sup_state AS (\n\tSELECT\n\tstate_code,\n\tstate_abbrev\n\tFROM (\n\t\tSELECT \n\t\t\tstate_code,\n\t\t\tstate_abbrev\n\t\tFROM @{pipeline().parameters.TARGET_TABLE_OWNER}.sup_state\n\t\tWHERE crrnt_snpsht_flag=1 and source_sys_id = 'EXCEED'\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY state_abbrev ORDER BY state_code) = 1\n),\nEXP_values AS (\n\tSELECT\n\tSQ_pif_02_stage.pif_symbol,\n\tSQ_pif_02_stage.pif_policy_number,\n\tSQ_pif_02_stage.pif_module,\n\t-- *INF*: ltrim(rtrim(pif_symbol)) || ltrim(rtrim(pif_policy_number)) || ltrim(rtrim(pif_module))\n\tltrim(rtrim(pif_symbol)) || ltrim(rtrim(pif_policy_number)) || ltrim(rtrim(pif_module)) AS v_contract_key,\n\t-- *INF*: ltrim(rtrim(v_contract_key))\n\tltrim(rtrim(v_contract_key)) AS contract_key,\n\t-- *INF*: LTRIM(RTRIM('MAILING'))\n\tLTRIM(RTRIM('MAILING')) AS addr_type,\n\tSQ_pif_02_stage.pif_customer_number AS in_pif_customer_number,\n\tSQ_pif_02_stage.pif_zip_5_digit_code AS in_pif_zip_5_digit_code,\n\t-- *INF*: iif(isnull(in_pif_customer_number) or IS_SPACES(in_pif_customer_number) or LENGTH(in_pif_customer_number)=0,'0000000000',ltrim(rtrim(in_pif_customer_number)))\n\tIFF(in_pif_customer_number IS NULL OR IS_SPACES(in_pif_customer_number) OR LENGTH(in_pif_customer_number) = 0, '0000000000', ltrim(rtrim(in_pif_customer_number))) AS v_customer_num,\n\tv_customer_num AS customer_number,\n\t'INS' AS cust_role_code,\n\tSQ_pif_02_stage.pif_address_line_1 AS in_pif_address_line_1,\n\t-- *INF*: ltrim(rtrim(in_pif_address_line_1))\n\tltrim(rtrim(in_pif_address_line_1)) AS v_pif_address_line_1,\n\tSQ_pif_02_stage.pif_insured_name_cont AS in_pif_insured_name_cont,\n\tSQ_pif_02_stage.pif_address_line_2_b AS in_pif_address_line_2_b,\n\t-- *INF*: ltrim(rtrim(in_pif_address_line_2_b))\n\tltrim(rtrim(in_pif_address_line_2_b)) AS v_pif_address_line_2_b,\n\tSQ_pif_02_stage.pif_address_line_3 AS in_pif_address_line_3,\n\t-- *INF*: ltrim(rtrim(in_pif_address_line_3))\n\tltrim(rtrim(in_pif_address_line_3)) AS v_pif_address_line_3,\n\tSQ_pif_02_stage.pif_address_line_4 AS in_pif_address_line_4,\n\tSQ_pif_02_stage.pif_wbc_county AS in_pif_wbc_county,\n\t-- *INF*: ltrim(rtrim(in_pif_address_line_4))\n\tltrim(rtrim(in_pif_address_line_4)) AS v_pif_address_line_4,\n\t-- *INF*: ltrim(in_pif_insured_name_cont || v_pif_address_line_2_b)\n\tltrim(in_pif_insured_name_cont || v_pif_address_line_2_b) AS v_pif_insured_cont_add_line_2,\n\t-- *INF*: iif(iif(IS_SPACES(v_pif_address_line_4) or isnull(v_pif_address_line_4) or LENGTH(v_pif_address_line_4)=0,\r\n\t-- 1,0)=1,\r\n\t-- (iif(decode(SUBSTR(v_pif_address_line_2_b,(LENGTH(v_pif_address_line_2_b)-3),4),\r\n\t-- ' LLC',1,\r\n\t-- ' DBA',1,\r\n\t-- ' BA;',1,\r\n\t-- ' BA,',1,\r\n\t-- ' SOC',1,\r\n\t-- 'PLAN',1,\r\n\t-- 'CORP',1,\r\n\t-- 0)=1,'N/A',v_pif_insured_cont_add_line_2)),\r\n\t-- iif(iif(IN(SUBSTR(v_pif_address_line_2_b,1,1),'1','2','3','4','5','6','7','8','9','0',0)=1,1,iif(decode(substr(v_pif_insured_cont_add_line_2,1,4),\r\n\t-- 'POST',1,\r\n\t-- 'PO B',1,0)=1,1,0))=0,\r\n\t-- iif(decode(SUBSTR(v_pif_address_line_2_b,(LENGTH(v_pif_address_line_2_b)-2),3) ,\r\n\t-- ' ST',1,\r\n\t-- ' RD',1,\r\n\t-- ' PL',1,0)=1,v_pif_insured_cont_add_line_2,v_pif_address_line_3),\r\n\t-- iif(iif(decode(SUBSTR(v_pif_address_line_2_b,(LENGTH(v_pif_address_line_2_b)-3),4),\r\n\t-- ' LLC',1,\r\n\t-- ' DBA',1,\r\n\t-- ' BA;',1,\r\n\t-- ' BA,',1,\r\n\t-- ' SOC',1,\r\n\t-- 'PLAN',1,\r\n\t-- 'CORP',1,\r\n\t-- 0)=1,1,iif(IIF(NOT (ISNULL(v_pif_address_line_2_b)) OR NOT (IS_SPACES(v_pif_address_line_2_b)), instr(v_pif_address_line_2_b,'TRUST'),0) != 0,1,iif(IIF(NOT (ISNULL(v_pif_address_line_1)) OR NOT (IS_SPACES(v_pif_address_line_1)), instr(v_pif_address_line_1,'TRUST'),0) != 0,1,0))) =1,v_pif_address_line_3,v_pif_insured_cont_add_line_2)))\n\tIFF(IFF(IS_SPACES(v_pif_address_line_4) OR v_pif_address_line_4 IS NULL OR LENGTH(v_pif_address_line_4) = 0, 1, 0) = 1, ( IFF(decode(SUBSTR(v_pif_address_line_2_b, ( LENGTH(v_pif_address_line_2_b) - 3 ), 4),\n\t' LLC', 1,\n\t' DBA', 1,\n\t' BA;', 1,\n\t' BA,', 1,\n\t' SOC', 1,\n\t'PLAN', 1,\n\t'CORP', 1,\n\t0) = 1, 'N/A', v_pif_insured_cont_add_line_2) ), IFF(IFF(IN(SUBSTR(v_pif_address_line_2_b, 1, 1), '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', 0) = 1, 1, IFF(decode(substr(v_pif_insured_cont_add_line_2, 1, 4),\n\t'POST', 1,\n\t'PO B', 1,\n\t0) = 1, 1, 0)) = 0, IFF(decode(SUBSTR(v_pif_address_line_2_b, ( LENGTH(v_pif_address_line_2_b) - 2 ), 3),\n\t' ST', 1,\n\t' RD', 1,\n\t' PL', 1,\n\t0) = 1, v_pif_insured_cont_add_line_2, v_pif_address_line_3), IFF(IFF(decode(SUBSTR(v_pif_address_line_2_b, ( LENGTH(v_pif_address_line_2_b) - 3 ), 4),\n\t' LLC', 1,\n\t' DBA', 1,\n\t' BA;', 1,\n\t' BA,', 1,\n\t' SOC', 1,\n\t'PLAN', 1,\n\t'CORP', 1,\n\t0) = 1, 1, IFF(IFF(NOT ( v_pif_address_line_2_b IS NULL ) OR NOT ( IS_SPACES(v_pif_address_line_2_b) ), instr(v_pif_address_line_2_b, 'TRUST'), 0) != 0, 1, IFF(IFF(NOT ( v_pif_address_line_1 IS NULL ) OR NOT ( IS_SPACES(v_pif_address_line_1) ), instr(v_pif_address_line_1, 'TRUST'), 0) != 0, 1, 0))) = 1, v_pif_address_line_3, v_pif_insured_cont_add_line_2))) AS v_addr_line_1,\n\t-- *INF*: iif(iif(IS_SPACES(v_pif_address_line_4) or isnull(v_pif_address_line_4) or LENGTH(v_pif_address_line_4)=0,\r\n\t-- 1,0)=1,\r\n\t-- (iif(decode(SUBSTR(v_pif_address_line_2_b,(LENGTH(v_pif_address_line_2_b)-3),4),\r\n\t-- ' LLC',1,\r\n\t-- ' DBA',1,\r\n\t-- ' BA;',1,\r\n\t-- ' BA,',1,\r\n\t-- ' SOC',1,\r\n\t-- 'PLAN',1,\r\n\t-- 'CORP',1,\r\n\t-- 0)=1,'N/A',v_pif_insured_cont_add_line_2)),\r\n\t-- iif(iif(IN(SUBSTR(v_pif_address_line_2_b,1,1),'1','2','3','4','5','6','7','8','9','0',0)=1,1,iif(decode(substr(v_pif_insured_cont_add_line_2,1,4),\r\n\t-- 'POST',1,\r\n\t-- 'PO B',1,0)=1,1,0))=0,\r\n\t-- iif(decode(SUBSTR(v_pif_address_line_2_b,(LENGTH(v_pif_address_line_2_b)-2),3) ,\r\n\t-- ' ST',1,\r\n\t-- ' RD',1,\r\n\t-- ' PL',1,0)=1,v_pif_insured_cont_add_line_2,v_pif_address_line_3),\r\n\t-- iif(iif(decode(SUBSTR(v_pif_address_line_2_b,(LENGTH(v_pif_address_line_2_b)-3),4),\r\n\t-- ' LLC',1,\r\n\t-- ' DBA',1,\r\n\t-- ' BA;',1,\r\n\t-- ' BA,',1,\r\n\t-- ' SOC',1,\r\n\t-- 'PLAN',1,\r\n\t-- 'CORP',1,\r\n\t-- 0)=1,1,iif(IIF(NOT (ISNULL(v_pif_address_line_2_b)) OR NOT (IS_SPACES(v_pif_address_line_2_b)), instr(v_pif_address_line_2_b,'TRUST'),0) != 0,1,iif(IIF(NOT (ISNULL(v_pif_address_line_1)) OR NOT (IS_SPACES(v_pif_address_line_1)), instr(v_pif_address_line_1,'TRUST'),0) != 0,1,0))) =1,v_pif_address_line_3,v_pif_insured_cont_add_line_2)))\n\tIFF(IFF(IS_SPACES(v_pif_address_line_4) OR v_pif_address_line_4 IS NULL OR LENGTH(v_pif_address_line_4) = 0, 1, 0) = 1, ( IFF(decode(SUBSTR(v_pif_address_line_2_b, ( LENGTH(v_pif_address_line_2_b) - 3 ), 4),\n\t' LLC', 1,\n\t' DBA', 1,\n\t' BA;', 1,\n\t' BA,', 1,\n\t' SOC', 1,\n\t'PLAN', 1,\n\t'CORP', 1,\n\t0) = 1, 'N/A', v_pif_insured_cont_add_line_2) ), IFF(IFF(IN(SUBSTR(v_pif_address_line_2_b, 1, 1), '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', 0) = 1, 1, IFF(decode(substr(v_pif_insured_cont_add_line_2, 1, 4),\n\t'POST', 1,\n\t'PO B', 1,\n\t0) = 1, 1, 0)) = 0, IFF(decode(SUBSTR(v_pif_address_line_2_b, ( LENGTH(v_pif_address_line_2_b) - 2 ), 3),\n\t' ST', 1,\n\t' RD', 1,\n\t' PL', 1,\n\t0) = 1, v_pif_insured_cont_add_line_2, v_pif_address_line_3), IFF(IFF(decode(SUBSTR(v_pif_address_line_2_b, ( LENGTH(v_pif_address_line_2_b) - 3 ), 4),\n\t' LLC', 1,\n\t' DBA', 1,\n\t' BA;', 1,\n\t' BA,', 1,\n\t' SOC', 1,\n\t'PLAN', 1,\n\t'CORP', 1,\n\t0) = 1, 1, IFF(IFF(NOT ( v_pif_address_line_2_b IS NULL ) OR NOT ( IS_SPACES(v_pif_address_line_2_b) ), instr(v_pif_address_line_2_b, 'TRUST'), 0) != 0, 1, IFF(IFF(NOT ( v_pif_address_line_1 IS NULL ) OR NOT ( IS_SPACES(v_pif_address_line_1) ), instr(v_pif_address_line_1, 'TRUST'), 0) != 0, 1, 0))) = 1, v_pif_address_line_3, v_pif_insured_cont_add_line_2))) AS v_address_line_1,\n\t-- *INF*: iif(isnull(v_address_line_1) or IS_SPACES(v_address_line_1) or LENGTH(v_address_line_1)=0,'N/A',LTRIM(RTRIM(v_address_line_1)))\n\tIFF(v_address_line_1 IS NULL OR IS_SPACES(v_address_line_1) OR LENGTH(v_address_line_1) = 0, 'N/A', LTRIM(RTRIM(v_address_line_1))) AS addr_line_1,\n\t-- *INF*: iif(iif(IS_SPACES(v_pif_address_line_4) or isnull(v_pif_address_line_4) or LENGTH(v_pif_address_line_4)=0,\r\n\t-- 1,0)=1,'N/A',\r\n\t-- iif(iif(IN(SUBSTR(v_pif_address_line_2_b,1,1),'1','2','3','4','5','6','7','8','9','0',0)=1,1,iif(decode(substr(v_pif_insured_cont_add_line_2,1,4),\r\n\t-- 'POST',1,\r\n\t-- 'PO B',1,0)=1,1,0))=0,\r\n\t-- iif(decode(SUBSTR(v_pif_address_line_2_b,(LENGTH(v_pif_address_line_2_b)-2),3) ,\r\n\t-- ' ST',1,\r\n\t-- ' RD',1,\r\n\t-- ' PL',1,0)=1,v_pif_address_line_3,'N/A'),\r\n\t-- iif(iif(decode(SUBSTR(v_pif_address_line_2_b,(LENGTH(v_pif_address_line_2_b)-3),4),\r\n\t-- ' LLC',1,\r\n\t-- ' DBA',1,\r\n\t-- ' BA;',1,\r\n\t-- ' BA,',1,\r\n\t-- ' SOC',1,\r\n\t-- 'PLAN',1,\r\n\t-- 'CORP',1,\r\n\t-- 0)=1,1,iif(IIF(NOT (ISNULL(v_pif_address_line_2_b)) OR NOT (IS_SPACES(v_pif_address_line_2_b)), instr(v_pif_address_line_2_b,'TRUST'),0) != 0,1,iif(IIF(NOT (ISNULL(v_pif_address_line_1)) OR NOT (IS_SPACES(v_pif_address_line_1)), instr(v_pif_address_line_1,'TRUST'),0) != 0,1,0))) =1,'N/A',v_pif_address_line_3)))\n\tIFF(IFF(IS_SPACES(v_pif_address_line_4) OR v_pif_address_line_4 IS NULL OR LENGTH(v_pif_address_line_4) = 0, 1, 0) = 1, 'N/A', IFF(IFF(IN(SUBSTR(v_pif_address_line_2_b, 1, 1), '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', 0) = 1, 1, IFF(decode(substr(v_pif_insured_cont_add_line_2, 1, 4),\n\t'POST', 1,\n\t'PO B', 1,\n\t0) = 1, 1, 0)) = 0, IFF(decode(SUBSTR(v_pif_address_line_2_b, ( LENGTH(v_pif_address_line_2_b) - 2 ), 3),\n\t' ST', 1,\n\t' RD', 1,\n\t' PL', 1,\n\t0) = 1, v_pif_address_line_3, 'N/A'), IFF(IFF(decode(SUBSTR(v_pif_address_line_2_b, ( LENGTH(v_pif_address_line_2_b) - 3 ), 4),\n\t' LLC', 1,\n\t' DBA', 1,\n\t' BA;', 1,\n\t' BA,', 1,\n\t' SOC', 1,\n\t'PLAN', 1,\n\t'CORP', 1,\n\t0) = 1, 1, IFF(IFF(NOT ( v_pif_address_line_2_b IS NULL ) OR NOT ( IS_SPACES(v_pif_address_line_2_b) ), instr(v_pif_address_line_2_b, 'TRUST'), 0) != 0, 1, IFF(IFF(NOT ( v_pif_address_line_1 IS NULL ) OR NOT ( IS_SPACES(v_pif_address_line_1) ), instr(v_pif_address_line_1, 'TRUST'), 0) != 0, 1, 0))) = 1, 'N/A', v_pif_address_line_3))) AS v_addr_line_2,\n\t-- *INF*: iif(isnull(v_addr_line_2) or IS_SPACES(v_addr_line_2) or LENGTH(v_addr_line_2)=0,'N/A',LTRIM(RTRIM(v_addr_line_2)))\n\tIFF(v_addr_line_2 IS NULL OR IS_SPACES(v_addr_line_2) OR LENGTH(v_addr_line_2) = 0, 'N/A', LTRIM(RTRIM(v_addr_line_2))) AS v_address_line_2,\n\t-- *INF*: v_address_line_2\r\n\t-- \r\n\t-- --iif(isnull(v_addr_line_2) or IS_SPACES(v_addr_line_2) or LENGTH(v_addr_line_2)=0,'N/A',LTRIM(RTRIM(v_addr_line_2)))\n\tv_address_line_2 AS addr_line_2,\n\t'N/A' AS addr_line_3,\n\t-- *INF*: iif(iif(IS_SPACES(v_pif_address_line_4) or isnull(v_pif_address_line_4) or LENGTH(v_pif_address_line_4)=0,\r\n\t-- 1,0)=1,ltrim(rtrim(SUBSTR(v_pif_address_line_3,1,INSTR(v_pif_address_line_3,',')-1))),ltrim(rtrim(SUBSTR(v_pif_address_line_4,1,INSTR(v_pif_address_line_4,',')-1))))\r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- --iif(iif(IS_SPACES(v_pif_address_line_4) or isnull(v_pif_address_line_4) or LENGTH(v_pif_address_line_4)=0,\r\n\t-- --1,0)=1,ltrim(rtrim(REPLACECHR( 1,SUBSTR(v_pif_address_line_3,1,INSTR(v_pif_address_line_3,',')),',',''))),\r\n\t-- --ltrim(rtrim--(REPLACECHR( 1,SUBSTR(v_pif_address_line_4,1,INSTR(v_pif_address_line_4,',')),',',''))))\n\tIFF(IFF(IS_SPACES(v_pif_address_line_4) OR v_pif_address_line_4 IS NULL OR LENGTH(v_pif_address_line_4) = 0, 1, 0) = 1, ltrim(rtrim(SUBSTR(v_pif_address_line_3, 1, INSTR(v_pif_address_line_3, ',') - 1))), ltrim(rtrim(SUBSTR(v_pif_address_line_4, 1, INSTR(v_pif_address_line_4, ',') - 1)))) AS v_city,\n\t-- *INF*: iif(isnull(v_city) or IS_SPACES(v_city) or LENGTH(v_city)=0,'N/A',ltrim(rtrim(v_city)))\n\tIFF(v_city IS NULL OR IS_SPACES(v_city) OR LENGTH(v_city) = 0, 'N/A', ltrim(rtrim(v_city))) AS v_city_1,\n\t-- *INF*: iif(iif(IS_SPACES(v_pif_address_line_4) or isnull(v_pif_address_line_4) or LENGTH(v_pif_address_line_4)=0,\r\n\t-- 1,0)=1,ltrim(rtrim(SUBSTR(v_pif_address_line_3,INSTR(v_pif_address_line_3,',',-1)+1))),ltrim(rtrim(SUBSTR(v_pif_address_line_4,INSTR(v_pif_address_line_4,',',-1)+1))))\r\n\t-- \r\n\t-- \r\n\t-- --iif(iif(IS_SPACES(v_pif_address_line_4) or isnull(v_pif_address_line_4) or LENGTH(v_pif_address_line_4)=0,\r\n\t-- --1,0)=1,ltrim(rtrim(SUBSTR(v_pif_address_line_3,INSTR(v_pif_address_line_3,',')+1))),ltrim(rtrim(SUBSTR--(v_pif_address_line_4,INSTR(v_pif_address_line_4,',')+1))))\r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- --iif(iif(IS_SPACES(v_pif_address_line_4) or isnull(v_pif_address_line_4) or LENGTH(v_pif_address_line_4)=0,--\r\n\t-- --1,0)=1,ltrim(rtrim(REPLACECHR(1,SUBSTR(v_pif_address_line_3,INSTR(v_pif_address_line_3,',')),',',''))),\r\n\t-- --ltrim(rtrim--(REPLACECHR(1,SUBSTR(v_pif_address_line_4,INSTR(v_pif_address_line_4,',')),',',''))))\r\n\t-- \n\tIFF(IFF(IS_SPACES(v_pif_address_line_4) OR v_pif_address_line_4 IS NULL OR LENGTH(v_pif_address_line_4) = 0, 1, 0) = 1, ltrim(rtrim(SUBSTR(v_pif_address_line_3, INSTR(v_pif_address_line_3, ',', - 1) + 1))), ltrim(rtrim(SUBSTR(v_pif_address_line_4, INSTR(v_pif_address_line_4, ',', - 1) + 1)))) AS v_state,\n\t-- *INF*: REPLACECHR(1,v_state,',.',NULL)\r\n\t-- \r\n\t-- \r\n\t-- \n\tREPLACECHR(1, v_state, ',.', NULL) AS v_state_replacechr,\n\t-- *INF*: iif(isnull(v_state_replacechr) or IS_SPACES(v_state_replacechr) or LENGTH(v_state_replacechr)=0,'N/A',ltrim(rtrim(v_state_replacechr)))\n\tIFF(v_state_replacechr IS NULL OR IS_SPACES(v_state_replacechr) OR LENGTH(v_state_replacechr) = 0, 'N/A', ltrim(rtrim(v_state_replacechr))) AS v_state_1,\n\t-- *INF*: IIF((v_state_1=('N/A')) AND (v_city_1=('N/A')) AND (v_address_line_2=('N/A')),LTRIM(RTRIM(SUBSTR(v_address_line_1,1,INSTR(v_address_line_1,',')-1))),v_city_1)\r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- \n\tIFF(( v_state_1 = ( 'N/A' ) ) AND ( v_city_1 = ( 'N/A' ) ) AND ( v_address_line_2 = ( 'N/A' ) ), LTRIM(RTRIM(SUBSTR(v_address_line_1, 1, INSTR(v_address_line_1, ',') - 1))), v_city_1) AS v_city_1_1,\n\t-- *INF*: IIF((v_state_1=('N/A')) AND (v_city_1=('N/A')) AND (v_address_line_2=('N/A')),ltrim(rtrim(SUBSTR(v_address_line_1,INSTR(v_address_line_1,',',-1)+1))),v_state_1)\r\n\t-- \r\n\t-- \r\n\t-- --iif(iif(IS_SPACES(v_pif_address_line_4) or isnull(v_pif_address_line_4) or LENGTH(v_pif_address_line_4)=0,\r\n\t-- --1,0)=1,ltrim(rtrim(SUBSTR(v_pif_address_line_3,INSTR(v_pif_address_line_3,',',-1)+1))),ltrim(rtrim(SUBSTR(v_pif_address_line_4,INSTR(v_pif_address_line_4,',',-1)+1))))\n\tIFF(( v_state_1 = ( 'N/A' ) ) AND ( v_city_1 = ( 'N/A' ) ) AND ( v_address_line_2 = ( 'N/A' ) ), ltrim(rtrim(SUBSTR(v_address_line_1, INSTR(v_address_line_1, ',', - 1) + 1))), v_state_1) AS v_state_1_1,\n\t-- *INF*: IIF((v_city_1_1=('N/A')) AND (v_address_line_2 != ('N/A')),LTRIM(RTRIM(SUBSTR(v_address_line_2,1,INSTR(v_address_line_2,',')-1))),v_city_1_1)\r\n\t-- \r\n\t-- \r\n\t-- \n\tIFF(( v_city_1_1 = ( 'N/A' ) ) AND ( v_address_line_2 != ( 'N/A' ) ), LTRIM(RTRIM(SUBSTR(v_address_line_2, 1, INSTR(v_address_line_2, ',') - 1))), v_city_1_1) AS v_final_city_name,\n\t-- *INF*: IIF((v_city_1_1=('N/A')) AND (v_address_line_2 != ('N/A')),ltrim(rtrim(SUBSTR(v_address_line_2,INSTR(v_address_line_2,',',-1)+1))),v_state_1_1)\r\n\t-- \r\n\t-- \n\tIFF(( v_city_1_1 = ( 'N/A' ) ) AND ( v_address_line_2 != ( 'N/A' ) ), ltrim(rtrim(SUBSTR(v_address_line_2, INSTR(v_address_line_2, ',', - 1) + 1))), v_state_1_1) AS v_final_state_prov_name,\n\tLKP_sup_state.state_code AS lkp_state_code,\n\t-- *INF*: iif(isnull(v_final_city_name) or IS_SPACES(v_final_city_name) or LENGTH(v_final_city_name)=0,'N/A',ltrim(rtrim(v_final_city_name)))\r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- --v_city_1_1\r\n\t-- --iif(isnull(v_final_city_name) or IS_SPACES(v_final_city_name) or LENGTH(v_final_city_name)=0,'N/A',ltrim(rtrim(v_final_city_name)))\n\tIFF(v_final_city_name IS NULL OR IS_SPACES(v_final_city_name) OR LENGTH(v_final_city_name) = 0, 'N/A', ltrim(rtrim(v_final_city_name))) AS city,\n\t-- *INF*: iif(isnull(v_final_state_prov_name) or IS_SPACES(v_final_state_prov_name) or LENGTH(v_final_state_prov_name)=0,lkp_state_code,iif(LENGTH(ltrim(rtrim(v_final_state_prov_name)))!= 2,lkp_state_code,ltrim(rtrim(v_final_state_prov_name))))\r\n\t-- \r\n\t-- \r\n\t-- --iif(isnull(v_final_state_prov_name) or IS_SPACES(v_final_state_prov_name) or LENGTH(v_final_state_prov_name)=0,'N/A',ltrim(rtrim(v_final_state_prov_name)))\n\tIFF(v_final_state_prov_name IS NULL OR IS_SPACES(v_final_state_prov_name) OR LENGTH(v_final_state_prov_name) = 0, lkp_state_code, IFF(LENGTH(ltrim(rtrim(v_final_state_prov_name))) != 2, lkp_state_code, ltrim(rtrim(v_final_state_prov_name)))) AS state,\n\t-- *INF*: iif(isnull(in_pif_zip_5_digit_code) or IS_SPACES(in_pif_zip_5_digit_code) or LENGTH(in_pif_zip_5_digit_code)=0,'N/A',LTRIM(RTRIM(in_pif_zip_5_digit_code)))\n\tIFF(in_pif_zip_5_digit_code IS NULL OR IS_SPACES(in_pif_zip_5_digit_code) OR LENGTH(in_pif_zip_5_digit_code) = 0, 'N/A', LTRIM(RTRIM(in_pif_zip_5_digit_code))) AS zip_postal_code,\n\t'N/A' AS zip_postal_code_extension,\n\t-- *INF*: iif(isnull(in_pif_wbc_county) or IS_SPACES(in_pif_wbc_county) or LENGTH(in_pif_wbc_county)=0,'N/A',LTRIM(RTRIM(in_pif_wbc_county)))\n\tIFF(in_pif_wbc_county IS NULL OR IS_SPACES(in_pif_wbc_county) OR LENGTH(in_pif_wbc_county) = 0, 'N/A', LTRIM(RTRIM(in_pif_wbc_county))) AS county_parish_name,\n\t'0000' AS loc_unit_num,\n\t-- *INF*: ltrim(rtrim(decode(v_state,\r\n\t-- 'AB','CANADA',\r\n\t-- 'BC','CANADA',\r\n\t-- 'MB','CANADA',\r\n\t-- 'MG','CANADA',\r\n\t-- 'NB','CANADA',\r\n\t-- 'NF','CANADA',\r\n\t-- 'NS','CANADA',\r\n\t-- 'NW','CANADA',\r\n\t-- 'ON','CANADA',\r\n\t-- 'PE','CANADA',\r\n\t-- 'PQ','CANADA',\r\n\t-- 'SA','CANADA',\r\n\t-- 'YN','CANADA',\r\n\t-- 'USA')))\n\tltrim(rtrim(decode(v_state,\n\t'AB', 'CANADA',\n\t'BC', 'CANADA',\n\t'MB', 'CANADA',\n\t'MG', 'CANADA',\n\t'NB', 'CANADA',\n\t'NF', 'CANADA',\n\t'NS', 'CANADA',\n\t'NW', 'CANADA',\n\t'ON', 'CANADA',\n\t'PE', 'CANADA',\n\t'PQ', 'CANADA',\n\t'SA', 'CANADA',\n\t'YN', 'CANADA',\n\t'USA'))) AS country,\n\t'N/A' AS no_match_flag,\n\t'N/A' AS delivery_confirmation_flag,\n\t'N/A' AS group1_match_code,\n\t0 AS latitude,\n\t0 AS longitude\n\tFROM SQ_pif_02_stage\n\tLEFT JOIN LKP_sup_state\n\tON LKP_sup_state.state_abbrev = SQ_pif_02_stage.pif_risk_state_prov\n),\nLKP_contract_customer_key AS (\n\tSELECT\n\tcontract_cust_ak_id,\n\tcontract_key\n\tFROM (\n\t\tSELECT \r\n\t\tcontract_customer.contract_cust_ak_id as contract_cust_ak_id, \r\n\t\tltrim(rtrim(contract_customer.contract_key)) as contract_key \r\n\t\tFROM \r\n\t\tcontract_customer\r\n\t\tWHERE contract_customer.crrnt_snpsht_flag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY contract_key ORDER BY contract_cust_ak_id DESC) = 1\n),\nLKP_contract_customer_address AS (\n\tSELECT\n\tcontract_cust_addr_id,\n\tcontract_cust_addr_ak_id,\n\tloc_unit_num,\n\taddr_line_1,\n\taddr_line_2,\n\taddr_line_3,\n\tcity_name,\n\tstate_prov_code,\n\tzip_postal_code,\n\tzip_postal_code_extension,\n\tcounty_parish_name,\n\tcountry_name,\n\tno_match_flag,\n\tdelivery_confirmation_flag,\n\tgroup1_match_code,\n\tlatitude,\n\tlongitude,\n\tcontract_cust_ak_id,\n\taddr_type\n\tFROM (\n\t\tSELECT \n\t\t\tcontract_cust_addr_id,\n\t\t\tcontract_cust_addr_ak_id,\n\t\t\tloc_unit_num,\n\t\t\taddr_line_1,\n\t\t\taddr_line_2,\n\t\t\taddr_line_3,\n\t\t\tcity_name,\n\t\t\tstate_prov_code,\n\t\t\tzip_postal_code,\n\t\t\tzip_postal_code_extension,\n\t\t\tcounty_parish_name,\n\t\t\tcountry_name,\n\t\t\tno_match_flag,\n\t\t\tdelivery_confirmation_flag,\n\t\t\tgroup1_match_code,\n\t\t\tlatitude,\n\t\t\tlongitude,\n\t\t\tcontract_cust_ak_id,\n\t\t\taddr_type\n\t\tFROM @{pipeline().parameters.TARGET_TABLE_OWNER}.contract_customer_address\n\t\tWHERE CRRNT_SNPSHT_FLAG=1 and source_sys_id = '@{pipeline().parameters.SOURCE_SYSTEM_ID}'\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY contract_cust_ak_id,addr_type ORDER BY contract_cust_addr_id) = 1\n),\nEXP_Detect_Changes AS (\n\tSELECT\n\tLKP_contract_customer_address.contract_cust_addr_id AS lkp_cust_addr_id,\n\tLKP_contract_customer_address.contract_cust_addr_ak_id AS lkp_cust_addr_ak_id,\n\tLKP_contract_customer_address.loc_unit_num AS lkp_loc_unit_num,\n\tLKP_contract_customer_address.addr_line_1 AS lkp_addr_line_1,\n\tLKP_contract_customer_address.addr_line_2 AS lkp_addr_line_2,\n\tLKP_contract_customer_address.addr_line_3 AS lkp_addr_line_3,\n\tLKP_contract_customer_address.city_name AS lkp_city,\n\tLKP_contract_customer_address.state_prov_code AS lkp_state,\n\tLKP_contract_customer_address.zip_postal_code AS lkp_zip_code,\n\tLKP_contract_customer_address.zip_postal_code_extension AS lkp_zip_postal_code_extension,\n\tLKP_contract_customer_address.county_parish_name AS lkp_county,\n\tLKP_contract_customer_address.country_name AS lkp_country,\n\tLKP_contract_customer_address.no_match_flag AS lkp_no_match_flag,\n\tLKP_contract_customer_address.delivery_confirmation_flag AS lkp_delivery_confirmation_flag,\n\tLKP_contract_customer_address.group1_match_code AS lkp_group1_match_code,\n\tLKP_contract_customer_address.latitude AS lkp_latitude,\n\tLKP_contract_customer_address.longitude AS lkp_longitude,\n\tEXP_values.contract_key,\n\tEXP_values.addr_type,\n\tEXP_values.customer_number,\n\tLKP_contract_customer_key.contract_cust_ak_id AS cust_ak_id,\n\tEXP_values.addr_line_1,\n\tEXP_values.addr_line_2,\n\tEXP_values.addr_line_3,\n\tEXP_values.city,\n\tEXP_values.state,\n\tEXP_values.zip_postal_code,\n\tEXP_values.zip_postal_code_extension,\n\tEXP_values.county_parish_name,\n\tEXP_values.loc_unit_num,\n\tEXP_values.country,\n\tEXP_values.no_match_flag,\n\tEXP_values.delivery_confirmation_flag,\n\tEXP_values.group1_match_code,\n\tEXP_values.latitude,\n\tEXP_values.longitude,\n\t-- *INF*: IIF(ISNULL(lkp_cust_addr_ak_id), 'NEW', \r\n\t-- IIF(lkp_addr_line_1 != addr_line_1 OR\r\n\t-- lkp_addr_line_2 != addr_line_2 OR\r\n\t-- lkp_addr_line_3 != addr_line_3 OR\r\n\t-- lkp_city != city  OR\r\n\t-- lkp_state != state OR\r\n\t-- lkp_zip_code != zip_postal_code OR\r\n\t-- lkp_zip_postal_code_extension != zip_postal_code_extension OR\r\n\t-- LTRIM(RTRIM(lkp_loc_unit_num)) != loc_unit_num OR\r\n\t-- lkp_county != county_parish_name OR\t\r\n\t-- lkp_country != country OR\r\n\t-- lkp_no_match_flag != no_match_flag OR\r\n\t-- lkp_delivery_confirmation_flag != delivery_confirmation_flag OR\r\n\t-- lkp_group1_match_code != group1_match_code OR\r\n\t-- lkp_latitude  != latitude OR\r\n\t-- lkp_longitude != longitude,\r\n\t-- 'UPDATE', 'NOCHANGE'))\r\n\t-- \r\n\t-- \r\n\t-- \r\n\t-- --iif(NewLookupRow=1,'NEW',IIF(NewLookupRow=2,'UPDATE','NOCHANGE'))\n\tIFF(lkp_cust_addr_ak_id IS NULL, 'NEW', IFF(lkp_addr_line_1 != addr_line_1 OR lkp_addr_line_2 != addr_line_2 OR lkp_addr_line_3 != addr_line_3 OR lkp_city != city OR lkp_state != state OR lkp_zip_code != zip_postal_code OR lkp_zip_postal_code_extension != zip_postal_code_extension OR LTRIM(RTRIM(lkp_loc_unit_num)) != loc_unit_num OR lkp_county != county_parish_name OR lkp_country != country OR lkp_no_match_flag != no_match_flag OR lkp_delivery_confirmation_flag != delivery_confirmation_flag OR lkp_group1_match_code != group1_match_code OR lkp_latitude != latitude OR lkp_longitude != longitude, 'UPDATE', 'NOCHANGE')) AS v_changed_flag,\n\tv_changed_flag AS changed_flag,\n\t1 AS crrnt_snpsht_flag,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS audit_id,\n\t-- *INF*: iif(v_changed_flag='NEW',\r\n\t-- \tto_date('01/01/1800 01:00:00','MM/DD/YYYY HH24:MI:SS'),sysdate)\n\tIFF(v_changed_flag = 'NEW', to_date('01/01/1800 01:00:00', 'MM/DD/YYYY HH24:MI:SS'), sysdate) AS v_eff_from_date,\n\tv_eff_from_date AS eff_from_date,\n\t-- *INF*: TO_DATE('12/31/2100 23:59:59','MM/DD/YYYY HH24:MI:SS')\n\tTO_DATE('12/31/2100 23:59:59', 'MM/DD/YYYY HH24:MI:SS') AS eff_to_date,\n\t@{pipeline().parameters.SOURCE_SYSTEM_ID} AS source_system_id,\n\tSYSDATE AS created_date,\n\tSYSDATE AS modified_date\n\tFROM EXP_values\n\tLEFT JOIN LKP_contract_customer_address\n\tON LKP_contract_customer_address.contract_cust_ak_id = LKP_contract_customer_key.contract_cust_ak_id AND LKP_contract_customer_address.addr_type = EXP_values.addr_type\n\tLEFT JOIN LKP_contract_customer_key\n\tON LKP_contract_customer_key.contract_key = EXP_values.contract_key\n),\nFIL_insert AS (\n\tSELECT\n\tlkp_cust_addr_ak_id, \n\tcontract_key, \n\taddr_type, \n\tcustomer_number, \n\tcust_ak_id, \n\taddr_line_1, \n\taddr_line_2, \n\taddr_line_3, \n\tcity, \n\tstate, \n\tzip_postal_code, \n\tzip_postal_code_extension, \n\tcounty_parish_name, \n\tloc_unit_num, \n\tcountry, \n\tno_match_flag, \n\tdelivery_confirmation_flag, \n\tgroup1_match_code, \n\tlatitude, \n\tlongitude, \n\tchanged_flag, \n\tcrrnt_snpsht_flag, \n\taudit_id, \n\teff_from_date, \n\teff_to_date, \n\tsource_system_id, \n\tcreated_date, \n\tmodified_date\n\tFROM EXP_Detect_Changes\n\tWHERE changed_flag='NEW' OR changed_flag='UPDATE'\n),\nSEQ_customer_address AS (\n\tCREATE SEQUENCE SEQ_customer_address\n\tSTART = 0\n\tINCREMENT = 1;\n),\nEXP_customer_address_ak_id AS (\n\tSELECT\n\tlkp_cust_addr_ak_id,\n\t-- *INF*: IIF(ISNULL(lkp_cust_addr_ak_id),NEXTVAL,lkp_cust_addr_ak_id)\n\tIFF(lkp_cust_addr_ak_id IS NULL, NEXTVAL, lkp_cust_addr_ak_id) AS cust_addr_ak_id,\n\tcontract_key,\n\taddr_type,\n\tcustomer_number,\n\tcust_ak_id,\n\taddr_line_1,\n\taddr_line_2,\n\taddr_line_3,\n\tcity,\n\tstate,\n\tzip_postal_code,\n\tzip_postal_code_extension,\n\tcounty_parish_name,\n\tloc_unit_num,\n\tcountry,\n\tno_match_flag,\n\tdelivery_confirmation_flag,\n\tgroup1_match_code,\n\tlatitude,\n\tlongitude,\n\tcrrnt_snpsht_flag,\n\taudit_id,\n\teff_from_date,\n\teff_to_date,\n\tsource_system_id,\n\tcreated_date,\n\tmodified_date,\n\tSEQ_customer_address.NEXTVAL\n\tFROM FIL_insert\n),\nTGT_contract_customer_address_INSERT AS (\n\tINSERT INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.contract_customer_address\n\t(crrnt_snpsht_flag, audit_id, eff_from_date, eff_to_date, source_sys_id, created_date, modified_date, contract_cust_addr_ak_id, contract_cust_ak_id, addr_type, loc_unit_num, addr_line_1, addr_line_2, addr_line_3, city_name, state_prov_code, zip_postal_code, zip_postal_code_extension, county_parish_name, country_name, no_match_flag, delivery_confirmation_flag, group1_match_code, latitude, longitude)\n\tSELECT \n\tCRRNT_SNPSHT_FLAG, \n\tAUDIT_ID, \n\tEFF_FROM_DATE, \n\tEFF_TO_DATE, \n\tsource_system_id AS SOURCE_SYS_ID, \n\tCREATED_DATE, \n\tMODIFIED_DATE, \n\tcust_addr_ak_id AS CONTRACT_CUST_ADDR_AK_ID, \n\tcust_ak_id AS CONTRACT_CUST_AK_ID, \n\tADDR_TYPE, \n\tLOC_UNIT_NUM, \n\tADDR_LINE_1, \n\tADDR_LINE_2, \n\tADDR_LINE_3, \n\tcity AS CITY_NAME, \n\tstate AS STATE_PROV_CODE, \n\tZIP_POSTAL_CODE, \n\tZIP_POSTAL_CODE_EXTENSION, \n\tCOUNTY_PARISH_NAME, \n\tcountry AS COUNTRY_NAME, \n\tNO_MATCH_FLAG, \n\tDELIVERY_CONFIRMATION_FLAG, \n\tGROUP1_MATCH_CODE, \n\tLATITUDE, \n\tLONGITUDE\n\tFROM EXP_customer_address_ak_id\n),\nSQ_contract_customer_address AS (\n\tSELECT \r\n\t\tcontract_cust_addr_id,\r\n\t\teff_from_date,\r\n\t\teff_to_date,\r\n\t\tcontract_cust_addr_ak_id \r\n\tFROM\r\n\t\t@{pipeline().parameters.TARGET_TABLE_OWNER}. contract_customer_address \r\n\tWHERE  contract_cust_addr_ak_id  IN\r\n\t\t (SELECT contract_cust_addr_ak_id FROM @{pipeline().parameters.TARGET_TABLE_OWNER}.contract_customer_address \r\n\t\t   WHERE crrnt_snpsht_flag = 1 GROUP BY  contract_cust_addr_ak_id  HAVING count(*) > 1)\r\n\tAND source_sys_id='@{pipeline().parameters.SOURCE_SYSTEM_ID}'\r\n\tORDER BY  contract_cust_addr_ak_id ,eff_from_date  DESC\n),\nEXP_Lag_eff_from_date AS (\n\tSELECT\n\tcontract_cust_addr_id AS cust_addr_id,\n\teff_from_date AS in_eff_from_date,\n\teff_to_date AS orig_eff_to_date,\n\tcontract_cust_addr_ak_id AS cust_addr_ak_id,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- cust_addr_ak_id = v_prev_cust_addr_ak_id ,\r\n\t-- ADD_TO_DATE(v_prev_eff_from_date,'SS',-1),orig_eff_to_date)\n\tDECODE(TRUE,\n\tcust_addr_ak_id = v_prev_cust_addr_ak_id, ADD_TO_DATE(v_prev_eff_from_date, 'SS', - 1),\n\torig_eff_to_date) AS v_eff_to_date,\n\tv_eff_to_date AS eff_to_date,\n\tcust_addr_ak_id AS v_prev_cust_addr_ak_id,\n\tin_eff_from_date AS v_prev_eff_from_date,\n\t0 AS crrnt_snpsht_flag,\n\tSYSDATE AS modified_date\n\tFROM SQ_contract_customer_address\n),\nFIL_FirstRowInAKGroup AS (\n\tSELECT\n\tcust_addr_id, \n\torig_eff_to_date, \n\teff_to_date, \n\tcrrnt_snpsht_flag, \n\tmodified_date\n\tFROM EXP_Lag_eff_from_date\n\tWHERE orig_eff_to_date != eff_to_date\n),\nUPD_customer_address AS (\n\tSELECT\n\tcust_addr_id, \n\teff_to_date, \n\tcrrnt_snpsht_flag, \n\tmodified_date\n\tFROM FIL_FirstRowInAKGroup\n),\nTGT_contract_customer_address_UPDATE AS (\n\tMERGE INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.contract_customer_address AS T\n\tUSING UPD_customer_address AS S\n\tON T.contract_cust_addr_id = S.cust_addr_id\n\tWHEN MATCHED BY TARGET THEN\n\tUPDATE SET T.crrnt_snpsht_flag = S.crrnt_snpsht_flag, T.eff_to_date = S.eff_to_date, T.modified_date = S.modified_date\n),"
                        }
                    ]
                }
            }
        ],
        "parameters": {
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "TARGET_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "SOURCE_SYSTEM_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            }
        },
        "folder": {
            "name": ""
        },
        "annotations": []
    }
}