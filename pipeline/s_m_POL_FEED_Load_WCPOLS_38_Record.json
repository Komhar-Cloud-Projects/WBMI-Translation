{
    "name": "s_m_POL_FEED_Load_WCPOLS_38_Record",
    "properties": {
        "activities": [
            {
                "name": "m_POL_FEED_Load_WCPOLS_38_Record",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nSQ_WCPOLS_38_Record AS (\n\tSELECT distinct\r\n\t\tST.WCTrackHistoryID\r\n\t\t,F.FormName\r\n\t\t,PT.Name\r\n\t\t,Pol.TransactionEffectiveDate\r\n\t\t,PDSP.Value as SoleProprietorExcluded\r\n\t    ,PDP.Value as NameOfPartnerExcluded\r\n\t\t,PDOFF.Value as NameOfOfficersExcluded\r\n\t\t,PDOTH.Value as NameOfOthersExcluded\r\n\t\r\n\tFROM dbo.WorkWCStateTerm ST\r\n\t\r\n\tINNER JOIN dbo.WorkWCForms F\r\n\t\tON ST.WCTrackHistoryID = F.WCTrackHistoryID\r\n\tAND F.FormName like 'WC000308%'AND (F.OnPolicy=1 or F.[Add]=1) AND (F.Remove is NULL or F.Remove=0)\r\n\t\r\n\tINNER JOIN dbo.WorkWCParty PT\r\n\t\tON PT.WCTrackHistoryID = ST.WCTrackHistoryID\r\n\t\t\tAND PT.PartyAssociationType = 'Account'\r\n\t\r\n\tINNER JOIN dbo.WorkWCPolicy Pol\r\n\t\tON Pol.WCTrackHistoryID = ST.WCTrackHistoryID \r\n\t\r\n\tLEFT JOIN dbo.WorkWCPolicyDetails PDSP\r\n\t\tON PDSP.WCTrackHistoryID = ST.WCTrackHistoryID \r\n\t\tAND PDSP.Attribute='SoleProprietorExcluded'\r\n\t\r\n\tLEFT JOIN dbo.WorkWCPolicyDetails PDP\r\n\t\tON PDP.WCTrackHistoryID = ST.WCTrackHistoryID \r\n\t\tAND PDP.Attribute='NameOfPartnerExcluded'\r\n\t\t\r\n\tLEFT JOIN dbo.WorkWCPolicyDetails PDOFF\r\n\t\tON PDOFF.WCTrackHistoryID = ST.WCTrackHistoryID \r\n\t\tAND PDOFF.Attribute='NameOfOfficersExcluded'\r\n\t\t\r\n\tLEFT JOIN dbo.WorkWCPolicyDetails PDOTH\r\n\t\tON PDOTH.WCTrackHistoryID = ST.WCTrackHistoryID \r\n\t\tAND PDOTH.Attribute='NameOfOthersExcluded'\r\n\t\t\r\n\tWHERE 1 = 1\r\n\tAND ST.AuditId = @{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID}\r\n\tAND (PDSP.Value IS NOT NULL OR PDP.Value IS NOT NULL OR\tPDOFF.Value IS NOT NULL OR PDOTH.Value IS NOT NULL)\r\n\t@{pipeline().parameters.WHERE_CLAUSE_38}\r\n\t\r\n\tORDER BY ST.WCTrackHistoryID\n),\nSQ_WCPols00Record AS (\n\tSELECT\r\n\t\tWCTrackHistoryID,\r\n\t\tLinkData,\r\n\t     AuditId\r\n\t\tFROM dbo.WCPols00Record\r\n\tWHERE 1=1\r\n\tAND AuditId = @{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID}\r\n\tORDER BY WCTrackHistoryID\n),\nJNR_38_Record AS (SELECT\n\tSQ_WCPols00Record.WCTrackHistoryID, \n\tSQ_WCPols00Record.LinkData, \n\tSQ_WCPols00Record.AuditId, \n\tSQ_WCPOLS_38_Record.WCTrackHistoryID AS WCTrackHistoryID1, \n\tSQ_WCPOLS_38_Record.FormName, \n\tSQ_WCPOLS_38_Record.Name, \n\tSQ_WCPOLS_38_Record.TransactionEffectiveDate, \n\tSQ_WCPOLS_38_Record.SoleProprietorExcluded, \n\tSQ_WCPOLS_38_Record.NameOfPartnerExcluded, \n\tSQ_WCPOLS_38_Record.NameOfOfficersExcluded, \n\tSQ_WCPOLS_38_Record.NameOfOthersExcluded\n\tFROM SQ_WCPols00Record\n\tINNER JOIN SQ_WCPOLS_38_Record\n\tON SQ_WCPOLS_38_Record.WCTrackHistoryID = SQ_WCPols00Record.WCTrackHistoryID\n),\nmplt_Parse_FormNameField AS (WITH\n\tINPUT_FormName AS (\n\t\t\n\t),\n\tEXPTRANS AS (\n\t\tSELECT\n\t\tParsedNameOfForm,\n\t\tFormNameFromSource,\n\t\t-- *INF*: REVERSE(FormNameFromSource)\n\t\tREVERSE(FormNameFromSource) AS vReversedFromNameFromSource,\n\t\t-- *INF*: REVERSE(substr(vReversedFromNameFromSource,1,4))\n\t\tREVERSE(substr(vReversedFromNameFromSource, 1, 4)) AS vFormEdition,\n\t\t-- *INF*: DECODE(TRUE,\r\n\t\t-- substr(vReversedFromNameFromSource,5,1) >='A' and substr(vReversedFromNameFromSource,5,1) <='Z', substr(vReversedFromNameFromSource,5,1),\r\n\t\t-- ' '\r\n\t\t-- )\r\n\t\t-- \r\n\t\t-- -- check if within A and Z, if not then space\n\t\tDECODE(\n\t\t    TRUE,\n\t\t    substr(vReversedFromNameFromSource, 5, 1) >= 'A' and substr(vReversedFromNameFromSource, 5, 1) <= 'Z', substr(vReversedFromNameFromSource, 5, 1),\n\t\t    ' '\n\t\t) AS vBureauCode,\n\t\tvFormEdition AS oFormEdition,\n\t\tvBureauCode AS oBureauCode\n\t\tFROM INPUT_FormName\n\t),\n\tOUTPUT_FormName AS (\n\t\tSELECT\n\t\tParsedNameOfForm, \n\t\tFormNameFromSource, \n\t\toFormEdition AS FormEdition, \n\t\toBureauCode AS BureauCode\n\t\tFROM EXPTRANS\n\t),\n),\nEXP_Counter AS (\n\tSELECT\n\tSYSDATE AS ExtractDate,\n\tJNR_38_Record.AuditId,\n\tJNR_38_Record.WCTrackHistoryID,\n\tJNR_38_Record.LinkData,\n\t'38' AS RecordTypeCode,\n\t'WC000308' AS EndorsementNumber,\n\tmplt_Parse_FormNameField.BureauCode,\n\tmplt_Parse_FormNameField.FormEdition,\n\tJNR_38_Record.Name,\n\tJNR_38_Record.TransactionEffectiveDate,\n\t-- *INF*: TO_CHAR(TransactionEffectiveDate,'YYMMDD')\n\tTO_CHAR(TransactionEffectiveDate, 'YYMMDD') AS O_TransactionEffectiveDate,\n\tJNR_38_Record.SoleProprietorExcluded,\n\t-- *INF*: IIF(INSTR(SoleProprietorExcluded,'(',1,1)>0,\r\n\t-- SUBSTR(SoleProprietorExcluded,1,INSTR(SoleProprietorExcluded,'(',1,1)-1),SoleProprietorExcluded)\r\n\t-- \r\n\t-- \n\tIFF(\n\t    REGEXP_INSTR(SoleProprietorExcluded, '(', 1, 1) > 0,\n\t    SUBSTR(SoleProprietorExcluded, 1, REGEXP_INSTR(SoleProprietorExcluded, '(', 1, 1) - 1),\n\t    SoleProprietorExcluded\n\t) AS v_SoleProprietorExcluded,\n\tJNR_38_Record.NameOfPartnerExcluded,\n\t-- *INF*: IIF(INSTR(NameOfPartnerExcluded,'(',1,1)>0,\r\n\t-- SUBSTR(NameOfPartnerExcluded,1,INSTR(NameOfPartnerExcluded,'(',1,1)-1),NameOfPartnerExcluded)\n\tIFF(\n\t    REGEXP_INSTR(NameOfPartnerExcluded, '(', 1, 1) > 0,\n\t    SUBSTR(NameOfPartnerExcluded, 1, REGEXP_INSTR(NameOfPartnerExcluded, '(', 1, 1) - 1),\n\t    NameOfPartnerExcluded\n\t) AS v_NameOfPartnerExcluded,\n\tJNR_38_Record.NameOfOfficersExcluded,\n\t-- *INF*: IIF(INSTR(NameOfOfficersExcluded,'(',1,1)>0,\r\n\t-- SUBSTR(NameOfOfficersExcluded,1,INSTR(NameOfOfficersExcluded,'(',1,1)-1),NameOfOfficersExcluded)\n\tIFF(\n\t    REGEXP_INSTR(NameOfOfficersExcluded, '(', 1, 1) > 0,\n\t    SUBSTR(NameOfOfficersExcluded, 1, REGEXP_INSTR(NameOfOfficersExcluded, '(', 1, 1) - 1),\n\t    NameOfOfficersExcluded\n\t) AS v_NameOfOfficersExcluded,\n\tJNR_38_Record.NameOfOthersExcluded,\n\t-- *INF*: IIF(INSTR(NameOfOthersExcluded,'(',1,1)>0,\r\n\t-- SUBSTR(NameOfOthersExcluded,1,INSTR(NameOfOthersExcluded,'(',1,1)-1),NameOfOthersExcluded)\n\tIFF(\n\t    REGEXP_INSTR(NameOfOthersExcluded, '(', 1, 1) > 0,\n\t    SUBSTR(NameOfOthersExcluded, 1, REGEXP_INSTR(NameOfOthersExcluded, '(', 1, 1) - 1),\n\t    NameOfOthersExcluded\n\t) AS v_NameOfOthersExcluded,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- NOT ISNULL(SoleProprietorExcluded),'S',\r\n\t-- NOT ISNULL(NameOfPartnerExcluded),'P',\r\n\t-- NOT ISNULL(NameOfOfficersExcluded),'O',\r\n\t-- NOT ISNULL(NameOfOthersExcluded),'X',\r\n\t-- '')\n\tDECODE(\n\t    TRUE,\n\t    SoleProprietorExcluded IS NOT NULL, 'S',\n\t    NameOfPartnerExcluded IS NOT NULL, 'P',\n\t    NameOfOfficersExcluded IS NOT NULL, 'O',\n\t    NameOfOthersExcluded IS NOT NULL, 'X',\n\t    ''\n\t) AS DescriptorCode,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- NOT ISNULL(SoleProprietorExcluded),v_SoleProprietorExcluded,\r\n\t-- NOT ISNULL(NameOfPartnerExcluded),v_NameOfPartnerExcluded,\r\n\t-- NOT ISNULL(NameOfOfficersExcluded),v_NameOfOfficersExcluded,\r\n\t-- NOT ISNULL(NameOfOthersExcluded),v_NameOfOthersExcluded,\r\n\t-- '')\n\tDECODE(\n\t    TRUE,\n\t    SoleProprietorExcluded IS NOT NULL, v_SoleProprietorExcluded,\n\t    NameOfPartnerExcluded IS NOT NULL, v_NameOfPartnerExcluded,\n\t    NameOfOfficersExcluded IS NOT NULL, v_NameOfOfficersExcluded,\n\t    NameOfOthersExcluded IS NOT NULL, v_NameOfOthersExcluded,\n\t    ''\n\t) AS NameOfPersonToBeExcluded,\n\tWCTrackHistoryID AS v_CurrentRecord,\n\t-- *INF*: IIF(v_CurrentRecord<>v_PreviousRecord,0,1)\n\tIFF(v_CurrentRecord <> v_PreviousRecord, 0, 1) AS ChangeFlag,\n\tWCTrackHistoryID AS v_PreviousRecord,\n\t-- *INF*: IIF(ChangeFlag=1,v_Counter+1,1)\n\tIFF(ChangeFlag = 1, v_Counter + 1, 1) AS v_Counter,\n\t-- *INF*: MOD(v_Counter,3)\n\tMOD(v_Counter, 3) AS Split\n\tFROM JNR_38_Record\n\t -- Manually join with mplt_Parse_FormNameField\n),\nEXP_Split AS (\n\tSELECT\n\tExtractDate,\n\tAuditId,\n\tWCTrackHistoryID,\n\tLinkData,\n\tRecordTypeCode,\n\tEndorsementNumber,\n\tBureauCode,\n\tFormEdition,\n\tName,\n\tO_TransactionEffectiveDate AS TransactionEffectiveDate,\n\tDescriptorCode,\n\tNameOfPersonToBeExcluded,\n\tSplit,\n\t-- *INF*: IIF(Split=1,DescriptorCode,'')\n\tIFF(Split = 1, DescriptorCode, '') AS O_DescriptorCode,\n\t-- *INF*: IIF(Split=1,NameOfPersonToBeExcluded,'')\n\tIFF(Split = 1, NameOfPersonToBeExcluded, '') AS O_NameOfPersonToBeExcluded,\n\t-- *INF*: IIF(Split=2,DescriptorCode,'')\n\tIFF(Split = 2, DescriptorCode, '') AS O_DescriptorCode2,\n\t-- *INF*: IIF(Split=2,NameOfPersonToBeExcluded,'')\n\tIFF(Split = 2, NameOfPersonToBeExcluded, '') AS O_NameOfPersonToBeExcluded2,\n\t-- *INF*: IIF(Split=0,DescriptorCode,'')\n\tIFF(Split = 0, DescriptorCode, '') AS O_DescriptorCode3,\n\t-- *INF*: IIF(Split=0,NameOfPersonToBeExcluded,'')\n\tIFF(Split = 0, NameOfPersonToBeExcluded, '') AS O_NameOfPersonToBeExcluded3,\n\tWCTrackHistoryID AS v_CurrentGroup,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- v_CurrentGroup<>v_PreviousGroup,1,\r\n\t-- v_CurrentGroup=v_PreviousGroup AND Split=1,v_GroupKey+1,\r\n\t-- v_GroupKey)\n\tDECODE(\n\t    TRUE,\n\t    v_CurrentGroup <> v_PreviousGroup, 1,\n\t    v_CurrentGroup = v_PreviousGroup AND Split = 1, v_GroupKey + 1,\n\t    v_GroupKey\n\t) AS v_GroupKey,\n\tWCTrackHistoryID AS v_PreviousGroup,\n\tv_GroupKey AS GroupKey\n\tFROM EXP_Counter\n),\nAGG_GroupData AS (\n\tSELECT\n\tExtractDate,\n\tAuditId,\n\tWCTrackHistoryID,\n\tLinkData,\n\tRecordTypeCode,\n\tEndorsementNumber,\n\tBureauCode,\n\tFormEdition,\n\tO_DescriptorCode AS IN_DescriptorCode,\n\tO_NameOfPersonToBeExcluded AS IN_NameOfPersonToBeExcluded,\n\tO_DescriptorCode2 AS IN_DescriptorCode2,\n\tO_NameOfPersonToBeExcluded2 AS IN_NameOfPersonToBeExcluded2,\n\tO_DescriptorCode3 AS IN_DescriptorCode3,\n\tO_NameOfPersonToBeExcluded3 AS IN_NameOfPersonToBeExcluded3,\n\tGroupKey,\n\t-- *INF*: MAX(IN_DescriptorCode)\n\tMAX(IN_DescriptorCode) AS DescriptorCode,\n\t-- *INF*: MAX(IN_NameOfPersonToBeExcluded)\n\tMAX(IN_NameOfPersonToBeExcluded) AS NameOfPersonToBeExcluded,\n\t-- *INF*: MAX(IN_DescriptorCode2)\n\tMAX(IN_DescriptorCode2) AS DescriptorCode2,\n\t-- *INF*: MAX(IN_NameOfPersonToBeExcluded2)\n\tMAX(IN_NameOfPersonToBeExcluded2) AS NameOfPersonToBeExcluded2,\n\t-- *INF*: MAX(IN_DescriptorCode3)\n\tMAX(IN_DescriptorCode3) AS DescriptorCode3,\n\t-- *INF*: MAX(IN_NameOfPersonToBeExcluded3)\n\tMAX(IN_NameOfPersonToBeExcluded3) AS NameOfPersonToBeExcluded3,\n\tName,\n\tTransactionEffectiveDate\n\tFROM EXP_Split\n\tGROUP BY WCTrackHistoryID, GroupKey\n),\nEXP_Target AS (\n\tSELECT\n\tExtractDate,\n\tAuditId,\n\tWCTrackHistoryID,\n\tLinkData,\n\tRecordTypeCode,\n\tEndorsementNumber,\n\tBureauCode,\n\tFormEdition,\n\tDescriptorCode,\n\tNameOfPersonToBeExcluded,\n\tDescriptorCode2,\n\tNameOfPersonToBeExcluded2,\n\tDescriptorCode3,\n\tNameOfPersonToBeExcluded3,\n\tName,\n\tTransactionEffectiveDate\n\tFROM AGG_GroupData\n),\nWCPols38Record AS (\n\tINSERT INTO WCPols38Record\n\t(ExtractDate, AuditId, WCTrackHistoryID, LinkData, RecordTypeCode, EndorsementNumber, BureauVersionIdentifierEditionIdentifier, CarrierVersionIdentifier, DescriptorCode, NameOfPersonToBeExcluded, DescriptorCode2, NameOfPersonToBeExcluded2, DescriptorCode3, NameOfPersonToBeExcluded3, NameOfInsured, EndorsementEffectiveDate)\n\tSELECT \n\tEXTRACTDATE, \n\tAUDITID, \n\tWCTRACKHISTORYID, \n\tLINKDATA, \n\tRECORDTYPECODE, \n\tENDORSEMENTNUMBER, \n\tBureauCode AS BUREAUVERSIONIDENTIFIEREDITIONIDENTIFIER, \n\tFormEdition AS CARRIERVERSIONIDENTIFIER, \n\tDESCRIPTORCODE, \n\tNAMEOFPERSONTOBEEXCLUDED, \n\tDESCRIPTORCODE2, \n\tNAMEOFPERSONTOBEEXCLUDED2, \n\tDESCRIPTORCODE3, \n\tNAMEOFPERSONTOBEEXCLUDED3, \n\tName AS NAMEOFINSURED, \n\tTransactionEffectiveDate AS ENDORSEMENTEFFECTIVEDATE\n\tFROM EXP_Target\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WHERE_CLAUSE_38": {
                "type": "string",
                "defaultValue": "Default Value"
            }
        },
        "folder": {
            "name": "PolicyDataServices/"
        },
        "annotations": []
    }
}