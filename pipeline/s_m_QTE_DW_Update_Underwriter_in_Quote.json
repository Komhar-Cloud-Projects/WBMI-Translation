{
    "name": "s_m_QTE_DW_Update_Underwriter_in_Quote",
    "properties": {
        "activities": [
            {
                "name": "m_QTE_DW_Update_Underwriter_in_Quote",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nLKP_UnderwriterProductRelationship_UnderwritingAssociateAKID_ByAgySPCPOProg AS (\n\tSELECT\n\tAssociateCode,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyAmountMinimum,\n\tPolicyAmountMaximum,\n\tPolicyOfferingCode,\n\tProgramCode\n\tFROM (\n\t\tSELECT DISTINCT \r\n\t\tUPR.StrategicProfitCenterCode as StrategicProfitCenterCode, \r\n\t\tAgency.AgencyCode as AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum as PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum as PolicyAmountMaximum, \r\n\t\tUPR.PolicyOfferingCode as PolicyOfferingCode,\r\n\t\tUPR.ProgramCode as ProgramCode,\r\n\t\tMAX(UA.RoleSpecificUserCode) as AssociateCode\r\n\t\tFROM \r\n\t\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterProductRelationship UPR\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterAgencyRelationship UAR\r\n\t\ton UPR.AssociateId=UAR.AssociateId\r\n\t\tand UAR.StrategicProfitCenterCode=UPR.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Associate UA\r\n\t\ton UAR.AssociateId=UA.AssociateID\r\n\t\tAND UAR.StrategicProfitCenterCode=UA.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.VWAgency Agency\r\n\t\ton UAR.AgencyId=Agency.AgencyID\r\n\t\tWhere UA.associaterole = 'UNDERWRITER'\r\n\t\tgroup by \r\n\t\tUPR.StrategicProfitCenterCode,\r\n\t\tAgency.AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum,\r\n\t\tUPR.PolicyOfferingCode,\r\n\t\tUPR.ProgramCode\r\n\t\thaving count(distinct UA.RoleSpecificUserCode) = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY StrategicProfitCenterCode,AgencyCode,PolicyAmountMinimum,PolicyAmountMaximum,PolicyOfferingCode,ProgramCode ORDER BY AssociateCode DESC) = 1\n),\nLKP_UnderwriterProductRelationship_UnderwritingAssociateAKID_byAgySPC AS (\n\tSELECT\n\tAssociateCode,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyAmountMinimum,\n\tPolicyAmountMaximum\n\tFROM (\n\t\tSELECT DISTINCT \r\n\t\tUPR.StrategicProfitCenterCode as StrategicProfitCenterCode, \r\n\t\tAgency.AgencyCode as AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum as PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum as PolicyAmountMaximum, \r\n\t\tMAX(UA.RoleSpecificUserCode) as AssociateCode\r\n\t\tFROM \r\n\t\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterProductRelationship UPR\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterAgencyRelationship UAR\r\n\t\ton UPR.AssociateId=UAR.AssociateId\r\n\t\tand UAR.StrategicProfitCenterCode=UPR.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Associate UA\r\n\t\ton UAR.AssociateId=UA.AssociateID\r\n\t\tAND UAR.StrategicProfitCenterCode=UA.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.VWAgency Agency\r\n\t\ton UAR.AgencyId=Agency.AgencyID\r\n\t\tWhere UA.associaterole = 'UNDERWRITER'\r\n\t\tgroup by \r\n\t\tUPR.StrategicProfitCenterCode, \r\n\t\tAgency.AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum\r\n\t\thaving count(distinct UA.RoleSpecificUserCode) = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY StrategicProfitCenterCode,AgencyCode,PolicyAmountMinimum,PolicyAmountMaximum ORDER BY AssociateCode DESC) = 1\n),\nLKP_UnderwriterProductRelationship_UnderwritingAssociateAKID_byAgency AS (\n\tSELECT\n\tAssociateCode,\n\tStrategicProfitCenterCode,\n\tAgencyCode\n\tFROM (\n\t\tSELECT DISTINCT MAX(UA.RoleSpecificUserCode) AS AssociateCode,\r\n\t\tUAR.StrategicProfitCenterCode as StrategicProfitCenterCode,\r\n\t\tAgency.AgencyCode as AgencyCode\r\n\t\tFROM \r\n\t\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterAgencyRelationship UAR\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Associate UA\r\n\t\ton UAR.AssociateId=UA.AssociateID\r\n\t\tAND UAR.StrategicProfitCenterCode=UA.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.VWAgency Agency\r\n\t\ton UAR.AgencyId=Agency.AgencyID\r\n\t\tWHERE UA.associaterole = 'UNDERWRITER'\r\n\t\tgroup by \r\n\t\tUAR.StrategicProfitCenterCode,\r\n\t\tAgency.AgencyCode\r\n\t\thaving count(DISTINCT UA.RoleSpecificUserCode) = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY StrategicProfitCenterCode,AgencyCode ORDER BY AssociateCode DESC) = 1\n),\nLKP_UnderwriterProductRelationship_UnderwritingAssociateAKID_byAgySPCPO AS (\n\tSELECT\n\tAssociateCode,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyAmountMinimum,\n\tPolicyAmountMaximum,\n\tPolicyOfferingCode\n\tFROM (\n\t\tSELECT DISTINCT \r\n\t\tUPR.StrategicProfitCenterCode as StrategicProfitCenterCode, \r\n\t\tAgency.AgencyCode as AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum as PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum as PolicyAmountMaximum, \r\n\t\tUPR.PolicyOfferingCode as PolicyOfferingCode,\r\n\t\tMAX(UA.RoleSpecificUserCode) as AssociateCode\r\n\t\tFROM \r\n\t\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterProductRelationship UPR\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterAgencyRelationship UAR\r\n\t\ton UPR.AssociateId=UAR.AssociateId\r\n\t\tand UAR.StrategicProfitCenterCode=UPR.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Associate UA\r\n\t\ton UAR.AssociateId=UA.AssociateID\r\n\t\tAND UAR.StrategicProfitCenterCode=UA.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.VWAgency Agency\r\n\t\ton UAR.AgencyId=Agency.AgencyID\r\n\t\tWhere UA.associaterole = 'UNDERWRITER'\r\n\t\tgroup by \r\n\t\tUPR.StrategicProfitCenterCode, \r\n\t\tAgency.AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum,\r\n\t\tUPR.PolicyOfferingCode\r\n\t\thaving count(distinct UA.RoleSpecificUserCode) = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY StrategicProfitCenterCode,AgencyCode,PolicyAmountMinimum,PolicyAmountMaximum,PolicyOfferingCode ORDER BY AssociateCode DESC) = 1\n),\nLKP_BondProducts AS (\n\tSELECT\n\tProductCode,\n\tQuoteId\n\tFROM (\n\t\tselect Quote.QuoteId as QuoteId,\r\n\t\tProduct.ProductCode as ProductCode\r\n\t\tfrom @{pipeline().parameters.SOURCE_TABLE_OWNER}.Quote\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.QuoteTransaction\r\n\t\ton Quote.QuoteAKId=QuoteTransaction.QuoteAKID\r\n\t\tand Quote.CurrentSnapshotFlag=1\r\n\t\tand Quote.StatusDate=QuoteTransaction.StatusDate\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Product\r\n\t\ton QuoteTransaction.ProductAKId=Product.ProductAKId\r\n\t\tand Product.CurrentSnapshotFlag=1\r\n\t\twhere Product.ProductCode in('610','620','630','640','650','660')\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY QuoteId ORDER BY ProductCode DESC) = 1\n),\nLKP_UnderwriterProductRelationship_UnderwritingAssociateAKID_ByAgySPCPOProgBond AS (\n\tSELECT\n\tAssociateCode,\n\tStrategicProfitCenterCode,\n\tAgencyCode,\n\tPolicyAmountMinimum,\n\tPolicyAmountMaximum,\n\tPolicyOfferingCode,\n\tProgramCode,\n\tBondCategory\n\tFROM (\n\t\tSELECT DISTINCT \r\n\t\tUPR.StrategicProfitCenterCode as StrategicProfitCenterCode, \r\n\t\tAgency.AgencyCode as AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum as PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum as PolicyAmountMaximum, \r\n\t\tUPR.PolicyOfferingCode as PolicyOfferingCode,\r\n\t\tUPR.ProgramCode as ProgramCode,\r\n\t\tUPR.BondCategory as BondCategory,\r\n\t\tMAX(UA.RoleSpecificUserCode) as AssociateCode\r\n\t\tFROM \r\n\t\t@{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterProductRelationship UPR\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterAgencyRelationship UAR\r\n\t\ton UPR.AssociateId=UAR.AssociateId\r\n\t\tand UAR.StrategicProfitCenterCode=UPR.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.Associate UA\r\n\t\ton UAR.AssociateId=UA.AssociateID\r\n\t\tAND UAR.StrategicProfitCenterCode=UA.StrategicProfitCenterCode\r\n\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.VWAgency Agency\r\n\t\ton UAR.AgencyId=Agency.AgencyID\r\n\t\tWhere UA.associaterole = 'UNDERWRITER'\r\n\t\tgroup by \r\n\t\tUPR.StrategicProfitCenterCode,\r\n\t\tAgency.AgencyCode,\r\n\t\tUPR.PolicyAmountMinimum, \r\n\t\tUPR.PolicyAmountMaximum,\r\n\t\tUPR.PolicyOfferingCode,\r\n\t\tUPR.ProgramCode,\r\n\t\tUPR.BondCategory\r\n\t\thaving count(distinct UA.RoleSpecificUserCode) = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY StrategicProfitCenterCode,AgencyCode,PolicyAmountMinimum,PolicyAmountMaximum,PolicyOfferingCode,ProgramCode,BondCategory ORDER BY AssociateCode DESC) = 1\n),\nLKP_UnderwriterWorkCompPool AS (\n\tSELECT\n\tAssociateCode,\n\tDummy\n\tFROM (\n\t\tselect distinct 1 as Dummy,\r\n\t\ta.RoleSpecificUserCode as AssociateCode\r\n\t\tfrom @{pipeline().parameters.SOURCE_TABLE_OWNER}.associate a\r\n\t\t\tjoin @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwriterProductRelationship b on a.AssociateID = b.AssociateId\r\n\t\twhere a.associaterole = 'UNDERWRITER'\r\n\t\tand b.InsuranceSegmentCode = '3'\r\n\t\tgroup by a.RoleSpecificUserCode\r\n\t\thaving count(DISTINCT a.RoleSpecificUserCode) = 1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY Dummy ORDER BY AssociateCode DESC) = 1\n),\nSQ_Quote AS (\n\tselect Q.QuoteId,\r\n\tQ.AgencyAKId,\r\n\tQ.StrategicProfitCenterAKId,\r\n\tQ.PolicyOfferingAKId,\r\n\tQ.ProgramAKId,\r\n\tISNULL(SUM(QC.WrittenPremium),0) AS WrittenPremium\r\n\tfrom @{pipeline().parameters.SOURCE_TABLE_OWNER}.Quote Q\r\n\tleft join @{pipeline().parameters.SOURCE_TABLE_OWNER}.QuoteTransaction QC\r\n\ton Q.QuoteAKId=QC.QuoteAKID\r\n\tand Q.StatusDate=QC.StatusDate\r\n\twhere Q.underwritingassociateakid=-1\r\n\tGROUP BY Q.QuoteId,\r\n\tQ.AgencyAKId,Q.StrategicProfitCenterAKId,Q.ProgramAKId,Q.StrategicProfitCenterAKId,Q.PolicyOfferingAKId \r\n\tORDER BY Q.QuoteId\n),\nLKP_Agency_V2 AS (\n\tSELECT\n\tAgencyCode,\n\tTerminatedDate,\n\tAgencyAKID\n\tFROM (\n\t\tSELECT \n\t\t\tAgencyCode,\n\t\t\tTerminatedDate,\n\t\t\tAgencyAKID\n\t\tFROM V2.Agency\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY AgencyAKID ORDER BY AgencyCode) = 1\n),\nLKP_InsuranceSegment AS (\n\tSELECT\n\tInsuranceSegmentCode,\n\tInsuranceSegmentAKId\n\tFROM (\n\t\tSELECT \n\t\t\tInsuranceSegmentCode,\n\t\t\tInsuranceSegmentAKId\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.InsuranceSegment\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY InsuranceSegmentAKId ORDER BY InsuranceSegmentCode) = 1\n),\nLKP_PolicyOffering AS (\n\tSELECT\n\tPolicyOfferingCode,\n\tPolicyOfferingAKId\n\tFROM (\n\t\tSELECT \n\t\t\tPolicyOfferingCode,\n\t\t\tPolicyOfferingAKId\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.PolicyOffering\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY PolicyOfferingAKId ORDER BY PolicyOfferingCode) = 1\n),\nLKP_Program AS (\n\tSELECT\n\tProgramCode,\n\tProgramAKId\n\tFROM (\n\t\tSELECT \n\t\t\tProgramCode,\n\t\t\tProgramAKId\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.Program\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY ProgramAKId ORDER BY ProgramCode) = 1\n),\nLKP_StrategicProfitCenter AS (\n\tSELECT\n\tStrategicProfitCenterCode,\n\tStrategicProfitCenterAKId\n\tFROM (\n\t\tSELECT \n\t\t\tStrategicProfitCenterCode,\n\t\t\tStrategicProfitCenterAKId\n\t\tFROM StrategicProfitCenter\n\t\tWHERE CurrentSnapshotFlag=1\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY StrategicProfitCenterAKId ORDER BY StrategicProfitCenterCode) = 1\n),\nEXP_Quote_ProductRelationship AS (\n\tSELECT\n\tLKP_StrategicProfitCenter.StrategicProfitCenterCode AS i_StrategicProfitCenterCode,\n\tLKP_Agency_V2.AgencyCode AS i_AgencyCode,\n\tSQ_Quote.QuoteId AS i_QuoteId,\n\tSQ_Quote.WrittenPremium AS i_WrittenPremium,\n\t-- *INF*: IIF(i_StrategicProfitCenterCode='5',i_WrittenPremium,0)\n\tIFF(i_StrategicProfitCenterCode = '5',\n\t\ti_WrittenPremium,\n\t\t0\n\t) AS v_WrittenPremium,\n\tLKP_PolicyOffering.PolicyOfferingCode AS i_PolicyOfferingCode,\n\tLKP_Program.ProgramCode AS i_ProgramCode,\n\tLKP_Agency_V2.TerminatedDate AS i_TerminatedDate,\n\tLKP_InsuranceSegment.InsuranceSegmentCode AS i_InsuranceSegmentCode,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ISNULL(:LKP.LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGENCY(i_StrategicProfitCenterCode,i_AgencyCode)),NULL,:LKP.LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGENCY(i_StrategicProfitCenterCode,i_AgencyCode))\n\tDECODE(TRUE,\n\t\tLKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGENCY_i_StrategicProfitCenterCode_i_AgencyCode.AssociateCode IS NULL, NULL,\n\t\tLKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGENCY_i_StrategicProfitCenterCode_i_AgencyCode.AssociateCode\n\t) AS v_UnderwritingAssociateAKID_Agy,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ISNULL(v_UnderwritingAssociateAKID_Agy), :LKP.LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPC(i_StrategicProfitCenterCode,i_AgencyCode,v_WrittenPremium),v_UnderwritingAssociateAKID_Agy)\n\tDECODE(TRUE,\n\t\tv_UnderwritingAssociateAKID_Agy IS NULL, LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPC_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium.AssociateCode,\n\t\tv_UnderwritingAssociateAKID_Agy\n\t) AS v_UnderwritingAssociateAKID_AgySPC,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ISNULL(v_UnderwritingAssociateAKID_AgySPC), :LKP.LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO(i_StrategicProfitCenterCode,i_AgencyCode,v_WrittenPremium,i_PolicyOfferingCode),v_UnderwritingAssociateAKID_AgySPC)\n\tDECODE(TRUE,\n\t\tv_UnderwritingAssociateAKID_AgySPC IS NULL, LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode.AssociateCode,\n\t\tv_UnderwritingAssociateAKID_AgySPC\n\t) AS v_UnderwritingAssociateAKID_AgySPCPO,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ISNULL(v_UnderwritingAssociateAKID_AgySPCPO),\r\n\t-- :LKP.LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG(i_StrategicProfitCenterCode,i_AgencyCode,v_WrittenPremium,i_PolicyOfferingCode, i_ProgramCode),v_UnderwritingAssociateAKID_AgySPCPO)\n\tDECODE(TRUE,\n\t\tv_UnderwritingAssociateAKID_AgySPCPO IS NULL, LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode.AssociateCode,\n\t\tv_UnderwritingAssociateAKID_AgySPCPO\n\t) AS v_UnderwritingAssociateAKID_AgySPCPOProg,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ISNULL(v_UnderwritingAssociateAKID_AgySPCPOProg),\r\n\t-- \r\n\t-- DECODE(TRUE,\r\n\t-- \r\n\t-- :LKP.LKP_BONDPRODUCTS(i_QuoteId) = '610',\r\n\t-- :LKP.LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND(i_StrategicProfitCenterCode,i_AgencyCode,v_WrittenPremium,i_PolicyOfferingCode, i_ProgramCode,'Contract'),\r\n\t-- \r\n\t-- IN(:LKP.LKP_BONDPRODUCTS(i_QuoteId),'620','630','640','650','660'),\r\n\t-- :LKP.LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND(i_StrategicProfitCenterCode,i_AgencyCode,v_WrittenPremium,i_PolicyOfferingCode, i_ProgramCode,'NonContract')\r\n\t-- \r\n\t-- \r\n\t-- ),v_UnderwritingAssociateAKID_AgySPCPOProg)\n\tDECODE(TRUE,\n\t\tv_UnderwritingAssociateAKID_AgySPCPOProg IS NULL, DECODE(TRUE,\n\t\tLKP_BONDPRODUCTS_i_QuoteId.ProductCode = '610', LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_Contract.AssociateCode,\n\t\tLKP_BONDPRODUCTS_i_QuoteId.ProductCode IN ('620','630','640','650','660'), LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_NonContract.AssociateCode\n\t\t),\n\t\tv_UnderwritingAssociateAKID_AgySPCPOProg\n\t) AS v_UnderwritingAssociateAKID_AgySPCPOProgBond,\n\t-- *INF*: IIF(ISNULL(v_UnderwritingAssociateAKID_AgySPCPOProgBond),'N/A', v_UnderwritingAssociateAKID_AgySPCPOProgBond)\n\tIFF(v_UnderwritingAssociateAKID_AgySPCPOProgBond IS NULL,\n\t\t'N/A',\n\t\tv_UnderwritingAssociateAKID_AgySPCPOProgBond\n\t) AS v_UnderwritingAssociateCode,\n\ti_QuoteId AS o_QuoteId,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- --Look for work comp pool underwriter\r\n\t-- v_UnderwritingAssociateCode='N/A' AND i_InsuranceSegmentCode = '3',\r\n\t-- IIF(ISNULL(:LKP.LKP_UNDERWRITERWORKCOMPPOOL(1)),'N/A',:LKP.LKP_UNDERWRITERWORKCOMPPOOL(1)),\r\n\t-- \r\n\t-- --Other checks\r\n\t-- v_UnderwritingAssociateCode='N/A' AND i_TerminatedDate<>TO_DATE('12/31/2100','MM/DD/YYYY'),'0998',\r\n\t-- v_UnderwritingAssociateCode='N/A' AND IN  (i_AgencyCode,'16998','14998','21999','34999','16999','34998','12999','22999','98999','26999','55555','13999','24999','15999','48001','48966','14967','15966'),'0999',\r\n\t-- v_UnderwritingAssociateCode='N/A' AND i_PolicyOfferingCode='000','0999',\r\n\t-- LTRIM(RTRIM(v_UnderwritingAssociateCode)))\n\tDECODE(TRUE,\n\t\tv_UnderwritingAssociateCode = 'N/A' \n\t\tAND i_InsuranceSegmentCode = '3', IFF(LKP_UNDERWRITERWORKCOMPPOOL_1.AssociateCode IS NULL,\n\t\t\t'N/A',\n\t\t\tLKP_UNDERWRITERWORKCOMPPOOL_1.AssociateCode\n\t\t),\n\t\tv_UnderwritingAssociateCode = 'N/A' \n\t\tAND i_TerminatedDate <> TO_DATE('12/31/2100', 'MM/DD/YYYY'\n\t\t), '0998',\n\t\tv_UnderwritingAssociateCode = 'N/A' \n\t\tAND i_AgencyCode IN ('16998','14998','21999','34999','16999','34998','12999','22999','98999','26999','55555','13999','24999','15999','48001','48966','14967','15966'), '0999',\n\t\tv_UnderwritingAssociateCode = 'N/A' \n\t\tAND i_PolicyOfferingCode = '000', '0999',\n\t\tLTRIM(RTRIM(v_UnderwritingAssociateCode\n\t\t\t)\n\t\t)\n\t) AS o_UnderwritingAssociateCode,\n\tsysdate AS o_ModifiedDate\n\tFROM SQ_Quote\n\tLEFT JOIN LKP_Agency_V2\n\tON LKP_Agency_V2.AgencyAKID = SQ_Quote.AgencyAKId\n\tLEFT JOIN LKP_InsuranceSegment\n\tON LKP_InsuranceSegment.InsuranceSegmentAKId = SQ_Quote.InsuranceSegmentAKId\n\tLEFT JOIN LKP_PolicyOffering\n\tON LKP_PolicyOffering.PolicyOfferingAKId = SQ_Quote.PolicyOfferingAKId\n\tLEFT JOIN LKP_Program\n\tON LKP_Program.ProgramAKId = SQ_Quote.ProgramAKId\n\tLEFT JOIN LKP_StrategicProfitCenter\n\tON LKP_StrategicProfitCenter.StrategicProfitCenterAKId = SQ_Quote.StrategicProfitCenterAKId\n\tLEFT JOIN LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGENCY LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGENCY_i_StrategicProfitCenterCode_i_AgencyCode\n\tON LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGENCY_i_StrategicProfitCenterCode_i_AgencyCode.StrategicProfitCenterCode = i_StrategicProfitCenterCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGENCY_i_StrategicProfitCenterCode_i_AgencyCode.AgencyCode = i_AgencyCode\n\n\tLEFT JOIN LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPC LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPC_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium\n\tON LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPC_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium.StrategicProfitCenterCode = i_StrategicProfitCenterCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPC_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium.AgencyCode = i_AgencyCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPC_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium.PolicyAmountMinimum = v_WrittenPremium\n\n\tLEFT JOIN LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode\n\tON LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode.StrategicProfitCenterCode = i_StrategicProfitCenterCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode.AgencyCode = i_AgencyCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode.PolicyAmountMinimum = v_WrittenPremium\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPO_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode.PolicyAmountMaximum = i_PolicyOfferingCode\n\n\tLEFT JOIN LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode\n\tON LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode.StrategicProfitCenterCode = i_StrategicProfitCenterCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode.AgencyCode = i_AgencyCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode.PolicyAmountMinimum = v_WrittenPremium\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode.PolicyAmountMaximum = i_PolicyOfferingCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROG_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode.PolicyOfferingCode = i_ProgramCode\n\n\tLEFT JOIN LKP_BONDPRODUCTS LKP_BONDPRODUCTS_i_QuoteId\n\tON LKP_BONDPRODUCTS_i_QuoteId.QuoteId = i_QuoteId\n\n\tLEFT JOIN LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_Contract\n\tON LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_Contract.StrategicProfitCenterCode = i_StrategicProfitCenterCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_Contract.AgencyCode = i_AgencyCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_Contract.PolicyAmountMinimum = v_WrittenPremium\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_Contract.PolicyAmountMaximum = i_PolicyOfferingCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_Contract.PolicyOfferingCode = i_ProgramCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_Contract.ProgramCode = 'Contract'\n\n\tLEFT JOIN LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_NonContract\n\tON LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_NonContract.StrategicProfitCenterCode = i_StrategicProfitCenterCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_NonContract.AgencyCode = i_AgencyCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_NonContract.PolicyAmountMinimum = v_WrittenPremium\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_NonContract.PolicyAmountMaximum = i_PolicyOfferingCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_NonContract.PolicyOfferingCode = i_ProgramCode\n\tAND LKP_UNDERWRITERPRODUCTRELATIONSHIP_UNDERWRITINGASSOCIATEAKID_BYAGYSPCPOPROGBOND_i_StrategicProfitCenterCode_i_AgencyCode_v_WrittenPremium_i_PolicyOfferingCode_i_ProgramCode_NonContract.ProgramCode = 'NonContract'\n\n\tLEFT JOIN LKP_UNDERWRITERWORKCOMPPOOL LKP_UNDERWRITERWORKCOMPPOOL_1\n\tON LKP_UNDERWRITERWORKCOMPPOOL_1.Dummy = 1\n\n),\nLKP_Quote AS (\n\tSELECT\n\tUnderwritingAssociateAKId,\n\tQuoteId\n\tFROM (\n\t\tSELECT \n\t\t\tUnderwritingAssociateAKId,\n\t\t\tQuoteId\n\t\tFROM @{pipeline().parameters.TARGET_TABLE_OWNER}.Quote\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY QuoteId ORDER BY UnderwritingAssociateAKId) = 1\n),\nLKP_UnderwriterAssociate AS (\n\tSELECT\n\tUnderwritingAssociateAKID,\n\tUnderwriterCode\n\tFROM (\n\t\tSELECT \n\t\t\tUnderwritingAssociateAKID,\n\t\t\tUnderwriterCode\n\t\tFROM @{pipeline().parameters.SOURCE_TABLE_OWNER}.UnderwritingAssociate\n\t\tWHERE CurrentSnapshotFlag=1 and AssociateRole in ('UNDERWRITER','CUSTOM UNDERWRITER')\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY UnderwriterCode ORDER BY UnderwritingAssociateAKID DESC) = 1\n),\nFIL_Change AS (\n\tSELECT\n\tEXP_Quote_ProductRelationship.o_QuoteId AS QuoteId, \n\tLKP_Quote.UnderwritingAssociateAKId, \n\tLKP_UnderwriterAssociate.UnderwritingAssociateAKID AS UnderwritingAssociateAKID_new, \n\tEXP_Quote_ProductRelationship.o_ModifiedDate AS ModifiedDate\n\tFROM EXP_Quote_ProductRelationship\n\tLEFT JOIN LKP_Quote\n\tON LKP_Quote.QuoteId = EXP_Quote_ProductRelationship.o_QuoteId\n\tLEFT JOIN LKP_UnderwriterAssociate\n\tON LKP_UnderwriterAssociate.UnderwriterCode = EXP_Quote_ProductRelationship.o_UnderwritingAssociateCode\n\tWHERE UnderwritingAssociateAKId<>UnderwritingAssociateAKID_new\n),\nTGT_Quote_Update AS (\n\tINSERT INTO @{pipeline().parameters.TARGET_TABLE_OWNER}.Quote\n\t(QuoteId, ModifiedDate, UnderwritingAssociateAKId)\n\tSELECT \n\tQUOTEID, \n\tMODIFIEDDATE, \n\tUnderwritingAssociateAKID_new AS UNDERWRITINGASSOCIATEAKID\n\tFROM FIL_Change\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "246494"
            },
            "WBMI_BATCH_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "905492"
            },
            "WBMI_SESSION_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "7603307"
            },
            "SELECTION_START_TS": {
                "type": "string",
                "defaultValue": "08/29/2023 22:45:05"
            },
            "SELECTION_END_TS": {
                "type": "string",
                "defaultValue": "08/30/2023 23:03:49"
            },
            "DBCONNECTION_SOURCE": {
                "type": "string",
                "defaultValue": "SQLServer_RPT_EDM_Claim"
            },
            "DBCONNECTION_TARGET": {
                "type": "string",
                "defaultValue": "SQLServer_RPT_EDM_Claim"
            },
            "SOURCE_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "DBO"
            },
            "TARGET_TABLE_OWNER": {
                "type": "string",
                "defaultValue": "DBO"
            },
            "SOURCE_SYSTEM_ID": {
                "type": "string",
                "defaultValue": "DCT"
            },
            "DBCONNECTION_AGENCYODS": {
                "type": "string",
                "defaultValue": "SQLServer_AgencyODS_Agency"
            },
            "WHERE_CLAUSE ": {
                "type": "string",
                "defaultValue": "and WorkDCTPolicy.QuoteActionStatus IS NOT NULL"
            }
        },
        "folder": {
            "name": "Quote DataWarehouse/"
        },
        "annotations": []
    }
}