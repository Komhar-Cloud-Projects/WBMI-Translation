{
    "name": "s_m_WCPOLS_DCT_Bureau_Comparison",
    "properties": {
        "activities": [
            {
                "name": "m_WCPOLS_DCT_Bureau_Comparison",
                "type": "Script",
                "dependsOn": [],
                "policy": {
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "linkedServiceName": {
                    "referenceName": "ls_SNOWFLAKE_WBMI",
                    "type": "LinkedServiceReference"
                },
                "typeProperties": {
                    "scripts": [
                        {
                            "type": "Query",
                            "text": "WITH\nSQ_WorkWCTrackHistory AS (\n\tSelect distinct HistoryID,PolicyKey from WorkWCTrackHistory\r\n\twhere AuditID=@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID}\r\n\t@{pipeline().parameters.WHERE_CLAUSE}\n),\nEXP_TrackHistory AS (\n\tSELECT\n\tHistoryID,\n\tPolicyKey\n\tFROM SQ_WorkWCTrackHistory\n),\nSQ_WCPOLS_Reconciliation_File AS (\n\n-- TODO Manual --\n\n),\nFIL_BureauData AS (\n\tSELECT\n\tReconciliationID, \n\tAuditID, \n\tBureauName, \n\tPolicyKey, \n\tTransactionType, \n\tHistoryID\n\tFROM SQ_WCPOLS_Reconciliation_File\n\tWHERE AuditID=@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID}\n),\nSRT_BureauData AS (\n\tSELECT\n\tReconciliationID, \n\tAuditID, \n\tBureauName, \n\tPolicyKey AS PolicyKey_Bureau, \n\tTransactionType AS TransactionType_Bureau, \n\tHistoryID AS HistoryID_Bureau\n\tFROM FIL_BureauData\n\tORDER BY HistoryID_Bureau ASC\n),\nSQ_WCPOLS_DCT_Data AS (\n\n-- TODO Manual --\n\n),\nFIL_DCT_Data AS (\n\tSELECT\n\tWCPOLS_DCT_Data_ID, \n\tAuditID, \n\tHistoryID, \n\tPolicyKey, \n\tType, \n\tChangeDate, \n\tRecordType, \n\tComments\n\tFROM SQ_WCPOLS_DCT_Data\n\tWHERE AuditID=@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID}\n),\nSRT_DCT_Data AS (\n\tSELECT\n\tWCPOLS_DCT_Data_ID, \n\tAuditID, \n\tHistoryID AS HistoryID_DCT, \n\tPolicyKey AS PolicyKey_DCT, \n\tType AS TransactionType_DCT, \n\tChangeDate, \n\tRecordType, \n\tComments\n\tFROM FIL_DCT_Data\n\tORDER BY HistoryID_DCT ASC\n),\nJNR_Comparison AS (SELECT\n\tSRT_BureauData.BureauName, \n\tSRT_BureauData.PolicyKey_Bureau, \n\tSRT_BureauData.TransactionType_Bureau, \n\tSRT_BureauData.HistoryID_Bureau, \n\tSRT_DCT_Data.HistoryID_DCT, \n\tSRT_DCT_Data.PolicyKey_DCT, \n\tSRT_DCT_Data.TransactionType_DCT, \n\tSRT_DCT_Data.ChangeDate, \n\tSRT_DCT_Data.RecordType, \n\tSRT_DCT_Data.Comments\n\tFROM SRT_BureauData\n\tFULL OUTER JOIN SRT_DCT_Data\n\tON SRT_DCT_Data.HistoryID_DCT = SRT_BureauData.HistoryID_Bureau\n),\nEXP_Comparison AS (\n\tSELECT\n\tBureauName,\n\tPolicyKey_Bureau AS IN_PolicyKey_Bureau,\n\t-- *INF*: LPAD(IN_PolicyKey_Bureau,9,'0')\n\tLPAD(IN_PolicyKey_Bureau, 9, '0') AS PolicyKey_Bureau,\n\tTransactionType_Bureau,\n\tHistoryID_Bureau,\n\tHistoryID_DCT,\n\tPolicyKey_DCT AS IN_PolicyKey_DCT,\n\t-- *INF*: LPAD(IN_PolicyKey_DCT,9,'0')\n\tLPAD(IN_PolicyKey_DCT, 9, '0') AS PolicyKey_DCT,\n\tTransactionType_DCT,\n\tChangeDate,\n\tRecordType,\n\tComments,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- (NOT ISNULL(IN_PolicyKey_Bureau)),LPAD(IN_PolicyKey_Bureau,9,'0'),\r\n\t-- (NOT ISNULL(IN_PolicyKey_DCT)),LPAD(IN_PolicyKey_DCT,9,'0'),\r\n\t-- '')\n\tDECODE(\n\t    TRUE,\n\t    (IN_PolicyKey_Bureau IS NOT NULL), LPAD(IN_PolicyKey_Bureau, 9, '0'),\n\t    (IN_PolicyKey_DCT IS NOT NULL), LPAD(IN_PolicyKey_DCT, 9, '0'),\n\t    ''\n\t) AS PolicyKey_Comp,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- (NOT ISNULL(HistoryID_Bureau)),HistoryID_Bureau,\r\n\t-- (NOT ISNULL(HistoryID_DCT)),HistoryID_DCT,\r\n\t-- '')\n\tDECODE(\n\t    TRUE,\n\t    (HistoryID_Bureau IS NOT NULL), HistoryID_Bureau,\n\t    (HistoryID_DCT IS NOT NULL), HistoryID_DCT,\n\t    ''\n\t) AS HistoryID_Comp\n\tFROM JNR_Comparison\n),\nSQ_WCPOLS_DG_ExclusionList AS (\n\n-- TODO Manual --\n\n),\nEXP_Exclusion AS (\n\tSELECT\n\tExtractDate,\n\t-- *INF*: ADD_TO_DATE(TO_DATE(ExtractDate,'MM/DD/YYYY'),'HH',13)\n\tDATEADD(HOUR,13,TO_TIMESTAMP(ExtractDate, 'MM/DD/YYYY')) AS O_ExtractDate,\n\tPolicykey,\n\t-- *INF*: LPAD(Policykey,9,'0')\n\tLPAD(Policykey, 9, '0') AS O_Policykey,\n\tTransactionType\n\tFROM SQ_WCPOLS_DG_ExclusionList\n),\nFIL_Exclusion AS (\n\tSELECT\n\tO_ExtractDate AS ExtractDate, \n\tO_Policykey AS Policykey, \n\tTransactionType\n\tFROM EXP_Exclusion\n\tWHERE ExtractDate>=@{pipeline().parameters.SELECTION_START_TS}\n),\nSRT_Exclusion AS (\n\tSELECT\n\tPolicykey, \n\tTransactionType\n\tFROM FIL_Exclusion\n\tORDER BY Policykey ASC, TransactionType ASC\n),\nJNR_Exclusion AS (SELECT\n\tEXP_Comparison.BureauName, \n\tEXP_Comparison.PolicyKey_Bureau, \n\tEXP_Comparison.TransactionType_Bureau, \n\tEXP_Comparison.HistoryID_Bureau, \n\tEXP_Comparison.HistoryID_DCT, \n\tEXP_Comparison.PolicyKey_DCT, \n\tEXP_Comparison.TransactionType_DCT, \n\tEXP_Comparison.ChangeDate, \n\tEXP_Comparison.RecordType, \n\tEXP_Comparison.Comments, \n\tEXP_Comparison.PolicyKey_Comp, \n\tEXP_Comparison.HistoryID_Comp, \n\tSRT_Exclusion.Policykey, \n\tSRT_Exclusion.TransactionType\n\tFROM EXP_Comparison\n\tLEFT OUTER JOIN SRT_Exclusion\n\tON SRT_Exclusion.Policykey = EXP_Comparison.PolicyKey_Comp\n),\nJNR_WIData AS (SELECT\n\tEXP_TrackHistory.HistoryID, \n\tEXP_TrackHistory.PolicyKey, \n\tJNR_Exclusion.BureauName, \n\tJNR_Exclusion.PolicyKey_Bureau, \n\tJNR_Exclusion.TransactionType_Bureau, \n\tJNR_Exclusion.HistoryID_Bureau, \n\tJNR_Exclusion.HistoryID_DCT, \n\tJNR_Exclusion.PolicyKey_DCT, \n\tJNR_Exclusion.TransactionType_DCT, \n\tJNR_Exclusion.ChangeDate, \n\tJNR_Exclusion.RecordType, \n\tJNR_Exclusion.Comments, \n\tJNR_Exclusion.PolicyKey_Comp, \n\tJNR_Exclusion.Policykey AS Policykey_Exclusion, \n\tJNR_Exclusion.TransactionType AS TransactionType_Exclusion, \n\tJNR_Exclusion.HistoryID_Comp\n\tFROM EXP_TrackHistory\n\tRIGHT OUTER JOIN JNR_Exclusion\n\tON JNR_Exclusion.PolicyKey_DCT = EXP_TrackHistory.PolicyKey AND JNR_Exclusion.HistoryID_DCT = EXP_TrackHistory.HistoryID\n),\nSRT_Bureau AS (\n\tSELECT\n\tHistoryID_DCT, \n\tHistoryID_Bureau, \n\tChangeDate, \n\tTransactionType_DCT, \n\tTransactionType_Bureau, \n\tPolicyKey_DCT, \n\tPolicyKey_Bureau, \n\tBureauName, \n\tRecordType, \n\tComments, \n\tPolicyKey_Comp, \n\tHistoryID_Comp, \n\tPolicykey_Exclusion, \n\tTransactionType_Exclusion, \n\tHistoryID AS HistoryID_TrackHistory, \n\tPolicyKey AS PolicyKey_TrackHistory\n\tFROM JNR_WIData\n\tORDER BY PolicyKey_Comp ASC\n),\nEXP_Target AS (\n\tSELECT\n\tv_Counter+1 AS v_Counter,\n\tv_Counter AS WCPOLS_DCT_Bureau_ComparisonID,\n\t@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID} AS AuditID,\n\tHistoryID_DCT,\n\t-- *INF*: TO_INTEGER(HistoryID_DCT)\n\tCAST(HistoryID_DCT AS INTEGER) AS o_HistoryID_DCT,\n\tHistoryID_Bureau,\n\tChangeDate,\n\t-- *INF*: IIF(ISNULL (HistoryID_DCT) ,TO_CHAR(SYSDATE,'YYYYMMDD'),ChangeDate)\n\tIFF(HistoryID_DCT IS NULL, TO_CHAR(CURRENT_TIMESTAMP, 'YYYYMMDD'), ChangeDate) AS v_UnBalancedChangeDate,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- v_BalanceFlag='1',ChangeDate,\r\n\t-- v_BalanceFlag='0',v_UnBalancedChangeDate,\r\n\t-- '')\n\tDECODE(\n\t    TRUE,\n\t    v_BalanceFlag = '1', ChangeDate,\n\t    v_BalanceFlag = '0', v_UnBalancedChangeDate,\n\t    ''\n\t) AS o_ChangeDate,\n\tTransactionType_DCT,\n\tTransactionType_Bureau,\n\tPolicyKey_DCT,\n\tPolicyKey_Bureau,\n\tBureauName,\n\tRecordType,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- LTRIM(RTRIM(BureauName))='','NO',\r\n\t-- ISNULL(BureauName),'NO',\r\n\t-- NOT ISNULL(BureauName),'YES',\r\n\t-- '')\r\n\t-- \n\tDECODE(\n\t    TRUE,\n\t    LTRIM(RTRIM(BureauName)) = '', 'NO',\n\t    BureauName IS NULL, 'NO',\n\t    BureauName IS NOT NULL, 'YES',\n\t    ''\n\t) AS ToBeSent,\n\tComments,\n\t-- *INF*: IIF(HistoryID_Bureau=HistoryID_DCT,'1','0')\n\tIFF(HistoryID_Bureau = HistoryID_DCT, '1', '0') AS v_BalanceFlag,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- ISNULL (HistoryID_DCT) ,'Data did not come through the DCT validation',\r\n\t-- ISNULL(HistoryID_Bureau) AND (Policykey=PolicyKey_DCT)\r\n\t-- ,'PolicyKey Listed in Exclusion File',\r\n\t-- ISNULL(HistoryID_Bureau) AND ISNULL(HistoryID_TrackHistory),'Shred Failure',\r\n\t-- ISNULL(HistoryID_Bureau) AND (ISNULL(Comments) OR LTRIM(RTRIM(Comments))=''),'Shred Failure',\r\n\t-- Comments)\n\tDECODE(\n\t    TRUE,\n\t    HistoryID_DCT IS NULL, 'Data did not come through the DCT validation',\n\t    HistoryID_Bureau IS NULL AND (Policykey = PolicyKey_DCT), 'PolicyKey Listed in Exclusion File',\n\t    HistoryID_Bureau IS NULL AND HistoryID_TrackHistory IS NULL, 'Shred Failure',\n\t    HistoryID_Bureau IS NULL AND (Comments IS NULL OR LTRIM(RTRIM(Comments)) = ''), 'Shred Failure',\n\t    Comments\n\t) AS v_UnBalancedComments,\n\t'' AS v_BalancedComments,\n\t-- *INF*: DECODE(TRUE,\r\n\t-- v_BalanceFlag='1',v_BalancedComments,\r\n\t-- v_BalanceFlag='0',v_UnBalancedComments,\r\n\t-- 'comments')\n\tDECODE(\n\t    TRUE,\n\t    v_BalanceFlag = '1', v_BalancedComments,\n\t    v_BalanceFlag = '0', v_UnBalancedComments,\n\t    'comments'\n\t) AS o_Comments,\n\tPolicyKey_Comp,\n\tPolicykey_Exclusion AS Policykey,\n\tHistoryID_TrackHistory,\n\tPolicyKey_TrackHistory\n\tFROM SRT_Bureau\n),\nLKP_WorkWCTrackHistory AS (\n\tSELECT\n\tHistoryID,\n\tPolicyKey,\n\tHistoryID_DCT\n\tFROM (\n\t\tSelect distinct HistoryID as HistoryID,PolicyKey as PolicyKey from WorkWCTrackHistory\r\n\t\twhere AuditID<>@{pipeline().parameters.WBMI_AUDIT_CONTROL_RUN_ID}\r\n\t\t@{pipeline().parameters.WHERE_CLAUSE_LKP}\n\t)\n\tQUALIFY ROW_NUMBER() OVER (PARTITION BY HistoryID ORDER BY HistoryID) = 1\n),\nEXP_Filter AS (\n\tSELECT\n\tEXP_Target.WCPOLS_DCT_Bureau_ComparisonID,\n\tEXP_Target.AuditID,\n\tEXP_Target.HistoryID_DCT,\n\tEXP_Target.HistoryID_Bureau,\n\tEXP_Target.o_ChangeDate AS ChangeDate,\n\tEXP_Target.TransactionType_DCT,\n\tEXP_Target.TransactionType_Bureau,\n\tEXP_Target.PolicyKey_DCT,\n\tEXP_Target.PolicyKey_Bureau,\n\tEXP_Target.BureauName,\n\tEXP_Target.ToBeSent,\n\tEXP_Target.o_Comments AS Comments,\n\tLKP_WorkWCTrackHistory.HistoryID AS LKP_HistoryID,\n\t-- *INF*: IIF((NOT ISNULL(LKP_HistoryID) AND LTRIM(RTRIM(Comments))='Shred Failure'),'0','1')\n\tIFF((LKP_HistoryID IS NULL AND LTRIM(RTRIM(Comments)) = 'Shred FailNOT ure'), '0', '1') AS FilterFlag\n\tFROM EXP_Target\n\tLEFT JOIN LKP_WorkWCTrackHistory\n\tON LKP_WorkWCTrackHistory.HistoryID = EXP_Target.o_HistoryID_DCT\n),\nFIL_ChangeDateIssues AS (\n\tSELECT\n\tWCPOLS_DCT_Bureau_ComparisonID, \n\tAuditID, \n\tHistoryID_DCT, \n\tHistoryID_Bureau, \n\tChangeDate, \n\tTransactionType_DCT, \n\tTransactionType_Bureau, \n\tPolicyKey_DCT, \n\tPolicyKey_Bureau, \n\tBureauName, \n\tToBeSent, \n\tComments, \n\tLKP_HistoryID, \n\tFilterFlag\n\tFROM EXP_Filter\n\tWHERE FilterFlag='1'\n),\nWCPOLS_DCT_Bureau_Comparison AS (\n\tINSERT INTO WCPOLS_DCT_Bureau_Comparison\n\t(WCPOLS_DCT_Bureau_Comparison, AuditID, HistoryID_DCT, HistoryID_Bureau, ChangeDate, TransactionType_DCT, TransactionType_Bureau, PolicyKey_DCT, PolicyKey_Bureau, BureauName, ToBeSent, Comments)\n\tSELECT \n\tWCPOLS_DCT_Bureau_ComparisonID AS WCPOLS_DCT_BUREAU_COMPARISON, \n\tAUDITID, \n\tHISTORYID_DCT, \n\tHISTORYID_BUREAU, \n\tCHANGEDATE, \n\tTRANSACTIONTYPE_DCT, \n\tTRANSACTIONTYPE_BUREAU, \n\tPOLICYKEY_DCT, \n\tPOLICYKEY_BUREAU, \n\tBUREAUNAME, \n\tTOBESENT, \n\tCOMMENTS\n\tFROM FIL_ChangeDateIssues\n),"
                        }
                    ]
                },
                "state": "Inactive",
                "onInactiveMarkAs": "Succeeded"
            }
        ],
        "parameters": {
            "WBMI_AUDIT_CONTROL_RUN_ID": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WHERE_CLAUSE": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "SELECTION_START_TS": {
                "type": "string",
                "defaultValue": "Default Value"
            },
            "WHERE_CLAUSE_LKP": {
                "type": "string",
                "defaultValue": "Default Value"
            }
        },
        "folder": {
            "name": "PolicyDataServices/"
        },
        "annotations": []
    }
}